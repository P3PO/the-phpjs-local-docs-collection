
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Getting Started with Doctrine &mdash; Doctrine 2 ORM 2 documentation</title>
    <link rel="stylesheet" href="../_static/bootstrap/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/layout.css" type="text/css" />
    <link rel="stylesheet" href="../_static/configurationblock.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>

    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/configurationblock.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/configurationblock.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/configurationblock.js"></script>
    <script src="../_static/bootstrap/js/bootstrap.min.js"></script>

    <script type="text/javascript">
    <!--
        $(document).ready(function() {
            $("#versions").change(function() {
                var docsUrl = $(this).val();
                window.location.href = docsUrl;
            });
        });
    -->
    </script>
    <link rel="shortcut icon" href="../_static/doctrine.ico"/>
    <link rel="top" title="Doctrine 2 ORM 2 documentation" href="../index.html" />
    <link rel="next" title="Getting Started: Database First" href="getting-started-database.html" />
    <link rel="prev" title="Welcome to Doctrine 2 ORM’s documentation!" href="../index.html" />
 
<!-- RTD Extra Head -->


<script type="text/javascript" src="//media.readthedocs.org/javascript/rtd.js"></script>
<link rel="stylesheet" href="//media.readthedocs.org/css/rtd-shim.css" type="text/css" />
<!-- end RTD <extrahead> -->

  </head>
  <body>
    <div id="wrapper">
      <div id="header">
        <h1 id="h1title"></h1>
        <div id="logo">
          <a href="http://www.doctrine-project.org/">Doctrine - PHP Database Libraries</a>
        </div>
      </div>
      <div id="nav" class="cls">
        <div class="tl cls">
          <ul>
            <li><a target="_top" href="/">home</a></li>
            <li><a class="" target="_top" href="http://www.doctrine-project.org/about">about</a></li>
            <li><a class="" target="_top" href="http://www.doctrine-project.org/projects.html">projects</a></li>
            <li><a class="" target="_top" href="http://www.doctrine-project.org/projects/orm">orm</a></li>
            <li><a class="" target="_top" href="http://www.doctrine-project.org/projects/dbal">dbal</a></li>
            <li><a class="" target="_top" href="http://www.doctrine-project.org/blog">blog</a></li>
            <li><a class="" target="_top" href="http://www.doctrine-project.org/jira">development</a></li>
            <li><a class="" target="_top" href="http://www.doctrine-project.org/contribute">contribute</a></li>
            <li><a class="" target="_top" href="http://www.doctrine-project.org/community">community</a></li>
          </ul>
        </div>
      </div>
      <div id="content" class="cls">
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="getting-started-database.html" title="Getting Started: Database First"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../index.html" title="Welcome to Doctrine 2 ORM’s documentation!"
             accesskey="P">previous</a> |</li>
        <li><a href="/">Doctrine Homepage</a> &raquo;</li>
        <li><a href="../index.html">Doctrine 2 ORM 2 documentation</a> &raquo;</li> 
      </ul>
    </div>  

        <div class="document">
            <div class="documentwrapper">
                <div class="bodywrapper">

              <div class="body" >
                
  <div class="section" id="getting-started-with-doctrine">
<h1>Getting Started with Doctrine<a class="headerlink" href="#getting-started-with-doctrine" title="Permalink to this headline">¶</a></h1>
<p>This guide covers getting started with the Doctrine ORM. After working
through the guide you should know:</p>
<ul class="simple">
<li>How to install and configure Doctrine by connecting it to a database</li>
<li>Mapping PHP objects to database tables</li>
<li>Generating a database schema from PHP objects</li>
<li>Using the <tt class="docutils literal"><span class="pre">EntityManager</span></tt> to insert, update, delete and find
objects in the database.</li>
</ul>
<div class="section" id="guide-assumptions">
<h2>Guide Assumptions<a class="headerlink" href="#guide-assumptions" title="Permalink to this headline">¶</a></h2>
<p>This guide is designed for beginners that haven&#8217;t worked with Doctrine ORM
before. There are some prerequesites for the tutorial that have to be
installed:</p>
<ul class="simple">
<li>PHP 5.3.3 or above</li>
<li>Composer Package Manager (<a class="reference external" href="http://getcomposer.org/doc/00-intro.md">Install Composer</a>)</li>
</ul>
<p>The code of this tutorial is <a class="reference external" href="https://github.com/doctrine/doctrine2-orm-tutorial">available on Github</a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This tutorial assumes you work with <strong>Doctrine 2.4</strong> and above.
Some of the code will not work with lower versions.</p>
</div>
</div>
<div class="section" id="what-is-doctrine">
<h2>What is Doctrine?<a class="headerlink" href="#what-is-doctrine" title="Permalink to this headline">¶</a></h2>
<p>Doctrine 2 is an <a class="reference external" href="http://en.wikipedia.org/wiki/Object-relational_mapping">object-relational mapper (ORM)</a> for PHP 5.3.3+ that
provides transparent persistence for PHP objects. It uses the Data Mapper
pattern at the heart, aiming for a complete separation of your domain/business
logic from the persistence in a relational database management system.</p>
<p>The benefit of Doctrine for the programmer is the ability to focus
on the object-oriented business logic and worry about persistence only
as a secondary problem. This doesn&#8217;t mean persistence is downplayed by Doctrine
2, however it is our belief that there are considerable benefits for
object-oriented programming if persistence and entities are kept
separated.</p>
<div class="section" id="what-are-entities">
<h3>What are Entities?<a class="headerlink" href="#what-are-entities" title="Permalink to this headline">¶</a></h3>
<p>Entities are PHP Objects that can be identified over many requests
by a unique identifier or primary key. These classes don&#8217;t need to extend any
abstract base class or interface. An entity class must not be final
or contain final methods. Additionally it must not implement
<strong>clone</strong> nor <strong>wakeup</strong> or <a class="reference internal" href="../cookbook/implementing-wakeup-or-clone.html"><em>do so safely</em></a>.</p>
<p>An entity contains persistable properties. A persistable property
is an instance variable of the entity that is saved into and retrieved from the database
by Doctrine&#8217;s data mapping capabilities.</p>
</div>
</div>
<div class="section" id="an-example-model-bug-tracker">
<h2>An Example Model: Bug Tracker<a class="headerlink" href="#an-example-model-bug-tracker" title="Permalink to this headline">¶</a></h2>
<p>For this Getting Started Guide for Doctrine we will implement the
Bug Tracker domain model from the
<a class="reference external" href="http://framework.zend.com/manual/en/zend.db.table.html">Zend_Db_Table</a>
documentation. Reading their documentation we can extract the
requirements:</p>
<ul class="simple">
<li>A Bugs has a description, creation date, status, reporter and
engineer</li>
<li>A bug can occur on different products (platforms)</li>
<li>Products have a name.</li>
<li>Bug Reporter and Engineers are both Users of the System.</li>
<li>A user can create new bugs.</li>
<li>The assigned engineer can close a bug.</li>
<li>A user can see all his reported or assigned bugs.</li>
<li>Bugs can be paginated through a list-view.</li>
</ul>
</div>
<div class="section" id="setup-project">
<h2>Setup Project<a class="headerlink" href="#setup-project" title="Permalink to this headline">¶</a></h2>
<p>Create a new empty folder for this tutorial project, for example
<tt class="docutils literal"><span class="pre">doctrine2-tutorial</span></tt> and create a new file <tt class="docutils literal"><span class="pre">composer.json</span></tt> with
the following contents:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
    <span class="s">&quot;require&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&quot;doctrine/orm&quot;</span><span class="p">:</span> <span class="s">&quot;2.4.*&quot;</span><span class="p">,</span>
        <span class="s">&quot;symfony/yaml&quot;</span><span class="p">:</span> <span class="s">&quot;2.*&quot;</span>
    <span class="p">},</span>
    <span class="s">&quot;autoload&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&quot;psr-0&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;&quot;</span><span class="p">:</span> <span class="s">&quot;src/&quot;</span><span class="p">}</span>
    <span class="p">},</span>
    <span class="s">&quot;minimum-stability&quot;</span> <span class="p">:</span> <span class="s">&quot;dev&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Install Doctrine using the Composer Dependency Management tool, by calling:</p>
<div class="highlight-python"><pre>$ composer install</pre>
</div>
<p>This will install the packages Doctrine Common, Doctrine DBAL, Doctrine ORM,
Symfony YAML and Symfony Console into the <cite>vendor</cite> directory. The Symfony
dependencies are not required by Doctrine but will be used in this tutorial.</p>
<p>Add the following directories:</p>
<div class="highlight-python"><pre>doctrine2-tutorial
|-- config
|   |-- xml
|   `-- yaml
`-- src</pre>
</div>
</div>
<div class="section" id="obtaining-the-entitymanager">
<h2>Obtaining the EntityManager<a class="headerlink" href="#obtaining-the-entitymanager" title="Permalink to this headline">¶</a></h2>
<p>Doctrine&#8217;s public interface is the EntityManager, it provides the
access point to the complete lifecycle management of your entities
and transforms entities from and back to persistence. You have to
configure and create it to use your entities with Doctrine 2. I
will show the configuration steps and then discuss them step by
step:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// bootstrap.php</span>
<span class="k">use</span> <span class="nx">Doctrine\ORM\Tools\Setup</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Doctrine\ORM\EntityManager</span><span class="p">;</span>

<span class="k">require_once</span> <span class="s2">&quot;vendor/autoload.php&quot;</span><span class="p">;</span>

<span class="c1">// Create a simple &quot;default&quot; Doctrine ORM configuration for Annotations</span>
<span class="nv">$isDevMode</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
<span class="nv">$config</span> <span class="o">=</span> <span class="nx">Setup</span><span class="o">::</span><span class="na">createAnnotationMetadataConfiguration</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="nx">__DIR__</span><span class="o">.</span><span class="s2">&quot;/src&quot;</span><span class="p">),</span> <span class="nv">$isDevMode</span><span class="p">);</span>
<span class="c1">// or if you prefer yaml or XML</span>
<span class="c1">//$config = Setup::createXMLMetadataConfiguration(array(__DIR__.&quot;/config/xml&quot;), $isDevMode);</span>
<span class="c1">//$config = Setup::createYAMLMetadataConfiguration(array(__DIR__.&quot;/config/yaml&quot;), $isDevMode);</span>

<span class="c1">// database configuration parameters</span>
<span class="nv">$conn</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;driver&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;pdo_sqlite&#39;</span><span class="p">,</span>
    <span class="s1">&#39;path&#39;</span> <span class="o">=&gt;</span> <span class="nx">__DIR__</span> <span class="o">.</span> <span class="s1">&#39;/db.sqlite&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="c1">// obtaining the entity manager</span>
<span class="nv">$entityManager</span> <span class="o">=</span> <span class="nx">EntityManager</span><span class="o">::</span><span class="na">create</span><span class="p">(</span><span class="nv">$conn</span><span class="p">,</span> <span class="nv">$config</span><span class="p">);</span>
</pre></div>
</div>
<p>The first require statement sets up the autoloading capabilities of Doctrine
using the Composer autoload.</p>
<p>The second block consists of the instantiation of the ORM
<tt class="docutils literal"><span class="pre">Configuration</span></tt> object using the Setup helper. It assumes a bunch
of defaults that you don&#8217;t have to bother about for now. You can
read up on the configuration details in the
<a class="reference internal" href="../reference/configuration.html"><em>reference chapter on configuration</em></a>.</p>
<p>The third block shows the configuration options required to connect
to a database, in my case a file-based sqlite database. All the
configuration options for all the shipped drivers are given in the
<a class="reference external" href="http://www.doctrine-project.org/documentation/manual/2_0/en/dbal">DBAL Configuration section of the manual</a>.</p>
<p>The last block shows how the <tt class="docutils literal"><span class="pre">EntityManager</span></tt> is obtained from a
factory method.</p>
</div>
<div class="section" id="generating-the-database-schema">
<h2>Generating the Database Schema<a class="headerlink" href="#generating-the-database-schema" title="Permalink to this headline">¶</a></h2>
<p>Now that we have defined the Metadata Mappings and bootstrapped the
EntityManager we want to generate the relational database schema
from it. Doctrine has a Command-Line-Interface that allows you to
access the SchemaTool, a component that generates the required
tables to work with the metadata.</p>
<p>For the command-line tool to work a cli-config.php file has to be
present in the project root directory, where you will execute the
doctrine command. Its a fairly simple file:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// cli-config.php</span>
<span class="k">require_once</span> <span class="s2">&quot;bootstrap.php&quot;</span><span class="p">;</span>

<span class="k">return</span> <span class="nx">\Doctrine\ORM\Tools\Console\ConsoleRunner</span><span class="o">::</span><span class="na">createHelperSet</span><span class="p">(</span><span class="nv">$entityManager</span><span class="p">);</span>
</pre></div>
</div>
<p>You can then change into your project directory and call the
Doctrine command-line tool:</p>
<div class="highlight-python"><pre>$ cd project/
$ php vendor/bin/doctrine orm:schema-tool:create</pre>
</div>
<p>During the development you probably need to re-create the database
several times when changing the Entity metadata. You can then
either re-create the database:</p>
<div class="highlight-python"><pre>$ php vendor/bin/doctrine orm:schema-tool:drop --force
$ php vendor/bin/doctrine orm:schema-tool:create</pre>
</div>
<p>Or use the update functionality:</p>
<div class="highlight-python"><pre>$ php vendor/bin/doctrine orm:schema-tool:update --force</pre>
</div>
<p>The updating of databases uses a Diff Algorithm for a given
Database Schema, a cornerstone of the <tt class="docutils literal"><span class="pre">Doctrine\DBAL</span></tt> package,
which can even be used without the Doctrine ORM package. However
its not available in SQLite since it does not support ALTER TABLE.</p>
</div>
<div class="section" id="starting-with-the-product">
<h2>Starting with the Product<a class="headerlink" href="#starting-with-the-product" title="Permalink to this headline">¶</a></h2>
<p>We start with the Product entity requirements, because it is the most simple one
to get started. Create a <tt class="docutils literal"><span class="pre">src/Product.php</span></tt> file and put the <tt class="docutils literal"><span class="pre">Product</span></tt>
entity definition in there:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// src/Product.php</span>
<span class="k">class</span> <span class="nc">Product</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @var int</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$id</span><span class="p">;</span>
    <span class="sd">/**</span>
<span class="sd">     * @var string</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$name</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getId</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getName</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setName</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">=</span> <span class="nv">$name</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note how the properties have getter and setter methods defined except
<tt class="docutils literal"><span class="pre">$id</span></tt>. To access data from entities Doctrine 2 uses the Reflection API, so it
is possible for Doctrine to access the value of <tt class="docutils literal"><span class="pre">$id</span></tt>. You don&#8217;t have to
take Doctrine into account when designing access to the state of your objects.</p>
<p>The next step for persistence with Doctrine is to describe the
structure of the <tt class="docutils literal"><span class="pre">Product</span></tt> entity to Doctrine using a metadata
language. The metadata language describes how entities, their
properties and references should be persisted and what constraints
should be applied to them.</p>
<p>Metadata for entities are configured using a XML, YAML or Docblock Annotations.
This Getting Started Guide will show the mappings for all Mapping Drivers.
References in the text will be made to the XML mapping.</p>
<div class="configuration-block">
<ul class="simple">
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// src/Product.php</span>
<span class="sd">/**</span>
<span class="sd"> * @Entity @Table(name=&quot;products&quot;)</span>
<span class="sd"> **/</span>
<span class="k">class</span> <span class="nc">Product</span>
<span class="p">{</span>
    <span class="sd">/** @Id @Column(type=&quot;integer&quot;) @GeneratedValue **/</span>
    <span class="k">protected</span> <span class="nv">$id</span><span class="p">;</span>
    <span class="sd">/** @Column(type=&quot;string&quot;) **/</span>
    <span class="k">protected</span> <span class="nv">$name</span><span class="p">;</span>

    <span class="c1">// .. (other code)</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- config/xml/Product.dcm.xml --&gt;</span>
<span class="nt">&lt;doctrine-mapping</span> <span class="na">xmlns=</span><span class="s">&quot;http://doctrine-project.org/schemas/orm/doctrine-mapping&quot;</span>
      <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
      <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://doctrine-project.org/schemas/orm/doctrine-mapping</span>
<span class="s">                    http://raw.github.com/doctrine/doctrine2/master/doctrine-mapping.xsd&quot;</span><span class="nt">&gt;</span>

      <span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">&quot;Product&quot;</span> <span class="na">table=</span><span class="s">&quot;products&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">&quot;id&quot;</span> <span class="na">type=</span><span class="s">&quot;integer&quot;</span><span class="nt">&gt;</span>
              <span class="nt">&lt;generator</span> <span class="na">strategy=</span><span class="s">&quot;AUTO&quot;</span> <span class="nt">/&gt;</span>
          <span class="nt">&lt;/id&gt;</span>

          <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;name&quot;</span> <span class="na">type=</span><span class="s">&quot;string&quot;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/entity&gt;</span>
<span class="nt">&lt;/doctrine-mapping&gt;</span>
</pre></div>
</div>
</li>
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># config/yaml/Product.dcm.yml</span>
<span class="l-Scalar-Plain">Product</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">entity</span>
  <span class="l-Scalar-Plain">table</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">products</span>
  <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">integer</span>
      <span class="l-Scalar-Plain">generator</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">strategy</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">AUTO</span>
  <span class="l-Scalar-Plain">fields</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">string</span>
</pre></div>
</div>
</li>
</ul>
</div>
<p>The top-level <tt class="docutils literal"><span class="pre">entity</span></tt> definition tag specifies information about
the class and table-name. The primitive type <tt class="docutils literal"><span class="pre">Product::$name</span></tt> is
defined as <tt class="docutils literal"><span class="pre">field</span></tt> attributes. The Id property is defined with
the <tt class="docutils literal"><span class="pre">id</span></tt> tag. The id has a <tt class="docutils literal"><span class="pre">generator</span></tt> tag nested inside which
defines that the primary key generation mechanism automatically
uses the database platforms native id generation strategy, for
example AUTO INCREMENT in the case of MySql or Sequences in the
case of PostgreSql and Oracle.</p>
<p>You have to update the database now, because we have a first Entity now:</p>
<div class="highlight-python"><pre>$ php vendor/bin/doctrine orm:schema-tool:update --force --dump-sql</pre>
</div>
<p>Specifying both flags <tt class="docutils literal"><span class="pre">--force</span></tt> and <tt class="docutils literal"><span class="pre">-dump-sql</span></tt> prints and executes the DDL
statements.</p>
<p>Now create a new script that will insert products into the database:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// create_product.php</span>
<span class="k">require_once</span> <span class="s2">&quot;bootstrap.php&quot;</span><span class="p">;</span>

<span class="nv">$newProductName</span> <span class="o">=</span> <span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

<span class="nv">$product</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Product</span><span class="p">();</span>
<span class="nv">$product</span><span class="o">-&gt;</span><span class="na">setName</span><span class="p">(</span><span class="nv">$newProductName</span><span class="p">);</span>

<span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$product</span><span class="p">);</span>
<span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>

<span class="k">echo</span> <span class="s2">&quot;Created Product with ID &quot;</span> <span class="o">.</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">()</span> <span class="o">.</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>Call this script from the command line to see how new products are created:</p>
<div class="highlight-python"><pre>$ php create_product.php ORM
$ php create_product.php DBAL</pre>
</div>
<p>What is happening here? Using the <tt class="docutils literal"><span class="pre">Product</span></tt> is pretty standard OOP.
The interesting bits are the use of the <tt class="docutils literal"><span class="pre">EntityManager</span></tt> service. To
notify the EntityManager that a new entity should be inserted into the database
you have to call <tt class="docutils literal"><span class="pre">persist()</span></tt>. To intiate a transaction to actually perform
the insertion, You have to explicitly call <tt class="docutils literal"><span class="pre">flush()</span></tt> on the <tt class="docutils literal"><span class="pre">EntityManager</span></tt>.</p>
<p>This distinction between persist and flush is allows to aggregate all writes
(INSERT, UPDATE, DELETE) into one single transaction, which is executed when
flush is called. Using this approach the write-performance is significantly
better than in a scenario where updates are done for each entity in isolation.</p>
<p>Doctrine follows the UnitOfWork pattern which additionally detects all entities
that were fetched and have changed during the request. You don&#8217;t have to keep track of
entities yourself, when Doctrine already knowns about them.</p>
<p>As a next step we want to fetch a list of all the products. Let&#8217;s create a
new script for this:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// list_products.php</span>
<span class="k">require_once</span> <span class="s2">&quot;bootstrap.php&quot;</span><span class="p">;</span>

<span class="nv">$productRepository</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="s1">&#39;Product&#39;</span><span class="p">);</span>
<span class="nv">$products</span> <span class="o">=</span> <span class="nv">$productRepository</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$products</span> <span class="k">as</span> <span class="nv">$product</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s2">&quot;-%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">EntityManager#getRepository()</span></tt> method can create a finder object (called
repository) for every entity. It is provided by Doctrine and contains some
finder methods such as <tt class="docutils literal"><span class="pre">findAll()</span></tt>.</p>
<p>Let&#8217;s continue with displaying the name of a product based on its ID:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// show_product.php &lt;id&gt;</span>
<span class="k">require_once</span> <span class="s2">&quot;bootstrap.php&quot;</span><span class="p">;</span>

<span class="nv">$id</span> <span class="o">=</span> <span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="nv">$product</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="s1">&#39;Product&#39;</span><span class="p">,</span> <span class="nv">$id</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$product</span> <span class="o">===</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">&quot;No product found.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">echo</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s2">&quot;-%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">());</span>
</pre></div>
</div>
<p>Updating a product name demonstrates the functionality UnitOfWork of pattern
discussed before. We only need to find a product entity and all changes to its
properties are written to the database:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// update_product.php &lt;id&gt; &lt;new-name&gt;</span>
<span class="k">require_once</span> <span class="s2">&quot;bootstrap.php&quot;</span><span class="p">;</span>

<span class="nv">$id</span> <span class="o">=</span> <span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="nv">$newName</span> <span class="o">=</span> <span class="nv">$argv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="nv">$product</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="s1">&#39;Product&#39;</span><span class="p">,</span> <span class="nv">$id</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$product</span> <span class="o">===</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">&quot;Product </span><span class="si">$id</span><span class="s2"> does not exist.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="nv">$product</span><span class="o">-&gt;</span><span class="na">setName</span><span class="p">(</span><span class="nv">$newName</span><span class="p">);</span>

<span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>
</pre></div>
</div>
<p>After calling this script on one of the existing products, you can verify the
product name changed by calling the <tt class="docutils literal"><span class="pre">show_product.php</span></tt> script.</p>
</div>
<div class="section" id="adding-bug-and-user-entities">
<h2>Adding Bug and User Entities<a class="headerlink" href="#adding-bug-and-user-entities" title="Permalink to this headline">¶</a></h2>
<p>We continue with the bug tracker domain, by creating the missing classes
<tt class="docutils literal"><span class="pre">Bug</span></tt>  and <tt class="docutils literal"><span class="pre">User</span></tt> and putting them into <tt class="docutils literal"><span class="pre">src/Bug.php</span></tt> and
<tt class="docutils literal"><span class="pre">src/User.php</span></tt> respectively.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// src/Bug.php</span>
<span class="sd">/**</span>
<span class="sd"> * @Entity(repositoryClass=&quot;BugRepository&quot;) @Table(name=&quot;bugs&quot;)</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">Bug</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @Id @Column(type=&quot;integer&quot;) @GeneratedValue</span>
<span class="sd">     * @var int</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$id</span><span class="p">;</span>
    <span class="sd">/**</span>
<span class="sd">     * @Column(type=&quot;string&quot;)</span>
<span class="sd">     * @var string</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$description</span><span class="p">;</span>
    <span class="sd">/**</span>
<span class="sd">     * @Column(type=&quot;datetime&quot;)</span>
<span class="sd">     * @var DateTime</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$created</span><span class="p">;</span>
    <span class="sd">/**</span>
<span class="sd">     * @Column(type=&quot;string&quot;)</span>
<span class="sd">     * @var string</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$status</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getId</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getDescription</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">description</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setDescription</span><span class="p">(</span><span class="nv">$description</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">description</span> <span class="o">=</span> <span class="nv">$description</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setCreated</span><span class="p">(</span><span class="nx">DateTime</span> <span class="nv">$created</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">created</span> <span class="o">=</span> <span class="nv">$created</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getCreated</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">created</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setStatus</span><span class="p">(</span><span class="nv">$status</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">status</span> <span class="o">=</span> <span class="nv">$status</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getStatus</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">status</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// src/User.php</span>
<span class="sd">/**</span>
<span class="sd"> * @Entity @Table(name=&quot;users&quot;)</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">User</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @Id @GeneratedValue @Column(type=&quot;integer&quot;)</span>
<span class="sd">     * @var int</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$id</span><span class="p">;</span>
    <span class="sd">/**</span>
<span class="sd">     * @Column(type=&quot;string&quot;)</span>
<span class="sd">     * @var string</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$name</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getId</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getName</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setName</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">=</span> <span class="nv">$name</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>All of the properties discussed so far are simple string and integer values,
for example the id fields of the entities, their names, description, status and
change dates. With just the scalar values this model cannot describe the dynamics that we want. We
want to model references between entities.</p>
<p>References between objects are foreign keys in the database. You never have to
work with the foreign keys directly, only with objects that represent the
foreign key through their own identity.</p>
<p>For every foreign key you either have a Doctrine ManyToOne or OneToOne
association. On the inverse sides of these foreign keys you can have
OneToMany associations. Obviously you can have ManyToMany associations
that connect two tables with each other through a join table with
two foreign keys.</p>
<p>Now that you know the basics about references in Doctrine, we can extend the
domain model to match the requirements:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// src/Bug.php</span>
<span class="k">use</span> <span class="nx">Doctrine\Common\Collections\ArrayCollection</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Bug</span>
<span class="p">{</span>
    <span class="c1">// ... (previous code)</span>

    <span class="k">protected</span> <span class="nv">$products</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">products</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayCollection</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// src/User.php</span>
<span class="k">use</span> <span class="nx">Doctrine\Common\Collections\ArrayCollection</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">User</span>
<span class="p">{</span>
    <span class="c1">// ... (previous code)</span>

    <span class="k">protected</span> <span class="nv">$reportedBugs</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$assignedBugs</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">reportedBugs</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayCollection</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assignedBugs</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayCollection</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Whenever an entity is recreated from the database, an Collection
implementation of the type Doctrine is injected into your entity
instead of an array. Compared to the ArrayCollection this
implementation helps the Doctrine ORM understand the changes that
have happened to the collection which are noteworthy for
persistence.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Lazy load proxies always contain an instance of
Doctrine&#8217;s EntityManager and all its dependencies. Therefore a
var_dump() will possibly dump a very large recursive structure
which is impossible to render and read. You have to use
<tt class="docutils literal"><span class="pre">Doctrine\Common\Util\Debug::dump()</span></tt> to restrict the dumping to a
human readable level. Additionally you should be aware that dumping
the EntityManager to a Browser may take several minutes, and the
Debug::dump() method just ignores any occurrences of it in Proxy
instances.</p>
</div>
<p>Because we only work with collections for the references we must be
careful to implement a bidirectional reference in the domain model.
The concept of owning or inverse side of a relation is central to
this notion and should always be kept in mind. The following
assumptions are made about relations and have to be followed to be
able to work with Doctrine 2. These assumptions are not unique to
Doctrine 2 but are best practices in handling database relations
and Object-Relational Mapping.</p>
<ul class="simple">
<li>Changes to Collections are saved or updated, when the entity on
the <em>owning</em> side of the collection is saved or updated.</li>
<li>Saving an Entity at the inverse side of a relation never
triggers a persist operation to changes to the collection.</li>
<li>In a one-to-one relation the entity holding the foreign key of
the related entity on its own database table is <em>always</em> the owning
side of the relation.</li>
<li>In a many-to-many relation, both sides can be the owning side of
the relation. However in a bi-directional many-to-many relation
only one is allowed to be.</li>
<li>In a many-to-one relation the Many-side is the owning side by
default, because it holds the foreign key.</li>
<li>The OneToMany side of a relation is inverse by default, since
the foreign key is saved on the Many side. A OneToMany relation can
only be the owning side, if its implemented using a ManyToMany
relation with join table and restricting the one side to allow only
UNIQUE values per database constraint.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Consistency of bi-directional references on the inverse side of a
relation have to be managed in userland application code. Doctrine
cannot magically update your collections to be consistent.</p>
</div>
<p>In the case of Users and Bugs we have references back and forth to
the assigned and reported bugs from a user, making this relation
bi-directional. We have to change the code to ensure consistency of
the bi-directional reference:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// src/Bug.php</span>
<span class="k">class</span> <span class="nc">Bug</span>
<span class="p">{</span>
    <span class="c1">// ... (previous code)</span>

    <span class="k">protected</span> <span class="nv">$engineer</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$reporter</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setEngineer</span><span class="p">(</span><span class="nv">$engineer</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$engineer</span><span class="o">-&gt;</span><span class="na">assignedToBug</span><span class="p">(</span><span class="nv">$this</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">engineer</span> <span class="o">=</span> <span class="nv">$engineer</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setReporter</span><span class="p">(</span><span class="nv">$reporter</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$reporter</span><span class="o">-&gt;</span><span class="na">addReportedBug</span><span class="p">(</span><span class="nv">$this</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">reporter</span> <span class="o">=</span> <span class="nv">$reporter</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getEngineer</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">engineer</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getReporter</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">reporter</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// src/User.php</span>
<span class="k">class</span> <span class="nc">User</span>
<span class="p">{</span>
    <span class="c1">// ... (previous code)</span>

    <span class="k">protected</span> <span class="nv">$reportedBugs</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$assignedBugs</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">addReportedBug</span><span class="p">(</span><span class="nv">$bug</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">reportedBugs</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$bug</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">assignedToBug</span><span class="p">(</span><span class="nv">$bug</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assignedBugs</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$bug</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>I chose to name the inverse methods in past-tense, which should
indicate that the actual assigning has already taken place and the
methods are only used for ensuring consistency of the references.
This approach is my personal preference, you can choose whatever
method to make this work.</p>
<p>You can see from <tt class="docutils literal"><span class="pre">User::addReportedBug()</span></tt> and
<tt class="docutils literal"><span class="pre">User::assignedToBug()</span></tt> that using this method in userland alone
would not add the Bug to the collection of the owning side in
<tt class="docutils literal"><span class="pre">Bug::$reporter</span></tt> or <tt class="docutils literal"><span class="pre">Bug::$engineer</span></tt>. Using these methods and
calling Doctrine for persistence would not update the collections
representation in the database.</p>
<p>Only using <tt class="docutils literal"><span class="pre">Bug::setEngineer()</span></tt> or <tt class="docutils literal"><span class="pre">Bug::setReporter()</span></tt>
correctly saves the relation information. We also set both
collection instance variables to protected, however with PHP 5.3&#8217;s
new features Doctrine is still able to use Reflection to set and
get values from protected and private properties.</p>
<p>The <tt class="docutils literal"><span class="pre">Bug::$reporter</span></tt> and <tt class="docutils literal"><span class="pre">Bug::$engineer</span></tt> properties are
Many-To-One relations, which point to a User. In a normalized
relational model the foreign key is saved on the Bug&#8217;s table, hence
in our object-relation model the Bug is at the owning side of the
relation. You should always make sure that the use-cases of your
domain model should drive which side is an inverse or owning one in
your Doctrine mapping. In our example, whenever a new bug is saved
or an engineer is assigned to the bug, we don&#8217;t want to update the
User to persist the reference, but the Bug. This is the case with
the Bug being at the owning side of the relation.</p>
<p>Bugs reference Products by an uni-directional ManyToMany relation in
the database that points from Bugs to Products.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// src/Bug.php</span>
<span class="k">class</span> <span class="nc">Bug</span>
<span class="p">{</span>
    <span class="c1">// ... (previous code)</span>

    <span class="k">protected</span> <span class="nv">$products</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">assignToProduct</span><span class="p">(</span><span class="nv">$product</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">products</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$product</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getProducts</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">products</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We are now finished with the domain model given the requirements.
Now we continue adding metadata mappings for the <tt class="docutils literal"><span class="pre">User</span></tt> and <tt class="docutils literal"><span class="pre">Bug</span></tt>
as we did for the <tt class="docutils literal"><span class="pre">Product</span></tt> before:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// src/Bug.php</span>
<span class="sd">/**</span>
<span class="sd"> * @Entity @Table(name=&quot;bugs&quot;)</span>
<span class="sd"> **/</span>
<span class="k">class</span> <span class="nc">Bug</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @Id @Column(type=&quot;integer&quot;) @GeneratedValue</span>
<span class="sd">     **/</span>
    <span class="k">protected</span> <span class="nv">$id</span><span class="p">;</span>
    <span class="sd">/**</span>
<span class="sd">     * @Column(type=&quot;string&quot;)</span>
<span class="sd">     **/</span>
    <span class="k">protected</span> <span class="nv">$description</span><span class="p">;</span>
    <span class="sd">/**</span>
<span class="sd">     * @Column(type=&quot;datetime&quot;)</span>
<span class="sd">     **/</span>
    <span class="k">protected</span> <span class="nv">$created</span><span class="p">;</span>
    <span class="sd">/**</span>
<span class="sd">     * @Column(type=&quot;string&quot;)</span>
<span class="sd">     **/</span>
    <span class="k">protected</span> <span class="nv">$status</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @ManyToOne(targetEntity=&quot;User&quot;, inversedBy=&quot;assignedBugs&quot;)</span>
<span class="sd">     **/</span>
    <span class="k">protected</span> <span class="nv">$engineer</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @ManyToOne(targetEntity=&quot;User&quot;, inversedBy=&quot;reportedBugs&quot;)</span>
<span class="sd">     **/</span>
    <span class="k">protected</span> <span class="nv">$reporter</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @ManyToMany(targetEntity=&quot;Product&quot;)</span>
<span class="sd">     **/</span>
    <span class="k">protected</span> <span class="nv">$products</span><span class="p">;</span>

    <span class="c1">// ... (other code)</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- config/xml/Bug.dcm.xml --&gt;</span>
<span class="nt">&lt;doctrine-mapping</span> <span class="na">xmlns=</span><span class="s">&quot;http://doctrine-project.org/schemas/orm/doctrine-mapping&quot;</span>
      <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
      <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://doctrine-project.org/schemas/orm/doctrine-mapping</span>
<span class="s">                    http://raw.github.com/doctrine/doctrine2/master/doctrine-mapping.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">&quot;Bug&quot;</span> <span class="na">table=</span><span class="s">&quot;bugs&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">&quot;id&quot;</span> <span class="na">type=</span><span class="s">&quot;integer&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;generator</span> <span class="na">strategy=</span><span class="s">&quot;AUTO&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/id&gt;</span>

        <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;description&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;created&quot;</span> <span class="na">type=</span><span class="s">&quot;datetime&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;status&quot;</span> <span class="na">type=</span><span class="s">&quot;string&quot;</span> <span class="nt">/&gt;</span>

        <span class="nt">&lt;many-to-one</span> <span class="na">target-entity=</span><span class="s">&quot;User&quot;</span> <span class="na">field=</span><span class="s">&quot;reporter&quot;</span> <span class="na">inversed-by=</span><span class="s">&quot;reportedBugs&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;many-to-one</span> <span class="na">target-entity=</span><span class="s">&quot;User&quot;</span> <span class="na">field=</span><span class="s">&quot;engineer&quot;</span> <span class="na">inversed-by=</span><span class="s">&quot;assignedBugs&quot;</span> <span class="nt">/&gt;</span>

        <span class="nt">&lt;many-to-many</span> <span class="na">target-entity=</span><span class="s">&quot;Product&quot;</span> <span class="na">field=</span><span class="s">&quot;products&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/entity&gt;</span>
<span class="nt">&lt;/doctrine-mapping&gt;</span>
</pre></div>
</div>
</li>
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># config/yaml/Bug.dcm.yml</span>
<span class="l-Scalar-Plain">Bug</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">entity</span>
  <span class="l-Scalar-Plain">table</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">bugs</span>
  <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">integer</span>
      <span class="l-Scalar-Plain">generator</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">strategy</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">AUTO</span>
  <span class="l-Scalar-Plain">fields</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">description</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">text</span>
    <span class="l-Scalar-Plain">created</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">datetime</span>
    <span class="l-Scalar-Plain">status</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">string</span>
  <span class="l-Scalar-Plain">manyToOne</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">reporter</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">targetEntity</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">User</span>
      <span class="l-Scalar-Plain">inversedBy</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">reportedBugs</span>
    <span class="l-Scalar-Plain">engineer</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">targetEntity</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">User</span>
      <span class="l-Scalar-Plain">inversedBy</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">assignedBugs</span>
  <span class="l-Scalar-Plain">manyToMany</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">products</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">targetEntity</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Product</span>
</pre></div>
</div>
</li>
</ul>
</div>
<p>Here we have the entity, id and primitive type definitions.
The column names are used from the Zend_Db_Table examples and
have different names than the properties on the Bug class.
Additionally for the &#8220;created&#8221; field it is specified that it is of
the Type &#8220;DATETIME&#8221;, which translates the YYYY-mm-dd HH:mm:ss
Database format into a PHP DateTime instance and back.</p>
<p>After the field definitions the two qualified references to the
user entity are defined. They are created by the <tt class="docutils literal"><span class="pre">many-to-one</span></tt>
tag. The class name of the related entity has to be specified with
the <tt class="docutils literal"><span class="pre">target-entity</span></tt> attribute, which is enough information for
the database mapper to access the foreign-table. Since
<tt class="docutils literal"><span class="pre">reporter</span></tt> and <tt class="docutils literal"><span class="pre">engineer</span></tt> are on the owning side of a
bi-directional relation we also have to specify the <tt class="docutils literal"><span class="pre">inversed-by</span></tt>
attribute. They have to point to the field names on the inverse
side of the relationship. We will see in the next example that the <tt class="docutils literal"><span class="pre">inversed-by</span></tt>
attribute has a counterpart <tt class="docutils literal"><span class="pre">mapped-by</span></tt> which makes that
the inverse side.</p>
<p>The last missing property is the <tt class="docutils literal"><span class="pre">Bug::$products</span></tt> collection. It
holds all products where the specific bug is occurring in. Again
you have to define the <tt class="docutils literal"><span class="pre">target-entity</span></tt> and <tt class="docutils literal"><span class="pre">field</span></tt> attributes
on the <tt class="docutils literal"><span class="pre">many-to-many</span></tt> tag. Furthermore you have to specify the
details of the many-to-many join-table and its foreign key columns.
The definition is rather complex, however relying on the XML
auto-completion I got it working easily, although I forget the
schema details all the time.</p>
<p>The last missing definition is that of the User entity:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// src/User.php</span>
<span class="sd">/**</span>
<span class="sd"> * @Entity @Table(name=&quot;users&quot;)</span>
<span class="sd"> **/</span>
<span class="k">class</span> <span class="nc">User</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @Id @GeneratedValue @Column(type=&quot;integer&quot;)</span>
<span class="sd">     * @var int</span>
<span class="sd">     **/</span>
    <span class="k">protected</span> <span class="nv">$id</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @Column(type=&quot;string&quot;)</span>
<span class="sd">     * @var string</span>
<span class="sd">     **/</span>
    <span class="k">protected</span> <span class="nv">$name</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @OneToMany(targetEntity=&quot;Bug&quot;, mappedBy=&quot;reporter&quot;)</span>
<span class="sd">     * @var Bug[]</span>
<span class="sd">     **/</span>
    <span class="k">protected</span> <span class="nv">$reportedBugs</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @OneToMany(targetEntity=&quot;Bug&quot;, mappedBy=&quot;engineer&quot;)</span>
<span class="sd">     * @var Bug[]</span>
<span class="sd">     **/</span>
    <span class="k">protected</span> <span class="nv">$assignedBugs</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>

    <span class="c1">// .. (other code)</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- config/xml/User.dcm.xml --&gt;</span>
<span class="nt">&lt;doctrine-mapping</span> <span class="na">xmlns=</span><span class="s">&quot;http://doctrine-project.org/schemas/orm/doctrine-mapping&quot;</span>
      <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
      <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://doctrine-project.org/schemas/orm/doctrine-mapping</span>
<span class="s">                    http://raw.github.com/doctrine/doctrine2/master/doctrine-mapping.xsd&quot;</span><span class="nt">&gt;</span>

     <span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">&quot;User&quot;</span> <span class="na">table=</span><span class="s">&quot;users&quot;</span><span class="nt">&gt;</span>
         <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">&quot;id&quot;</span> <span class="na">type=</span><span class="s">&quot;integer&quot;</span><span class="nt">&gt;</span>
             <span class="nt">&lt;generator</span> <span class="na">strategy=</span><span class="s">&quot;AUTO&quot;</span> <span class="nt">/&gt;</span>
         <span class="nt">&lt;/id&gt;</span>

         <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;name&quot;</span> <span class="na">type=</span><span class="s">&quot;string&quot;</span> <span class="nt">/&gt;</span>

         <span class="nt">&lt;one-to-many</span> <span class="na">target-entity=</span><span class="s">&quot;Bug&quot;</span> <span class="na">field=</span><span class="s">&quot;reportedBugs&quot;</span> <span class="na">mapped-by=</span><span class="s">&quot;reporter&quot;</span> <span class="nt">/&gt;</span>
         <span class="nt">&lt;one-to-many</span> <span class="na">target-entity=</span><span class="s">&quot;Bug&quot;</span> <span class="na">field=</span><span class="s">&quot;assignedBugs&quot;</span> <span class="na">mapped-by=</span><span class="s">&quot;engineer&quot;</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;/entity&gt;</span>
<span class="nt">&lt;/doctrine-mapping&gt;</span>
</pre></div>
</div>
</li>
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># config/xml/User.dcm.yml</span>
<span class="l-Scalar-Plain">User</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">entity</span>
  <span class="l-Scalar-Plain">table</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">users</span>
  <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">integer</span>
      <span class="l-Scalar-Plain">generator</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">strategy</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">AUTO</span>
  <span class="l-Scalar-Plain">fields</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">string</span>
  <span class="l-Scalar-Plain">oneToMany</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">reportedBugs</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">targetEntity</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Bug</span>
      <span class="l-Scalar-Plain">mappedBy</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">reporter</span>
    <span class="l-Scalar-Plain">assignedBugs</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">targetEntity</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Bug</span>
      <span class="l-Scalar-Plain">mappedBy</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">engineer</span>
</pre></div>
</div>
</li>
</ul>
</div>
<p>Here are some new things to mention about the <tt class="docutils literal"><span class="pre">one-to-many</span></tt> tags.
Remember that we discussed about the inverse and owning side. Now
both reportedBugs and assignedBugs are inverse relations, which
means the join details have already been defined on the owning
side. Therefore we only have to specify the property on the Bug
class that holds the owning sides.</p>
<p>This example has a fair overview of the most basic features of the
metadata definition language.</p>
</div>
<div class="section" id="implementing-more-requirements">
<h2>Implementing more Requirements<a class="headerlink" href="#implementing-more-requirements" title="Permalink to this headline">¶</a></h2>
<p>For starters we need a create user entities:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// create_user.php</span>
<span class="k">require_once</span> <span class="s2">&quot;bootstrap.php&quot;</span><span class="p">;</span>

<span class="nv">$newUsername</span> <span class="o">=</span> <span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

<span class="nv">$user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">();</span>
<span class="nv">$user</span><span class="o">-&gt;</span><span class="na">setName</span><span class="p">(</span><span class="nv">$newUsername</span><span class="p">);</span>

<span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$user</span><span class="p">);</span>
<span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>

<span class="k">echo</span> <span class="s2">&quot;Created User with ID &quot;</span> <span class="o">.</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">()</span> <span class="o">.</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>Now call:</p>
<div class="highlight-python"><pre>$ php create_user.php beberlei</pre>
</div>
<p>We now have the data to create a bug and the code for this scenario may look
like this:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// create_bug.php</span>
<span class="k">require_once</span> <span class="s2">&quot;bootstrap.php&quot;</span><span class="p">;</span>

<span class="nv">$theReporterId</span> <span class="o">=</span> <span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="nv">$theDefaultEngineerId</span> <span class="o">=</span> <span class="nv">$argv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="nv">$productIds</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="nv">$argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

<span class="nv">$reporter</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="s2">&quot;User&quot;</span><span class="p">,</span> <span class="nv">$theReporterId</span><span class="p">);</span>
<span class="nv">$engineer</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="s2">&quot;User&quot;</span><span class="p">,</span> <span class="nv">$theDefaultEngineerId</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$reporter</span> <span class="o">||</span> <span class="o">!</span><span class="nv">$engineer</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">&quot;No reporter and/or engineer found for the input.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="nv">$bug</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Bug</span><span class="p">();</span>
<span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">setDescription</span><span class="p">(</span><span class="s2">&quot;Something does not work!&quot;</span><span class="p">);</span>
<span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">setCreated</span><span class="p">(</span><span class="k">new</span> <span class="nx">DateTime</span><span class="p">(</span><span class="s2">&quot;now&quot;</span><span class="p">));</span>
<span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">setStatus</span><span class="p">(</span><span class="s2">&quot;OPEN&quot;</span><span class="p">);</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$productIds</span> <span class="k">AS</span> <span class="nv">$productId</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$product</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="s2">&quot;Product&quot;</span><span class="p">,</span> <span class="nv">$productId</span><span class="p">);</span>
    <span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">assignToProduct</span><span class="p">(</span><span class="nv">$product</span><span class="p">);</span>
<span class="p">}</span>

<span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">setReporter</span><span class="p">(</span><span class="nv">$reporter</span><span class="p">);</span>
<span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">setEngineer</span><span class="p">(</span><span class="nv">$engineer</span><span class="p">);</span>

<span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$bug</span><span class="p">);</span>
<span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>

<span class="k">echo</span> <span class="s2">&quot;Your new Bug Id: &quot;</span><span class="o">.</span><span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">()</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>Since we only have one user and product, probably with the ID of 1, we can call this script with:</p>
<div class="highlight-python"><pre>php create_bug.php 1 1 1</pre>
</div>
<p>This is the first contact with the read API of the EntityManager,
showing that a call to <tt class="docutils literal"><span class="pre">EntityManager#find($name,</span> <span class="pre">$id)</span></tt> returns a
single instance of an entity queried by primary key. Besides this
we see the persist + flush pattern again to save the Bug into the
database.</p>
<p>See how simple relating Bug, Reporter, Engineer and Products is
done by using the discussed methods in the &#8220;A first prototype&#8221;
section. The UnitOfWork will detect this relations when flush is
called and relate them in the database appropriately.</p>
</div>
<div class="section" id="queries-for-application-use-cases">
<h2>Queries for Application Use-Cases<a class="headerlink" href="#queries-for-application-use-cases" title="Permalink to this headline">¶</a></h2>
<div class="section" id="list-of-bugs">
<h3>List of Bugs<a class="headerlink" href="#list-of-bugs" title="Permalink to this headline">¶</a></h3>
<p>Using the previous examples we can fill up the database quite a
bit, however we now need to discuss how to query the underlying
mapper for the required view representations. When opening the
application, bugs can be paginated through a list-view, which is
the first read-only use-case:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// list_bugs.php</span>
<span class="k">require_once</span> <span class="s2">&quot;bootstrap.php&quot;</span><span class="p">;</span>

<span class="nv">$dql</span> <span class="o">=</span> <span class="s2">&quot;SELECT b, e, r FROM Bug b JOIN b.engineer e JOIN b.reporter r ORDER BY b.created DESC&quot;</span><span class="p">;</span>

<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">createQuery</span><span class="p">(</span><span class="nv">$dql</span><span class="p">);</span>
<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">setMaxResults</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>
<span class="nv">$bugs</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">getResult</span><span class="p">();</span>

<span class="k">foreach</span><span class="p">(</span><span class="nv">$bugs</span> <span class="k">AS</span> <span class="nv">$bug</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">getDescription</span><span class="p">()</span><span class="o">.</span><span class="s2">&quot; - &quot;</span><span class="o">.</span><span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">getCreated</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">format</span><span class="p">(</span><span class="s1">&#39;d.m.Y&#39;</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s2">&quot;    Reported by: &quot;</span><span class="o">.</span><span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">getReporter</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">()</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s2">&quot;    Assigned to: &quot;</span><span class="o">.</span><span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">getEngineer</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">()</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">foreach</span><span class="p">(</span><span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">getProducts</span><span class="p">()</span> <span class="k">AS</span> <span class="nv">$product</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">&quot;    Platform: &quot;</span><span class="o">.</span><span class="nv">$product</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">()</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">echo</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The DQL Query in this example fetches the 30 most recent bugs with
their respective engineer and reporter in one single SQL statement.
The console output of this script is then:</p>
<div class="highlight-python"><pre>Something does not work! - 02.04.2010
    Reported by: beberlei
    Assigned to: beberlei
    Platform: My Product</pre>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Dql is not Sql</strong></p>
<p>You may wonder why we start writing SQL at the beginning of this
use-case. Don&#8217;t we use an ORM to get rid of all the endless
hand-writing of SQL? Doctrine introduces DQL which is best
described as <strong>object-query-language</strong> and is a dialect of
<a class="reference external" href="http://en.wikipedia.org/wiki/Object_Query_Language">OQL</a> and
similar to <a class="reference external" href="http://www.hibernate.org">HQL</a> or
<a class="reference external" href="http://en.wikipedia.org/wiki/Java_Persistence_Query_Language">JPQL</a>.
It does not know the concept of columns and tables, but only those
of Entity-Class and property. Using the Metadata we defined before
it allows for very short distinctive and powerful queries.</p>
<p>An important reason why DQL is favourable to the Query API of most
ORMs is its similarity to SQL. The DQL language allows query
constructs that most ORMs don&#8217;t, GROUP BY even with HAVING,
Sub-selects, Fetch-Joins of nested classes, mixed results with
entities and scalar data such as COUNT() results and much more.
Using DQL you should seldom come to the point where you want to
throw your ORM into the dumpster, because it doesn&#8217;t support some
the more powerful SQL concepts.</p>
<p>Besides handwriting DQL you can however also use the
<tt class="docutils literal"><span class="pre">QueryBuilder</span></tt> retrieved by calling
<tt class="docutils literal"><span class="pre">$entityManager-&gt;createQueryBuilder()</span></tt> which is a Query Object
around the DQL language.</p>
<p class="last">As a last resort you can however also use Native SQL and a
description of the result set to retrieve entities from the
database. DQL boils down to a Native SQL statement and a
<tt class="docutils literal"><span class="pre">ResultSetMapping</span></tt> instance itself. Using Native SQL you could
even use stored procedures for data retrieval, or make use of
advanced non-portable database queries like PostgreSql&#8217;s recursive
queries.</p>
</div>
</div>
<div class="section" id="array-hydration-of-the-bug-list">
<h3>Array Hydration of the Bug List<a class="headerlink" href="#array-hydration-of-the-bug-list" title="Permalink to this headline">¶</a></h3>
<p>In the previous use-case we retrieved the result as their
respective object instances. We are not limited to retrieving
objects only from Doctrine however. For a simple list view like the
previous one we only need read access to our entities and can
switch the hydration from objects to simple PHP arrays instead.
This can obviously yield considerable performance benefits for
read-only requests.</p>
<p>Implementing the same list view as before using array hydration we
can rewrite our code:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// list_bugs_array.php</span>
<span class="k">require_once</span> <span class="s2">&quot;bootstrap.php&quot;</span><span class="p">;</span>

<span class="nv">$dql</span> <span class="o">=</span> <span class="s2">&quot;SELECT b, e, r, p FROM Bug b JOIN b.engineer e &quot;</span><span class="o">.</span>
       <span class="s2">&quot;JOIN b.reporter r JOIN b.products p ORDER BY b.created DESC&quot;</span><span class="p">;</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">createQuery</span><span class="p">(</span><span class="nv">$dql</span><span class="p">);</span>
<span class="nv">$bugs</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">getArrayResult</span><span class="p">();</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$bugs</span> <span class="k">AS</span> <span class="nv">$bug</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$bug</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="s2">&quot; - &quot;</span> <span class="o">.</span> <span class="nv">$bug</span><span class="p">[</span><span class="s1">&#39;created&#39;</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">format</span><span class="p">(</span><span class="s1">&#39;d.m.Y&#39;</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s2">&quot;    Reported by: &quot;</span><span class="o">.</span><span class="nv">$bug</span><span class="p">[</span><span class="s1">&#39;reporter&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s2">&quot;    Assigned to: &quot;</span><span class="o">.</span><span class="nv">$bug</span><span class="p">[</span><span class="s1">&#39;engineer&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">foreach</span><span class="p">(</span><span class="nv">$bug</span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">]</span> <span class="k">AS</span> <span class="nv">$product</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">&quot;    Platform: &quot;</span><span class="o">.</span><span class="nv">$product</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">echo</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>There is one significant difference in the DQL query however, we
have to add an additional fetch-join for the products connected to
a bug. The resulting SQL query for this single select statement is
pretty large, however still more efficient to retrieve compared to
hydrating objects.</p>
</div>
<div class="section" id="find-by-primary-key">
<h3>Find by Primary Key<a class="headerlink" href="#find-by-primary-key" title="Permalink to this headline">¶</a></h3>
<p>The next Use-Case is displaying a Bug by primary key. This could be
done using DQL as in the previous example with a where clause,
however there is a convenience method on the <tt class="docutils literal"><span class="pre">EntityManager</span></tt> that
handles loading by primary key, which we have already seen in the
write scenarios:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// show_bug.php</span>
<span class="k">require_once</span> <span class="s2">&quot;bootstrap.php&quot;</span><span class="p">;</span>

<span class="nv">$theBugId</span> <span class="o">=</span> <span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

<span class="nv">$bug</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="s2">&quot;Bug&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nv">$theBugId</span><span class="p">);</span>

<span class="k">echo</span> <span class="s2">&quot;Bug: &quot;</span><span class="o">.</span><span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">getDescription</span><span class="p">()</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">&quot;Engineer: &quot;</span><span class="o">.</span><span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">getEngineer</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">()</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>The output of the engineers name is fetched from the database! What is happening?</p>
<p>Since we only retrieved the bug by primary key both the engineer and reporter
are not immediately loaded from the database but are replaced by LazyLoading
proxies. These proxies will load behind the scenes, when the first method
is called on them.</p>
<p>Sample code of this proxy generated code can be found in the specified Proxy
Directory, it looks like:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">MyProject\Proxies</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * THIS CLASS WAS GENERATED BY THE DOCTRINE ORM. DO NOT EDIT THIS FILE.</span>
<span class="sd"> **/</span>
<span class="k">class</span> <span class="nc">UserProxy</span> <span class="k">extends</span> <span class="nx">\User</span> <span class="k">implements</span> <span class="nx">\Doctrine\ORM\Proxy\Proxy</span>
<span class="p">{</span>
    <span class="c1">// .. lazy load code here</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">addReportedBug</span><span class="p">(</span><span class="nv">$bug</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_load</span><span class="p">();</span>
        <span class="k">return</span> <span class="k">parent</span><span class="o">::</span><span class="na">addReportedBug</span><span class="p">(</span><span class="nv">$bug</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">assignedToBug</span><span class="p">(</span><span class="nv">$bug</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_load</span><span class="p">();</span>
        <span class="k">return</span> <span class="k">parent</span><span class="o">::</span><span class="na">assignedToBug</span><span class="p">(</span><span class="nv">$bug</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>See how upon each method call the proxy is lazily loaded from the
database?</p>
<p>The call prints:</p>
<div class="highlight-python"><pre>$ php show_bug.php 1
Bug: Something does not work!
Engineer: beberlei</pre>
</div>
</div>
</div>
<div class="section" id="dashboard-of-the-user">
<h2>Dashboard of the User<a class="headerlink" href="#dashboard-of-the-user" title="Permalink to this headline">¶</a></h2>
<p>For the next use-case we want to retrieve the dashboard view, a
list of all open bugs the user reported or was assigned to. This
will be achieved using DQL again, this time with some WHERE clauses
and usage of bound parameters:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// dashboard.php</span>
<span class="k">require_once</span> <span class="s2">&quot;bootstrap.php&quot;</span><span class="p">;</span>

<span class="nv">$theUserId</span> <span class="o">=</span> <span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

<span class="nv">$dql</span> <span class="o">=</span> <span class="s2">&quot;SELECT b, e, r FROM Bug b JOIN b.engineer e JOIN b.reporter r &quot;</span><span class="o">.</span>
       <span class="s2">&quot;WHERE b.status = &#39;OPEN&#39; AND (e.id = ?1 OR r.id = ?1) ORDER BY b.created DESC&quot;</span><span class="p">;</span>

<span class="nv">$myBugs</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">createQuery</span><span class="p">(</span><span class="nv">$dql</span><span class="p">)</span>
                        <span class="o">-&gt;</span><span class="na">setParameter</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$theUserId</span><span class="p">)</span>
                        <span class="o">-&gt;</span><span class="na">setMaxResults</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
                        <span class="o">-&gt;</span><span class="na">getResult</span><span class="p">();</span>

<span class="k">echo</span> <span class="s2">&quot;You have created or assigned to &quot;</span> <span class="o">.</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$myBugs</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&quot; open bugs:</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">;</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$myBugs</span> <span class="k">AS</span> <span class="nv">$bug</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">()</span> <span class="o">.</span> <span class="s2">&quot; - &quot;</span> <span class="o">.</span> <span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">getDescription</span><span class="p">()</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="number-of-bugs">
<h2>Number of Bugs<a class="headerlink" href="#number-of-bugs" title="Permalink to this headline">¶</a></h2>
<p>Until now we only retrieved entities or their array representation.
Doctrine also supports the retrieval of non-entities through DQL.
These values are called &#8220;scalar result values&#8221; and may even be
aggregate values using COUNT, SUM, MIN, MAX or AVG functions.</p>
<p>We will need this knowledge to retrieve the number of open bugs
grouped by product:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// products.php</span>
<span class="k">require_once</span> <span class="s2">&quot;bootstrap.php&quot;</span><span class="p">;</span>

<span class="nv">$dql</span> <span class="o">=</span> <span class="s2">&quot;SELECT p.id, p.name, count(b.id) AS openBugs FROM Bug b &quot;</span><span class="o">.</span>
       <span class="s2">&quot;JOIN b.products p WHERE b.status = &#39;OPEN&#39; GROUP BY p.id&quot;</span><span class="p">;</span>
<span class="nv">$productBugs</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">createQuery</span><span class="p">(</span><span class="nv">$dql</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getScalarResult</span><span class="p">();</span>

<span class="k">foreach</span><span class="p">(</span><span class="nv">$productBugs</span> <span class="k">as</span> <span class="nv">$productBug</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$productBug</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="s2">&quot; has &quot;</span> <span class="o">.</span> <span class="nv">$productBug</span><span class="p">[</span><span class="s1">&#39;openBugs&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="s2">&quot; open bugs!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="updating-entities">
<h2>Updating Entities<a class="headerlink" href="#updating-entities" title="Permalink to this headline">¶</a></h2>
<p>There is a single use-case missing from the requirements, Engineers
should be able to close a bug. This looks like:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// src/Bug.php</span>

<span class="k">class</span> <span class="nc">Bug</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">close</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">status</span> <span class="o">=</span> <span class="s2">&quot;CLOSE&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// close_bug.php</span>
<span class="k">require_once</span> <span class="s2">&quot;bootstrap.php&quot;</span><span class="p">;</span>

<span class="nv">$theBugId</span> <span class="o">=</span> <span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

<span class="nv">$bug</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="s2">&quot;Bug&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nv">$theBugId</span><span class="p">);</span>
<span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">close</span><span class="p">();</span>

<span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>
</pre></div>
</div>
<p>When retrieving the Bug from the database it is inserted into the
IdentityMap inside the UnitOfWork of Doctrine. This means your Bug
with exactly this id can only exist once during the whole request
no matter how often you call <tt class="docutils literal"><span class="pre">EntityManager#find()</span></tt>. It even
detects entities that are hydrated using DQL and are already
present in the Identity Map.</p>
<p>When flush is called the EntityManager loops over all the entities
in the identity map and performs a comparison between the values
originally retrieved from the database and those values the entity
currently has. If at least one of these properties is different the
entity is scheduled for an UPDATE against the database. Only the
changed columns are updated, which offers a pretty good performance
improvement compared to updating all the properties.</p>
</div>
<div class="section" id="entity-repositories">
<h2>Entity Repositories<a class="headerlink" href="#entity-repositories" title="Permalink to this headline">¶</a></h2>
<p>For now we have not discussed how to separate the Doctrine query logic from your model.
In Doctrine 1 there was the concept of <tt class="docutils literal"><span class="pre">Doctrine_Table</span></tt> instances for this
separation. The similar concept in Doctrine2 is called Entity Repositories, integrating
the <a class="reference external" href="http://martinfowler.com/eaaCatalog/repository.html">repository pattern</a> at the heart of Doctrine.</p>
<p>Every Entity uses a default repository by default and offers a bunch of convenience
methods that you can use to query for instances of that Entity. Take for example
our Product entity. If we wanted to Query by name, we can use:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="nv">$product</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="s1">&#39;Product&#39;</span><span class="p">)</span>
                         <span class="o">-&gt;</span><span class="na">findOneBy</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="nv">$productName</span><span class="p">));</span>
</pre></div>
</div>
<p>The method <tt class="docutils literal"><span class="pre">findOneBy()</span></tt> takes an array of fields or association keys and the values to match against.</p>
<p>If you want to find all entities matching a condition you can use <tt class="docutils literal"><span class="pre">findBy()</span></tt>, for
example querying for all closed bugs:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="nv">$bugs</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="s1">&#39;Bug&#39;</span><span class="p">)</span>
                      <span class="o">-&gt;</span><span class="na">findBy</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;status&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;CLOSED&#39;</span><span class="p">));</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$bugs</span> <span class="k">AS</span> <span class="nv">$bug</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// do stuff</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Compared to DQL these query methods are falling short of functionality very fast.
Doctrine offers you a convenient way to extend the functionalities of the default <tt class="docutils literal"><span class="pre">EntityRepository</span></tt>
and put all the specialized DQL query logic on it. For this you have to create a subclass
of <tt class="docutils literal"><span class="pre">Doctrine\ORM\EntityRepository</span></tt>, in our case a <tt class="docutils literal"><span class="pre">BugRepository</span></tt> and group all
the previously discussed query functionality in it:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// src/BugRepository.php</span>

<span class="k">use</span> <span class="nx">Doctrine\ORM\EntityRepository</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">BugRepository</span> <span class="k">extends</span> <span class="nx">EntityRepository</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getRecentBugs</span><span class="p">(</span><span class="nv">$number</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$dql</span> <span class="o">=</span> <span class="s2">&quot;SELECT b, e, r FROM Bug b JOIN b.engineer e JOIN b.reporter r ORDER BY b.created DESC&quot;</span><span class="p">;</span>

        <span class="nv">$query</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getEntityManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">createQuery</span><span class="p">(</span><span class="nv">$dql</span><span class="p">);</span>
        <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">setMaxResults</span><span class="p">(</span><span class="nv">$number</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">getResult</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getRecentBugsArray</span><span class="p">(</span><span class="nv">$number</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$dql</span> <span class="o">=</span> <span class="s2">&quot;SELECT b, e, r, p FROM Bug b JOIN b.engineer e &quot;</span><span class="o">.</span>
               <span class="s2">&quot;JOIN b.reporter r JOIN b.products p ORDER BY b.created DESC&quot;</span><span class="p">;</span>
        <span class="nv">$query</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getEntityManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">createQuery</span><span class="p">(</span><span class="nv">$dql</span><span class="p">);</span>
        <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">setMaxResults</span><span class="p">(</span><span class="nv">$number</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">getArrayResult</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getUsersBugs</span><span class="p">(</span><span class="nv">$userId</span><span class="p">,</span> <span class="nv">$number</span> <span class="o">=</span> <span class="mi">15</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$dql</span> <span class="o">=</span> <span class="s2">&quot;SELECT b, e, r FROM Bug b JOIN b.engineer e JOIN b.reporter r &quot;</span><span class="o">.</span>
               <span class="s2">&quot;WHERE b.status = &#39;OPEN&#39; AND e.id = ?1 OR r.id = ?1 ORDER BY b.created DESC&quot;</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getEntityManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">createQuery</span><span class="p">(</span><span class="nv">$dql</span><span class="p">)</span>
                             <span class="o">-&gt;</span><span class="na">setParameter</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$userId</span><span class="p">)</span>
                             <span class="o">-&gt;</span><span class="na">setMaxResults</span><span class="p">(</span><span class="nv">$number</span><span class="p">)</span>
                             <span class="o">-&gt;</span><span class="na">getResult</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getOpenBugsByProduct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$dql</span> <span class="o">=</span> <span class="s2">&quot;SELECT p.id, p.name, count(b.id) AS openBugs FROM Bug b &quot;</span><span class="o">.</span>
               <span class="s2">&quot;JOIN b.products p WHERE b.status = &#39;OPEN&#39; GROUP BY p.id&quot;</span><span class="p">;</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getEntityManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">createQuery</span><span class="p">(</span><span class="nv">$dql</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getScalarResult</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Don&#8217;t forget to add a <cite>require_once</cite> call for this class to the bootstrap.php</p>
<p>To be able to use this query logic through <tt class="docutils literal"><span class="pre">$this-&gt;getEntityManager()-&gt;getRepository('Bug')</span></tt>
we have to adjust the metadata slightly.</p>
<div class="configuration-block">
<ul class="simple">
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="sd">/**</span>
<span class="sd"> * @Entity(repositoryClass=&quot;BugRepository&quot;)</span>
<span class="sd"> * @Table(name=&quot;bugs&quot;)</span>
<span class="sd"> **/</span>
<span class="k">class</span> <span class="nc">Bug</span>
<span class="p">{</span>
    <span class="c1">//...</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;doctrine-mapping</span> <span class="na">xmlns=</span><span class="s">&quot;http://doctrine-project.org/schemas/orm/doctrine-mapping&quot;</span>
      <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
      <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://doctrine-project.org/schemas/orm/doctrine-mapping</span>
<span class="s">                    http://raw.github.com/doctrine/doctrine2/master/doctrine-mapping.xsd&quot;</span><span class="nt">&gt;</span>

      <span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">&quot;Bug&quot;</span> <span class="na">table=</span><span class="s">&quot;bugs&quot;</span> <span class="na">repository-class=</span><span class="s">&quot;BugRepository&quot;</span><span class="nt">&gt;</span>

      <span class="nt">&lt;/entity&gt;</span>
<span class="nt">&lt;/doctrine-mapping&gt;</span>
</pre></div>
</div>
</li>
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">Bug</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">entity</span>
  <span class="l-Scalar-Plain">repositoryClass</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">BugRepository</span>
</pre></div>
</div>
</li>
</ul>
</div>
<p>Now we can remove our query logic in all the places and instead use them through the EntityRepository.
As an example here is the code of the first use case &#8220;List of Bugs&#8221;:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// list_bugs_repository.php</span>
<span class="k">require_once</span> <span class="s2">&quot;bootstrap.php&quot;</span><span class="p">;</span>

<span class="nv">$bugs</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="s1">&#39;Bug&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getRecentBugs</span><span class="p">();</span>

<span class="k">foreach</span><span class="p">(</span><span class="nv">$bugs</span> <span class="k">AS</span> <span class="nv">$bug</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">getDescription</span><span class="p">()</span><span class="o">.</span><span class="s2">&quot; - &quot;</span><span class="o">.</span><span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">getCreated</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">format</span><span class="p">(</span><span class="s1">&#39;d.m.Y&#39;</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s2">&quot;    Reported by: &quot;</span><span class="o">.</span><span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">getReporter</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">()</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s2">&quot;    Assigned to: &quot;</span><span class="o">.</span><span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">getEngineer</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">()</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">foreach</span><span class="p">(</span><span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">getProducts</span><span class="p">()</span> <span class="k">AS</span> <span class="nv">$product</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">&quot;    Platform: &quot;</span><span class="o">.</span><span class="nv">$product</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">()</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">echo</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Using EntityRepositories you can avoid coupling your model with specific query logic.
You can also re-use query logic easily throughout your application.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h2>
<p>This tutorial is over here, I hope you had fun. Additional content
will be added to this tutorial incrementally, topics will include:</p>
<ul class="simple">
<li>More on Association Mappings</li>
<li>Lifecycle Events triggered in the UnitOfWork</li>
<li>Ordering of Collections</li>
</ul>
<p>Additional details on all the topics discussed here can be found in
the respective manual chapters.</p>
</div>
</div>


              </div>
                </div>

            </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">



             
            <div id="searchbox" style="">
              <h3>Search</h3>
                <form class="search" action="http://readthedocs.org/search/project/" method="get">
                  <input type="text" name="q" size="18">
                  <input type="submit" value="Go">
                  <input type="hidden" name="selected_facets" value="project:Doctrine ORM">
                </form>
            </div>
            <h3><a href="../index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">Getting Started with Doctrine</a><ul>
<li><a class="reference internal" href="#guide-assumptions">Guide Assumptions</a></li>
<li><a class="reference internal" href="#what-is-doctrine">What is Doctrine?</a><ul>
<li><a class="reference internal" href="#what-are-entities">What are Entities?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#an-example-model-bug-tracker">An Example Model: Bug Tracker</a></li>
<li><a class="reference internal" href="#setup-project">Setup Project</a></li>
<li><a class="reference internal" href="#obtaining-the-entitymanager">Obtaining the EntityManager</a></li>
<li><a class="reference internal" href="#generating-the-database-schema">Generating the Database Schema</a></li>
<li><a class="reference internal" href="#starting-with-the-product">Starting with the Product</a></li>
<li><a class="reference internal" href="#adding-bug-and-user-entities">Adding Bug and User Entities</a></li>
<li><a class="reference internal" href="#implementing-more-requirements">Implementing more Requirements</a></li>
<li><a class="reference internal" href="#queries-for-application-use-cases">Queries for Application Use-Cases</a><ul>
<li><a class="reference internal" href="#list-of-bugs">List of Bugs</a></li>
<li><a class="reference internal" href="#array-hydration-of-the-bug-list">Array Hydration of the Bug List</a></li>
<li><a class="reference internal" href="#find-by-primary-key">Find by Primary Key</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dashboard-of-the-user">Dashboard of the User</a></li>
<li><a class="reference internal" href="#number-of-bugs">Number of Bugs</a></li>
<li><a class="reference internal" href="#updating-entities">Updating Entities</a></li>
<li><a class="reference internal" href="#entity-repositories">Entity Repositories</a></li>
<li><a class="reference internal" href="#conclusion">Conclusion</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="../index.html"
                                  title="previous chapter">Welcome to Doctrine 2 ORM&#8217;s documentation!</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="getting-started-database.html"
                                  title="next chapter">Getting Started: Database First</a></p>
  
    <h3>This Page</h3>
    <ul class="this-page-menu">
      
        <li><a href="../_sources/tutorials/getting-started.txt"
               rel="nofollow">Show Source</a></li>
      
      
        <li><a href="https://github.com/doctrine/doctrine2/blob/master/docs/en/tutorials/getting-started.rst">
          Show on GitHub</a></li>
        <li><a href="https://github.com/doctrine/doctrine2/edit/master/docs/en/tutorials/getting-started.rst">
          Edit on GitHub</a></li>
      
    </ul>
  

        </div>
      </div>
          <div class="clearer"></div>
        </div>

          <div class="footer">
              &copy; Copyright 2010-12, Doctrine Project Team.
              Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
            <br/>
            <a target="_BLANK" href="http://www.servergrove.com"><img src="http://www.doctrine-project.org/images/servergrove.jpg" /></a>      <br/><br/>
            <form action="https://www.paypal.com/cgi-bin/webscr" method="post">
              <input type="hidden" name="cmd" value="_s-xclick" />
              <input type="hidden" name="hosted_button_id" value="BAE2E3XANQ77Y" />
              <input type="image" src="https://www.paypal.com/en_US/i/btn/btn_donateCC_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!" />
              <img alt="" border="0" src="https://www.paypal.com/en_US/i/scr/pixel.gif" width="1" height="1" />
            </form>
          </div>
 <!-- End original user content -->


<br/>
<br/>
<br/>


<style type="text/css">
  #version_menu, .rtd-badge.rtd {
    -webkit-transition: all 0.25s 0.75s;
    transition: all 0.25s 0.75s;
  }
  .footer_popout:hover #version_menu, .footer_popout:hover .rtd-badge.rtd {
    -webkit-transition: all 0.25s 0s;
    transition: all 0.25s 0s;
  }
  .rtd-badge {
    position: fixed;
    display: block;
    bottom: 5px;
    height: 40px;
    text-indent: -9999em;
    border-radius: 3px;
    -moz-border-radius: 3px;
    -webkit-border-radius: 3px;
    box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 1px 0 rgba(255, 255, 255, 0.2) inset;
    -moz-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 1px 0 rgba(255, 255, 255, 0.2) inset;
    -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 1px 0 rgba(255, 255, 255, 0.2) inset;
  }
  #version_menu {
    position: fixed;
    visibility: hidden;
    opacity: 0;
    bottom: 11px;
    right: 47px;
    list-style-type: none;
    margin: 0;
  }
  .footer_popout:hover #version_menu {
    visibility: visible;
    opacity: 1;
    right: 166px;
  }
  #version_menu li {
    display: block;
    float: right;
  }
  #version_menu li a {
    display: block;
    padding: 6px 10px 4px 10px;
    margin: 7px 7px 0 0;
    font-weight: bold;
    font-size: 14px;
    height: 20px;
    line-height: 17px;
    text-decoration: none;
    color: #fff;
    background: #8ca1af url(//media.readthedocs.org//images/gradient-light.png) bottom left repeat-x;
    border-radius: 3px;
    -moz-border-radius: 3px;
    -webkit-border-radius: 3px;
    box-shadow: 0 1px 1px #465158;
    -moz-box-shadow: 0 1px 1px #465158;
    -webkit-box-shadow: 0 1px 1px #465158;
    text-shadow: 0 1px 1px rgba(0, 0, 0, 0.5);
  }
  #version_menu li a:hover {
    text-decoration: none;
    background-color: #697983;
    box-shadow: 0 1px 0px #465158;
    -moz-box-shadow: 0 1px 0px #465158;
    -webkit-box-shadow: 0 1px 0px #465158;
  }
  .rtd-badge.rtd {
    background: #3b4449 url(//media.readthedocs.org//images/badge-rtd.png) scroll top left no-repeat;
    border: 1px solid #282E32;
    width: 41px;
    right: 5px;
  }
  .footer_popout:hover .rtd-badge.rtd {
    width: 160px;
  }
  .rtd-badge.revsys { background: #465158 url(//media.readthedocs.org//images/badge-revsys.png) top left no-repeat;
    border: 1px solid #1C5871;
    width: 290px;
    right: 173px;
  }
  .rtd-badge.revsys-inline-sponsored {
    position: inherit;
    margin-left: auto;
    margin-right: 175px;
    margin-bottom: 5px;
    background: #465158 url(//media.readthedocs.org//images/badge-revsys.png) top left no-repeat;
    border: 1px solid #1C5871;
    width: 290px;
    right: 173px;
  }
  .rtd-badge.revsys-inline {
    position: inherit;
    margin-left: auto;
    margin-right: 175px;
    margin-bottom: 5px;
    background: #465158 url(//media.readthedocs.org//images/badge-revsys-sm.png) top left no-repeat;
    border: 1px solid #1C5871;
    width: 205px;
    right: 173px;
  }

</style>
<div class="rtd_doc_footer">
  <div class="footer_popout">
    <a href="//readthedocs.org/projects/doctrine-orm/?fromdocs=doctrine-orm" class="rtd-badge rtd"> Brought to you by Read the Docs</a>
    <ul id="version_menu">
      
        <li><a href="/en/latest/">latest</a></li>
      
    </ul>
  </div>
</div>
<!-- RTD Analytics Code -->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-17997319-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>




      </div>

      <div id="bot-rcnr">
        <div class="tl"><!-- corner --></div>
      </div>
    </div>

  <script src="http://www.google-analytics.com/urchin.js" type="text/javascript">
  </script>
  <script type="text/javascript">
  _uacct = "UA-288343-7";
  urchinTracker();
  </script>
  <a class="githublink" href="http://github.com/doctrine"><img src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png" alt="Fork me on GitHub"></a>
  </body>
</html>