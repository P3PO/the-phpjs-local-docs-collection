

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>1   Introduction &mdash; Varnish Book 3.0 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '3.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Varnish Book 3.0 documentation" href="#" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="#">Varnish Book 3.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <img alt="_images/dummy.png" src="_images/dummy.png" style="width: 1px; height: 1px;" />
<img alt="_images/dummy.png" src="_images/dummy.png" style="width: 1px; height: 1px;" />
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Authors:</th><td class="field-body">Tollef Fog Heen (<a class="reference external" href="http://www.varnish-software.com/">Varnish Software</a>),
Kristian Lyngstøl (<a class="reference external" href="http://www.varnish-software.com/">Varnish Software</a>),
Jérôme Renard (<a class="reference external" href="http://39web.fr/">39Web</a>)</td>
</tr>
<tr class="field-even field"><th class="field-name">Copyright:</th><td class="field-body">Varnish Software AS 2010-2013, Redpill Linpro AS 2008-2009</td>
</tr>
<tr class="field-odd field"><th class="field-name">Versions:</th><td class="field-body">Documentation version-4.7-59-g7a1d021 / Tested for Varnish ./util/version.sh: linha 9: varnishstat: comando não encontrado</td>
</tr>
<tr class="field-even field"><th class="field-name">Date:</th><td class="field-body">2013-10-09</td>
</tr>
<tr class="field-odd field"><th class="field-name">License:</th><td class="field-body">The material is available under a CC-BY-NC-SA license. See
<a class="reference external" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">http://creativecommons.org/licenses/by-nc-sa/3.0/</a> for the full
license. For questions regarding what we mean by non-commercial,
please contact <a class="reference external" href="mailto:training&#37;&#52;&#48;varnish-software&#46;com">training<span>&#64;</span>varnish-software<span>&#46;</span>com</a>.</td>
</tr>
<tr class="field-even field"><th class="field-name">Contact:</th><td class="field-body">For any questions regarding this training material, please
contact <a class="reference external" href="mailto:training&#37;&#52;&#48;varnish-software&#46;com">training<span>&#64;</span>varnish-software<span>&#46;</span>com</a>.</td>
</tr>
<tr class="field-odd field"><th class="field-name">Web:</th><td class="field-body"><a class="reference external" href="http://www.varnish-software.com/book/">http://www.varnish-software.com/book/</a></td>
</tr>
<tr class="field-even field"><th class="field-name">Source:</th><td class="field-body"><a class="reference external" href="http://github.com/varnish/Varnish-Book/">http://github.com/varnish/Varnish-Book/</a></td>
</tr>
</tbody>
</table>
<div class="contents handout topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="auto-toc simple">
<li><a class="reference internal" href="#introduction" id="id2">1&nbsp;&nbsp;&nbsp;Introduction</a><ul class="auto-toc">
<li><a class="reference internal" href="#about-the-course" id="id3">1.1&nbsp;&nbsp;&nbsp;About the course</a></li>
<li><a class="reference internal" href="#goals-and-prerequisites" id="id4">1.2&nbsp;&nbsp;&nbsp;Goals and Prerequisites</a></li>
<li><a class="reference internal" href="#introduction-to-varnish" id="id5">1.3&nbsp;&nbsp;&nbsp;Introduction to Varnish</a></li>
<li><a class="reference internal" href="#design-principles" id="id6">1.4&nbsp;&nbsp;&nbsp;Design principles</a></li>
<li><a class="reference internal" href="#how-objects-are-stored" id="id7">1.5&nbsp;&nbsp;&nbsp;How objects are stored</a></li>
</ul>
</li>
<li><a class="reference internal" href="#getting-started" id="id8">2&nbsp;&nbsp;&nbsp;Getting started</a><ul class="auto-toc">
<li><a class="reference internal" href="#configuration" id="id9">2.1&nbsp;&nbsp;&nbsp;Configuration</a></li>
<li><a class="reference internal" href="#command-line-configuration" id="id10">2.2&nbsp;&nbsp;&nbsp;Command line configuration</a></li>
<li><a class="reference internal" href="#configuration-files" id="id11">2.3&nbsp;&nbsp;&nbsp;Configuration files</a></li>
<li><a class="reference internal" href="#defining-a-backend-in-vcl" id="id12">2.4&nbsp;&nbsp;&nbsp;Defining a backend in VCL</a></li>
<li><a class="reference internal" href="#exercise-installation" id="id13">2.5&nbsp;&nbsp;&nbsp;Exercise: Installation</a></li>
<li><a class="reference internal" href="#exercise-fetch-data-through-varnish" id="id14">2.6&nbsp;&nbsp;&nbsp;Exercise: Fetch data through Varnish</a></li>
<li><a class="reference internal" href="#log-data" id="id15">2.7&nbsp;&nbsp;&nbsp;Log data</a></li>
<li><a class="reference internal" href="#varnishlog" id="id16">2.8&nbsp;&nbsp;&nbsp;varnishlog</a></li>
<li><a class="reference internal" href="#varnishlog-tag-examples" id="id17">2.9&nbsp;&nbsp;&nbsp;Varnishlog tag examples</a></li>
<li><a class="reference internal" href="#varnishlog-options" id="id18">2.10&nbsp;&nbsp;&nbsp;varnishlog options</a></li>
<li><a class="reference internal" href="#varnishstat" id="id19">2.11&nbsp;&nbsp;&nbsp;varnishstat</a></li>
<li><a class="reference internal" href="#the-management-interface" id="id20">2.12&nbsp;&nbsp;&nbsp;The management interface</a></li>
<li><a class="reference internal" href="#exercise-try-out-the-tools" id="id21">2.13&nbsp;&nbsp;&nbsp;Exercise: Try out the tools</a></li>
</ul>
</li>
<li><a class="reference internal" href="#tuning" id="id22">3&nbsp;&nbsp;&nbsp;Tuning</a><ul class="auto-toc">
<li><a class="reference internal" href="#process-architecture" id="id23">3.1&nbsp;&nbsp;&nbsp;Process Architecture</a><ul class="auto-toc">
<li><a class="reference internal" href="#the-management-process" id="id24">3.1.1&nbsp;&nbsp;&nbsp;The management process</a></li>
<li><a class="reference internal" href="#the-child-process" id="id25">3.1.2&nbsp;&nbsp;&nbsp;The child process</a></li>
<li><a class="reference internal" href="#vcl-compilation" id="id26">3.1.3&nbsp;&nbsp;&nbsp;VCL compilation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#storage-backends" id="id27">3.2&nbsp;&nbsp;&nbsp;Storage backends</a></li>
<li><a class="reference internal" href="#the-shared-memory-log" id="id28">3.3&nbsp;&nbsp;&nbsp;The shared memory log</a></li>
<li><a class="reference internal" href="#tunable-parameters" id="id29">3.4&nbsp;&nbsp;&nbsp;Tunable parameters</a></li>
<li><a class="reference internal" href="#threading-model" id="id30">3.5&nbsp;&nbsp;&nbsp;Threading model</a></li>
<li><a class="reference internal" href="#threading-parameters" id="id31">3.6&nbsp;&nbsp;&nbsp;Threading parameters</a><ul class="auto-toc">
<li><a class="reference internal" href="#details-of-threading-parameters" id="id32">3.6.1&nbsp;&nbsp;&nbsp;Details of threading parameters</a></li>
<li><a class="reference internal" href="#number-of-threads" id="id33">3.6.2&nbsp;&nbsp;&nbsp;Number of threads</a></li>
<li><a class="reference internal" href="#timing-thread-growth" id="id34">3.6.3&nbsp;&nbsp;&nbsp;Timing thread growth</a></li>
</ul>
</li>
<li><a class="reference internal" href="#system-parameters" id="id35">3.7&nbsp;&nbsp;&nbsp;System parameters</a></li>
<li><a class="reference internal" href="#timers" id="id36">3.8&nbsp;&nbsp;&nbsp;Timers</a></li>
<li><a class="reference internal" href="#exercise-tune-first-byte-timeout" id="id37">3.9&nbsp;&nbsp;&nbsp;Exercise: Tune first_byte_timeout</a></li>
<li><a class="reference internal" href="#exercise-configure-threading" id="id38">3.10&nbsp;&nbsp;&nbsp;Exercise: Configure threading</a></li>
</ul>
</li>
<li><a class="reference internal" href="#http" id="id39">4&nbsp;&nbsp;&nbsp;HTTP</a><ul class="auto-toc">
<li><a class="reference internal" href="#protocol-basics" id="id40">4.1&nbsp;&nbsp;&nbsp;Protocol basics</a></li>
<li><a class="reference internal" href="#requests" id="id41">4.2&nbsp;&nbsp;&nbsp;Requests</a></li>
<li><a class="reference internal" href="#request-example" id="id42">4.3&nbsp;&nbsp;&nbsp;Request example</a></li>
<li><a class="reference internal" href="#response" id="id43">4.4&nbsp;&nbsp;&nbsp;Response</a></li>
<li><a class="reference internal" href="#response-example" id="id44">4.5&nbsp;&nbsp;&nbsp;Response example</a></li>
<li><a class="reference internal" href="#http-request-response-control-flow" id="id45">4.6&nbsp;&nbsp;&nbsp;HTTP request/response control flow</a></li>
<li><a class="reference internal" href="#statelesness-and-idempotence" id="id46">4.7&nbsp;&nbsp;&nbsp;Statelesness and idempotence</a></li>
<li><a class="reference internal" href="#cache-related-headers" id="id47">4.8&nbsp;&nbsp;&nbsp;Cache related headers</a></li>
<li><a class="reference internal" href="#exercise-test-various-cache-headers" id="id48">4.9&nbsp;&nbsp;&nbsp;Exercise : Test various Cache headers</a></li>
<li><a class="reference internal" href="#expires" id="id49">4.10&nbsp;&nbsp;&nbsp;Expires</a></li>
<li><a class="reference internal" href="#cache-control" id="id50">4.11&nbsp;&nbsp;&nbsp;Cache-Control</a></li>
<li><a class="reference internal" href="#last-modified" id="id51">4.12&nbsp;&nbsp;&nbsp;Last-Modified</a></li>
<li><a class="reference internal" href="#if-modified-since" id="id52">4.13&nbsp;&nbsp;&nbsp;If-Modified-Since</a></li>
<li><a class="reference internal" href="#if-none-match" id="id53">4.14&nbsp;&nbsp;&nbsp;If-None-Match</a></li>
<li><a class="reference internal" href="#etag" id="id54">4.15&nbsp;&nbsp;&nbsp;Etag</a></li>
<li><a class="reference internal" href="#pragma" id="id55">4.16&nbsp;&nbsp;&nbsp;Pragma</a></li>
<li><a class="reference internal" href="#vary" id="id56">4.17&nbsp;&nbsp;&nbsp;Vary</a></li>
<li><a class="reference internal" href="#age" id="id57">4.18&nbsp;&nbsp;&nbsp;Age</a></li>
<li><a class="reference internal" href="#header-availability-summary" id="id58">4.19&nbsp;&nbsp;&nbsp;Header availability summary</a></li>
<li><a class="reference internal" href="#cache-hit-and-misses" id="id59">4.20&nbsp;&nbsp;&nbsp;Cache-hit and misses</a></li>
<li><a class="reference internal" href="#exercise-use-article-php-to-test-age" id="id60">4.21&nbsp;&nbsp;&nbsp;Exercise: Use <cite>article.php</cite> to test <cite>Age</cite></a></li>
</ul>
</li>
<li><a class="reference internal" href="#vcl-basics" id="id61">5&nbsp;&nbsp;&nbsp;VCL Basics</a><ul class="auto-toc">
<li><a class="reference internal" href="#the-vcl-state-engine" id="id62">5.1&nbsp;&nbsp;&nbsp;The VCL State Engine</a></li>
<li><a class="reference internal" href="#syntax" id="id63">5.2&nbsp;&nbsp;&nbsp;Syntax</a></li>
<li><a class="reference internal" href="#vcl-request-flow" id="id64">5.3&nbsp;&nbsp;&nbsp;VCL - request flow</a><ul class="auto-toc">
<li><a class="reference internal" href="#detailed-request-flow" id="id65">5.3.1&nbsp;&nbsp;&nbsp;Detailed request flow</a></li>
</ul>
</li>
<li><a class="reference internal" href="#vcl-functions" id="id66">5.4&nbsp;&nbsp;&nbsp;VCL - functions</a></li>
<li><a class="reference internal" href="#vcl-vcl-recv" id="id67">5.5&nbsp;&nbsp;&nbsp;VCL - <tt class="docutils literal"><span class="pre">vcl_recv</span></tt></a></li>
<li><a class="reference internal" href="#default-vcl-recv" id="id68">5.6&nbsp;&nbsp;&nbsp;Default: <tt class="docutils literal"><span class="pre">vcl_recv</span></tt></a></li>
<li><a class="reference internal" href="#example-basic-device-detection" id="id69">5.7&nbsp;&nbsp;&nbsp;Example: Basic Device Detection</a></li>
<li><a class="reference internal" href="#vcl-vcl-fetch" id="id70">5.8&nbsp;&nbsp;&nbsp;VCL - <tt class="docutils literal"><span class="pre">vcl_fetch</span></tt></a></li>
<li><a class="reference internal" href="#default-vcl-fetch" id="id71">5.9&nbsp;&nbsp;&nbsp;Default: <tt class="docutils literal"><span class="pre">vcl_fetch</span></tt></a></li>
<li><a class="reference internal" href="#the-initial-value-of-beresp-ttl" id="id72">5.10&nbsp;&nbsp;&nbsp;The initial value of <tt class="docutils literal"><span class="pre">beresp.ttl</span></tt></a></li>
<li><a class="reference internal" href="#example-enforce-caching-of-jpg-urls-for-60-seconds" id="id73">5.11&nbsp;&nbsp;&nbsp;Example: Enforce caching of .jpg urls for 60 seconds</a></li>
<li><a class="reference internal" href="#example-cache-jpg-for-60-only-if-s-maxage-isn-t-present" id="id74">5.12&nbsp;&nbsp;&nbsp;Example: Cache .jpg for 60 only if s-maxage isn&#8217;t present</a></li>
<li><a class="reference internal" href="#exercise-either-use-s-maxage-or-set-ttl-by-file-type" id="id75">5.13&nbsp;&nbsp;&nbsp;Exercise: Either use s-maxage or set ttl by file type</a></li>
<li><a class="reference internal" href="#solution-either-use-s-maxage-or-set-ttl-by-file-type" id="id76">5.14&nbsp;&nbsp;&nbsp;Solution: Either use s-maxage or set ttl by file type</a></li>
<li><a class="reference internal" href="#summary-of-vcl-part-1" id="id77">5.15&nbsp;&nbsp;&nbsp;Summary of VCL - Part 1</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id1" id="id78">6&nbsp;&nbsp;&nbsp;VCL functions</a><ul class="auto-toc">
<li><a class="reference internal" href="#variable-availability-in-vcl" id="id79">6.1&nbsp;&nbsp;&nbsp;Variable availability in VCL</a></li>
<li><a class="reference internal" href="#vcl-vcl-hash" id="id80">6.2&nbsp;&nbsp;&nbsp;VCL - <tt class="docutils literal"><span class="pre">vcl_hash</span></tt></a></li>
<li><a class="reference internal" href="#vcl-vcl-hit" id="id81">6.3&nbsp;&nbsp;&nbsp;VCL - <tt class="docutils literal"><span class="pre">vcl_hit</span></tt></a></li>
<li><a class="reference internal" href="#vcl-vcl-miss" id="id82">6.4&nbsp;&nbsp;&nbsp;VCL - <tt class="docutils literal"><span class="pre">vcl_miss</span></tt></a></li>
<li><a class="reference internal" href="#vcl-vcl-pass" id="id83">6.5&nbsp;&nbsp;&nbsp;VCl - <tt class="docutils literal"><span class="pre">vcl_pass</span></tt></a></li>
<li><a class="reference internal" href="#vcl-vcl-deliver" id="id84">6.6&nbsp;&nbsp;&nbsp;VCL - <tt class="docutils literal"><span class="pre">vcl_deliver</span></tt></a></li>
<li><a class="reference internal" href="#vcl-vcl-error" id="id85">6.7&nbsp;&nbsp;&nbsp;VCL - <tt class="docutils literal"><span class="pre">vcl_error</span></tt></a></li>
<li><a class="reference internal" href="#example-redirecting-users-with-vcl-error" id="id86">6.8&nbsp;&nbsp;&nbsp;Example: Redirecting users with <tt class="docutils literal"><span class="pre">vcl_error</span></tt></a></li>
<li><a class="reference internal" href="#exercise-modify-the-error-message-and-headers" id="id87">6.9&nbsp;&nbsp;&nbsp;Exercise: Modify the error message and headers</a></li>
<li><a class="reference internal" href="#solution-modify-the-error-message-and-headers" id="id88">6.10&nbsp;&nbsp;&nbsp;Solution: Modify the error message and headers</a></li>
</ul>
</li>
<li><a class="reference internal" href="#cache-invalidation" id="id89">7&nbsp;&nbsp;&nbsp;Cache invalidation</a><ul class="auto-toc">
<li><a class="reference internal" href="#naming-confusion" id="id90">7.1&nbsp;&nbsp;&nbsp;Naming confusion</a></li>
<li><a class="reference internal" href="#removing-a-single-object" id="id91">7.2&nbsp;&nbsp;&nbsp;Removing a single object</a></li>
<li><a class="reference internal" href="#example-purge" id="id92">7.3&nbsp;&nbsp;&nbsp;Example: <tt class="docutils literal"><span class="pre">purge;</span></tt></a></li>
<li><a class="reference internal" href="#the-lookup-that-always-misses" id="id93">7.4&nbsp;&nbsp;&nbsp;The lookup that always misses</a></li>
<li><a class="reference internal" href="#banning" id="id94">7.5&nbsp;&nbsp;&nbsp;Banning</a></li>
<li><a class="reference internal" href="#vcl-contexts-when-adding-bans" id="id95">7.6&nbsp;&nbsp;&nbsp;VCL contexts when adding bans</a></li>
<li><a class="reference internal" href="#smart-bans" id="id96">7.7&nbsp;&nbsp;&nbsp;Smart bans</a></li>
<li><a class="reference internal" href="#ban-or-purge" id="id97">7.8&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">ban()</span></tt> or <tt class="docutils literal"><span class="pre">purge;</span></tt>?</a></li>
<li><a class="reference internal" href="#exercise-write-a-vcl-for-bans-and-purges" id="id98">7.9&nbsp;&nbsp;&nbsp;Exercise: Write a VCL for bans and purges</a></li>
<li><a class="reference internal" href="#solution-write-a-vcl-for-bans-and-purges" id="id99">7.10&nbsp;&nbsp;&nbsp;Solution: Write a VCL for bans and purges</a></li>
<li><a class="reference internal" href="#exercise-purge-an-article-from-the-backend" id="id100">7.11&nbsp;&nbsp;&nbsp;Exercise : PURGE an article from the backend</a></li>
<li><a class="reference internal" href="#solution-purge-an-article-from-the-backend" id="id101">7.12&nbsp;&nbsp;&nbsp;Solution : PURGE an article from the backend</a></li>
</ul>
</li>
<li><a class="reference internal" href="#saving-a-request" id="id102">8&nbsp;&nbsp;&nbsp;Saving a request</a><ul class="auto-toc">
<li><a class="reference internal" href="#core-grace-mechanisms" id="id103">8.1&nbsp;&nbsp;&nbsp;Core grace mechanisms</a></li>
<li><a class="reference internal" href="#req-grace-and-beresp-grace" id="id104">8.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">req.grace</span></tt> and <tt class="docutils literal"><span class="pre">beresp.grace</span></tt></a></li>
<li><a class="reference internal" href="#when-can-grace-happen" id="id105">8.3&nbsp;&nbsp;&nbsp;When can grace happen</a></li>
<li><a class="reference internal" href="#exercise-grace" id="id106">8.4&nbsp;&nbsp;&nbsp;Exercise: Grace</a></li>
<li><a class="reference internal" href="#health-checks" id="id107">8.5&nbsp;&nbsp;&nbsp;Health checks</a></li>
<li><a class="reference internal" href="#health-checks-and-grace" id="id108">8.6&nbsp;&nbsp;&nbsp;Health checks and grace</a></li>
<li><a class="reference internal" href="#directors" id="id109">8.7&nbsp;&nbsp;&nbsp;Directors</a><ul class="auto-toc">
<li><a class="reference internal" href="#client-and-hash-directors" id="id110">8.7.1&nbsp;&nbsp;&nbsp;Client and hash directors</a></li>
<li><a class="reference internal" href="#the-dns-director" id="id111">8.7.2&nbsp;&nbsp;&nbsp;The DNS director</a></li>
</ul>
</li>
<li><a class="reference internal" href="#demo-health-probes-and-grace" id="id112">8.8&nbsp;&nbsp;&nbsp;Demo: Health probes and grace</a></li>
<li><a class="reference internal" href="#saint-mode" id="id113">8.9&nbsp;&nbsp;&nbsp;Saint mode</a></li>
<li><a class="reference internal" href="#restart-in-vcl" id="id114">8.10&nbsp;&nbsp;&nbsp;Restart in VCL</a></li>
<li><a class="reference internal" href="#backend-properties" id="id115">8.11&nbsp;&nbsp;&nbsp;Backend properties</a></li>
<li><a class="reference internal" href="#example-evil-backend-hack" id="id116">8.12&nbsp;&nbsp;&nbsp;Example: Evil backend hack</a></li>
<li><a class="reference internal" href="#access-control-lists" id="id117">8.13&nbsp;&nbsp;&nbsp;Access Control Lists</a></li>
<li><a class="reference internal" href="#exercise-combine-purge-and-restart" id="id118">8.14&nbsp;&nbsp;&nbsp;Exercise: Combine PURGE and restart</a></li>
<li><a class="reference internal" href="#solution-combine-purge-and-restart" id="id119">8.15&nbsp;&nbsp;&nbsp;Solution: Combine PURGE and restart</a></li>
</ul>
</li>
<li><a class="reference internal" href="#content-composition" id="id120">9&nbsp;&nbsp;&nbsp;Content Composition</a><ul class="auto-toc">
<li><a class="reference internal" href="#a-typical-site" id="id121">9.1&nbsp;&nbsp;&nbsp;A typical site</a></li>
<li><a class="reference internal" href="#cookies" id="id122">9.2&nbsp;&nbsp;&nbsp;Cookies</a></li>
<li><a class="reference internal" href="#vary-and-cookies" id="id123">9.3&nbsp;&nbsp;&nbsp;Vary and Cookies</a></li>
<li><a class="reference internal" href="#best-practices-for-cookies" id="id124">9.4&nbsp;&nbsp;&nbsp;Best practices for cookies</a></li>
<li><a class="reference internal" href="#exercise-compare-vary-and-hash-data" id="id125">9.5&nbsp;&nbsp;&nbsp;Exercise: Compare Vary and <tt class="docutils literal"><span class="pre">hash_data</span></tt></a></li>
<li><a class="reference internal" href="#edge-side-includes" id="id126">9.6&nbsp;&nbsp;&nbsp;Edge Side Includes</a></li>
<li><a class="reference internal" href="#basic-esi-usage" id="id127">9.7&nbsp;&nbsp;&nbsp;Basic ESI usage</a></li>
<li><a class="reference internal" href="#exercise-enable-esi-and-cookies" id="id128">9.8&nbsp;&nbsp;&nbsp;Exercise: Enable ESI and Cookies</a></li>
<li><a class="reference internal" href="#testing-esi-without-varnish" id="id129">9.9&nbsp;&nbsp;&nbsp;Testing ESI without Varnish</a></li>
<li><a class="reference internal" href="#masquerading-ajax-requests" id="id130">9.10&nbsp;&nbsp;&nbsp;Masquerading AJAX requests</a></li>
<li><a class="reference internal" href="#exercise-write-a-vcl-that-masquerades-xhr-calls" id="id131">9.11&nbsp;&nbsp;&nbsp;Exercise : write a VCL that masquerades XHR calls</a></li>
<li><a class="reference internal" href="#solution-write-a-vcl-that-masquerades-xhr-calls" id="id132">9.12&nbsp;&nbsp;&nbsp;Solution : write a VCL that masquerades XHR calls</a></li>
</ul>
</li>
<li><a class="reference internal" href="#finishing-words" id="id133">10&nbsp;&nbsp;&nbsp;Finishing words</a><ul class="auto-toc">
<li><a class="reference internal" href="#varnish-2-1-to-3-0" id="id134">10.1&nbsp;&nbsp;&nbsp;Varnish 2.1 to 3.0</a></li>
<li><a class="reference internal" href="#resources" id="id135">10.2&nbsp;&nbsp;&nbsp;Resources</a></li>
</ul>
</li>
<li><a class="reference internal" href="#appendix-a-varnish-programs" id="id136">11&nbsp;&nbsp;&nbsp;Appendix A: Varnish Programs</a><ul class="auto-toc">
<li><a class="reference internal" href="#varnishtop" id="id137">11.1&nbsp;&nbsp;&nbsp;varnishtop</a></li>
<li><a class="reference internal" href="#varnishncsa" id="id138">11.2&nbsp;&nbsp;&nbsp;varnishncsa</a></li>
<li><a class="reference internal" href="#varnishhist" id="id139">11.3&nbsp;&nbsp;&nbsp;varnishhist</a></li>
<li><a class="reference internal" href="#exercise-try-the-tools" id="id140">11.4&nbsp;&nbsp;&nbsp;Exercise: Try the tools</a></li>
</ul>
</li>
<li><a class="reference internal" href="#appendix-b-extra-material" id="id141">12&nbsp;&nbsp;&nbsp;Appendix B: Extra Material</a><ul class="auto-toc">
<li><a class="reference internal" href="#ajax-html" id="id142">12.1&nbsp;&nbsp;&nbsp;ajax.html</a></li>
<li><a class="reference internal" href="#article-php" id="id143">12.2&nbsp;&nbsp;&nbsp;article.php</a></li>
<li><a class="reference internal" href="#cookies-php" id="id144">12.3&nbsp;&nbsp;&nbsp;cookies.php</a></li>
<li><a class="reference internal" href="#esi-top-php" id="id145">12.4&nbsp;&nbsp;&nbsp;esi-top.php</a></li>
<li><a class="reference internal" href="#esi-user-php" id="id146">12.5&nbsp;&nbsp;&nbsp;esi-user.php</a></li>
<li><a class="reference internal" href="#httpheadersexample-php" id="id147">12.6&nbsp;&nbsp;&nbsp;httpheadersexample.php</a></li>
<li><a class="reference internal" href="#purgearticle-php" id="id148">12.7&nbsp;&nbsp;&nbsp;purgearticle.php</a></li>
<li><a class="reference internal" href="#test-php" id="id149">12.8&nbsp;&nbsp;&nbsp;test.php</a></li>
<li><a class="reference internal" href="#set-cookie-php" id="id150">12.9&nbsp;&nbsp;&nbsp;set-cookie.php</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="introduction">
<h1><a class="toc-backref" href="#id2">1&nbsp;&nbsp;&nbsp;Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li>About the course</li>
<li>Goals and prerequisites</li>
<li>Introduction to Varnish</li>
<li>History</li>
<li>Design Principles</li>
</ul>
<div class="section" id="about-the-course">
<h2><a class="toc-backref" href="#id3">1.1&nbsp;&nbsp;&nbsp;About the course</a><a class="headerlink" href="#about-the-course" title="Permalink to this headline">¶</a></h2>
<p>The course is split in two:</p>
<ol class="arabic simple">
<li>Architecture, command line tools, installation, parameters, etc</li>
<li>The Varnish Configuration Language</li>
</ol>
<p>The course has roughly 50% exercises and 50% instruction, and you will find
all the information on the slides in the supplied training material.</p>
<p>The supplied training material also has additional information for most
chapters.</p>
<p>The Varnish Book includes the material for both the <cite>Varnish System
Administration</cite> course and the <cite>Varnish for Web developers</cite> course.</p>
<div class="handout container">
<p>The agenda is adjusted based on the progress made. There is usually
ample time to investigate specific aspects of Varnish that may be of
special interest to some of the participants.</p>
<p>The exercises will occasionally offer multiple means to reach the same
goals. Specially when you start working on VCL, you will notice that
there are almost always more than one way to solve a specific problem,
and it isn&#8217;t necessarily given that the solution offered by the
instructor or this course material is better than what you might come up
with yourself.</p>
<p>Always feel free to interrupt the instructor if something is unclear.</p>
</div>
</div>
<div class="section" id="goals-and-prerequisites">
<h2><a class="toc-backref" href="#id4">1.2&nbsp;&nbsp;&nbsp;Goals and Prerequisites</a><a class="headerlink" href="#goals-and-prerequisites" title="Permalink to this headline">¶</a></h2>
<p>Prerequisites:</p>
<ul class="simple">
<li>Comfortable working in a shell on a Linux/UNIX machine, including editing
text files and starting daemons.</li>
<li>Basic understanding of HTTP and related internet protocols</li>
</ul>
<p>Goals:</p>
<ul class="simple">
<li>Thorough understanding of Varnish</li>
<li>Understanding of how VCL works and how to use it</li>
</ul>
<div class="handout container">
<p>The course is oriented around a GNU/Linux server-platform, but the
majority of the tasks only require minimal knowledge of GNU/Linux.</p>
<p>The course starts out by installing Varnish and navigating some of the
common configuration files, which is perhaps the most UNIX-centric part
of the course. Do not hesitate to ask for help.</p>
<p>The goal of the course is to make you confident when using Varnish and
let you adjust Varnish to your exact needs. If you have any specific
area you are particularly interested in, the course is usually flexible
enough to make room for it.</p>
</div>
</div>
<div class="section" id="introduction-to-varnish">
<h2><a class="toc-backref" href="#id5">1.3&nbsp;&nbsp;&nbsp;Introduction to Varnish</a><a class="headerlink" href="#introduction-to-varnish" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>What is Varnish?</li>
<li>Open Source / Free Software</li>
<li>History</li>
<li>Varnish Governance Board (VGB)</li>
</ul>
<div class="handout container">
<p>Varnish is a reverse HTTP proxy, sometimes referred to as a HTTP
accelerator or a web accelerator.  It stores files or fragments of
files in memory, allowing them to be served quickly. It is
essentially a key/value store, that usually uses the URL as a
key. It is designed for modern hardware, modern operating systems
and modern work loads.</p>
<p>At the same time, Varnish is flexible. The Varnish Configuration
Language is lightning fast and allows the administrator to express their
wanted policy rather than being constrained by what the Varnish
developers want to cater for or could think of. Varnish has shown itself
to work well both on large (and expensive) servers and tiny appliances.</p>
<p>Varnish is also an open source project, and free software. The
development process is public and everyone can submit patches, or just
take a peek at the code if there is some uncertainty as to how Varnish
works. There is a community of volunteers who help each other and
newcomers. The BSD-like license used by Varnish does not place
significant restriction on re-use of the code, which makes it possible
to integrate Varnish in virtually any solution.</p>
<p>Varnish is developed and tested on GNU/Linux and FreeBSD. The code-base
is kept as self-contained as possible to avoid introducing out-side bugs
and unneeded complexity. As a consequence of this, Varnish uses very few
external libraries.</p>
<p>Varnish development is governed by the Varnish Governance Board (VGB),
which thus far has not needed to intervene. The VGB consists of an
architect, a community representative and a representative from Varnish
Software. As of March 2012, the positions are filled by Poul-Henning
Kamp (Architect), Rogier Mulhuijzen (Community) and Kristian Lyngstøl
(Varnish Software). On a day-to-day basis, there is little need to
interfere with the general flow of development.</p>
<p>For those interested in development, the developers arrange weekly bug
washes were recent tickets and development is discussed. This usually
takes place on Mondays around 12:00 CET on the IRC channel
<cite>#varnish-hacking</cite> on <cite>irc.linpro.net</cite>.</p>
</div>
</div>
<div class="section" id="design-principles">
<h2><a class="toc-backref" href="#id6">1.4&nbsp;&nbsp;&nbsp;Design principles</a><a class="headerlink" href="#design-principles" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Solve real problems</li>
<li>Optimize for modern hardware (64-bit, multi-core, etc)</li>
<li>Work with the kernel, not against it</li>
<li>Innovation, not regurgitation</li>
</ul>
<div class="handout container">
<p>The focus of Varnish has always been performance and flexibility.
That has required some sacrifices.</p>
<p>Varnish is designed for hardware that you buy today, not the
hardware you bought 15 years ago. Varnish is designed to run
on 64-bit architectures and will scale almost proportional to
the number of CPU cores you have available. Though CPU-power
is rarely a problem.</p>
<p>If you choose to run Varnish on a 32-bit system, you are limited to
3GB of virtual memory address space, which puts a limit on the
number of threads you can run and the size of your cache. This is a
trade-off to gain a simpler design and reduce the amount of work
Varnish needs to do. The 3GB limit depends on the operating system
kernel. The theoretical maximum is 4GB, but your OS will reserve
some of that for the kernel. This is called the user/kernel split.</p>
<p>Varnish does not keep track of whether your cache is on disk or in
memory. Instead, Varnish will request a large chunk of memory and
leave it to the operating system to figure out where that memory
really is. The operating system can generally do a better job than
a user-space program.</p>
<p>Accept filters, epoll and kqueue are advanced features of the
operating system that are designed for high-performance services
like Varnish. By using these, Varnish can move a lot of the
complexity into the OS kernel which is also better positioned to
know what threads are ready to execute when.</p>
<p>In addition, Varnish uses a configuration language that is
translated to C-code, compiled with a normal C compiler and
then dynamically linked directly into Varnish at
run-time. This has several advantages. The most practical of
which is the freedom you get as a system administrator. You
can use VCL to decide how you want to interface with Varnish,
instead of having a developer try to predict every possible
scenario. The fact that it boils down to C and a C compiler
also gives you very high performance, and if you really wanted
to, you could by-pass the VCL to C translation and write raw C
code (this is called in-line C in VCL). In short: Varnish
provides the features, VCL allow you to specify exactly how
you use and combine them.</p>
<p>With Varnish 3 you also have Varnish Modules or simply vmods. These
modules let you extend the functionality of the VCL language by
pulling in custom-written features. Some examples include
non-standard header manipulation, access to memcached or complex
normalization of headers.</p>
<p>The shared memory log allows Varnish to log large amounts of
information at almost no cost by having other applications parse
the data and extract the useful bits. This reduces the
lock-contention in the heavily threaded environment of Varnish.
Lock-contention is also one of the reasons why Varnish uses a
workspace-oriented memory-model instead of allocating the
exact amount of space it needs at run-time.</p>
<p>To summarize: Varnish is designed to run on modern hardware
under real work-loads and to solve real problems. Varnish does not
cater to the &#8220;I want to make Varnish run on my 486 just
because&#8221;-crowd. If it does work on your 486, then that&#8217;s fine, but
that&#8217;s not where you will see our focus. Nor will you see us
sacrifice performance or simplicity for the sake of niche use-cases
that can easily be solved by other means - like using a 64-bit OS.</p>
</div>
</div>
<div class="section" id="how-objects-are-stored">
<h2><a class="toc-backref" href="#id7">1.5&nbsp;&nbsp;&nbsp;How objects are stored</a><a class="headerlink" href="#how-objects-are-stored" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Objects in Varnish are stored in a hash</li>
<li>You can control the hashing</li>
<li>Multiple objects can have the same hash key</li>
</ul>
<div class="handout container">
<p>Varnish has, as mentioned, a key/value store in its
core. Objects are stored in memory and a reference to this
object is kept in a hash tree.</p>
<p>A rather unique feature of Varnish is that you can actually
control what goes into the hashing algorithm that Varnish uses
to store data. Typically the key is made out of the HTTP Host
header and the URL, but you&#8217;re actually able to override this
if you should choose to do so.</p>
<p>The HTTP protocol specifies that there can be multiple objects
that can be served on the same URL, depending on the
preferences of the client. For instance, serving gzip&#8217;ed
content to a client that doesn&#8217;t indicate gzip support doesn&#8217;t
make much sense and Varnish might look at the Various objects
stored at that key to pick out the one that matches.</p>
</div>
</div>
</div>
<div class="section" id="getting-started">
<h1><a class="toc-backref" href="#id8">2&nbsp;&nbsp;&nbsp;Getting started</a><a class="headerlink" href="#getting-started" title="Permalink to this headline">¶</a></h1>
<p>In this chapter, we will:</p>
<blockquote>
<div><ul class="simple">
<li>Install and test a backend</li>
<li>Install Varnish</li>
<li>Make Varnish and the backend-server work together</li>
<li>Cover basic configuration</li>
</ul>
</div></blockquote>
<div class="handout container">
<p>You want to use packages for your operating system whenever
possible.</p>
<p>If the computer you will be using throughout this course has
Varnish 3.0.0 or more recent available through the package system,
you are encouraged to use that package if you do not feel you need
the exercise in installing from source.</p>
<p>We will be using Apache as a web server.</p>
<p>This course is about Varnish, but we need an operating system to
test. For the sake of keeping things simple, the course uses Debian
as a platform. You will find several references to differences
between Debian and Red Hat where they matter the most, but for the
most part, this course is independent on the operating system in
use.</p>
</div>
<div class="section" id="configuration">
<h2><a class="toc-backref" href="#id9">2.1&nbsp;&nbsp;&nbsp;Configuration</a><a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h2>
<p>Varnish has two categories of configuration:</p>
<ul class="simple">
<li>Command line configuration and tunable parameters</li>
<li>VCL</li>
</ul>
<p>To re-load Varnish configuration, you have several commands:</p>
<table border="1" class="docutils">
<colgroup>
<col width="43%" />
<col width="57%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Command</th>
<th class="head">Result</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">service</span> <span class="pre">varnish</span> <span class="pre">restart</span></tt></td>
<td>Completely restarts Varnish, using the
operating system mechanisms. Your cache
will be flushed.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">service</span> <span class="pre">varnish</span> <span class="pre">reload</span></tt></td>
<td>Only reloads VCL. Cache is not affected.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">varnishadm</span> <span class="pre">vcl.load</span> <span class="pre">..</span></tt>
and <tt class="docutils literal"><span class="pre">varnishadm</span> <span class="pre">vcl.use</span> <span class="pre">..</span></tt></td>
<td>Can be used to manually reload VCL. The
<tt class="docutils literal"><span class="pre">service</span> <span class="pre">varnish</span> <span class="pre">reload</span></tt> command does
this for you automatically.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">varnishadm</span> <span class="pre">param.set</span> <span class="pre">...</span></tt></td>
<td>Can be used to set parameters without
restarting Varnish.</td>
</tr>
</tbody>
</table>
<p>Using the <tt class="docutils literal"><span class="pre">service</span></tt> commands is recommended. It&#8217;s safe and fast.</p>
<div class="handout container">
<p>Tunable parameters and command line arguments are used to define
how Varnish should work with operating system and hardware in
addition to setting some default values, while VCL define how
Varnish should interact with web servers and clients.</p>
<p>Almost every aspect of Varnish can be reconfigured without
restarting Varnish. Notable exceptions are cache size and
location, the username and group that Varnish runs as and
hashing algorithm.</p>
<p>While you can change the values, some changes might require
restarting the child to take effect (modifying the listening
port, for instance) or might not be visible
immediately. Changes to how long objects are cached, for
instance, usually only take effect after the currently cached
objects expire and are fetched again. Issuing <tt class="docutils literal"><span class="pre">param.show</span>
<span class="pre">&lt;parameter&gt;</span></tt> will give you a description of the parameter,
when and how it takes effect and the default and current
value.</p>
</div>
</div>
<div class="section" id="command-line-configuration">
<h2><a class="toc-backref" href="#id10">2.2&nbsp;&nbsp;&nbsp;Command line configuration</a><a class="headerlink" href="#command-line-configuration" title="Permalink to this headline">¶</a></h2>
<table class="docutils option-list" frame="void" rules="none">
<col class="option" />
<col class="description" />
<tbody valign="top">
<tr><td class="option-group" colspan="2">
<kbd><span class="option">-a <var>&lt;[hostname]:port&gt;</var></span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>listen address</td></tr>
<tr><td class="option-group">
<kbd><span class="option">-f <var>&lt;filename&gt;</var></span></kbd></td>
<td>VCL</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">-p <var>&lt;parameter=value&gt;</var></span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>set tunable parameters</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">-S <var>&lt;secretfile&gt;</var></span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>authentication secret for management</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">-T <var>&lt;hostname:port&gt;</var></span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>Management interface</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">-s <var>&lt;storagetype,options&gt;</var></span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>where and how to store objects</td></tr>
</tbody>
</table>
<div class="handout container">
<p>All the options that you can pass to the <tt class="docutils literal"><span class="pre">varnishd</span></tt> binary are
documented in the <tt class="docutils literal"><span class="pre">varnishd(1)</span></tt> manual page (<tt class="docutils literal"><span class="pre">man</span> <span class="pre">varnishd</span></tt>).
You may want to take a moment to skim over the options mentioned
above.</p>
<p>The only option that is strictly needed to start Varnish is the
<tt class="docutils literal"><span class="pre">-f</span></tt> to specify a VCL file.</p>
<p>Though they are not strictly required, you almost always want to
specify a <tt class="docutils literal"><span class="pre">-s</span></tt> to select a storage backend,  <tt class="docutils literal"><span class="pre">-a</span></tt> to make sure
Varnish listens for clients on the port you expect and <tt class="docutils literal"><span class="pre">-T</span></tt> to
enable a management interface, often referred to as a telnet
interface.</p>
<p>Both for <tt class="docutils literal"><span class="pre">-T</span></tt> and <tt class="docutils literal"><span class="pre">-a</span></tt>, you do not need to specify an IP, but
can use <tt class="docutils literal"><span class="pre">:80</span></tt> to tell Varnish to listen to port 80 on all IPs
available. Make sure you don&#8217;t forget the colon, as <tt class="docutils literal"><span class="pre">-a</span> <span class="pre">80</span></tt> will
tell Varnish to listen to the IP with the decimal-representation
&#8220;80&#8221;, which is almost certainly not what you want. This is a result
of the underlying function that accept this kind of syntax.</p>
<p>You can specify <tt class="docutils literal"><span class="pre">-p</span></tt> for parameters multiple times. The workflow
for tuning Varnish parameters usually means that you first try the
parameter on a running Varnish through the management interface to
find the value you want, then store it in a configuration file that
will pass it to Varnish with <tt class="docutils literal"><span class="pre">-p</span></tt> next time you start it up. We
will look at these files later on.</p>
<p>The <tt class="docutils literal"><span class="pre">-S</span></tt> option specifies a file which contains a secret to be
used for authentication. This can be used to authenticate with
<tt class="docutils literal"><span class="pre">varnishadm</span> <span class="pre">-S</span></tt> as long as varnishadm can read the same secret
file - or rather the same content: The content of the file can be
copied to another machine to allow varnishadm to access the
management interface remotely.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>It is possible to start Varnish without a VCL file using the
<tt class="docutils literal"><span class="pre">-b</span></tt> option instead of <tt class="docutils literal"><span class="pre">-f</span></tt>:</p>
<table class="docutils option-list" frame="void" rules="none">
<col class="option" />
<col class="description" />
<tbody valign="top">
<tr><td class="option-group" colspan="2">
<kbd><span class="option">-b <var>&lt;hostname:port&gt;</var></span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>backend address</td></tr>
</tbody>
</table>
<p class="last">Since the <tt class="docutils literal"><span class="pre">-b</span></tt> option is mutually exclusive with the <tt class="docutils literal"><span class="pre">-f</span></tt>
option, we will only use the <tt class="docutils literal"><span class="pre">-f</span></tt> option. You can use <tt class="docutils literal"><span class="pre">-b</span></tt>
if you do not intend to specify any VCL and only have a single
web server.</p>
</div>
</div>
</div>
<div class="section" id="configuration-files">
<h2><a class="toc-backref" href="#id11">2.3&nbsp;&nbsp;&nbsp;Configuration files</a><a class="headerlink" href="#configuration-files" title="Permalink to this headline">¶</a></h2>
<p>Most Varnish-installations use two configuration-files. One of them is used
by the operating system to start Varnish, while the other contains your
VCL.</p>
<table border="1" class="docutils">
<colgroup>
<col width="42%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">File</th>
<th class="head">Usage</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">/etc/default/varnish</span></tt></td>
<td>Used for parameters and command line
arguments. When you change this, you
need to run <tt class="docutils literal"><span class="pre">service</span> <span class="pre">varnish</span> <span class="pre">restart</span></tt>
for the changes to take effect.
On RedHat-based OS&#8217;s, this is kept in
<tt class="docutils literal"><span class="pre">/etc/sysconfig/varnish</span></tt> instead.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">/etc/varnish/default.vcl</span></tt></td>
<td>The VCL file. You can change the file
name by editing <cite>/etc/default/varnish</cite>
if you want to, but it&#8217;s normal to use
the default name. This contains your
VCL and backend-definitions. After
changing this, you can run either
<tt class="docutils literal"><span class="pre">service</span> <span class="pre">varnish</span> <span class="pre">reload</span></tt>, which will
not restart Varnish, or you can run
<tt class="docutils literal"><span class="pre">service</span> <span class="pre">varnish</span> <span class="pre">restart</span></tt>, which
empties the cache.</td>
</tr>
</tbody>
</table>
<div class="handout container">
<p>There are other ways to reload VCL and make parameter-changes take
effect, mostly using the <tt class="docutils literal"><span class="pre">varnishadm</span></tt> tool. However, using the
<tt class="docutils literal"><span class="pre">service</span> <span class="pre">varnish</span> <span class="pre">reload</span></tt> and <tt class="docutils literal"><span class="pre">service</span> <span class="pre">varnish</span> <span class="pre">restart</span></tt> commands is a
good habit.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you want to know how the <tt class="docutils literal"><span class="pre">service</span> <span class="pre">varnish</span></tt>-commands work, you
can always look at the script that runs behind the scenes. If you are
used to UNIX-like systems, it will come as no surprise that the
script can be found in <tt class="docutils literal"><span class="pre">/etc/init.d/varnish</span></tt>.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The script-configuration (located in <cite>/etc/sysconfig</cite> or
<cite>/etc/default</cite>) is directly sourced as a shell script. Pay close
attention to any backslashes (\) and quotation marks that might move
around as you edit the DAEMON_OPTS environmental variable.</p>
</div>
</div>
</div>
<div class="section" id="defining-a-backend-in-vcl">
<h2><a class="toc-backref" href="#id12">2.4&nbsp;&nbsp;&nbsp;Defining a backend in VCL</a><a class="headerlink" href="#defining-a-backend-in-vcl" title="Permalink to this headline">¶</a></h2>
<p>/etc/varnish/default.vcl</p>
<div class="highlight-python"><pre>backend default {
   .host = "localhost";
   .port = "8080";
}
</pre>
</div>
<div class="handout container">
<p>In Varnish terminology, a backend-server is whatever server Varnish
talks to to fetch content. This can be any sort of service as long as it
understands HTTP. Most of the time, Varnish talks to a web server or an
application frontend server.</p>
<p>You almost always want to use VCL so we might as well get started.</p>
<p>The above example defines a backend named <tt class="docutils literal"><span class="pre">default</span></tt>. The name
<cite>default</cite> is not special, and the real default backend that Varnish will
use is the first backend you specify.</p>
<p>You can specify many backends at the same time, but for now, we will
only specify one to get started.</p>
</div>
</div>
<div class="section" id="exercise-installation">
<h2><a class="toc-backref" href="#id13">2.5&nbsp;&nbsp;&nbsp;Exercise: Installation</a><a class="headerlink" href="#exercise-installation" title="Permalink to this headline">¶</a></h2>
<p>You can install packages on Debian with <tt class="docutils literal"><span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">&lt;package&gt;</span></tt>. E.g:
<tt class="docutils literal"><span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">apache2</span></tt>. For Red Hat, the tool would be <tt class="docutils literal"><span class="pre">yum</span> <span class="pre">install</span>
<span class="pre">&lt;package&gt;</span></tt>.</p>
<ol class="arabic simple">
<li>Install <tt class="docutils literal"><span class="pre">apache2</span></tt> and verify it works by browsing to <cite>http://localhost/</cite>.
You probably want to change <tt class="docutils literal"><span class="pre">localhost</span></tt> with whatever the hostname of
the machine you&#8217;re working is.</li>
<li>Change Apache&#8217;s ports from 80 to 8080, in <cite>/etc/apache2/ports.conf</cite> and
<cite>/etc/apache2/sites-enabled/000-default</cite>.</li>
<li>Install Varnish</li>
<li>Modify the Varnish configuration file so Varnish listens on port <cite>80</cite>,
has a management interface on port <cite>1234</cite> and uses <cite>127.0.0.1:8080</cite> as
the backend.</li>
<li>Start Varnish using <tt class="docutils literal"><span class="pre">service</span> <span class="pre">varnish</span> <span class="pre">start</span></tt>.</li>
</ol>
<p>The end result should be:</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="30%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Service</th>
<th class="head">Result</th>
<th class="head">Related config-files</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Apache</td>
<td>Answers on port <cite>8080</cite></td>
<td><tt class="docutils literal"><span class="pre">/etc/apache2/ports.conf</span></tt> and
<tt class="docutils literal"><span class="pre">/etc/apache2/sites-enabled/000-default</span></tt></td>
</tr>
<tr class="row-odd"><td>Varnish</td>
<td>Answers on port <cite>80</cite></td>
<td><tt class="docutils literal"><span class="pre">/etc/default/varnish</span></tt></td>
</tr>
<tr class="row-even"><td>Varnish</td>
<td>Talks to apache on
<cite>localhost:8080</cite></td>
<td><tt class="docutils literal"><span class="pre">/etc/varnish/default.vcl</span></tt></td>
</tr>
</tbody>
</table>
<div class="handout container">
<p>Varnish Software and the Varnish community maintains a package
repository for several common GNU/Linux distributions. If your system
does not have sufficiently up-to-date packages, visit
<a class="reference external" href="https://www.varnish-cache.org/releases">https://www.varnish-cache.org/releases</a> and find a package for your
distribution.</p>
<p>Once you have modified the <tt class="docutils literal"><span class="pre">/etc/default/varnish</span></tt>-file, it should look
something like this (comments removed):</p>
<div class="highlight-python"><pre>NFILES=131072
MEMLOCK=82000
INSTANCE=$(uname -n)
DAEMON_OPTS="-a :80 \
             -T localhost:1234 \
             -f /etc/varnish/default.vcl \
             -s malloc,256m"</pre>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">You can get an overview over services listening on TCP ports by
issuing the command <tt class="docutils literal"><span class="pre">netstat</span> <span class="pre">-nlpt</span></tt>.</p>
</div>
</div>
</div>
<div class="section" id="exercise-fetch-data-through-varnish">
<h2><a class="toc-backref" href="#id14">2.6&nbsp;&nbsp;&nbsp;Exercise: Fetch data through Varnish</a><a class="headerlink" href="#exercise-fetch-data-through-varnish" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>Install <tt class="docutils literal"><span class="pre">libwww-perl</span></tt></li>
<li>Execute <tt class="docutils literal"><span class="pre">GET</span> <span class="pre">-Used</span> <span class="pre">http://localhost:80/</span></tt> (on the command line)</li>
<li>Compare the results from multiple executions.</li>
</ol>
<div class="handout container">
<p>GET and HEAD is actually the same tool; lwp-request. A HTTP HEAD request
tells the web server - or Varnish in this case - to only reply with the
HTTP headers, while GET returns everything.</p>
<p><tt class="docutils literal"><span class="pre">GET</span> <span class="pre">-Used</span></tt> tells lwp-request to do a GET-request, print the
request headers (U), print the response status code (s), which is
typically &#8220;200 OK&#8221; or &#8220;404 File not found&#8221;, print the response
headers &#8220;-e&#8221; and finally to not display the content of the
response. Feel free to try removing some of the options observe the
effect.</p>
<p>GET is also useful to generate requests with custom headers, as you can
supply extra headers with <tt class="docutils literal"><span class="pre">-H</span> <span class="pre">&quot;Header:</span> <span class="pre">value&quot;</span></tt>, which can be used
multiple times.</p>
<p>You may also be familiar with firebug, an add-on for Firefox used
for web development and related affairs. This too can show you the
response headers.</p>
<p>Web browsers have their own cache which you may not immediately be
able to tell if you&#8217;re using or not. It&#8217;s often helpful to
double-check with GET or HEAD if you are in doubt if what you&#8217;re
seeing is coming from Varnish or is part of your browser cache.</p>
</div>
</div>
<div class="section" id="log-data">
<h2><a class="toc-backref" href="#id15">2.7&nbsp;&nbsp;&nbsp;Log data</a><a class="headerlink" href="#log-data" title="Permalink to this headline">¶</a></h2>
<p>Varnish provides a great deal of log data in real-time. The two most important tools to process that log data is:</p>
<ul class="simple">
<li>Varnishlog, used to access request-specific data (An extended access log,
provides information about specific clients and requests.).</li>
<li>varnishstat, used to access global counters (Provides overall statistics,
e.g the number of total requests, number of objects and more.).</li>
<li>If you have multiple Varnish instances on the same machine, you need to
specify <tt class="docutils literal"><span class="pre">-n</span> <span class="pre">&lt;name&gt;</span></tt> both when starting Varnish and when starting the
corresponding tools.</li>
</ul>
<p>In addition the <tt class="docutils literal"><span class="pre">varnishncsa</span></tt>-tool is often used to write apache-like log
files.</p>
<div class="handout container">
<p>If you look for logging data for Varnish you may discover that
<cite>/var/log/varnish/</cite> is either non-existent or empty. There&#8217;s a reason
for that.</p>
<p>Varnish logs all its information to a shared memory log which is
overwritten repeatedly every time it&#8217;s filled up. To use the log data,
you need to use specific tools to parse the content.</p>
<p>The downside is that you don&#8217;t have historic data unless you set it up
yourself, which is not covered in this chapter, but the upside is that
you get an abundance of information when you need it.</p>
<p>Through the course you will become familiar with varnishlog and
varnishstat, which are the two most important tools you have at your
disposal.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>If you want to log to disk you should take a look at
<tt class="docutils literal"><span class="pre">/etc/default/varnishlog</span></tt> or <tt class="docutils literal"><span class="pre">/etc/default/varnishncsa</span></tt> (or the
<tt class="docutils literal"><span class="pre">syconfig</span></tt> equivalents). This will allow you to run <tt class="docutils literal"><span class="pre">varnishncsa</span></tt>
or <tt class="docutils literal"><span class="pre">varnishlog</span></tt> as a service in the background that writes to disk.</p>
<p class="last">Keep in mind that <tt class="docutils literal"><span class="pre">varnishlog</span></tt> generates large amounts of data,
though. You may not want to log all of it to disk.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">All log tools (and varnishadm) takes an <tt class="docutils literal"><span class="pre">-n</span></tt> option. Varnish itself
also takes a <tt class="docutils literal"><span class="pre">-n</span></tt> option. This is used to specify a name for
<tt class="docutils literal"><span class="pre">varnishd</span></tt>, or the location of the shared memory log. On most
installations <tt class="docutils literal"><span class="pre">-n</span></tt> is not used, but if you run multiple Varnish
instances on a single machine you need to use <tt class="docutils literal"><span class="pre">-n</span></tt> to distinguish
one varnish-instance from another.</p>
</div>
</div>
</div>
<div class="section" id="varnishlog">
<h2><a class="toc-backref" href="#id16">2.8&nbsp;&nbsp;&nbsp;varnishlog</a><a class="headerlink" href="#varnishlog" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>97 ReqStart     c 10.1.0.10 50866 117511506
97 RxRequest    c GET
97 RxURL        c /style.css
97 RxProtocol   c HTTP/1.1
97 RxHeader     c Host: www.example.com
97 VCL_call     c recv lookup
97 VCL_call     c hash hash
97 Hit          c 117505004
97 VCL_call     c hit deliver
97 Length       c 3218
97 VCL_call     c deliver deliver
97 TxProtocol   c HTTP/1.1
97 TxStatus     c 200
97 TxResponse   c OK
97 TxHeader     c Content-Length: 3218
97 TxHeader     c Date: Sat, 22 Aug 2008 01:10:10 GMT
97 TxHeader     c X-Varnish: 117511501 117505004
97 TxHeader     c Age: 2
97 TxHeader     c Via: 1.1 varnish
97 ReqEnd       c 117511501 1227316210.534358978 \
     1227316210.535176039  0.035283089 0.000793934 0.000023127</pre>
</div>
<div class="handout container">
<p>The above output is a single cache hit, as processed by Varnish. When
you are dealing with several thousand requests per second you need
filtering.</p>
<p>The displayed data is categorized as follows:</p>
<ol class="arabic simple">
<li>The number on the left is a semi-unique identifier of the request. It
is used to distinguish different requests.</li>
<li>Each piece of log information belongs to a tag, as seen on the second
left-most column. TxHeader, RxHeader, VCL_call etc. You can use
those tags for intelligent filtering.</li>
<li>Varnishlog will try to decipher if a request is related to a client
(c), backend (b) or &#8220;misc&#8221; (-). This can be used to filter the log.
The misc-category will contain data related to thread-collection,
object expiry and similar internal data.</li>
<li>The tag-specific content. E.g: the actual URL, the name and content
of a HTTP header and so on.</li>
</ol>
<p>Since varnishlog displays all data in the log unless you filter it,
there is a lot of data that you can safely ignore, and some data you
should focus on. The following table demonstrates some tags and values
that are useful. Since the tags them self are somewhat generic, you do
not have a &#8220;Response header sent to a client&#8221;-header, but a &#8220;Sent
Header&#8221; (<cite>TxHeader</cite>) tag, and it&#8217;s up to you to interpret if that means
it was sent to a client or a web server.</p>
</div>
</div>
<div class="section" id="varnishlog-tag-examples">
<h2><a class="toc-backref" href="#id17">2.9&nbsp;&nbsp;&nbsp;Varnishlog tag examples</a><a class="headerlink" href="#varnishlog-tag-examples" title="Permalink to this headline">¶</a></h2>
<table border="1" class="docutils">
<colgroup>
<col width="21%" />
<col width="39%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Tag</th>
<th class="head">Example value</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">RxURL</span></tt></td>
<td><tt class="docutils literal"><span class="pre">/index.html</span></tt></td>
<td>Varnish received a URL,
the only scenario where
Varnish receives a URL is
from a client, thus: a
client sent us this URL.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">TxURL</span></tt></td>
<td><tt class="docutils literal"><span class="pre">/index.html</span></tt></td>
<td>Varnish sent a URL,
the only scenario where
Varnish sends a URL is
to a backend, thus: this
is part of a backend
request.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">RxHeader</span></tt></td>
<td><tt class="docutils literal"><span class="pre">Host:</span> <span class="pre">www.example.com</span></tt></td>
<td>A received header.
Either a request
header or
a response header
backend. Since we
know the <cite>Host</cite>-header is
a request header, we can
assume it&#8217;s from a client.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">TxHeader</span></tt></td>
<td><tt class="docutils literal"><span class="pre">Host:</span> <span class="pre">example.com</span></tt></td>
<td>A header Varnish sent.
Either a request header
or a  response header.
Since we know the
<cite>Host</cite>-header is a request
header we can assume it is
a header Varnish sent to a
backend.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">RxRequest</span></tt></td>
<td><tt class="docutils literal"><span class="pre">GET</span></tt></td>
<td>Received request method.
Varnish only receives
requests from clients.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">TxStatus</span></tt></td>
<td><tt class="docutils literal"><span class="pre">200</span></tt></td>
<td>Status code Varnish sent.
Only sent to clients.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">RxStatus</span></tt></td>
<td><tt class="docutils literal"><span class="pre">500</span></tt></td>
<td>Status code Varnish
received from a backend.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">ReqEnd</span></tt></td>
<td>1048725851
1352290440.688310385
1352290440.688468695
0.000107288 0.000083208
0.000075102</td>
<td>The &#8220;End of request&#8221; entry
has various timing details
for debugging. The first
number is the XID, the
second is the time the
request started and the
second is when it finished.
The fourth number is
time from accepting the
connection to processing
of the request started.
The fifth number is time
from request processing
started to delivery (e.g:
VCL execution and backend
fetching). The sixth and
last number is how long
the delivery itself took.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="varnishlog-options">
<h2><a class="toc-backref" href="#id18">2.10&nbsp;&nbsp;&nbsp;varnishlog options</a><a class="headerlink" href="#varnishlog-options" title="Permalink to this headline">¶</a></h2>
<table class="docutils option-list" frame="void" rules="none">
<col class="option" />
<col class="description" />
<tbody valign="top">
<tr><td class="option-group">
<kbd><span class="option">-b</span></kbd></td>
<td>Only show traffic to backend.</td></tr>
<tr><td class="option-group">
<kbd><span class="option">-c</span></kbd></td>
<td>Only show traffic to client.</td></tr>
<tr><td class="option-group">
<kbd><span class="option">-O</span></kbd></td>
<td>Do not group by request.</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">-m <var>&lt;tag:filter&gt;</var></span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>Show <em>requests</em> where the &lt;tag&gt; matches &lt;filter&gt;. Example:
<tt class="docutils literal"><span class="pre">varnishlog</span> <span class="pre">-m</span> <span class="pre">TxStatus:500</span></tt> to show requests
returned to a client with status code 500.</td></tr>
</tbody>
</table>
<div class="handout container">
<table class="docutils option-list" frame="void" rules="none">
<col class="option" />
<col class="description" />
<tbody valign="top">
<tr><td class="option-group">
<kbd><span class="option">-n <var>&lt;name&gt;</var></span></kbd></td>
<td>The name of the Varnish instance, or path to the shmlog.
Useful for running multiple instances of Varnish.</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">-i <var>&lt;tag[,tag][..]&gt;</var></span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>Only show the specified tags.</td></tr>
<tr><td class="option-group">
<kbd><span class="option">-I <var>&lt;regex&gt;</var></span></kbd></td>
<td>Filter the tag provided by -i, using the regular expression for -I.</td></tr>
</tbody>
</table>
<p>Some examples of useful command-combinations:</p>
<table border="1" class="docutils">
<colgroup>
<col width="39%" />
<col width="61%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Command</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">varnishlog</span> <span class="pre">-c</span></tt>
<tt class="docutils literal"><span class="pre">-m</span> <span class="pre">RxURL:/specific/url/</span></tt></td>
<td>Only show client-requests for the url
<cite>/specific/url</cite>..</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">varnishlog</span> <span class="pre">-O</span> <span class="pre">-i</span> <span class="pre">ReqEnd</span></tt></td>
<td>Only show the ReqEnd tag. Useful to spot sporadic
slowdown. Watch the last three values of it.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">varnishlog</span> <span class="pre">-O</span> <span class="pre">-i</span> <span class="pre">TxURL</span></tt></td>
<td>Only show the URLs sent to backend servers. E.g:
Cache misses and content not cached.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">varnishlog</span> <span class="pre">-O</span> <span class="pre">-i</span> <span class="pre">RxHeader</span></tt>
<tt class="docutils literal"><span class="pre">-I</span> <span class="pre">Accept-Encoding</span></tt></td>
<td>Show the Accept-Encoding request header.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">varnishlog</span> <span class="pre">-b</span></tt>
<tt class="docutils literal"><span class="pre">-m</span> <span class="pre">TxRequest:POST</span></tt></td>
<td>Show backend requests using the POST method.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">varnishlog</span> <span class="pre">-O</span></tt>
<tt class="docutils literal"><span class="pre">-i</span> <span class="pre">TxURL,TxHeader</span></tt></td>
<td>Only shows the URL sent to a backend server and
all headers sent, either to a client or backend.</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><tt class="docutils literal"><span class="pre">varnishlog</span></tt> sometimes accept arguments that are technically
incorrect, which can have surprising results on filtering. Make sure
you double-check the filter logic. You most likely want to specify -b
or -c too.</p>
</div>
</div>
</div>
<div class="section" id="varnishstat">
<h2><a class="toc-backref" href="#id19">2.11&nbsp;&nbsp;&nbsp;varnishstat</a><a class="headerlink" href="#varnishstat" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>0+00:44:50                                                   foobar
Hitrate ratio:       10      100      175
Hitrate avg:     0.9507   0.9530   0.9532

      574660       241.00       213.63 Client connections accepted
     2525317       937.00       938.78 Client requests received
     2478794       931.00       921.48 Cache hits
        7723         3.00         2.87 Cache hits for pass
      140055        36.00        52.07 Cache misses
       47974        12.00        17.83 Backend conn. success
      109526        31.00        40.72 Backend conn. reuses
       46676         5.00        17.35 Backend conn. was closed
      156211        41.00        58.07 Backend conn. recycles
      110500        34.00        41.08 Fetch with Length
       46519         6.00        17.29 Fetch chunked
         456         0.00         0.17 Fetch wanted close
        5091          .            .   N struct sess_mem
        3473          .            .   N struct sess
       53570          .            .   N struct object
       50070          .            .   N struct objecthead
          20          .            .   N struct vbe_conn</pre>
</div>
<div class="handout container">
<p>varnishstat gives a good representation of the general health of
Varnish, including cache hit rate, uptime, number of failed backend
connections and many other statistics.</p>
<p>There are over a hundred different counters available. To increase the
usefulness of varnishstat, only counters with a value different from
0 is shown by default.</p>
<p>varnishstat can be executed either as a one-shot tool which simply
prints the current values of all the counters, using the <tt class="docutils literal"><span class="pre">-1</span></tt> option,
or interactively. Both methods allow you to specify specific counters
using <tt class="docutils literal"><span class="pre">-f</span> <span class="pre">field1,field2,...</span></tt> to limit the list.</p>
<p>In interactive mode, varnishstat starts out by printing the uptime(45
minutes, in the example above) and hostname(foobar).</p>
<p>The <cite>Hitrate ratio</cite> and <cite>Hitrate avg</cite> are related. The Hitrate average
measures the cache hit rate for a period of time stated by <cite>hitrate
ratio</cite>. In the example above, the hitrate average for the last 10
seconds is 0.9507 (or 95.07%), 0.9530 for the last 100 seconds and
0.9532 for the last 175 seconds. When you start varnishstat, all of
these will start at 1 second, then grow to 10, 100 and 1000. This is
because varnishstat has to compute the average while it is running;
there is no historic data of counters available.</p>
<p>The bulk of varnishstat is the counters. The left column is the raw
value, the second column is change per second in real time and the
third column is change per second on average since Varnish started.
In the above example Varnish has served 574660 requests and is
currently serving roughly 241 requests per second.</p>
<p>Some counters do not have &#8216;per second&#8217; data. These are counters which
both increase and decrease.</p>
<p>There are far too many counters to keep track of for non-developers, and
many of the counters are only there for debugging purposes. This allows
you to provide the developers of Varnish with real and detailed data
whenever you run into a performance issue or bug. It allows the
developers to test ideas and get feedback on how it works in production
environments without creating special test versions of Varnish. In
short: It allows Varnish to be developed according to how it is used.</p>
<p>In addition to some obviously interesting counters, like <cite>cache_hit</cite> and
<cite>client_conn</cite>, some counters of note are:</p>
<table border="1" class="docutils">
<colgroup>
<col width="26%" />
<col width="74%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Counter</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><cite>client_drop</cite></td>
<td>This counts clients Varnish had to drop due to
resource shortage. It should be 0.</td>
</tr>
<tr class="row-odd"><td><cite>cache_hitpass</cite></td>
<td>Hitpass is a special type of cache miss.
It will be covered in the VCL chapters, but
it can often be used to indicate if something
the backend sent has triggered cache misses.</td>
</tr>
<tr class="row-even"><td><cite>backend_fail</cite></td>
<td>Counts the number of requests to backends that
fail. Should have a low number, ideally 0, but
it&#8217;s not unnatural to have backend failures
once in a while. Just make sure it doesn&#8217;t
become the normal state of operation.</td>
</tr>
<tr class="row-odd"><td><cite>n_object</cite></td>
<td>Counts the number of objects in cache.
You can have multiple variants of the same
object depending on your setup.</td>
</tr>
<tr class="row-even"><td><cite>n_wrk</cite>,
<cite>n_wrk_queued</cite>,
<cite>n_wrk_drop</cite></td>
<td>Thread counters. During normal operation,
the <cite>n_wrk_queued</cite> counter should not grow.
Once Varnish is out of threads, it will queue
up requests and <cite>n_wrk_queued</cite> counts how many
times this has happened. Once the queue is
full, Varnish starts dropping requests without
answering. <cite>n_wrk_drop</cite> counts how many times
a request has been dropped. It should be 0.</td>
</tr>
<tr class="row-odd"><td><cite>n_lru_nuked</cite></td>
<td>Counts the number of objects Varnish has had
to evict from cache before they expired to
make room for other content. If it is always
0, there is no point increasing the size of
the cache since the cache isn&#8217;t full. If it&#8217;s
climbing steadily a bigger cache could improve
cache efficiency.</td>
</tr>
<tr class="row-even"><td><cite>esi_errors</cite>,
<cite>esi_warnings</cite></td>
<td>If you use Edge Side Includes (ESI), these
somewhat hidden counters can be helpful to
determine if the ESI syntax the web server is
sending is valid.</td>
</tr>
<tr class="row-odd"><td><cite>uptime</cite></td>
<td>Varnish&#8217; uptime. Useful to spot if Varnish has
been restarted, either manually or by bugs.
Particularly useful if a monitor tool uses it.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="the-management-interface">
<h2><a class="toc-backref" href="#id20">2.12&nbsp;&nbsp;&nbsp;The management interface</a><a class="headerlink" href="#the-management-interface" title="Permalink to this headline">¶</a></h2>
<p>Varnish offers a management interface (Historically called the Telnet
interface.), assuming it was started with a <tt class="docutils literal"><span class="pre">-T</span></tt> option. You can use the
management interface to:</p>
<ul class="simple">
<li>Change parameters without restarting varnish</li>
<li>Reload VCL</li>
<li>View the most up-to-date documentation for parameters</li>
</ul>
<p>There are a few other uses too which you can read about using the
<tt class="docutils literal"><span class="pre">help</span></tt>-command after you connect to the management interface with
<tt class="docutils literal"><span class="pre">varnishadm</span></tt>.</p>
<p>The <tt class="docutils literal"><span class="pre">service</span> <span class="pre">varnish</span> <span class="pre">reload</span></tt> command uses the management interface to
reload VCL without restarting Varnish.</p>
<div class="handout container">
<p>Keep the following in mind when using the management interface:</p>
<ol class="arabic simple">
<li>Any changes you make are done immediately on the running Varnish
instance.</li>
<li>Changes are not persistent across restarts of Varnish. If you change
a parameter and you want the change to apply if you restart Varnish,
you need to also store it in the regular configuration for the boot
script.</li>
</ol>
<p>Because the management interface is not encrypted, only has limited
authentication and still allows almost total control over Varnish, it is
important to protect it. Using the <tt class="docutils literal"><span class="pre">-S</span></tt> option offers reasonably good
access control, but does not protect against more elaborate attacks,
like man in the middle attacks &#8211; the interface is not encrypted.</p>
<p>The simplest way to protect the management interface is to only have it
listen on localhost (127.0.0.1). Combined with the secret file, you can
now offer access to the interface on a user-by-user basis by adjusting
the read permission on the secret file. The secret file usually lives in
<tt class="docutils literal"><span class="pre">/etc/varnish/secret</span></tt>. The content is not a password, but a shared
secret (it is never transmitted over the interface).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Newer Varnish-versions will automatically detect the correct
arguments for <tt class="docutils literal"><span class="pre">varnishadm</span></tt> using the shared memory log. For older
versions, you always had to specify at least the <tt class="docutils literal"><span class="pre">-T</span></tt>-option when
using varnishadm.</p>
<p>This automatic detection relies on the <tt class="docutils literal"><span class="pre">-n</span></tt> option since
<tt class="docutils literal"><span class="pre">varnishadm</span></tt> needs to find the shared memory log.</p>
<p class="last">For remote access you will always specify <tt class="docutils literal"><span class="pre">-T</span></tt> and <tt class="docutils literal"><span class="pre">-S</span></tt> since a
remote <tt class="docutils literal"><span class="pre">varnishadm</span></tt> can&#8217;t read the shared memory log.</p>
</div>
</div>
</div>
<div class="section" id="exercise-try-out-the-tools">
<h2><a class="toc-backref" href="#id21">2.13&nbsp;&nbsp;&nbsp;Exercise: Try out the tools</a><a class="headerlink" href="#exercise-try-out-the-tools" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>Run <tt class="docutils literal"><span class="pre">varnishstat</span></tt> and <tt class="docutils literal"><span class="pre">varnishlog</span></tt> while performing a few requests.</li>
<li>Make <tt class="docutils literal"><span class="pre">varnishlog</span></tt> only print client-requests where the <cite>RxURL</cite>-tag
contains <tt class="docutils literal"><span class="pre">/favicon.ico</span></tt>.</li>
<li>Use <tt class="docutils literal"><span class="pre">varnishadm</span></tt> to determine the default value for the
<tt class="docutils literal"><span class="pre">default_ttl</span></tt>-parameter, and what it does.</li>
</ol>
<div class="handout container">
<p>As you are finishing up this exercise, you hopefully begin to see the
usefulness of the various Varnish tools. <tt class="docutils literal"><span class="pre">varnishstat</span></tt> and
<tt class="docutils literal"><span class="pre">varnishlog</span></tt> are the two most used tools, and are usually what you
need for sites that are not in production yet.</p>
<p>The various arguments for <tt class="docutils literal"><span class="pre">varnishlog</span></tt> are mostly designed to help you
find exactly what you want, and filter out the noise. On production
traffic, the amount of log data that Varnish produces is staggering, and
filtering is a requirement for using <tt class="docutils literal"><span class="pre">varnishlog</span></tt> effectively.</p>
</div>
</div>
</div>
<div class="section" id="tuning">
<h1><a class="toc-backref" href="#id22">3&nbsp;&nbsp;&nbsp;Tuning</a><a class="headerlink" href="#tuning" title="Permalink to this headline">¶</a></h1>
<p><em>This chapter is for the system administration course only</em></p>
<p>This chapter will cover:</p>
<ul class="simple">
<li>Architecture</li>
<li>Best practices</li>
<li>Parameters</li>
</ul>
<div class="handout container">
<p>Tuning Varnish is two-fold. Perhaps the most important aspect of it is
is getting your VCL straight. For now, though, we will focus on tuning
Varnish for your hardware, operating system and network.</p>
<p>To be able to do that, knowledge of the process- and thread-architecture
is helpful.</p>
<p>The internal architecture of Varnish is of some interest, both because
it is chiefly responsible for the performance you will be able to
achieve with Varnish, and because it affects how you integrate Varnish
in your own architecture.</p>
<p>There are several aspects of the design that was unique to Varnish when
it was originally implemented. Truly good solutions is the aim of
Varnish, regardless of whether that means reusing ancient ideas or
coming up with something radically different.</p>
</div>
<div class="section" id="process-architecture">
<h2><a class="toc-backref" href="#id23">3.1&nbsp;&nbsp;&nbsp;Process Architecture</a><a class="headerlink" href="#process-architecture" title="Permalink to this headline">¶</a></h2>
<p>The multi-process architecture:</p>
<img alt="_images/architecture.png" class="align-center" src="_images/architecture.png" style="width: 80%;" />
<dl class="class">
<dt id="handout">
<em class="property">class </em><tt class="descname">handout</tt><a class="headerlink" href="#handout" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<div class="section" id="the-management-process">
<h3><a class="toc-backref" href="#id24">3.1.1&nbsp;&nbsp;&nbsp;The management process</a><a class="headerlink" href="#the-management-process" title="Permalink to this headline">¶</a></h3>
<p>Varnish has two main processes: the management process and the child
process.  The management process apply configuration changes (VCL and
parameters), compile VCL, monitor Varnish, initialize Varnish and provides
a command line interface, accessible either directly on the terminal or
through a management interface.</p>
<p>The management process polls the child process every few seconds to see if
it&#8217;s still there. If it doesn&#8217;t get a reply within a reasonable time, the
management process will kill the child and start it back up again. The same
happens if the child unexpectedly exits, for example from a segmentation
fault or assert error.</p>
<p>This ensures that even if Varnish does contain a critical bug, it will
start back up again fast. Usually within a few seconds, depending on the
conditions.</p>
<p>All of this is logged to syslog. This makes it crucially important to
monitor the syslog, otherwise you may never even know unless you look for
them, because the perceived downtime is so short.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Varnish Software and the Varnish community at large occasionally get
requests for assistance in performance tuning Varnish that turn out to
be crash-issues. Because the Varnish management thread starts the child
up so fast, the users don&#8217;t even notice the down time, only the extra
loading time as Varnish is constantly emptying its cache.</p>
<p class="last">This is easily avoidable by paying attention to syslog and the <cite>uptime</cite>
counter in <tt class="docutils literal"><span class="pre">varnishstat</span></tt>.</p>
</div>
<dl class="class">
<dt>
<em class="property">class </em><tt class="descname">handout</tt></dt>
<dd></dd></dl>

</div>
<div class="section" id="the-child-process">
<h3><a class="toc-backref" href="#id25">3.1.2&nbsp;&nbsp;&nbsp;The child process</a><a class="headerlink" href="#the-child-process" title="Permalink to this headline">¶</a></h3>
<p>The child process consist of several different types of threads, including,
but not limited to:</p>
<ul class="simple">
<li>Acceptor thread to accept new connections and delegate them.</li>
<li>Worker threads - one per session. It&#8217;s common to use hundreds of worker
threads.</li>
<li>Expiry thread, to evict old content from the cache.</li>
</ul>
<p>Varnish uses workspaces to reduce the contention between each thread when
they need to acquire or modify memory. There are multiple workspaces, but
the most important one is the session workspace, which is used to
manipulate session data. An example is changing <cite>www.example.com</cite> to
<cite>example.com</cite> before it is entered into the cache, to reduce the number of
duplicates.</p>
<p>It is important to remember that even if you have 5MB of session workspace
and are using 1000 threads, the actual memory usage is not 5GB. The virtual
memory usage will indeed be 5GB, but unless you actually use the memory,
this is not a problem. Your memory controller and operating system will
keep track of what you actually use.</p>
<p>To communicate with the rest of the system, the child process uses a shared
memory log accessible from the file system. This means that if a thread
needs to log something, all it has to do is grab a lock, write to a memory
area and then free the lock. In addition to that, each worker thread has a
cache for log data to reduce lock contention.</p>
<p>The log file is usually about 80MB, and split in two. The first part is
counters, the second part is request data. To view the actual data, a
number of tools exist that parses the shared memory log. Because the
log-data is not meant to be written to disk in its raw form, Varnish can
afford to be very verbose. You then use one of the log-parsing tools to
extract the piece of information you want - either to store it permanently
or to monitor Varnish in real-time.</p>
<dl class="class">
<dt>
<em class="property">class </em><tt class="descname">handout</tt></dt>
<dd></dd></dl>

</div>
<div class="section" id="vcl-compilation">
<h3><a class="toc-backref" href="#id26">3.1.3&nbsp;&nbsp;&nbsp;VCL compilation</a><a class="headerlink" href="#vcl-compilation" title="Permalink to this headline">¶</a></h3>
<p>Configuring the caching policies of Varnish is done in the Varnish
Configuration Language (VCL). Your VCL is then interpreted by the
management process into to C and then compiled by a normal C compiler -
typically gcc. Lastly, it is linked into the running Varnish instance.</p>
<p>As a result of this, changing configuration while Varnish is running is
very cheap. Varnish may want to keep the old configuration around for a bit
in case it still has references to it, but the policies of the new VCL
takes effect immediately.</p>
<p>Because the compilation is done outside of the child process, there is
no risk of affecting the running Varnish by accidentally loading an
ill-formated VCL.</p>
<p>A compiled VCL file is kept around until you restart Varnish completely, or
until you issue <tt class="docutils literal"><span class="pre">vcl.discard</span></tt> from the management interface. You can only
discard compiled VCL files after all references to them are gone, and the
amount of references left is part of the output of <tt class="docutils literal"><span class="pre">vcl.list</span></tt>.</p>
</div>
</div>
<div class="section" id="storage-backends">
<h2><a class="toc-backref" href="#id27">3.2&nbsp;&nbsp;&nbsp;Storage backends</a><a class="headerlink" href="#storage-backends" title="Permalink to this headline">¶</a></h2>
<p>Varnish supports different methods of allocating space for the
cache, and you choose which one you want with the <tt class="docutils literal"><span class="pre">-s</span></tt> argument.</p>
<ul class="simple">
<li>file</li>
<li>malloc</li>
<li>persistent (experimental)</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">As a Rule of thumb use: malloc if it fits in memory, file if it doesn&#8217;t.
Expect around 1kB of overhead per object cached.</p>
</div>
<div class="handout container">
<p>They approach the same basic problem from two different angles.
With the <cite>malloc</cite>-method, Varnish will request the entire size of
the cache with a malloc() (memory allocation) library call. The
operating system divides the cache between memory and disk by
swapping out what it can&#8217;t fit in memory.</p>
<p>The alternative is to use the <cite>file</cite> storage backend, which instead
creates a file on a filesystem to contain the entire cache, then
tell the operating system through the mmap() (memory map) system
call to map the entire file into memory if possible.</p>
<p>The <cite>file</cite> storage method does not retain data when you stop or
restart Varnish! This is what persistent storage is for. When <tt class="docutils literal"><span class="pre">-s</span>
<span class="pre">file</span></tt> is used, Varnish does not keep track of what is written to
disk and what is not. As a result, it&#8217;s impossible to know whether
the cache on disk can be used or not — it&#8217;s just random data.
Varnish will not (and can not) re-use old cache if you use <tt class="docutils literal"><span class="pre">-s</span>
<span class="pre">file</span></tt>.</p>
<p>While <cite>malloc</cite> will use swap to store data to disk, <cite>file</cite> will use
memory to cache the data instead. Varnish allow you to choose
between the two because the performance of the two approaches have
varied historically.</p>
<p>The persistent storage backend is similar to file, but
experimental. It does not yet gracefully
handle situations where you run out of space. We only recommend
using persistent if you have a large amount of data that you must
cache and are prepared to work with us to track down bugs.</p>
<p>When choosing storage backend, the rule of thumb is to use malloc
if your cache will be contained entirely or mostly in memory, while
the file storage backend performs far better when you need a large
cache that exceeds the physical memory available. This might vary
based on the kernel you use, but seems to be the case for 2.6.18
and later Linux kernel, in addition to FreeBSD.</p>
<p>It is important to keep in mind that the size you specify with the
<tt class="docutils literal"><span class="pre">-s</span></tt> argument is the size for the actual cache. Varnish has an
overhead on top of this for keeping track of the cache, so the
actual memory footprint of Varnish will exceed what the &#8216;-s&#8217;
argument specifies if the cache is full. The current estimate
(subject to change on individual Varnish-versions) is that about
1kB of overhead needed for each object. For 1 million objects, that
means 1GB extra memory usage.</p>
<p>In addition to the per-object overhead, there is also a fairly
static overhead which you can calculate by starting Varnish without
any objects. Typically around 100MB.</p>
</div>
</div>
<div class="section" id="the-shared-memory-log">
<h2><a class="toc-backref" href="#id28">3.3&nbsp;&nbsp;&nbsp;The shared memory log</a><a class="headerlink" href="#the-shared-memory-log" title="Permalink to this headline">¶</a></h2>
<p>Varnish&#8217; shared memory log is used to log most data. It&#8217;s sometimes called
a shm-log, and operates on a round-robin capacity.</p>
<p>There&#8217;s not much you have to do with the shared memory log, except ensure
that it does not cause I/O. This is easily accomplished by putting it on a
tmpfs.</p>
<div class="handout container">
<p>This is typically done in &#8216;/etc/fstab&#8217;, and the shmlog is normally kept
in &#8216;/var/lib/varnish&#8217; or equivalent locations. All the content in that
directory is safe to delete.</p>
<p>The shared memory log is not persistent, so do not expect it to contain
any real history.</p>
<p>The typical size of the shared memory log is 80MB. If you want to see
old log entries, not just real-time, you can use the <tt class="docutils literal"><span class="pre">-d</span></tt> argument for
<cite>varnishlog</cite>: <tt class="docutils literal"><span class="pre">varnishlog</span> <span class="pre">-d</span></tt>.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Some packages will use <tt class="docutils literal"><span class="pre">-s</span> <span class="pre">file</span></tt> by default with a path that puts
the storage file in the same directory as the shmlog. You want to
avoid this.</p>
</div>
</div>
</div>
<div class="section" id="tunable-parameters">
<h2><a class="toc-backref" href="#id29">3.4&nbsp;&nbsp;&nbsp;Tunable parameters</a><a class="headerlink" href="#tunable-parameters" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p class="first">In the CLI:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">param</span><span class="o">.</span><span class="n">show</span> <span class="o">-</span><span class="n">l</span>
</pre></div>
</div>
</li>
<li><p class="first">Don&#8217;t fall for the copy/paste tips</p>
</li>
<li><p class="first">Test the parameters in CLI, then store them in the configuration file</p>
</li>
</ul>
<div class="handout container">
<p>Varnish has many different parameters which can be adjusted to make
Varnish act better under specific workloads or with specific software and
hardware setups. They can all be viewed with <tt class="docutils literal"><span class="pre">param.show</span></tt> in the
management interface and set with the <tt class="docutils literal"><span class="pre">-p</span></tt> option passed to
Varnish - or directly in the management interface.</p>
<p>Remember that changes made in the management interface are not stored
anywhere, so unless you store your changes in a startup script, they will
be lost when Varnish restarts.</p>
<p>The general advice with regards to parameters is to keep it simple. Most
of the defaults are very good, and even though they might give a small
boost to performance, it&#8217;s generally better to use safe defaults if you
don&#8217;t have a very specific need.</p>
<p>A few hidden commands exist in the CLI, which can be revealed with
<tt class="docutils literal"><span class="pre">help</span> <span class="pre">-d</span></tt>. These are meant exclusively for development or
testing, and many of them are downright dangerous. They are hidden
for a reason, and the only exception is perhaps <tt class="docutils literal"><span class="pre">debug.health</span></tt>,
which is somewhat common to use.</p>
</div>
</div>
<div class="section" id="threading-model">
<h2><a class="toc-backref" href="#id30">3.5&nbsp;&nbsp;&nbsp;Threading model</a><a class="headerlink" href="#threading-model" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>The child process runs multiple threads</li>
<li>Worker threads are the bread and butter of the Varnish architecture</li>
<li>Utility-threads</li>
<li>Balance</li>
</ul>
<div class="handout container">
<p>The child process of Varnish is where the magic takes place. It consists
of several distinct threads performing different tasks. The following
table lists some interesting threads, to give you an idea of what goes
on. The table is not complete.</p>
<table border="1" class="docutils">
<colgroup>
<col width="23%" />
<col width="41%" />
<col width="36%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Thread-name</th>
<th class="head">Amount of threads</th>
<th class="head">Task</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>cache-worker</td>
<td>One per active connection</td>
<td>Handle requests</td>
</tr>
<tr class="row-odd"><td>cache-main</td>
<td>One</td>
<td>Startup</td>
</tr>
<tr class="row-even"><td>ban lurker</td>
<td>One</td>
<td>Clean bans</td>
</tr>
<tr class="row-odd"><td>acceptor</td>
<td>One</td>
<td>Accept new connections</td>
</tr>
<tr class="row-even"><td>epoll/kqueue</td>
<td>Configurable, default: 2</td>
<td>Manage thread pools</td>
</tr>
<tr class="row-odd"><td>expire</td>
<td>One</td>
<td>Remove old content</td>
</tr>
<tr class="row-even"><td>backend poll</td>
<td>One per backend poll</td>
<td>Health checks</td>
</tr>
</tbody>
</table>
<p>Most of the time, we only deal with the cache-worker threads when
configuring Varnish. With the exception of the amount of thread pools,
all the other threads are not configurable.</p>
<p>For tuning Varnish, you need to think about your expected traffic. The
thread model allows you to use multiple thread pools, but time and
experience has shown that as long as you have 2 thread pools, adding
more will not increase performance.</p>
<p>The most important thread setting is the number of worker threads.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you run across tuning advice that suggests running one thread pool
for each CPU core, rest assured that this is old advice. Experiments
and data from production environments have revealed that as long as
you have two thread pools (which is the default), there is nothing to
gain by increasing the number of thread pools.</p>
</div>
</div>
</div>
<div class="section" id="threading-parameters">
<h2><a class="toc-backref" href="#id31">3.6&nbsp;&nbsp;&nbsp;Threading parameters</a><a class="headerlink" href="#threading-parameters" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Thread pools can safely be ignored</li>
<li>Maximum: Roughly 5000 (total)</li>
<li>Start them sooner rather than later</li>
<li>Maximum and minimum values are per thread pool</li>
</ul>
<dl class="class">
<dt>
<em class="property">class </em><tt class="descname">handout</tt></dt>
<dd></dd></dl>

<div class="section" id="details-of-threading-parameters">
<h3><a class="toc-backref" href="#id32">3.6.1&nbsp;&nbsp;&nbsp;Details of threading parameters</a><a class="headerlink" href="#details-of-threading-parameters" title="Permalink to this headline">¶</a></h3>
<p>While most parameters can be left to the defaults, the exception
is the number of threads.</p>
<p>Varnish will use one thread for each session and the number of
threads you let Varnish use is directly proportional to how many
requests Varnish can serve concurrently.</p>
<p>The available parameters directly related to threads are:</p>
<table border="1" class="docutils">
<colgroup>
<col width="41%" />
<col width="59%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Parameter</th>
<th class="head">Default value</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>thread_pool_add_delay</td>
<td>2 [milliseconds]</td>
</tr>
<tr class="row-odd"><td>thread_pool_add_threshold</td>
<td>2 [requests]</td>
</tr>
<tr class="row-even"><td>thread_pool_fail_delay</td>
<td>200 [milliseconds]</td>
</tr>
<tr class="row-odd"><td>thread_pool_max</td>
<td>500 [threads]</td>
</tr>
<tr class="row-even"><td>thread_pool_min</td>
<td>5 [threads]</td>
</tr>
<tr class="row-odd"><td>thread_pool_purge_delay</td>
<td>1000 [milliseconds]</td>
</tr>
<tr class="row-even"><td>thread_pool_stack</td>
<td>65536 [bytes]</td>
</tr>
<tr class="row-odd"><td>thread_pool_timeout</td>
<td>300 [seconds]</td>
</tr>
<tr class="row-even"><td>thread_pools</td>
<td>2 [pools]</td>
</tr>
<tr class="row-odd"><td>thread_stats_rate</td>
<td>10 [requests]</td>
</tr>
</tbody>
</table>
<p>Among these, <tt class="docutils literal"><span class="pre">thread_pool_min</span></tt> and <tt class="docutils literal"><span class="pre">thread_pool_max</span></tt> are most
important. The <tt class="docutils literal"><span class="pre">thread_pools</span></tt> parameter is also of some importance, but
mainly because it is used to calculate the final number of threads.</p>
<p>Varnish operates with multiple pools of threads. When a connection is
accepted, the connection is delegated to one of these thread pools. The
thread pool will further delegate the connection to available thread if one
is available, put the connection on a queue if there are no available
threads or drop the connection if the queue is full. By default, Varnish
uses 2 thread pools, and this has proven sufficient for even the most busy
Varnish server.</p>
<p>For the sake of keeping things simple, the current best practice is to
leave thread_pools at the default 2 [pools].</p>
<dl class="class">
<dt>
<em class="property">class </em><tt class="descname">handout</tt></dt>
<dd></dd></dl>

</div>
<div class="section" id="number-of-threads">
<h3><a class="toc-backref" href="#id33">3.6.2&nbsp;&nbsp;&nbsp;Number of threads</a><a class="headerlink" href="#number-of-threads" title="Permalink to this headline">¶</a></h3>
<p>Varnish has the ability to spawn new worker threads on demand, and remove
them once the load is reduced. This is mainly intended for traffic spikes.
It&#8217;s a better approach to try to always keep a few threads idle during
regular traffic than it is to run on a minimum amount of threads and
constantly spawn and destroy threads as demand changes. As long as you are
on a 64-bit system, the cost of running a few hundred threads extra is very
limited.</p>
<p>The <tt class="docutils literal"><span class="pre">thread_pool_min</span></tt> parameter defines how many threads will be running
for each thread pool even when there is no load. <tt class="docutils literal"><span class="pre">thread_pool_max</span></tt>
defines the maximum amount of threads that will be used per thread pool.</p>
<p>The defaults of a minimum of 5 [threads] and maximum
500 [threads] threads per thread pool and
2 [pools] will result in:</p>
<ul class="simple">
<li>At any given time, at least 5 [threads] *
2 [pools] worker threads will be running</li>
<li>No more than 500 [threads] * 2 [pools] threads
will run.</li>
</ul>
<p>We rarely recommend running with more than 5000 threads. If you seem to
need more than 5000 threads, it&#8217;s very likely that there is something not
quite right about your setup, and you should investigate elsewhere before
you increase the maximum value.</p>
<p>For minimum, it&#8217;s common to operate with 500 to 1000 threads minimum
(total). You can observe if this is enough through varnishstat, by looking
at the <cite>N queued work requests</cite> (<tt class="docutils literal"><span class="pre">n_wrk_queued</span></tt>) counter over time. It
should be fairly static after startup.</p>
<dl class="class">
<dt>
<em class="property">class </em><tt class="descname">handout</tt></dt>
<dd></dd></dl>

</div>
<div class="section" id="timing-thread-growth">
<h3><a class="toc-backref" href="#id34">3.6.3&nbsp;&nbsp;&nbsp;Timing thread growth</a><a class="headerlink" href="#timing-thread-growth" title="Permalink to this headline">¶</a></h3>
<p>Varnish can use several thousand threads, and has had this capability from
the very beginning. Not all operating system kernels were prepared to deal
with this, though, so the parameter <tt class="docutils literal"><span class="pre">thread_pool_add_delay</span></tt> was added
which ensures that there is a small delay between each thread that spawns.
As operating systems have matured, this has become less important and the
default value of <tt class="docutils literal"><span class="pre">thread_pool_add_delay</span></tt> has been reduced dramatically,
from 20ms to 2ms.</p>
<p>There are a few, less important parameters related to thread timing. The
<tt class="docutils literal"><span class="pre">thread_pool_timeout</span></tt> is how long a thread is kept around when there is
no work for it before it is removed. This only applies if you have more
threads than the minimum, and is rarely changed.</p>
<p>Another less important parameter is the <tt class="docutils literal"><span class="pre">thread_pool_fail_delay</span></tt>, which defines how long to wait
after the operating system denied us a new thread before we try again.</p>
</div>
</div>
<div class="section" id="system-parameters">
<h2><a class="toc-backref" href="#id35">3.7&nbsp;&nbsp;&nbsp;System parameters</a><a class="headerlink" href="#system-parameters" title="Permalink to this headline">¶</a></h2>
<p>As Varnish has matured, fewer and fewer parameters require tuning. The
<tt class="docutils literal"><span class="pre">sess_workspace</span></tt> is one of the parameters that could still pose a
problem.</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">sess_workspace</span></tt> - incoming HTTP header workspace (from client)</li>
<li>Common values range from the default of 65536 [bytes] to 10MB</li>
<li>ESI typically requires exponential growth</li>
<li>Remember: It&#8217;s all virtual - not physical memory.</li>
</ul>
<div class="handout container">
<p>Workspaces are some of the things you can change with parameters. The
session workspace is how much memory is allocated to each HTTP session for
tasks like string manipulation of incoming headers. It is also
used to modify the object returned from a web server before the
precise size is allocated and the object is stored read-only.</p>
<p>Some times you may have to increase the session workspace to avoid
running out of workspace.</p>
<p>As most of the parameters can be left unchanged, we will not go through
all of them, but take a look at the list <tt class="docutils literal"><span class="pre">param.show</span></tt> gives you
to get an impression of what they can do.</p>
</div>
</div>
<div class="section" id="timers">
<h2><a class="toc-backref" href="#id36">3.8&nbsp;&nbsp;&nbsp;Timers</a><a class="headerlink" href="#timers" title="Permalink to this headline">¶</a></h2>
<table border="1" class="docutils">
<colgroup>
<col width="27%" />
<col width="32%" />
<col width="28%" />
<col width="13%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Parameter</th>
<th class="head">Default</th>
<th class="head">Description</th>
<th class="head">Scope</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>connect_timeout</td>
<td>0.700000 [s]</td>
<td>OS/network latency</td>
<td>Backend</td>
</tr>
<tr class="row-odd"><td>first_byte_timeout</td>
<td>60.000000 [s]</td>
<td>Page generation?</td>
<td>Backend</td>
</tr>
<tr class="row-even"><td>between_bytes_timeout</td>
<td>60.000000 [s]</td>
<td>Hiccoughs?</td>
<td>Backend</td>
</tr>
<tr class="row-odd"><td>send_timeout</td>
<td>60 [seconds]</td>
<td>Client-in-tunnel</td>
<td>Client</td>
</tr>
<tr class="row-even"><td>sess_timeout</td>
<td>5 [seconds]</td>
<td>keep-alive timeout</td>
<td>Client</td>
</tr>
<tr class="row-odd"><td>cli_timeout</td>
<td>10 [seconds]</td>
<td>Management thread-&gt;child</td>
<td>Management</td>
</tr>
</tbody>
</table>
<div class="handout container">
<p>The timeout-parameters are generally set to pretty good defaults, but
you might have to adjust them for unusual applications. The connection
timeout is tuned for a geographically close web server, and might have to
be increased if your Varnish server and web server are not close.</p>
<p>Keep in mind that the session timeout affects how long sessions are kept
around, which in turn affects file descriptors left open. It is not wise to
increase the session timeout without taking this into consideration.</p>
<p>The <tt class="docutils literal"><span class="pre">cli_timeout</span></tt> is how long the management thread waits for the worker
thread to reply before it assumes it is dead, kills it and starts it back
up. The default value seems to do the trick for most users today.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The <tt class="docutils literal"><span class="pre">connect_timeout</span></tt> is 0.700000 [s] by default.
This is more than enough time for the typical setup where
Varnish talks to a backend in the same server room - but it may
be too short if Varnish is using a remote backend which may have
more latency. If this is set too high, it will not let Varnish
handle errors gracefully.</p>
<p class="last">An other use-case for increasing <tt class="docutils literal"><span class="pre">connect_timeout</span></tt> occurs when
virtual machines are involved in the stack, as they can increase
the connection time significantly.</p>
</div>
</div>
</div>
<div class="section" id="exercise-tune-first-byte-timeout">
<h2><a class="toc-backref" href="#id37">3.9&nbsp;&nbsp;&nbsp;Exercise: Tune first_byte_timeout</a><a class="headerlink" href="#exercise-tune-first-byte-timeout" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Create a small CGI script in /usr/lib/cgi-bin/test.cgi containing:</p>
<div class="highlight-python"><pre>#! /bin/sh
sleep 5
echo "Content-type: text/plain"
echo "Cache-control: max-age=0"
echo
echo "Hello world"
date</pre>
</div>
</li>
<li><p class="first">Make it executable.</p>
</li>
<li><p class="first">Test that it works outside of Varnish.</p>
</li>
<li><p class="first">Start Varnish, test that it works through Varnish.</p>
</li>
<li><p class="first">Set <tt class="docutils literal"><span class="pre">first_byte_timeout</span></tt> to 2s.</p>
</li>
<li><p class="first">Check that it doesn&#8217;t work.</p>
</li>
</ol>
</div>
<div class="section" id="exercise-configure-threading">
<h2><a class="toc-backref" href="#id38">3.10&nbsp;&nbsp;&nbsp;Exercise: Configure threading</a><a class="headerlink" href="#exercise-configure-threading" title="Permalink to this headline">¶</a></h2>
<p>While performing this exercise, watch the <cite>n_wrk</cite> counter in
<tt class="docutils literal"><span class="pre">varnishstat</span></tt> to determine the number of threads that are running.</p>
<ol class="arabic simple">
<li>Start Varnish.</li>
<li>Change the <tt class="docutils literal"><span class="pre">thread_pool_min</span></tt> and <tt class="docutils literal"><span class="pre">thread_pool_max</span></tt> parameters to get.
100 threads running at any given time, but never more than 400.</li>
<li>Make the changes work across restarts of Varnish.</li>
</ol>
<p>Extra: Experiment with <tt class="docutils literal"><span class="pre">thread_pool_add_delay</span></tt> and
<tt class="docutils literal"><span class="pre">thread_pool_timeout</span></tt> while watching <tt class="docutils literal"><span class="pre">varnishstat</span></tt> to see how thread
creation and destruction is affected. Does <tt class="docutils literal"><span class="pre">thread_pool_timeout</span></tt> affect
already running threads?</p>
<div class="handout container">
<p>You can also try changing the <tt class="docutils literal"><span class="pre">thread_pool_stack</span></tt> variable to a low
value. This will only affect new threads, but try to find out how low
you can set it, and what happens if it&#8217;s too low.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It&#8217;s not common to modify <tt class="docutils literal"><span class="pre">thread_pool_stack</span></tt>,
<tt class="docutils literal"><span class="pre">thread_pool_add_delay</span></tt> or <tt class="docutils literal"><span class="pre">thread_pool_timeout</span></tt>. These extra
assignments are for educational purposes, and not intended as an
encouragement to change the values.</p>
</div>
</div>
</div>
</div>
<div class="section" id="http">
<h1><a class="toc-backref" href="#id39">4&nbsp;&nbsp;&nbsp;HTTP</a><a class="headerlink" href="#http" title="Permalink to this headline">¶</a></h1>
<p><em>This chapter is for the webdeveloper course only</em></p>
<p>This chapter covers:</p>
<ul class="simple">
<li>Protocol basics</li>
<li>Requests and responses</li>
<li>HTTP request/response control flow</li>
<li>Statelessness and idempotence</li>
<li>Cache related headers</li>
</ul>
<div class="handout container">
<p>HTTP is at the heart of Varnish, or rather the model HTTP represents.</p>
<p>This chapter will cover the basics of HTTP as a protocol, how it&#8217;s used
in the wild, and delve into caching as it applies to HTTP.</p>
</div>
<div class="section" id="protocol-basics">
<h2><a class="toc-backref" href="#id40">4.1&nbsp;&nbsp;&nbsp;Protocol basics</a><a class="headerlink" href="#protocol-basics" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Hyper-Text Transfer Protocol, HTTP, is at the core of the web</li>
<li>Specified by the IETF, the latest version (HTTP/1.1) is available from
<a class="reference external" href="http://tools.ietf.org/html/rfc2616">http://tools.ietf.org/html/rfc2616</a></li>
<li>A request consists of a request method, headers and an optional request
body.</li>
<li>A response consists of a response status, headers and an optional
response body.</li>
<li>Multiple requests can be sent over a single connection, in serial.</li>
<li>Clients will open multiple connections to fetch resources in parallel.</li>
</ul>
<div class="handout container">
<p>HTTP is a networking protocol for distributed systems. It is the foundation of
data communication for the Web. The development of this standard is done by the
IETF and the W3C. The latest version of the standard is HTTP/1.1.</p>
<p>A new version of HTTP called HTTP bis is under development, you can follow
the work document at <a class="reference external" href="http://datatracker.ietf.org/wg/httpbis/charter/">http://datatracker.ietf.org/wg/httpbis/charter/</a>.
Basically HTTP bis will be HTTP/1.1 with new features for example a better
caching of web pages.</p>
</div>
</div>
<div class="section" id="requests">
<h2><a class="toc-backref" href="#id41">4.2&nbsp;&nbsp;&nbsp;Requests</a><a class="headerlink" href="#requests" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Standard request methods are: <cite>GET</cite>, <cite>POST</cite>, <cite>HEAD</cite>, <cite>OPTIONS</cite>, <cite>PUT</cite>,
<cite>DELETE</cite>, <cite>TRACE</cite>, or <cite>CONNECT</cite>.</li>
<li>This is followed by a URI, e.g:  <cite>/img/image.png</cite> or <cite>/index.html</cite></li>
<li>Usually followed by the HTTP version</li>
<li>A new-line (CRLF), followed by an arbitrary amount of CRLF-separated
headers (<cite>Accept-Language</cite>, <cite>Cookie</cite>, <cite>Host</cite>, <cite>User-Agent</cite>, etc).</li>
<li>A single empty line, ending in CRLF.</li>
<li>An optional message body, depending on the request method.</li>
</ul>
<div class="handout container">
<p>Each request has the same, strict and fairly simple pattern. A request
method informs the web server what sort of request this is: Is the
client trying to fetch a resource (<cite>GET</cite>), or update some data(<cite>POST</cite>)?
Or just get the headers of a resource (<cite>HEAD</cite>)?</p>
<p>There are strict rules that apply to the request methods. For instance,
a <cite>GET</cite> request can not contain a request body, but a <cite>POST</cite> request
can.</p>
<p>Similarly, a web server can not attach a request body to a response to a
<cite>HEAD</cite> body.</p>
</div>
</div>
<div class="section" id="request-example">
<h2><a class="toc-backref" href="#id42">4.3&nbsp;&nbsp;&nbsp;Request example</a><a class="headerlink" href="#request-example" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>GET / HTTP/1.1
Host: localhost
User-Agent: Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10.5; fr; rv:1.9.2.16) Gecko/20110319 Firefox/3.6.16
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: fr,fr-fr;q=0.8,en-us;q=0.5,en;q=0.3
Accept-Encoding: gzip,deflate
Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7
Keep-Alive: 115
Connection: keep-alive
Cache-Control: max-age=0</pre>
</div>
<div class="handout container">
<p>The above is a typical HTTP <cite>GET</cite> request for the <tt class="docutils literal"><span class="pre">/</span></tt> resource.</p>
<p>Note that the <tt class="docutils literal"><span class="pre">Host</span></tt>-header contains the hostname as seen by the
browser. The above request was generated by entering <a class="reference external" href="http://localhost/">http://localhost/</a>
in the browser. The browser automatically adds a number of headers. Some
of these will vary depending on language settings, others will vary
depending on whether the client has a cached copy of the page already,
or if the client is doing a refresh or forced refresh.</p>
<p>Whether the server honors these headers will depend on both the server
in question and the specific header.</p>
<p>The following is an example of a HTTP request using the <cite>POST</cite> method,
which includes a request body:</p>
<div class="highlight-python"><pre>POST /accounts/ServiceLoginAuth HTTP/1.1
Host: www.google.com
User-Agent: Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10.5; fr; rv:1.9.2.16) Gecko/20110319 Firefox/3.6.16
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: fr,fr-fr;q=0.8,en-us;q=0.5,en;q=0.3
Accept-Encoding: gzip,deflate
Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7
Keep-Alive: 115
Connection: keep-alive
Referer: https://www.google.com/accounts/ServiceLogin
Cookie: GoogleAccountsLocale_session=en;[...]
Content-Type: application/x-www-form-urlencoded
Content-Length: 288

ltmpl=default[...]&amp;signIn=Sign+in&amp;asts=</pre>
</div>
</div>
</div>
<div class="section" id="response">
<h2><a class="toc-backref" href="#id43">4.4&nbsp;&nbsp;&nbsp;Response</a><a class="headerlink" href="#response" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>HTTP/1.1 200 OK
Cache-Control: max-age=150
Content-Length: 150

[data]</pre>
</div>
<ul class="simple">
<li>A HTTP response contains the HTTP versions, response code(e.g: 200)  and response
message (e.g: OK).</li>
<li>CRLF as line separator</li>
<li>A number of headers</li>
<li>Headers are terminated with a blank line.</li>
<li>Optional response body</li>
</ul>
<div class="handout container">
<p>The HTTP response is similar to the request itself. The response code
informs the browser both whether the request succeeded and what type of
response this is. The response message is a text-representation of the
same information, and is often ignored by the browser itself.</p>
<p>Examples of status codes are <cite>200 OK</cite>, <cite>404 File Not Found</cite>, <cite>304 Not
Modified</cite> and so fort. They are all defined in the HTTP standard, and
grouped into the following categories:</p>
<ul class="simple">
<li>1xx: Informational - Request received, continuing process</li>
<li>2xx: Success - The action was successfully received, understood, and
accepted</li>
<li>3xx: Redirection - Further action must be taken in order to complete
the request</li>
<li>4xx: Client Error - The request contains bad syntax or cannot be
fulfilled</li>
<li>5xx: Server Error - The server failed to fulfill an apparently valid
request</li>
</ul>
</div>
</div>
<div class="section" id="response-example">
<h2><a class="toc-backref" href="#id44">4.5&nbsp;&nbsp;&nbsp;Response example</a><a class="headerlink" href="#response-example" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>HTTP/1.1 200 OK
Server: Apache/2.2.14 (Ubuntu)
X-Powered-By: PHP/5.3.2-1ubuntu4.7
Cache-Control: public, max-age=86400
Last-Modified: Mon, 04 Apr 2011 04:13:41 +0000
Expires: Sun, 11 Mar 1984 12:00:00 GMT
Vary: Cookie,Accept-Encoding
ETag: "1301890421"
Content-Type: text/html; charset=utf-8
Content-Length: 23562
Date: Mon, 04 Apr 2011 09:02:26 GMT
X-Varnish: 1886109724 1886107902
Age: 17324
Via: 1.1 varnish
Connection: keep-alive

(data)</pre>
</div>
</div>
<div class="section" id="http-request-response-control-flow">
<h2><a class="toc-backref" href="#id45">4.6&nbsp;&nbsp;&nbsp;HTTP request/response control flow</a><a class="headerlink" href="#http-request-response-control-flow" title="Permalink to this headline">¶</a></h2>
<img alt="_images/httprequestflow.png" class="align-center" src="_images/httprequestflow.png" style="width: 80%;" />
<p>The client sends an HTTP request to the server which returns an HTTP response
with the message body.</p>
</div>
<div class="section" id="statelesness-and-idempotence">
<h2><a class="toc-backref" href="#id46">4.7&nbsp;&nbsp;&nbsp;Statelesness and idempotence</a><a class="headerlink" href="#statelesness-and-idempotence" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt><strong>statelesness</strong></dt>
<dd>HTTP is by definition a stateless protocol which means that in theory
your browser has to reconnect to the server for every request. In practice
there is a header called <cite>Keep-Alive</cite> you may use if you want to keep the
connection open between the client (your browser) and the server.</dd>
<dt><strong>idempotence</strong></dt>
<dd>Imdempotence means that an operation can be applied multiple times without
changing the result. <cite>GET</cite> and <cite>PUT</cite> HTTP request are expected to be
idempotent whereas <cite>POST</cite> requests are not. In other words, you can not
cache <cite>POST</cite> HTTP responses.</dd>
</dl>
<div class="handout container">
For more discussion about idempotence
<a class="reference external" href="http://queue.acm.org/detail.cfm?id=2187821">http://queue.acm.org/detail.cfm?id=2187821</a>.</div>
</div>
<div class="section" id="cache-related-headers">
<h2><a class="toc-backref" href="#id47">4.8&nbsp;&nbsp;&nbsp;Cache related headers</a><a class="headerlink" href="#cache-related-headers" title="Permalink to this headline">¶</a></h2>
<p>HTTP provides a list of headers dedicated to page caching and cache
invalidation. The most important ones are :</p>
<ul class="simple">
<li>Expires</li>
<li>Cache-Control</li>
<li>Etag</li>
<li>Last-Modified</li>
<li>If-Modified-Since</li>
<li>If-None-Match</li>
<li>Vary</li>
<li>Age</li>
</ul>
</div>
<div class="section" id="exercise-test-various-cache-headers">
<h2><a class="toc-backref" href="#id48">4.9&nbsp;&nbsp;&nbsp;Exercise : Test various Cache headers</a><a class="headerlink" href="#exercise-test-various-cache-headers" title="Permalink to this headline">¶</a></h2>
<p>Before we talk about all the various cache headers and cache mechanisms, we
will use <cite>httpheadersexample.php</cite> to experiment and get a sense of what
it&#8217;s all about.</p>
<p>Try both clicking the links twice, hitting refresh and forced refresh
(usually done by hitting control-F5, depending on browser).</p>
<ol class="arabic simple">
<li>Try out the Expires-header and see how the browser and Varnish behave.</li>
<li>What happens when both Expires and Cache-Control is present?</li>
<li>Test the <cite>If-Modified-Since</cite> request too. Does the browser issue a
request to Varnish? If the item was in cache, does Varnish query the
web-server?</li>
<li>Try the <cite>Vary</cite>-test by using two different browsers at the same time.</li>
</ol>
<div class="handout container">
<p>When performing this exercise, try to see if you can spot the patterns.
There are many levels of cache on the Web, and you have to think about
more than just Varnish.</p>
<p>If it hasn&#8217;t already, it&#8217;s likely that browser cache will confuse you at
least a few times through this course. When that happens, pull up
varnishlog or another browser.</p>
</div>
</div>
<div class="section" id="expires">
<h2><a class="toc-backref" href="#id49">4.10&nbsp;&nbsp;&nbsp;Expires</a><a class="headerlink" href="#expires" title="Permalink to this headline">¶</a></h2>
<p>The <cite>Expires</cite> <strong>response</strong> header field gives the date/time after which the
response is considered stale. A stale cache item will not be returned by
any cache (proxy cache or client cache).</p>
<p>The syntax for this header is:</p>
<div class="highlight-python"><pre>Expires: GMT formatted date</pre>
</div>
<p>It is recommended not to define <cite>Expires</cite> too far in the future. Setting it
to 1 year is usually enough.</p>
<p>Using <cite>Expires</cite> does not prevent the cached resource to be updated. If a
resource is updated changing its name (by using a version number for
instance) is possible.</p>
<p><cite>Expires</cite> works best for any file that is part of your design like
JavaScripts stylesheets or images.</p>
</div>
<div class="section" id="cache-control">
<h2><a class="toc-backref" href="#id50">4.11&nbsp;&nbsp;&nbsp;Cache-Control</a><a class="headerlink" href="#cache-control" title="Permalink to this headline">¶</a></h2>
<p>The <cite>Cache-Control</cite> header field specifies directives that <strong>must</strong> be
applied by all caching mechanisms (from proxy cache to browser cache).
<cite>Cache-Control</cite> accepts the following arguments (only the most relevant are
described):</p>
<ul class="simple">
<li><cite>public</cite>: The response may be cached by any cache.</li>
<li><cite>no-store</cite>: The response body <strong>must not</strong> be stored by any cache
mechanism;</li>
<li><cite>no-cache</cite>: Authorizes a cache mechanism to store the response in its
cache but it <strong>must not</strong> reuse it without validating it with the origin
server first. In order to avoid any confusion with this argument think of
it as a &#8220;store-but-do-no-serve-from-cache-without-revalidation&#8221;
instruction.</li>
<li><cite>max-age</cite>: Specifies the period in seconds during which the cache will be
considered fresh;</li>
<li><cite>s-maxage</cite>: Like <cite>max-age</cite> but it applies only to public caches;</li>
<li><cite>must-revalidate</cite>: Indicates that a stale cache item can not be serviced
without revalidation with the origin server first;</li>
</ul>
<div class="handout container">
<p>Unlike <cite>Expires</cite>, <cite>Cache-Control</cite> is both a <strong>request</strong> and a <strong>response</strong>
header, here is the list of arguments you may use for each context:</p>
<table border="1" class="docutils">
<colgroup>
<col width="50%" />
<col width="23%" />
<col width="28%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Argument</th>
<th class="head">Request</th>
<th class="head">Response</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><cite>no-cache</cite></td>
<td>X</td>
<td>X</td>
</tr>
<tr class="row-odd"><td><cite>no-store</cite></td>
<td>X</td>
<td>X</td>
</tr>
<tr class="row-even"><td><cite>max-age</cite></td>
<td>X</td>
<td>X</td>
</tr>
<tr class="row-odd"><td><cite>s-maxage</cite></td>
<td>&nbsp;</td>
<td>X</td>
</tr>
<tr class="row-even"><td><cite>max-stale</cite></td>
<td>X</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td><cite>min-fresh</cite></td>
<td>X</td>
<td>&nbsp;</td>
</tr>
<tr class="row-even"><td><cite>no-transform</cite></td>
<td>X</td>
<td>X</td>
</tr>
<tr class="row-odd"><td><cite>only-if-cached</cite></td>
<td>X</td>
<td>&nbsp;</td>
</tr>
<tr class="row-even"><td><cite>public</cite></td>
<td>&nbsp;</td>
<td>X</td>
</tr>
<tr class="row-odd"><td><cite>private</cite></td>
<td>&nbsp;</td>
<td>X</td>
</tr>
<tr class="row-even"><td><cite>must-revalidate</cite></td>
<td>&nbsp;</td>
<td>X</td>
</tr>
<tr class="row-odd"><td><cite>proxy-revalidate</cite></td>
<td>&nbsp;</td>
<td>X</td>
</tr>
</tbody>
</table>
<p>Example of a <cite>Cache-Control</cite> header:</p>
<div class="highlight-python"><pre>Cache-Control: public, must-revalidate, max-age=2592000</pre>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>As you might have noticed <cite>Expires</cite> and <cite>Cache-Control</cite> do more or less the
same job, <cite>Cache-Control</cite> gives you more control though. There is a
significant difference between these two headers:</p>
<blockquote class="last">
<div><ul class="simple">
<li><cite>Cache-Control</cite> uses relative times in seconds, cf (s)max-age</li>
<li><cite>Expires</cite> always returns an absolute date</li>
</ul>
</div></blockquote>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Cache-Control <strong>always</strong> overrides Expires.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">By default, Varnish does not care about the Cache-Control
request header.  If you want to let users update the cache
via a force refresh you need to do it yourself.</p>
</div>
</div>
</div>
<div class="section" id="last-modified">
<h2><a class="toc-backref" href="#id51">4.12&nbsp;&nbsp;&nbsp;Last-Modified</a><a class="headerlink" href="#last-modified" title="Permalink to this headline">¶</a></h2>
<p>The <cite>Last-Modified</cite> <strong>response</strong> header field indicates the date and time
at which the origin server believes the variant was last modified. This
headers may be used in conjunction with <cite>If-Modified-Since</cite> and
<cite>If-None-Match</cite>.</p>
<p>Example of a <cite>Last-Modified</cite> header:</p>
<div class="highlight-python"><pre>Last-Modified: Wed, 01 Sep 2004 13:24:52 GMT</pre>
</div>
</div>
<div class="section" id="if-modified-since">
<h2><a class="toc-backref" href="#id52">4.13&nbsp;&nbsp;&nbsp;If-Modified-Since</a><a class="headerlink" href="#if-modified-since" title="Permalink to this headline">¶</a></h2>
<p>The <cite>If-Modified-Since</cite> <strong>request</strong> header field is used with a method to
make it conditional:</p>
<ul class="simple">
<li><strong>if</strong> the requested variant has not been modified since the time
specified in this field, an entity will not be returned from the server;</li>
<li><strong>instead</strong>, a 304 (not modified) response will be returned without any
message-body.</li>
</ul>
<p>Example of an <cite>If-Modified-Since</cite> header:</p>
<div class="highlight-python"><pre>If-Modified-Since: Wed, 01 Sep 2004 13:24:52 GMT</pre>
</div>
<img alt="_images/httpifmodifiedsince.png" class="align-center" src="_images/httpifmodifiedsince.png" style="height: 1235px;" />
</div>
<div class="section" id="if-none-match">
<h2><a class="toc-backref" href="#id53">4.14&nbsp;&nbsp;&nbsp;If-None-Match</a><a class="headerlink" href="#if-none-match" title="Permalink to this headline">¶</a></h2>
<p>The <cite>If-None-Match</cite> <strong>request</strong> header field is used with a method to make
it conditional.</p>
<p>A client that has one or more entities previously obtained from the
resource can verify that none of those entities is current by including a
list of their associated entity tags in the If-None-Match header field.</p>
<p>The purpose of this feature is to allow efficient updates of cached
information with a minimum amount of transaction overhead. It is also used
to prevent a method (e.g. PUT) from inadvertently modifying an existing
resource when the client believes that the resource does not exist.</p>
<p>Example of an <cite>If-None-Match</cite> header :</p>
<div class="highlight-python"><pre>If-None-Match: "1edec-3e3073913b100"</pre>
</div>
<img alt="_images/httpifnonematch.png" class="align-center" src="_images/httpifnonematch.png" style="width: 80%;" />
</div>
<div class="section" id="etag">
<h2><a class="toc-backref" href="#id54">4.15&nbsp;&nbsp;&nbsp;Etag</a><a class="headerlink" href="#etag" title="Permalink to this headline">¶</a></h2>
<p>The <cite>ETag</cite> <strong>response</strong> header field provides the current value of the
entity tag for the requested variant.  The idea behind <cite>Etag</cite> is to provide
a unique value for a resource&#8217;s contents.</p>
<p>Example of an <cite>Etag</cite> header:</p>
<div class="highlight-python"><pre>Etag: "1edec-3e3073913b100"</pre>
</div>
</div>
<div class="section" id="pragma">
<h2><a class="toc-backref" href="#id55">4.16&nbsp;&nbsp;&nbsp;Pragma</a><a class="headerlink" href="#pragma" title="Permalink to this headline">¶</a></h2>
<p>The <cite>Pragma</cite> <strong>request</strong> header is a legacy header and should no longer be used.
Some applications still send headers like <tt class="docutils literal"><span class="pre">Pragma:</span> <span class="pre">no-cache</span></tt> but this is
for backwards compatibility reasons <strong>only</strong>.</p>
<p>Any proxy cache should treat <tt class="docutils literal"><span class="pre">Pragma:</span> <span class="pre">no-cache</span></tt> as <tt class="docutils literal"><span class="pre">Cache-Control:</span>
<span class="pre">no-cache</span></tt>, and should not be seen as a reliable header especially when
used as a response header.</p>
</div>
<div class="section" id="vary">
<h2><a class="toc-backref" href="#id56">4.17&nbsp;&nbsp;&nbsp;Vary</a><a class="headerlink" href="#vary" title="Permalink to this headline">¶</a></h2>
<p>The <cite>Vary</cite> <strong>response</strong> header indicates the response returned by the origin
server may vary depending on headers received in the request.</p>
<p>The most common usage of <cite>Vary</cite> is to use <tt class="docutils literal"><span class="pre">Vary:</span> <span class="pre">Accept-Encoding</span></tt>, which
tells caches (Varnish included) that the content might look different
depending on the <cite>Accept-Encoding</cite>-header the client sends. In other words:
The page can be delivered compressed or uncompressed depending on the
client.</p>
<div class="handout container">
<p>The <cite>Vary</cite>-header is one of the trickiest headers to deal with for a
cache. A cache, like Varnish, does not necessarily understand the
semantics of a header, or what part triggers different variants of a
page.</p>
<p>As a result, using <tt class="docutils literal"><span class="pre">Vary:</span> <span class="pre">User-Agent</span></tt> for instance tells a cache that
for ANY change in the <cite>User-Agent</cite>-header, the content <cite>might</cite> look
different. Since there are probably thousands of <cite>User-Agent</cite> strings
out there, this means you will drastically reduce the efficiency of any
cache method.</p>
<p>An other example is using <tt class="docutils literal"><span class="pre">Vary:</span> <span class="pre">Cookie</span></tt> which is actually not a bad
idea. Unfortunately, you can&#8217;t issue <tt class="docutils literal"><span class="pre">Vary:</span> <span class="pre">Cookie(but</span> <span class="pre">only</span> <span class="pre">THESE</span>
<span class="pre">cookies:</span> <span class="pre">...)</span></tt>. And since a client will send you a great deal of
cookies, this means that just using <tt class="docutils literal"><span class="pre">Vary:</span> <span class="pre">Cookie</span></tt> is not necessarily
sufficient. We will discuss this further in the Content Composition
chapter.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">From Varnish version 3, Varnish handles <cite>Accept-Encoding</cite> and <tt class="docutils literal"><span class="pre">Vary:</span>
<span class="pre">Accept-Encoding</span></tt> for you. This is because Varnish 3 has support for
gzip compression. In Varnish 2 it was necessary to normalize the
<cite>Accept-Encoding</cite>-header, but this is redundant in Varnish 3.</p>
</div>
</div>
</div>
<div class="section" id="age">
<h2><a class="toc-backref" href="#id57">4.18&nbsp;&nbsp;&nbsp;Age</a><a class="headerlink" href="#age" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>A cache server can send an additional response header, <cite>Age</cite>, to indicate
the age of the response.</li>
<li>Varnish (and other caches) does this.</li>
<li>Browsers (and Varnish) will use the Age-header to determine how long to
cache.</li>
<li>E.g: for a <cite>max-age</cite>-based equation: cache duration = <cite>max-age</cite> - <cite>Age</cite></li>
<li>If you allow Varnish to cache for a long time, the <cite>Age</cite>-header could
effectively disallow client-side caches.</li>
</ul>
<div class="handout container">
<p>Consider what happens if you let Varnish cache content for a week,
because you can easily invalidate the cache Varnish keeps. If you do not
change the <cite>Age</cite>-header, Varnish will happily inform clients that the
content is, for example, two days old, and that the maximum age should
be no more than fifteen minutes.</p>
<p>Browsers will obey this. They will use the reply, but they will also
realize that it has exceeded its max-age, so they will not cache it.</p>
<p>Varnish will do the same, if your web-server emits and <cite>Age</cite>-header (or
if you put one Varnish-server in front of another).</p>
<p>We will see in later chapters how we can handle this in Varnish.</p>
</div>
</div>
<div class="section" id="header-availability-summary">
<h2><a class="toc-backref" href="#id58">4.19&nbsp;&nbsp;&nbsp;Header availability summary</a><a class="headerlink" href="#header-availability-summary" title="Permalink to this headline">¶</a></h2>
<p>The table below lists HTTP headers seen above and wether they are a request
header or a response one.</p>
<table border="1" class="docutils">
<colgroup>
<col width="50%" />
<col width="24%" />
<col width="26%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Header</th>
<th class="head">Request</th>
<th class="head">Response</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Expires</td>
<td>&nbsp;</td>
<td>X</td>
</tr>
<tr class="row-odd"><td>Cache-Control</td>
<td>X</td>
<td>X</td>
</tr>
<tr class="row-even"><td>Last-Modified</td>
<td>&nbsp;</td>
<td>X</td>
</tr>
<tr class="row-odd"><td>If-Modified-Since</td>
<td>X</td>
<td>&nbsp;</td>
</tr>
<tr class="row-even"><td>If-None-Match</td>
<td>X</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td>Etag</td>
<td>&nbsp;</td>
<td>X</td>
</tr>
<tr class="row-even"><td>Pragma</td>
<td>X</td>
<td>X</td>
</tr>
<tr class="row-odd"><td>Vary</td>
<td>&nbsp;</td>
<td>X</td>
</tr>
<tr class="row-even"><td>Age</td>
<td>&nbsp;</td>
<td>X</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="cache-hit-and-misses">
<h2><a class="toc-backref" href="#id59">4.20&nbsp;&nbsp;&nbsp;Cache-hit and misses</a><a class="headerlink" href="#cache-hit-and-misses" title="Permalink to this headline">¶</a></h2>
<p><strong>cache-hit</strong></p>
<p>There is a cache-hit when Varnish returns a page from its cache instead of
forwarding the request to the origin server.</p>
<img alt="_images/httpcachehit.png" class="align-center" src="_images/httpcachehit.png" style="width: 60%;" />
<p><strong>cache-miss</strong></p>
<p>There is a cache-miss when Varnish has to forward the request to the origin
server so the page can be serviced.</p>
<img alt="_images/httpcachemiss.png" class="align-center" src="_images/httpcachemiss.png" style="width: 60%;" />
</div>
<div class="section" id="exercise-use-article-php-to-test-age">
<h2><a class="toc-backref" href="#id60">4.21&nbsp;&nbsp;&nbsp;Exercise: Use <cite>article.php</cite> to test <cite>Age</cite></a><a class="headerlink" href="#exercise-use-article-php-to-test-age" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>Modify the <cite>article.php</cite>-script to send an Age header that says <cite>30</cite> and
<tt class="docutils literal"><span class="pre">Cache-Control:</span> <span class="pre">max-age=60</span></tt>.</li>
<li>Watch <tt class="docutils literal"><span class="pre">varnishlog</span></tt>.</li>
<li>Send a request to Varnish for <cite>article.php</cite>. See what <cite>Age</cite>-Header
Varnish replies with.</li>
<li>Is the <cite>Age</cite>-header an accurate method to determine if Varnish made a
cache hit or not?</li>
<li>How long does Varnish cache the reply? How long would a browser cache
it?</li>
</ol>
<div class="handout container">
<p>Also consider how you would avoid issues like this to begin with.  We do
not yet know how to modify Varnish&#8217; response headers, but hopefully you
will understand why you may need to do that.</p>
<p>Varnish is not the only part of your web-stack that parses and honors
cache-related headers. The primary consumer of such headers are the web
browsers, and there might also be other caches along the way which you
do not control, like a company-wide proxy server.</p>
<p>By using <cite>s-maxage</cite> instead of <cite>max-age</cite> we limit the number of
consumers to cache servers, but even <cite>s-maxage</cite> will be used by caching
proxies which you do not control.</p>
<p>In the next few chapters, you will learn how to modify the response
headers Varnish sends. That way, your web-server can emit response
headers that are only seen and used by Varnish.</p>
</div>
</div>
</div>
<div class="section" id="vcl-basics">
<h1><a class="toc-backref" href="#id61">5&nbsp;&nbsp;&nbsp;VCL Basics</a><a class="headerlink" href="#vcl-basics" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li>VCL as a state engine</li>
<li>Basic syntax</li>
<li>VCL_recv and VCL_fetch</li>
<li>Regular expressions</li>
</ul>
<div class="handout container">
<p>The Varnish Configuration Language allows you to define your caching
policy. You write VCL code which Varnish will parse, translate to C
code, compile and link to.</p>
<p>The following chapter focuses on the most important tasks you will do in
VCL. Varnish has a number of states that you can hook into with VCL, but
if you master the <tt class="docutils literal"><span class="pre">vcl_fetch</span></tt> and <tt class="docutils literal"><span class="pre">vcl_recv</span></tt> methods, you will be
have covered the vast majority of the actual work you need to do.</p>
<p>VCL is often described as domain specific or a state engine. The domain
specific part of it is that some data is only available in certain
states. For example: You can not access response headers before you&#8217;ve
actually started working on a response.</p>
</div>
<div class="section" id="the-vcl-state-engine">
<h2><a class="toc-backref" href="#id62">5.1&nbsp;&nbsp;&nbsp;The VCL State Engine</a><a class="headerlink" href="#the-vcl-state-engine" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Each request is processed separately.</li>
<li>Each request is independent of any others going on at the same time,
previously or later.</li>
<li>States are related, but isolated.</li>
<li><tt class="docutils literal"><span class="pre">return(x);</span></tt> exits one state and instructs Varnish to proceed to the
next state.</li>
<li>Default VCL code is always present, appended below your own VCL.</li>
</ul>
<div class="handout container">
<p>Before we begin looking at VCL code, it&#8217;s worth trying to understand the
fundamental concepts behind VCL.</p>
<p>When Varnish processes a request, it starts by parsing the request
itself, separating the request method from headers, verifying that it&#8217;s
a valid HTTP request and so on. When this basic parsing has completed,
the very first policy decisions can be done: Should Varnish even attempt
to find this resource in the cache? This decision is left to VCL, more
specifically the <tt class="docutils literal"><span class="pre">vcl_recv</span></tt> method.</p>
<p>If you do not provide any <tt class="docutils literal"><span class="pre">vcl_recv</span></tt> function, the default VCL
function for <tt class="docutils literal"><span class="pre">vcl_recv</span></tt> is executed. But even if you do specify your
own <tt class="docutils literal"><span class="pre">vcl_recv</span></tt> function, the default is still present. Whether it is
executed or not depends on whether your own VCL code terminates that
specific state or not.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>It is strongly advised to let the default VCL run whenever possible.
It is designed with safety in mind, which often means it&#8217;ll handle
any flaws in your VCL in a reasonable manner. It may not cache as
much, but often it&#8217;s better to not cache some content instead of
delivering the wrong content to the wrong user.</p>
<p class="last">There are exceptions, of course, but if you can not understand why
the default VCL does not let you cache some content, it is almost
always worth it to investigate why instead of overriding it.</p>
</div>
</div>
</div>
<div class="section" id="syntax">
<h2><a class="toc-backref" href="#id63">5.2&nbsp;&nbsp;&nbsp;Syntax</a><a class="headerlink" href="#syntax" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>//, # and /* foo */ for comments</li>
<li>sub $name functions</li>
<li>No loops, limited variables</li>
<li>Terminating statements, no return values</li>
<li>Domain-specific</li>
<li>Add as little or as much as you want</li>
</ul>
<div class="handout container">
<p>If you have worked with a programing language or two before, the basic
syntax of Varnish should be reasonably straight forward. It is inspired
mainly by C and Perl.</p>
<p>The functions of VCL are not true functions in the sense that they
accept variables and return values. To send data inside of VCL, you will
have to hide it inside of HTTP headers.</p>
<p>The &#8220;return&#8221; statement of VCL returns control from the VCL state engine
to Varnish. If you define your own function and call it from one of the
default functions, typing &#8220;return(foo)&#8221; will not return execution from
your custom function to the default function, but return execution from
VCL to Varnish. That is why we say that VCL has terminating statements,
not traditional return values.</p>
<p>For each domain, you can return control to Varnish using one or more
different return values. These return statements tell Varnish what to do
next. Examples include &#8220;look this up in cache&#8221;, &#8220;do not look this up in
the cache&#8221; and &#8220;generate an error message&#8221;.</p>
</div>
</div>
<div class="section" id="vcl-request-flow">
<h2><a class="toc-backref" href="#id64">5.3&nbsp;&nbsp;&nbsp;VCL - request flow</a><a class="headerlink" href="#vcl-request-flow" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt>
<em class="property">class </em><tt class="descname">handout</tt></dt>
<dd></dd></dl>

<img alt="_images/vcl.png" class="align-center" src="_images/vcl.png" style="height: 2235px;" />
<dl class="class">
<dt>
<em class="property">class </em><tt class="descname">handout</tt></dt>
<dd></dd></dl>

<div class="section" id="detailed-request-flow">
<h3><a class="toc-backref" href="#id65">5.3.1&nbsp;&nbsp;&nbsp;Detailed request flow</a><a class="headerlink" href="#detailed-request-flow" title="Permalink to this headline">¶</a></h3>
<img alt="_images/request.png" class="align-center" src="_images/request.png" style="height: 2235px;" />
</div>
</div>
<div class="section" id="vcl-functions">
<h2><a class="toc-backref" href="#id66">5.4&nbsp;&nbsp;&nbsp;VCL - functions</a><a class="headerlink" href="#vcl-functions" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>regsub(str, regex, sub)</li>
<li>regsuball(str, regex, sub)</li>
<li>ban_url(regex)</li>
<li>ban(expression)</li>
<li>purge;</li>
<li>return(restart)</li>
<li>return()</li>
<li>hash_data()</li>
</ul>
<div class="handout container">
<p>VCL offers a handful of simple functions that allow you to modify
strings, add bans, restart the VCL state engine and return control
from the VCL Run Time (VRT) environment to Varnish.</p>
<p>You will get to test all of these in detail, so the description is
brief.</p>
<p>regsub() and regsuball() has the same syntax and does the same thing:
They both take a string as input, search it with a regular expression
and replace it with another string. The difference between regsub() and
regsuball() is that the latter changes all occurrences while the former
only affects the first match.</p>
<p><tt class="docutils literal"><span class="pre">ban_url</span></tt> is one of the original ban functions provided, and are
generally not used much. The more flexible <cite>ban()</cite> function can perform
the same task. <tt class="docutils literal"><span class="pre">ban_url(foo)</span></tt> is the equivalent of <tt class="docutils literal"><span class="pre">ban(&quot;req.url</span> <span class="pre">~</span> <span class="pre">&quot;</span>
<span class="pre">foo)</span></tt>: Add a URL, host name excluded, to the ban list. We will go
through purging in detail in later chapters.</p>
<p><tt class="docutils literal"><span class="pre">return(restart)</span></tt> offers a way to re-run the VCL logic, starting at
<tt class="docutils literal"><span class="pre">vcl_recv</span></tt>.  All changes made up until that point are kept and the
<tt class="docutils literal"><span class="pre">req.restarts</span></tt> variable is incremented. The <cite>max_restarts</cite> parameter
defines the maximum number of restarts that can be issued in VCL before
an error is triggered, thus avoiding infinite looping.</p>
<p><tt class="docutils literal"><span class="pre">return()</span></tt> is used when execution of a VCL domain (for example
<tt class="docutils literal"><span class="pre">vcl_recv</span></tt>) is completed and control is returned to Varnish with a
single instruction as to what should happen next. Return values are
<cite>lookup</cite>, <cite>pass</cite>, <cite>pipe</cite>, <cite>hit_for_pass</cite>, <cite>fetch</cite>, <cite>deliver</cite> and <cite>hash</cite>,
but only a limited number of them are available in each VCL domain.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><tt class="docutils literal"><span class="pre">ban_url()</span></tt> uses a regular expression instead of actual string
matching. It will be removed in Varnish 4. You should use <tt class="docutils literal"><span class="pre">ban()</span></tt>
instead.</p>
</div>
</div>
</div>
<div class="section" id="vcl-vcl-recv">
<h2><a class="toc-backref" href="#id67">5.5&nbsp;&nbsp;&nbsp;VCL - <tt class="docutils literal"><span class="pre">vcl_recv</span></tt></a><a class="headerlink" href="#vcl-vcl-recv" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Normalize client-input</li>
<li>Pick a backend web server</li>
<li>Re-write client-data for web applications</li>
<li>Decide caching policy based on client-input</li>
<li>Access control</li>
<li>Security barriers</li>
<li>Fixing mistakes (e.g: <tt class="docutils literal"><span class="pre">index.htlm</span></tt> -&gt; <tt class="docutils literal"><span class="pre">index.html</span></tt>)</li>
</ul>
<div class="handout container">
<p><tt class="docutils literal"><span class="pre">vcl_recv</span></tt> is the first VCL function executed, right after Varnish has
decoded the request into its basic data structure. It has four main uses:</p>
<ol class="arabic simple">
<li>Modifying the client data to reduce cache diversity. E.g., removing any
leading &#8220;www.&#8221; in a URL.</li>
<li>Deciding caching policy based on client data. E.g., Not caching POST
requests, only caching specific URLs, etc</li>
<li>Executing re-write rules needed for specific web applications.</li>
<li>Deciding which Web server to use.</li>
</ol>
<p>In <tt class="docutils literal"><span class="pre">vcl_recv</span></tt> you can perform the following terminating statements:</p>
<p><cite>pass</cite> the cache, executing the rest of the Varnish processing as
normal, but not looking up the content in cache or storing it to cache.</p>
<p><cite>pipe</cite> the request, telling Varnish to shuffle byte between the selected
backend and the connected client without looking at the content. Because
Varnish no longer tries to map the content to a request, any subsequent
request sent over the same keep-alive connection will also be piped, and
not appear in any log.</p>
<p><cite>lookup</cite> the request in cache, possibly entering the data in cache if it
is not already present.</p>
<p><cite>error</cite> - Generate a synthetic response from Varnish. Typically an error
message, redirect message or response to a health check from a load
balancer.</p>
<p>It&#8217;s also common to use <tt class="docutils literal"><span class="pre">vcl_recv</span></tt> to apply some security measures.
Varnish is not a replacement for Intrusion Detection Systems, but can
still be used to stop some typical attacks early. Simple access control
lists can be applied in <tt class="docutils literal"><span class="pre">vcl_recv</span></tt> too. For further discussion about
security in VCL, take a look at the Security.vcl project, found at
<a class="reference external" href="https://github.com/comotion/security.vcl">https://github.com/comotion/security.vcl</a>.</p>
</div>
</div>
<div class="section" id="default-vcl-recv">
<h2><a class="toc-backref" href="#id68">5.6&nbsp;&nbsp;&nbsp;Default: <tt class="docutils literal"><span class="pre">vcl_recv</span></tt></a><a class="headerlink" href="#default-vcl-recv" title="Permalink to this headline">¶</a></h2>
<pre class="literal-block">
sub vcl_recv {
    if (req.restarts == 0) {
        if (req.http.x-forwarded-for) {
            set req.http.X-Forwarded-For =
                req.http.X-Forwarded-For + &quot;, &quot; + client.ip;
        } else {
            set req.http.X-Forwarded-For = client.ip;
        }
    }
    if (req.request != &quot;GET&quot; &amp;&amp;
      req.request != &quot;HEAD&quot; &amp;&amp;
      req.request != &quot;PUT&quot; &amp;&amp;
      req.request != &quot;POST&quot; &amp;&amp;
      req.request != &quot;TRACE&quot; &amp;&amp;
      req.request != &quot;OPTIONS&quot; &amp;&amp;
      req.request != &quot;DELETE&quot;) {
        /* Non-RFC2616 or CONNECT which is weird. */
        return (pipe);
    }
    if (req.request != &quot;GET&quot; &amp;&amp; req.request != &quot;HEAD&quot;) {
        /* We only deal with GET and HEAD by default */
        return (pass);
    }
    if (req.http.Authorization || req.http.Cookie) {
        /* Not cacheable by default */
        return (pass);
    }
    return (lookup);
}

</pre>
<div class="handout container">
<p>The default VCL for <tt class="docutils literal"><span class="pre">vcl_recv</span></tt> is designed to ensure a safe caching
policy even with no modifications in VCL. It has two main uses:</p>
<ol class="arabic simple">
<li>Only handle recognized HTTP methods and cache GET and HEAD</li>
<li>Do not cache data that is likely to be user-specific.</li>
</ol>
<p>It is executed right after any user-specified VCL, and is always
present. You can not remove it. However, if you terminate the
<tt class="docutils literal"><span class="pre">vcl_recv</span></tt> function using one of the terminating statements (pass,
pipe, lookup, error), the default VCL will not execute, as control is
handed back from the VRT (VCL Run-Time) to Varnish.</p>
<p>Most of the logic in the default VCL is needed for a well-behaving
Varnish server, and care should be taken when <tt class="docutils literal"><span class="pre">vcl_recv</span></tt> is terminated
before reaching the default VCL. Consider either replicating all the
logic in your own VCL, or letting Varnish fall through to the default
VCL.</p>
</div>
</div>
<div class="section" id="example-basic-device-detection">
<h2><a class="toc-backref" href="#id69">5.7&nbsp;&nbsp;&nbsp;Example: Basic Device Detection</a><a class="headerlink" href="#example-basic-device-detection" title="Permalink to this headline">¶</a></h2>
<p>One way of serving different content for mobile devices and desktop
browsers is to run some simple parsing on the <cite>User-Agent</cite> header to create
your own custom-header for mobile devices:</p>
<pre class="literal-block">
sub vcl_recv {
        if (req.http.User-Agent ~ &quot;iPad&quot; ||
            req.http.User-Agent ~ &quot;iPhone&quot; ||
            req.http.User-Agent ~ &quot;Android&quot;) {
                set req.http.X-Device = &quot;mobile&quot;;
        } else {
                set req.http.X-Device = &quot;desktop&quot;;
        }
}

</pre>
<p>You can read more about different types of device detection at
<a class="reference external" href="https://www.varnish-cache.org/docs/trunk/users-guide/devicedetection.html">https://www.varnish-cache.org/docs/trunk/users-guide/devicedetection.html</a></p>
<div class="handout container">
<p>This simple VCL will create a request header called <cite>X-Device</cite> which
will contain either <tt class="docutils literal"><span class="pre">mobile</span></tt> or <tt class="docutils literal"><span class="pre">desktop</span></tt>. The Web server can then
use this header to determine what page to serve, and inform Varnish
about it through <tt class="docutils literal"><span class="pre">Vary:</span> <span class="pre">X-Device</span></tt>.</p>
<p>It might be tempting to just send <tt class="docutils literal"><span class="pre">Vary:</span> <span class="pre">User-Agent</span></tt>, but that would
either require you to normalize the <cite>User-Agent</cite> header itself and
losing the detailed information on the browser, or it would drastically
inflate the cache size by keeping possibly hundreds of different
variants for each object just because there are tiny variations of the
<cite>User-Agent</cite> header.</p>
<p>For more information on the <cite>Vary</cite>-header, see the HTTP chapter.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you do use <tt class="docutils literal"><span class="pre">Vary:</span> <span class="pre">X-Device</span></tt>, you might want to send <tt class="docutils literal"><span class="pre">Vary:</span>
<span class="pre">User-Agent</span></tt> to the users <cite>after</cite> Varnish has used it. Otherwise,
intermediary caches will not know that the page looks different for
different devices.</p>
</div>
</div>
</div>
<div class="section" id="vcl-vcl-fetch">
<h2><a class="toc-backref" href="#id70">5.8&nbsp;&nbsp;&nbsp;VCL - <tt class="docutils literal"><span class="pre">vcl_fetch</span></tt></a><a class="headerlink" href="#vcl-vcl-fetch" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Sanitize server-response</li>
<li>Override cache duration</li>
</ul>
<div class="handout container">
<p>The <tt class="docutils literal"><span class="pre">vcl_fetch</span></tt> function is the backend-counterpart to <tt class="docutils literal"><span class="pre">vcl_recv</span></tt>.
In <tt class="docutils literal"><span class="pre">vcl_recv</span></tt> you can use information provided by the client to decide
on caching policy, while you use information provided by the server to
further decide on a caching policy in <tt class="docutils literal"><span class="pre">vcl_fetch</span></tt>.</p>
<p>If you chose to <cite>pass</cite> the request in an earlier VCL function (e.g.:
<tt class="docutils literal"><span class="pre">vcl_recv</span></tt>), you will still execute the logic of <tt class="docutils literal"><span class="pre">vcl_fetch</span></tt>, but
the object will not enter the cache even if you supply a cache time.</p>
<p>You have multiple tools available in <tt class="docutils literal"><span class="pre">vcl_fetch</span></tt>. First and foremost
you have the <tt class="docutils literal"><span class="pre">beresp.ttl</span></tt> variable, which defines how long an object
is kept.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>If the request was not passed <em>before</em> reaching <tt class="docutils literal"><span class="pre">vcl_fetch</span></tt>, the
<tt class="docutils literal"><span class="pre">beresp.ttl</span></tt> is still used even when you perform a
<tt class="docutils literal"><span class="pre">hit_for_pass</span></tt> in <tt class="docutils literal"><span class="pre">vcl_fetch</span></tt>. This is an important detail
that is important to remember: When you perform a pass in
<tt class="docutils literal"><span class="pre">vcl_fetch</span></tt> <em>you cache the decision you made</em>. In other words:
If <tt class="docutils literal"><span class="pre">beresp.ttl</span></tt> is 10 hours and you issue a pass, an object
will be entered into the cache and remain there for 10 hours,
telling Varnish not to cache. If you decide not to cache a page
that returns a &#8220;500 Internal Server Error&#8221;, for example, this is
critically important, as a temporary glitch on a page can cause
it to not be cached for a potentially long time.</p>
<p class="last">Always set <tt class="docutils literal"><span class="pre">beresp.ttl</span></tt> when you issue a pass in <tt class="docutils literal"><span class="pre">vcl_fetch</span></tt>.</p>
</div>
<p>Returning <tt class="docutils literal"><span class="pre">deliver</span></tt> in <tt class="docutils literal"><span class="pre">vcl_fetch</span></tt> tells Varnish to cache, if
possible.  Returning <tt class="docutils literal"><span class="pre">hit_for_pass</span></tt> tells it not to cache, but does
<em>not</em> run the <tt class="docutils literal"><span class="pre">vcl_pass</span></tt> function of VCL for this specific client. The
next client asking for the same resource will hit the <cite>hitpass</cite>-object
and go through <tt class="docutils literal"><span class="pre">vcl_pass</span></tt>.</p>
<p>Typical tasks performed in <tt class="docutils literal"><span class="pre">vcl_fetch</span></tt> include:</p>
<ul class="simple">
<li>Overriding cache time for certain URLs</li>
<li>Stripping Set-Cookie headers that are not needed</li>
<li>Stripping bugged Vary headers</li>
<li>Adding helper-headers to the object for use in banning (more
information in later chapters)</li>
<li>Applying other caching policies</li>
</ul>
</div>
</div>
<div class="section" id="default-vcl-fetch">
<h2><a class="toc-backref" href="#id71">5.9&nbsp;&nbsp;&nbsp;Default: <tt class="docutils literal"><span class="pre">vcl_fetch</span></tt></a><a class="headerlink" href="#default-vcl-fetch" title="Permalink to this headline">¶</a></h2>
<pre class="literal-block">
sub vcl_fetch {
    if (beresp.ttl &lt;= 0s ||
        beresp.http.Set-Cookie ||
        beresp.http.Vary == &quot;*&quot;) {
                /*
                 * Mark as &quot;Hit-For-Pass&quot; for the next 2 minutes
                 */
                set beresp.ttl = 120 s;
                return (hit_for_pass);
    }
    return (deliver);
}

</pre>
<div class="handout container">
The default VCL for <tt class="docutils literal"><span class="pre">vcl_fetch</span></tt> is designed to avoid caching anything
with a set-cookie header. There are very few situations where caching
content with a set-cookie header is desirable.</div>
</div>
<div class="section" id="the-initial-value-of-beresp-ttl">
<h2><a class="toc-backref" href="#id72">5.10&nbsp;&nbsp;&nbsp;The initial value of <tt class="docutils literal"><span class="pre">beresp.ttl</span></tt></a><a class="headerlink" href="#the-initial-value-of-beresp-ttl" title="Permalink to this headline">¶</a></h2>
<p>Before Varnish runs <tt class="docutils literal"><span class="pre">vcl_fetch</span></tt>, the <tt class="docutils literal"><span class="pre">beresp.ttl</span></tt> variable has already
been set to a value. It will use the first value it finds among:</p>
<ul class="simple">
<li>The <tt class="docutils literal"><span class="pre">s-maxage</span></tt> variable in the <tt class="docutils literal"><span class="pre">Cache-Control</span></tt> response header</li>
<li>The <tt class="docutils literal"><span class="pre">max-age</span></tt> variable in the <tt class="docutils literal"><span class="pre">Cache-Control</span></tt> response header</li>
<li>The <tt class="docutils literal"><span class="pre">Expires</span></tt> response header</li>
<li>The <tt class="docutils literal"><span class="pre">default_ttl</span></tt> parameter.</li>
</ul>
<p>Only the following status codes will be cached by default:</p>
<ul class="simple">
<li>200: OK</li>
<li>203: Non-Authoritative Information</li>
<li>300: Multiple Choices</li>
<li>301: Moved Permanently</li>
<li>302: Moved Temporarily</li>
<li>307: Temporary Redirect</li>
<li>410: Gone</li>
<li>404: Not Found</li>
</ul>
<div class="handout container">
<p>You can still cache other status codes, but you will have to set
the <tt class="docutils literal"><span class="pre">beresp.ttl</span></tt> to a positive value in <tt class="docutils literal"><span class="pre">vcl_fetch</span></tt> yourself.</p>
<p>Since all this is done before <tt class="docutils literal"><span class="pre">vcl_fetch</span></tt> is executed, you can
modify the Cache-Control headers without affecting <tt class="docutils literal"><span class="pre">beresp.ttl</span></tt>,
and vice versa.</p>
<p>A sensible approach is to use the <tt class="docutils literal"><span class="pre">s-maxage</span></tt> variable in the
<tt class="docutils literal"><span class="pre">Cache-Control</span></tt> header to instruct Varnish to cache, then have
Varnish remove that variable before sending it to clients using
<tt class="docutils literal"><span class="pre">regsub()</span></tt> in <tt class="docutils literal"><span class="pre">vcl_fetch</span></tt>. That way, you can safely set max-age
to what cache duration the clients should use and s-maxage for
Varnish without affecting intermediary caches.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Varnish, browsers and intermediary will parse the <tt class="docutils literal"><span class="pre">Age</span></tt>
response header. If you stack multiple Varnish servers in
front of each other, this means that setting
<tt class="docutils literal"><span class="pre">s-maxage=300</span></tt> will mean that the object really will be
cached for only 300 seconds throughout all Varnish servers.</p>
<p class="last">On the other hand, if your web server sends
<tt class="docutils literal"><span class="pre">Cache-Control:</span> <span class="pre">max-age=300,</span> <span class="pre">s-maxage=3600</span></tt> and you do
not remove the <tt class="docutils literal"><span class="pre">Age</span></tt> response header, Varnish will send
an <tt class="docutils literal"><span class="pre">Age</span></tt>-header that exceeds the <tt class="docutils literal"><span class="pre">max-age</span></tt> of the
objects, which will cause browsers to not cache the
content.</p>
</div>
</div>
</div>
<div class="section" id="example-enforce-caching-of-jpg-urls-for-60-seconds">
<h2><a class="toc-backref" href="#id73">5.11&nbsp;&nbsp;&nbsp;Example: Enforce caching of .jpg urls for 60 seconds</a><a class="headerlink" href="#example-enforce-caching-of-jpg-urls-for-60-seconds" title="Permalink to this headline">¶</a></h2>
<pre class="literal-block">
sub vcl_fetch {
        if (req.url ~ &quot;\.jpg$&quot;) {
                set beresp.ttl = 60s;
        }
}

</pre>
<div class="handout container">
<p>The above example is typical for a site migrating to Varnish. Setting
<tt class="docutils literal"><span class="pre">beresp.ttl</span></tt> ensures it&#8217;s cached.</p>
<p>Keep in mind that the default VCL will still be executed, which means
that an image with a Set-Cookie header will not be cached.</p>
</div>
</div>
<div class="section" id="example-cache-jpg-for-60-only-if-s-maxage-isn-t-present">
<h2><a class="toc-backref" href="#id74">5.12&nbsp;&nbsp;&nbsp;Example: Cache .jpg for 60 only if s-maxage isn&#8217;t present</a><a class="headerlink" href="#example-cache-jpg-for-60-only-if-s-maxage-isn-t-present" title="Permalink to this headline">¶</a></h2>
<pre class="literal-block">
sub vcl_fetch {
        if (beresp.http.cache-control !~ &quot;s-maxage&quot; &amp;&amp; req.url ~ &quot;\.jpg$&quot;) {
                set beresp.ttl = 60s;
        }
}

</pre>
<div class="handout container">
<p>The Cache-Control header can contain a number of headers. Varnish evaluates
it and looks for s-maxage and max-age. It will set the TTL to the value of
s-maxage if found. If s-maxage isn&#8217;t found, it will use max-age. If neither
exist, it will use the Expires header to set the ttl. If none of those
headers exist, it will use the default TTL.</p>
<p>This is done before <tt class="docutils literal"><span class="pre">vcl_fetch</span></tt> is executed and the process can
be seen by looking at the TTL tag of varnishlog.</p>
<p>The purpose of the above example is to allow a gradual migration to
using a backend-controlled caching policy. If the backend supplies
s-maxage, it will be used, but if it is missing, a forced TTL is
set.</p>
</div>
</div>
<div class="section" id="exercise-either-use-s-maxage-or-set-ttl-by-file-type">
<h2><a class="toc-backref" href="#id75">5.13&nbsp;&nbsp;&nbsp;Exercise: Either use s-maxage or set ttl by file type</a><a class="headerlink" href="#exercise-either-use-s-maxage-or-set-ttl-by-file-type" title="Permalink to this headline">¶</a></h2>
<p>Write a VCL that:</p>
<ul class="simple">
<li>Uses <tt class="docutils literal"><span class="pre">Cache-Control:</span> <span class="pre">s-maxage</span></tt> where present</li>
<li>Caches <tt class="docutils literal"><span class="pre">.jpg</span></tt> for 30 seconds if s-maxage isn&#8217;t present</li>
<li>Caches <tt class="docutils literal"><span class="pre">.html</span></tt> for 10 seconds if s-maxage isn&#8217;t present</li>
<li>Removes the Set-Cookie header if s-maxage OR the above rules indicates
that Varnish should cache.</li>
</ul>
<div class="handout container">
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Try solving each part of the exercise by itself first. Most somewhat
complex VCL tasks are easily solved when you divide the tasks into
smaller bits and solve them individually.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Varnish automatically reads s-maxage for you, so you only need to
check if it is there or not - if it&#8217;s present, Varnish has already
used it to set <tt class="docutils literal"><span class="pre">beresp.ttl</span></tt>.</p>
</div>
</div>
</div>
<div class="section" id="solution-either-use-s-maxage-or-set-ttl-by-file-type">
<h2><a class="toc-backref" href="#id76">5.14&nbsp;&nbsp;&nbsp;Solution: Either use s-maxage or set ttl by file type</a><a class="headerlink" href="#solution-either-use-s-maxage-or-set-ttl-by-file-type" title="Permalink to this headline">¶</a></h2>
<pre class="literal-block">
sub vcl_fetch {
        if (beresp.http.cache-control !~ &quot;s-maxage&quot;) {
                if (req.url ~ &quot;\.jpg(\?|$)&quot;) {
                        set beresp.ttl = 30s;
                        unset beresp.http.Set-Cookie;
                }
                if (req.url ~ &quot;\.html(\?|$)&quot;) {
                        set beresp.ttl = 10s;
                        unset beresp.http.Set-Cookie;
                }
        } else {
                if (beresp.ttl &gt; 0s) {
                        unset beresp.http.Set-Cookie;
                }
        }
}

</pre>
<div class="handout container">
There are many ways to solve this exercise, and this solution is
only one of them. The first part checks that s-maxage is /not/
present, then handles .jpg and .html files - including cookie
removal. The second part checks if s-maxage caused Varnish to set a
positive ttl and consider it cacheable.</div>
</div>
<div class="section" id="summary-of-vcl-part-1">
<h2><a class="toc-backref" href="#id77">5.15&nbsp;&nbsp;&nbsp;Summary of VCL - Part 1</a><a class="headerlink" href="#summary-of-vcl-part-1" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>VCL provides a state machine for controlling Varnish.</li>
<li>Each request is handled independently.</li>
<li>Building a VCL file is done one line at a time.</li>
</ul>
<div class="handout container">
<p>VCL is all about policy. By providing a state machine which you can
hook into, VCL allows you to affect the handling of any single
request almost anywhere in the execution chain.</p>
<p>This provides both the pros and cons of any other programming
language. There isn&#8217;t going to be any complete reference guide to
how you can deal with every possible scenario in VCL, but on the
other hand, if you master the basics of VCL you can solve complex
problems that nobody has thought about before. And you can usually
do it without requiring too many different sources of
documentation.</p>
<p>Whenever you are working on VCL, you should think of what that
exact line you are writing has to do. The best VCL is built by
having many independent sections that don&#8217;t interfere with each
other more than they have to.</p>
<p>This is made easier by the fact that VCL also has a default - which
is always present. If you just need to modify one little thing in
<tt class="docutils literal"><span class="pre">vcl_recv</span></tt>, you can do just that. You don&#8217;t have to copy the
default VCL, because it will be executed after your own - assuming
you don&#8217;t have any <cite>return</cite> statements.</p>
</div>
</div>
</div>
<div class="section" id="id1">
<h1><a class="toc-backref" href="#id78">6&nbsp;&nbsp;&nbsp;VCL functions</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li>Start off with a cheat-sheet for variables</li>
<li>Go through the remaining vcl functions: hash, pipe, miss, pass, hit,
error and deliver.</li>
<li>Add some &#8220;features&#8221; with VCL.</li>
</ul>
<div class="handout container">
<p>The following chapter will cover the parts of VCL where you typically
venture to customize the behavior of Varnish and not define caching
policy.</p>
<p>These functions can be used to add custom headers, change the appearance
of the Varnish error message, add HTTP redirect features in Varnish,
purge content and define what parts of a cached object is unique.</p>
<p>After this chapter, you should know what all the VCL functions can be
used for, and you&#8217;ll be ready to dive into more advanced features of
Varnish and VCL.</p>
</div>
<div class="section" id="variable-availability-in-vcl">
<h2><a class="toc-backref" href="#id79">6.1&nbsp;&nbsp;&nbsp;Variable availability in VCL</a><a class="headerlink" href="#variable-availability-in-vcl" title="Permalink to this headline">¶</a></h2>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="9%" />
<col width="10%" />
<col width="9%" />
<col width="9%" />
<col width="7%" />
<col width="10%" />
<col width="13%" />
<col width="9%" />
<col width="9%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Variable</th>
<th class="head">recv</th>
<th class="head">fetch</th>
<th class="head">pass</th>
<th class="head">miss</th>
<th class="head">hit</th>
<th class="head">error</th>
<th class="head">deliver</th>
<th class="head">pipe</th>
<th class="head">hash</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>req.*</td>
<td>R/W</td>
<td>R/W</td>
<td>R/W</td>
<td>R/W</td>
<td>R/W</td>
<td>R/W</td>
<td>R/W</td>
<td>R/W</td>
<td>R/W</td>
</tr>
<tr class="row-odd"><td>bereq.*</td>
<td>&nbsp;</td>
<td>R/W</td>
<td>R/W</td>
<td>R/W</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>R/W</td>
<td>&nbsp;</td>
</tr>
<tr class="row-even"><td>obj.hits</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>R</td>
<td>&nbsp;</td>
<td>R</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td>obj.ttl</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>R/W</td>
<td>R/W</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
</tr>
<tr class="row-even"><td>obj.grace</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>R/W</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td>obj.*</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>R</td>
<td>R/W</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
</tr>
<tr class="row-even"><td>beresp.*</td>
<td>&nbsp;</td>
<td>R/W</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td>resp.*</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>R/W</td>
<td>R/W</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<div class="handout container">
<p>The above is a map of the most important variables and where you can
read (R) from them and write (W) to them.</p>
<p>Some variables are left out: <tt class="docutils literal"><span class="pre">client.*</span></tt> and <tt class="docutils literal"><span class="pre">server.*</span></tt> are by and
large accessible everywhere, as is the <tt class="docutils literal"><span class="pre">now</span></tt> variable.</p>
<p>Remember that changes made to <tt class="docutils literal"><span class="pre">beresp</span></tt> are stored in <tt class="docutils literal"><span class="pre">obj</span></tt>
afterwards. And the <tt class="docutils literal"><span class="pre">resp.*</span></tt> variables are copies of what&#8217;s about to
be returned - possibly of <tt class="docutils literal"><span class="pre">obj</span></tt>. A change to <tt class="docutils literal"><span class="pre">beresp</span></tt> will, in other
words, affect future <tt class="docutils literal"><span class="pre">obj.*</span></tt> and <tt class="docutils literal"><span class="pre">resp.*</span></tt> variables. Similar
semantics apply to <tt class="docutils literal"><span class="pre">req.*</span></tt> and <tt class="docutils literal"><span class="pre">bereq.*</span></tt>. <tt class="docutils literal"><span class="pre">bereq.*</span></tt> is the
&#8220;backend request&#8221; as created from the original request. It may differ
slightly - Varnish can convert HEAD requests to GET for example.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Many of these variables will be self-explaining during while you&#8217;re
working through these exercises, but we&#8217;ll explain all of them
towards the end of the chapter to make sure there&#8217;s no confusion.</p>
</div>
</div>
</div>
<div class="section" id="vcl-vcl-hash">
<h2><a class="toc-backref" href="#id80">6.2&nbsp;&nbsp;&nbsp;VCL - <tt class="docutils literal"><span class="pre">vcl_hash</span></tt></a><a class="headerlink" href="#vcl-vcl-hash" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Defines what is unique about a request.</li>
<li>Executed directly after <tt class="docutils literal"><span class="pre">vcl_recv</span></tt></li>
</ul>
<div class="highlight-python"><pre>sub vcl_hash {
    hash_data(req.url);
    if (req.http.host) {
        hash_data(req.http.host);
    } else {
        hash_data(server.ip);
    }
    return (hash);
}
</pre>
</div>
<div class="handout container">
<p><tt class="docutils literal"><span class="pre">vcl_hash</span></tt> defines the hash key to be used for a cached object. Or in
other words: What separates one cached object from the next.</p>
<p>One usage of <tt class="docutils literal"><span class="pre">vcl_hash</span></tt> could be to add a user-name in the cache hash
to cache user-specific data. However, be warned that caching user-data
should only be done cautiously. A better alternative might be to cache
differently based on whether a user is logged in or not, but not
necessarily what user it is.</p>
<p>The default VCL for <tt class="docutils literal"><span class="pre">vcl_hash</span></tt> adds the hostname (or IP) and the URL
to the cache hash.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The handling of the <cite>Vary</cite>-header is separate from the cache hash.</p>
</div>
</div>
</div>
<div class="section" id="vcl-vcl-hit">
<h2><a class="toc-backref" href="#id81">6.3&nbsp;&nbsp;&nbsp;VCL - <tt class="docutils literal"><span class="pre">vcl_hit</span></tt></a><a class="headerlink" href="#vcl-vcl-hit" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Right after an object has been found (hit) in the cache</li>
<li>You can change the TTL or issue <tt class="docutils literal"><span class="pre">purge;</span></tt></li>
<li>Often used to throw out an old object</li>
</ul>
<div class="highlight-python"><pre>sub vcl_hit {
    return (deliver);
}
</pre>
</div>
</div>
<div class="section" id="vcl-vcl-miss">
<h2><a class="toc-backref" href="#id82">6.4&nbsp;&nbsp;&nbsp;VCL - <tt class="docutils literal"><span class="pre">vcl_miss</span></tt></a><a class="headerlink" href="#vcl-vcl-miss" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Right after an object was looked up and not found in cache</li>
<li>Mostly used to issue <tt class="docutils literal"><span class="pre">purge;</span></tt></li>
<li>Can also be used to modify backend request headers</li>
</ul>
<div class="highlight-python"><pre>sub vcl_miss {
    return (fetch);
}
</pre>
</div>
<div class="handout container">
<p>The subroutines <tt class="docutils literal"><span class="pre">vcl_hit</span></tt> and <tt class="docutils literal"><span class="pre">vcl_miss</span></tt> are closely related. It&#8217;s
rare that you can use them, and when you do, it&#8217;s typically related to
internal Varnish tricks - not debug-feedback or backend modification.</p>
<p>One example is using <tt class="docutils literal"><span class="pre">purge;</span></tt> to invalidate an object (more on this
later), another is to rewrite a backend request when you want the ESI
fragments to get the unmodified data.</p>
<p>You can also modify the backend request headers in <tt class="docutils literal"><span class="pre">vcl_miss</span></tt>. This is
very uncommon, as you&#8217;ve likely done this in <tt class="docutils literal"><span class="pre">vcl_recv</span></tt> already.
However, if you do not wish to send an <cite>X-Varnish</cite> header to the backend
server, you need to remove it in in <tt class="docutils literal"><span class="pre">vcl_miss</span></tt> and <tt class="docutils literal"><span class="pre">vcl_pass</span></tt> using
<tt class="docutils literal"><span class="pre">unset</span> <span class="pre">bereq.http.x-varnish;</span></tt>.</p>
</div>
</div>
<div class="section" id="vcl-vcl-pass">
<h2><a class="toc-backref" href="#id83">6.5&nbsp;&nbsp;&nbsp;VCl - <tt class="docutils literal"><span class="pre">vcl_pass</span></tt></a><a class="headerlink" href="#vcl-vcl-pass" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Run after a pass in <tt class="docutils literal"><span class="pre">vcl_recv</span></tt> OR after a lookup that returned a hitpass</li>
<li>Not run after <tt class="docutils literal"><span class="pre">vcl_fetch</span></tt>.</li>
</ul>
<div class="highlight-python"><pre>sub vcl_pass {
    return (pass);
}
</pre>
</div>
<div class="handout container">
<p>The <tt class="docutils literal"><span class="pre">vcl_pass</span></tt> function belongs in the same group as <tt class="docutils literal"><span class="pre">vcl_hit</span></tt>
and <tt class="docutils literal"><span class="pre">vcl_miss</span></tt>. It is run right after either a cache lookup or
<tt class="docutils literal"><span class="pre">vcl_recv</span></tt> determined that this isn&#8217;t a cached item and it&#8217;s not
going to be cached.</p>
<p>The usefulness of <tt class="docutils literal"><span class="pre">vcl_pass</span></tt> is limited, but it typically serves as
an important catch-all for features you&#8217;ve implemented in
<tt class="docutils literal"><span class="pre">vcl_hit</span></tt> and <tt class="docutils literal"><span class="pre">vcl_miss</span></tt>. The prime example is the PURGE
method, where you want to avoid sending a PURGE request to a
backend.</p>
</div>
</div>
<div class="section" id="vcl-vcl-deliver">
<h2><a class="toc-backref" href="#id84">6.6&nbsp;&nbsp;&nbsp;VCL - <tt class="docutils literal"><span class="pre">vcl_deliver</span></tt></a><a class="headerlink" href="#vcl-vcl-deliver" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Common last exit point for all (except <tt class="docutils literal"><span class="pre">vcl_pipe</span></tt>) code paths</li>
<li>Often used to add and remove debug-headers</li>
</ul>
<div class="highlight-python"><pre>sub vcl_deliver {
    return (deliver);
}
</pre>
</div>
<div class="handout container">
<p>While the <tt class="docutils literal"><span class="pre">vcl_deliver</span></tt> function is simple, it is also very useful for
modifying the output of Varnish. If you need to remove a header, or add
one that isn&#8217;t supposed to be stored in the cache, <tt class="docutils literal"><span class="pre">vcl_deliver</span></tt> is the
place to do it.</p>
<p>The main building blocks of <tt class="docutils literal"><span class="pre">vcl_deliver</span></tt> are:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">resp.http.*</span></tt></dt>
<dd>Headers that will be sent to the client. They can be set and unset.</dd>
<dt><tt class="docutils literal"><span class="pre">resp.status</span></tt></dt>
<dd>The status code (200, 404, 503, etc).</dd>
<dt><tt class="docutils literal"><span class="pre">resp.response</span></tt></dt>
<dd>The response message (&#8220;OK&#8221;, &#8220;File not found&#8221;, &#8220;Service
Unavailable&#8221;).</dd>
<dt><tt class="docutils literal"><span class="pre">obj.hits</span></tt></dt>
<dd>The number of hits a cached object has made. This can be evaluated
and sued as a string to easily reveal if a request was a cache hit
or miss.</dd>
<dt><tt class="docutils literal"><span class="pre">req.restarts</span></tt></dt>
<dd>The number of restarts issued in VCL - 0 if none were made.</dd>
</dl>
</div>
</div>
<div class="section" id="vcl-vcl-error">
<h2><a class="toc-backref" href="#id85">6.7&nbsp;&nbsp;&nbsp;VCL - <tt class="docutils literal"><span class="pre">vcl_error</span></tt></a><a class="headerlink" href="#vcl-vcl-error" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Used to generate content from within Varnish, without talking to a web
server</li>
<li>Error messages go here by default</li>
<li>Other use cases: Redirecting users (301/302 Redirects)</li>
</ul>
<div class="highlight-python"><pre>sub vcl_error {
    set obj.http.Content-Type = "text/html; charset=utf-8";
    set obj.http.Retry-After = "5";
    synthetic {"
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;"} + obj.status + " " + obj.response + {"&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Error "} + obj.status + " " + obj.response + {"&lt;/h1&gt;
    &lt;p&gt;"} + obj.response + {"&lt;/p&gt;
    &lt;h3&gt;Guru Meditation:&lt;/h3&gt;
    &lt;p&gt;XID: "} + req.xid + {"&lt;/p&gt;
    &lt;hr&gt;
    &lt;p&gt;Varnish cache server&lt;/p&gt;
  &lt;/body&gt;
&lt;/html&gt;
"};
    return (deliver);
}
</pre>
</div>
<div class="handout container">
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Note how you can use {&#8221; and &#8220;} to make multi-line strings. This is
not limited to synthetic, but can be used anywhere.</p>
</div>
</div>
</div>
<div class="section" id="example-redirecting-users-with-vcl-error">
<h2><a class="toc-backref" href="#id86">6.8&nbsp;&nbsp;&nbsp;Example: Redirecting users with <tt class="docutils literal"><span class="pre">vcl_error</span></tt></a><a class="headerlink" href="#example-redirecting-users-with-vcl-error" title="Permalink to this headline">¶</a></h2>
<pre class="literal-block">
sub vcl_recv {
        if (req.http.host == &quot;www.example.com&quot;) {
                set req.http.Location = &quot;http://example.com&quot; + req.url;
                error 750 &quot;Permanently moved&quot;;
        }
}

sub vcl_error {
        if (obj.status == 750) {
                set obj.http.location = req.http.Location;
                set obj.status = 301;
                return (deliver);
        }
}

</pre>
<div class="handout container">
<p>Redirecting with VCL is fairly easy - and fast. If you know a pattern,
it&#8217;s even easier.</p>
<p>Basic redirects in HTTP work by having the server return either 301
&#8220;Permanently moved&#8221; or 302 &#8220;Found&#8221;, with a Location header telling the
web browser where to look. The 301 can affect how browser prioritize
history and how search engines treat the content. 302 are more temporary
and will not affect search engines as greatly.</p>
<p>The above example illustrates how you can use Varnish to generate
meta-content.</p>
</div>
</div>
<div class="section" id="exercise-modify-the-error-message-and-headers">
<h2><a class="toc-backref" href="#id87">6.9&nbsp;&nbsp;&nbsp;Exercise: Modify the error message and headers</a><a class="headerlink" href="#exercise-modify-the-error-message-and-headers" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Make the default error message more friendly.</li>
<li>Add a header saying either HIT or MISS</li>
<li>&#8220;Rename&#8221; the Age header to X-Age.</li>
</ul>
</div>
<div class="section" id="solution-modify-the-error-message-and-headers">
<h2><a class="toc-backref" href="#id88">6.10&nbsp;&nbsp;&nbsp;Solution: Modify the error message and headers</a><a class="headerlink" href="#solution-modify-the-error-message-and-headers" title="Permalink to this headline">¶</a></h2>
<pre class="literal-block">
sub vcl_error {
        synthetic &quot;&lt;html&gt;&lt;body&gt;&lt;!-- Blank page must mean it's a browser issue! --&gt;&lt;/body&gt;&lt;/html&gt;&quot;;
        set obj.status = 200;
        return (deliver);
}

sub vcl_deliver {
        set resp.http.X-Age = resp.http.Age;
        unset resp.http.Age;

        if (obj.hits &gt; 0) {
                set resp.http.X-Cache = &quot;HIT&quot;;
        } else {
                set resp.http.X-Cache = &quot;MISS&quot;;
        }
}

</pre>
<div class="handout container">
<p>The solution doesn&#8217;t use the &#8220;long-string&#8221; syntax that the default uses,
but regular strings. This is all up to you.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>It&#8217;s safer to make sure a variable has a sensible value before using
it to make a string. That&#8217;s why it&#8217;s better to always check that
<tt class="docutils literal"><span class="pre">obj.hits</span> <span class="pre">&gt;</span> <span class="pre">0</span></tt> (and not just != 0) before you try using it.  While
there are no known bugs with <tt class="docutils literal"><span class="pre">obj.hits</span></tt> at the moment,
string-conversion has been an area where there have been some bugs in
the past when the variable to be converted had an unexpected value
(for example if you tried using <tt class="docutils literal"><span class="pre">obj.hits</span></tt> after a pass in
<tt class="docutils literal"><span class="pre">vcl_recv</span></tt>).</p>
<p class="last">This applies to all variables - and all languages for that matter</p>
</div>
</div>
</div>
</div>
<div class="section" id="cache-invalidation">
<h1><a class="toc-backref" href="#id89">7&nbsp;&nbsp;&nbsp;Cache invalidation</a><a class="headerlink" href="#cache-invalidation" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li>Explicit invalidation of cache</li>
<li><tt class="docutils literal"><span class="pre">purge;</span></tt> removes all variants of an object from cache, freeing up
memory</li>
<li><tt class="docutils literal"><span class="pre">set</span> <span class="pre">req.hash_always_miss</span> <span class="pre">=</span> <span class="pre">true;</span></tt> can refresh content explicitly</li>
<li><tt class="docutils literal"><span class="pre">ban();</span></tt> can be used to invalidate objects based on regular
expressions, but does not necessarily free up memory any time soon.</li>
<li>Which to use when?</li>
<li>What about this ban lurker?</li>
<li><tt class="docutils literal"><span class="pre">obj.ttl</span> <span class="pre">=</span> <span class="pre">0s;</span></tt> is obsolete.</li>
</ul>
<div class="handout container">
<p>Whenever you deal with a cache, you will eventually have to deal with
the challenge of cache invalidation, or refreshing content. There are
many motives behind such a task, and Varnish addresses the problem
in several slightly different ways.</p>
<p>Some questions you need to ask whenever the topic of cache invalidation
comes up are:</p>
<ul class="simple">
<li>Am I invalidating one specific object, or many?</li>
<li>Do I need to free up memory, or just replace the content?</li>
<li>Does it take a long time to replace the content?</li>
<li>Is this a regular task, or a one-off task?</li>
</ul>
<p>The rest of the chapter will hopefully give you the knowledge you need
to know which solution to pick when.</p>
</div>
<div class="section" id="naming-confusion">
<h2><a class="toc-backref" href="#id90">7.1&nbsp;&nbsp;&nbsp;Naming confusion</a><a class="headerlink" href="#naming-confusion" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>The course material uses Varnish 3-terminology if nothing else is stated.</li>
<li>Varnish 3 uses the term <cite>ban</cite> and <cite>banning</cite> for what was known as
<cite>purge</cite> and <cite>purging</cite> in Varnish 2. They are the same.</li>
<li>Varnish 3 has a new function called <tt class="docutils literal"><span class="pre">purge;</span></tt> that did not exist in VCL
in Varnish 2.</li>
<li><tt class="docutils literal"><span class="pre">purge;</span></tt> is a much improved way of doing what was in Varnish 2 done
using <tt class="docutils literal"><span class="pre">set</span> <span class="pre">obj.ttl</span> <span class="pre">=</span> <span class="pre">0s;</span></tt>.</li>
<li>Sorry about the confusion!</li>
</ul>
<div class="handout container">
<p>With Varnish 3, an attempt was made to clean up some terminology.
Unfortunately, this might have made things slightly worse, until people
forget everything about Varnish 2.</p>
<p>The function called <tt class="docutils literal"><span class="pre">purge()</span></tt> in Varnish 2 is known as <tt class="docutils literal"><span class="pre">ban()</span></tt> in
Varnish 3. This course material will use that terminology, but you are
likely to run across material that refers to <tt class="docutils literal"><span class="pre">purge()</span></tt> where you
should read it as <tt class="docutils literal"><span class="pre">ban()</span></tt>.</p>
<p>On top of that, Varnish 3 introduced the <tt class="docutils literal"><span class="pre">purge;</span></tt> function that&#8217;s
accessible in <tt class="docutils literal"><span class="pre">vcl_hit</span></tt> and <tt class="docutils literal"><span class="pre">vcl_miss</span></tt>. This replaces the usage of
<tt class="docutils literal"><span class="pre">set</span> <span class="pre">obj.ttl</span> <span class="pre">=</span> <span class="pre">0s;</span></tt>, which was common in Varnish 2, though the latter
is still valid in Varnish 3.</p>
<p>All the terms will be discussed in more detail, of course. This is just
a heads-up about possible naming confusion.</p>
</div>
</div>
<div class="section" id="removing-a-single-object">
<h2><a class="toc-backref" href="#id91">7.2&nbsp;&nbsp;&nbsp;Removing a single object</a><a class="headerlink" href="#removing-a-single-object" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>If you know exactly what to remove, use <tt class="docutils literal"><span class="pre">purge;</span></tt>.</li>
<li>It must be used in both <tt class="docutils literal"><span class="pre">vcl_hit</span></tt> and <tt class="docutils literal"><span class="pre">vcl_miss</span></tt></li>
<li>Frees up memory, removes all <tt class="docutils literal"><span class="pre">Vary:</span></tt>-variants of the object.</li>
<li>Leaves it to the next client to refresh the content</li>
<li>Often combined with <tt class="docutils literal"><span class="pre">return(restart);</span></tt></li>
</ul>
<div class="handout container">
<p>The <tt class="docutils literal"><span class="pre">purge;</span></tt> keyword is the simplest manner of removing content from
the cache explicitly.</p>
<p>A resource can exist in multiple <tt class="docutils literal"><span class="pre">Vary:</span></tt>-variants. For example you
could have a desktop version, a tablet version and a smartphone version of
your site and use <tt class="docutils literal"><span class="pre">Vary</span></tt> in combination with device detection to store
different variants of the same resource.</p>
<p>If you update your content you can use <tt class="docutils literal"><span class="pre">purge;</span></tt> to evict all variants
of that content from the cache. This is done in both <tt class="docutils literal"><span class="pre">vcl_hit</span></tt> and
<tt class="docutils literal"><span class="pre">vcl_miss</span></tt>. This is typically done by letting your content management
system send a special HTTP request to Varnish. Since the content
management system doesn&#8217;t necessarily hit a variant of the object that
is cached, you have to issue <tt class="docutils literal"><span class="pre">purge;</span></tt> in <tt class="docutils literal"><span class="pre">vcl_miss</span></tt> too. This
ensures that all variants of that resource are evicted from cache.</p>
<p>The biggest down-side of using <tt class="docutils literal"><span class="pre">purge;</span></tt> is that you evict the content
from cache before you know if Varnish can fetch a new copy from a web
server. If the web server is down, Varnish has no old copy of the
content.</p>
</div>
</div>
<div class="section" id="example-purge">
<h2><a class="toc-backref" href="#id92">7.3&nbsp;&nbsp;&nbsp;Example: <tt class="docutils literal"><span class="pre">purge;</span></tt></a><a class="headerlink" href="#example-purge" title="Permalink to this headline">¶</a></h2>
<pre class="literal-block">
acl purgers {
        &quot;127.0.0.1&quot;;
        &quot;192.168.0.0&quot;/24;
}

sub vcl_recv {
        if (req.request == &quot;PURGE&quot;) {
                if (!client.ip ~ purgers) {
                        error 405 &quot;Method not allowed&quot;;
                }
                return (lookup);
        }
}

sub vcl_hit {
        if (req.request == &quot;PURGE&quot;) {
                purge;
                error 200 &quot;Purged&quot;;
        }
}
sub vcl_miss {
        if (req.request == &quot;PURGE&quot;) {
                purge;
                error 404 &quot;Not in cache&quot;;
        }
}
sub vcl_pass {
        if (req.request == &quot;PURGE&quot;) {
                error 502 &quot;PURGE on a passed object&quot;;
        }
}

</pre>
<div class="handout container">
<p>The PURGE example above is fairly complete and deals with a non-standard
method. Using <tt class="docutils literal"><span class="pre">purge;</span></tt> will remove all <tt class="docutils literal"><span class="pre">Vary:</span></tt>-variants of the
object, unlike the older method of using <tt class="docutils literal"><span class="pre">obj.ttl</span> <span class="pre">=</span> <span class="pre">0s;</span></tt> which had to
be issued for each variants of an object.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">ACLs have not been explained yet, but will be explained in detail in
later chapters.</p>
</div>
</div>
</div>
<div class="section" id="the-lookup-that-always-misses">
<h2><a class="toc-backref" href="#id93">7.4&nbsp;&nbsp;&nbsp;The lookup that always misses</a><a class="headerlink" href="#the-lookup-that-always-misses" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">req.hash_always_miss</span> <span class="pre">=</span> <span class="pre">true;</span></tt> in <tt class="docutils literal"><span class="pre">vcl_recv</span></tt> will cause Varnish to
look the object up in cache, but ignore any copy it finds.</li>
<li>Useful way to do a controlled refresh of a specific object, for instance
if you use a script to refresh some slowly generated content.</li>
<li>Depending on Varnish-version, it may leave extra copies in the cache</li>
<li>If the server is down, the old content is left untouched</li>
</ul>
<div class="handout container">
<p>Using <tt class="docutils literal"><span class="pre">return</span> <span class="pre">(pass);</span></tt> in <tt class="docutils literal"><span class="pre">vcl_recv</span></tt>, you will always ask a backend
for content, but this will never put it into the cache. Using <tt class="docutils literal"><span class="pre">purge;</span></tt>
will remove old content, but what if the web server is down?</p>
<p>Using <tt class="docutils literal"><span class="pre">req.has_always_miss</span> <span class="pre">=</span> <span class="pre">true;</span></tt> tells Varnish to look the content
up but, as the name indicates, always miss. This means that Varnish will
first hit <tt class="docutils literal"><span class="pre">vcl_miss</span></tt> then (presumably) fetch the content from the
web server, run <tt class="docutils literal"><span class="pre">vcl_fetch</span></tt> and (again, presumably) cache the updated
copy of the content. If the backend server is down or unresponsive, the
current copy of the content is untouched and any client that does not
use <tt class="docutils literal"><span class="pre">req.hash_always_miss=true;</span></tt> will keep getting the old content as
long as this goes on.</p>
<p>The two use-cases for this is controlling who takes the penalty for
waiting around for the updated content, and ensuring that content isn&#8217;t
evicted until it&#8217;s safe.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Varnish up until 3.0.2 does not do anything to evict old content
after you have used <tt class="docutils literal"><span class="pre">req.hash_always_miss</span></tt> to update it. This means
that you will have multiple copies of the content in cache. The
newest copy will always be used, but if you cache your content for a
long period of time, the memory usage will gradually increase.</p>
<p class="last">This is a known bug, and hopefully fixed by the time you read this
warning.</p>
</div>
</div>
</div>
<div class="section" id="banning">
<h2><a class="toc-backref" href="#id94">7.5&nbsp;&nbsp;&nbsp;Banning</a><a class="headerlink" href="#banning" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Ban on anything</li>
<li>Does not free up memory</li>
<li><tt class="docutils literal"><span class="pre">ban</span> <span class="pre">req.url</span> <span class="pre">~</span> <span class="pre">&quot;/foo&quot;</span></tt></li>
<li><tt class="docutils literal"><span class="pre">ban</span> <span class="pre">req.http.host</span> <span class="pre">~</span> <span class="pre">&quot;example.com&quot;</span> <span class="pre">&amp;&amp;</span>
<span class="pre">obj.http.content-type</span> <span class="pre">~</span> <span class="pre">&quot;text&quot;</span></tt></li>
<li><tt class="docutils literal"><span class="pre">ban.list</span></tt></li>
<li>In VCL: <tt class="docutils literal"><span class="pre">ban(&quot;req.url</span> <span class="pre">~</span> <span class="pre">/foo&quot;);</span></tt></li>
</ul>
<div class="handout container">
<p>Banning in the context of Varnish refers to adding a ban to the
ban-list. It can be done both through the command line interface,
and through VCL, and the syntax is almost the same.</p>
<p>A ban is one or more statements in VCL-like syntax that will be tested
against objects in the cache when they are looked up in the cache hash.
A ban statement might be &#8220;the url starts with /sport&#8221; or &#8220;the object has
a Server-header matching lighttpd&#8221;.</p>
<p>Each object in the cache always points to an entry on the ban-list. This
is the entry that they were last checked against. Whenever Varnish
retrieves something from the cache, it checks if the objects pointer to
the ban list is point to the top of the list. If it does not point to
the top of the list, it will test the object against all new entries on
the ban list and, if the object did not match any of them, update the
pointer of the ban list.</p>
<p>There are pros and cons to this approach. The most obvious con is that
no memory is freed: Objects are only tested once a client asks for them.
A second con is that the ban list can get fairly large if there are
objects in the cache that are rarely, if ever, accessed. To remedy this,
Varnish tries to remove duplicate bans by marking them as &#8220;gone&#8221;
(indicated by a G on the ban list). Gone bans are left on the list
because an object is pointing to them, but are never again tested
against, as there is a newer ban that superseeds it.</p>
<p>The biggest pro of the ban-list approach is that Varnish can add bans to
the ban-list in constant time. Even if you have three million objects in
your cache, adding a ban is instantaneous. The load is spread over time
as the objects are requested, and they will never need to be tested if
they expire first.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">If the cache is completely empty, bans you add will not show up in
the ban list. This can often happen when testing your VCL code during
debugging.</p>
</div>
</div>
</div>
<div class="section" id="vcl-contexts-when-adding-bans">
<h2><a class="toc-backref" href="#id95">7.6&nbsp;&nbsp;&nbsp;VCL contexts when adding bans</a><a class="headerlink" href="#vcl-contexts-when-adding-bans" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>The context is that of the client present when testing, not the client
that initiated the request that resulted in the fetch from the backend.</li>
<li>In VCL, there is also the context of the client adding the item to the
ban list. This is the context used when no quotation marks are present.</li>
</ul>
<p><tt class="docutils literal"><span class="pre">ban(&quot;req.url</span> <span class="pre">==</span> <span class="pre">&quot;</span> <span class="pre">+</span> <span class="pre">req.http.x-url);</span></tt></p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">req.url</span></tt> from the future client that will trigger the test against the
object is used.</li>
<li><tt class="docutils literal"><span class="pre">req.http.x-url</span></tt> is the x-url header of the client that puts the ban on
the ban list.</li>
</ul>
<div class="handout container">
<p>One of the typical examples of purging reads <tt class="docutils literal"><span class="pre">ban(&quot;req.url</span> <span class="pre">==</span> <span class="pre">&quot;</span> <span class="pre">+</span>
<span class="pre">req.url)</span></tt>, which looks fairly strange. The important thing to remember
is that in VCL, you are essentially just creating one big string.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">To avoid confusion in VCL, keep as much as possible within quotation
marks, then verify that it works the way you planned by reviewing the
ban list through the cli, using <tt class="docutils literal"><span class="pre">ban.list</span></tt>.</p>
</div>
</div>
</div>
<div class="section" id="smart-bans">
<h2><a class="toc-backref" href="#id96">7.7&nbsp;&nbsp;&nbsp;Smart bans</a><a class="headerlink" href="#smart-bans" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>When Varnish tests bans, any <tt class="docutils literal"><span class="pre">req.*</span></tt>-reference has to come from whatever
client triggered the test.</li>
<li>A &#8220;ban lurker&#8221; thread runs in the background to test bans on less
accessed objects</li>
<li>The ban lurker has no <tt class="docutils literal"><span class="pre">req.*</span></tt>-structure. It has no URL or Hostname.</li>
<li>Smart bans are bans that only references <tt class="docutils literal"><span class="pre">obj.*</span></tt></li>
<li>Store the URL and Hostname on the object</li>
<li><tt class="docutils literal"><span class="pre">set</span> <span class="pre">beresp.http.x-url</span> <span class="pre">=</span> <span class="pre">req.url;</span></tt></li>
<li><tt class="docutils literal"><span class="pre">set</span> <span class="pre">beresp.http.x-host</span> <span class="pre">=</span> <span class="pre">req.http.host;</span></tt></li>
<li><tt class="docutils literal"><span class="pre">ban</span> <span class="pre">obj.http.x-url</span> <span class="pre">~</span> <span class="pre">/something/.*</span></tt></li>
</ul>
<div class="handout container">
<p>Varnish now has a ban lurker thread, which will test old objects
against bans periodically, without a client. For it to work, your
bans can not refer to anything starting with <cite>req</cite>, as the ban lurker
doesn&#8217;t have any request data structure.</p>
<p>If you wish to ban on url, it can be a good idea to store the URL
to the object, in <tt class="docutils literal"><span class="pre">vcl_fetch</span></tt>:</p>
<div class="highlight-python"><pre>set beresp.http.x-url = req.url;</pre>
</div>
<p>Then use that instead of <tt class="docutils literal"><span class="pre">req.url</span></tt> in your bans, in <tt class="docutils literal"><span class="pre">vcl_recv</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">ban</span><span class="p">(</span><span class="s">&quot;obj.http.x-url == &quot;</span> <span class="o">+</span>  <span class="n">req</span><span class="o">.</span><span class="n">url</span><span class="p">);</span>
</pre></div>
</div>
<p>This will allow Varnish to test the bans against less frequently
accessed objects, so they do not linger in your cache just because
no client asks for them just to discover they have been banned.</p>
</div>
</div>
<div class="section" id="ban-or-purge">
<h2><a class="toc-backref" href="#id97">7.8&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">ban()</span></tt> or <tt class="docutils literal"><span class="pre">purge;</span></tt>?</a><a class="headerlink" href="#ban-or-purge" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Banning is more flexible than <tt class="docutils literal"><span class="pre">purge;</span></tt>, but also slightly more complex</li>
<li>Banning can be done from CLI and VCL, while <tt class="docutils literal"><span class="pre">purge;</span></tt> is only possible
in VCL.</li>
<li>Smart bans require that your VCL stores <tt class="docutils literal"><span class="pre">req.url</span></tt> (or any other fields
you intend to ban on) ahead of time, even though banning on <tt class="docutils literal"><span class="pre">req.url</span></tt>
directly will still work.</li>
<li>Banning is not designed to free up memory, but smart bans using the ban
lurker will still do this.</li>
</ul>
<div class="handout container">
<p>There is rarely a need to pick either bans or purges in Varnish, as you
can have both. Some guidelines for selection, though:</p>
<ul class="simple">
<li>Any frequent automated or semi-automated cache invalidation will
likely require VCL changes for the best effect, be it <tt class="docutils literal"><span class="pre">purge;</span></tt> or
setting up smart bans.</li>
<li>If you are invalidating more than one item at a time, you will either
need a whole list, or need to use bans.</li>
<li>If it takes a long time to pull content into Varnish, it&#8217;s often a
good idea to use <tt class="docutils literal"><span class="pre">req.hash_always_miss</span></tt> to control which client ends
up waiting for the new copy. E.g: a script you control.</li>
</ul>
</div>
</div>
<div class="section" id="exercise-write-a-vcl-for-bans-and-purges">
<h2><a class="toc-backref" href="#id98">7.9&nbsp;&nbsp;&nbsp;Exercise: Write a VCL for bans and purges</a><a class="headerlink" href="#exercise-write-a-vcl-for-bans-and-purges" title="Permalink to this headline">¶</a></h2>
<p>Write a VCL implementing a <cite>PURGE</cite> and <cite>BAN</cite> request method, which issues
<tt class="docutils literal"><span class="pre">purge;</span></tt> and <tt class="docutils literal"><span class="pre">ban();</span></tt> respectively. The ban method should use the
request headers <tt class="docutils literal"><span class="pre">req.http.X-Ban-url</span></tt> and <tt class="docutils literal"><span class="pre">req.http.X-Ban-host</span></tt>
respectively. The VCL should use smart bans.</p>
<p>Do you get any artifacts from using smart bans, and can you avoid them?</p>
<p>To build further on this, you can also have a <cite>REFRESH</cite> method that fetches
new content, using <tt class="docutils literal"><span class="pre">req.hash_always_miss</span></tt>.</p>
<div class="handout container">
<p>To test this exercise you can use lwp-request. Example commands:</p>
<div class="highlight-python"><pre>lwp-request -f -m PURGE http://localhost/testpage
lwp-request -f -m BAN -H 'X-Ban-Url: .*html$' -H 'X-Ban-Host: .*\.example\.com' http://localhost/
lwp-request -f -m REFRESH http://localhost/testpage</pre>
</div>
<p>You may want to add <tt class="docutils literal"><span class="pre">-USsed</span></tt> to those commands to see the request
and response headers.</p>
</div>
</div>
<div class="section" id="solution-write-a-vcl-for-bans-and-purges">
<h2><a class="toc-backref" href="#id99">7.10&nbsp;&nbsp;&nbsp;Solution: Write a VCL for bans and purges</a><a class="headerlink" href="#solution-write-a-vcl-for-bans-and-purges" title="Permalink to this headline">¶</a></h2>
<pre class="literal-block">
sub vcl_recv {
        if (req.request == &quot;PURGE&quot;) {
                return (lookup);
        }
        if (req.request == &quot;BAN&quot;) {
                ban(&quot;obj.http.x-url ~ &quot; + req.http.x-ban-url +
                    &quot; &amp;&amp; obj.http.x-host ~ &quot; + req.http.x-ban-host);
                error 200 &quot;Banned&quot;;
        }
        if (req.request == &quot;REFRESH&quot;) {
                set req.request = &quot;GET&quot;;
                set req.hash_always_miss = true;
        }
}

sub vcl_hit {
        if (req.request == &quot;PURGE&quot;) {
                purge;
                error 200 &quot;Purged&quot;;
        }
}

sub vcl_miss {
        if (req.request == &quot;PURGE&quot;) {
                purge;
                error 404 &quot;Not in cache&quot;;
        }
}

sub vcl_fetch {
        set beresp.http.x-url = req.url;
        set beresp.http.x-host = req.http.host;
}

sub vcl_deliver {
        unset resp.http.x-url;
        unset resp.http.x-host;
}

</pre>
</div>
<div class="section" id="exercise-purge-an-article-from-the-backend">
<h2><a class="toc-backref" href="#id100">7.11&nbsp;&nbsp;&nbsp;Exercise : PURGE an article from the backend</a><a class="headerlink" href="#exercise-purge-an-article-from-the-backend" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Send a PURGE request to Varnish from your backend server after an article
is published. The publication part will be simulated.</li>
<li>The result should be that the article must be purged in Varnish.</li>
</ul>
<p>Now you know that purging can be as easy as sending a specific HTTP request
In order to help you have access to the file <cite>article.php</cite> which fakes an
article. It is recommended to create a new page called <cite>purgearticle.php</cite>.</p>
</div>
<div class="section" id="solution-purge-an-article-from-the-backend">
<h2><a class="toc-backref" href="#id101">7.12&nbsp;&nbsp;&nbsp;Solution : PURGE an article from the backend</a><a class="headerlink" href="#solution-purge-an-article-from-the-backend" title="Permalink to this headline">¶</a></h2>
<p><strong>article.php</strong></p>
<div class="highlight-python"><pre>&lt;?php
header( "Cache-Control: public, must-revalidate, max-age=3600, s-maxage=3600"  );

$date = new DateTime();
$now = $date-&gt;format( DateTime::RFC2822 );
?&gt;
&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;
&lt;html xmlns="http://www.w3.org/1999/xhtml"&gt;
    &lt;head&gt;&lt;/head&gt;
    &lt;body&gt;
        &lt;h1&gt;This is an article, cached for 1 hour&lt;/h1&gt;

        &lt;h2&gt;Now is &lt;?php echo $now; ?&gt;&lt;/h2&gt;
        &lt;a href="&lt;?=$_SERVER['PHP_SELF']?&gt;"&gt;Refresh this page&lt;/a&gt;
    &lt;/body&gt;
&lt;/html&gt;
</pre>
</div>
<p><strong>purgearticle.php</strong></p>
<div class="highlight-python"><pre>&lt;?php
header( 'Content-Type: text/plain' );
header( 'Cache-Control: max-age=0' );
$hostname = 'localhost';
$port     = 80;
$URL      = '/article.php';
$debug    = true;

print "Updating the article in the database ...\n";
purgeURL( $hostname, $port, $URL, $debug );

function purgeURL( $hostname, $port, $purgeURL, $debug )
{
    $finalURL = sprintf(
        "http://%s:%d%s", $hostname, $port, $purgeURL
    );

    print( "Purging ${finalURL}\n" );

    $curlOptionList = array(
        CURLOPT_RETURNTRANSFER    =&gt; true,
        CURLOPT_CUSTOMREQUEST     =&gt; 'PURGE',
        CURLOPT_HEADER            =&gt; true ,
        CURLOPT_NOBODY            =&gt; true,
        CURLOPT_URL               =&gt; $finalURL,
        CURLOPT_CONNECTTIMEOUT_MS =&gt; 2000
    );

    $fd = false;
    if( $debug == true ) {
        print "\n---- Curl debug -----\n";
        $fd = fopen("php://output", 'w+');
        $curlOptionList[CURLOPT_VERBOSE] = true;
        $curlOptionList[CURLOPT_STDERR]  = $fd;
    }

    $curlHandler = curl_init();
    curl_setopt_array( $curlHandler, $curlOptionList );
    curl_exec( $curlHandler );
    curl_close( $curlHandler );
    if( $fd !== false ) {
        fclose( $fd );
    }
}
?&gt;
</pre>
</div>
<p><strong>default.vcl</strong></p>
<pre class="literal-block">
backend default { .host = &quot;localhost&quot;; .port = &quot;80&quot;; }
acl purgers { &quot;127.0.0.1&quot;; }
sub vcl_recv {
    if (req.request == &quot;PURGE&quot;) {
        if (!client.ip ~ purgers) {
            error 405 &quot;Not allowed.&quot;;
        }
        return (lookup);
    }
}
sub vcl_hit {
        if (req.request == &quot;PURGE&quot;) {
                purge;
                error 200 &quot;Purged.&quot;;
        }
}
sub vcl_miss {
        if (req.request == &quot;PURGE&quot;) {
                purge;
                error 200 &quot;Purged.&quot;;
        }
}

</pre>
</div>
</div>
<div class="section" id="saving-a-request">
<h1><a class="toc-backref" href="#id102">8&nbsp;&nbsp;&nbsp;Saving a request</a><a class="headerlink" href="#saving-a-request" title="Permalink to this headline">¶</a></h1>
<p><em>This chapter is for the system administration course only</em></p>
<ul class="simple">
<li>Grace and grace mode</li>
<li>Health checks</li>
<li>Saint mode</li>
<li><tt class="docutils literal"><span class="pre">return</span> <span class="pre">(restart);</span></tt></li>
<li>Directors</li>
<li>Using ACLs</li>
</ul>
<div class="handout container">
<p>Varnish has several mechanisms for recovering from problematic
situations. It can retry a request to a different server, it can perform
health checks, use an otherwise expired object and more.</p>
<p>This chapter discusses how these features interact with each other and
how you can combine them to make your Varnish setup far more robust.</p>
</div>
<div class="section" id="core-grace-mechanisms">
<h2><a class="toc-backref" href="#id103">8.1&nbsp;&nbsp;&nbsp;Core grace mechanisms</a><a class="headerlink" href="#core-grace-mechanisms" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>A <cite>graced</cite> object is an object that has expired, but is still kept in
cache</li>
<li><cite>Grace mode</cite> is when Varnish uses a <cite>graced</cite> object</li>
<li>There is more than one way Varnish can end up using a graced object.</li>
<li><tt class="docutils literal"><span class="pre">req.grace</span></tt> defines how long overdue an object can be for Varnish to
still consider it for grace mode.</li>
<li><tt class="docutils literal"><span class="pre">beresp.grace</span></tt> defines how long past the <tt class="docutils literal"><span class="pre">beresp.ttl</span></tt>-time Varnish
will keep an object</li>
<li><tt class="docutils literal"><span class="pre">req.grace</span></tt> is often modified in <tt class="docutils literal"><span class="pre">vcl_recv</span></tt> based on the state of the
backend.</li>
</ul>
<div class="handout container">
<blockquote>
<div>When Varnish is in grace mode, it uses an object that has already
expired as far as the TTL is concerned. There are several reasons this
might happen, one of them being if a backend is marked as bad by a
health probe.</div></blockquote>
<dl class="docutils">
<dt>For Varnish to be able to use a graced object, two things need to</dt>
<dd><p class="first">happen:</p>
<ul class="simple">
<li>The object needs to still be kept around. This is affected by
<tt class="docutils literal"><span class="pre">beresp.grace</span></tt> in <tt class="docutils literal"><span class="pre">vcl_fetch</span></tt>.</li>
<li>The VCL has to allow Varnish to use an object as overdue as the one
kept around. This is affected by <tt class="docutils literal"><span class="pre">req.grace</span></tt> in <tt class="docutils literal"><span class="pre">vcl_recv</span></tt>.</li>
</ul>
<p>When setting up grace, you will need to modify both <tt class="docutils literal"><span class="pre">vcl_recv</span></tt> and
<tt class="docutils literal"><span class="pre">vcl_fetch</span></tt> to use grace effectively. The typical way to use grace is
to store an object for several hours past its TTL, but only use it a few
seconds after the TTL, except if the backend is sick. We will look more
at health checks in a moment, but for now, the following VCL can
illustrate a normal setup:</p>
<pre class="last literal-block">
sub vcl_recv {
        if (req.backend.healthy) {
                set req.grace = 30s;
        } else {
                set req.grace = 24h;
        }
}

sub vcl_fetch {
        set beresp.grace = 24h;
}

</pre>
</dd>
</dl>
</div>
</div>
<div class="section" id="req-grace-and-beresp-grace">
<h2><a class="toc-backref" href="#id104">8.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">req.grace</span></tt> and <tt class="docutils literal"><span class="pre">beresp.grace</span></tt></a><a class="headerlink" href="#req-grace-and-beresp-grace" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>set beresp.ttl=1m;
set req.grace = 30s;
set beresp.grace = 1h;</pre>
</div>
<ul class="simple">
<li>50s: Normal delivery</li>
<li>62s: Normal cache miss, but grace mode possible</li>
<li>80s: Normal cache miss, but grace mode possible</li>
<li>92s: Normal cache miss, grace mode possible but not allowed</li>
<li>3660s: (1h+1m) Object is removed from cache</li>
</ul>
<div class="handout container">
<p>In this time-line example, everything except the first normal delivery
is assuming the object is never refreshed. If a cache miss happens at
62s and the object is refreshed, then 18 seconds later (80s) a request
for the same resource would of course just hit the new 18 second old
object.</p>
<p>The flip-side to this time line is if you set <tt class="docutils literal"><span class="pre">req.grace</span></tt> to 1h but
leave <tt class="docutils literal"><span class="pre">beresp.grace</span></tt> to 30s instead. Even if grace is allowed for up
to an hour, it&#8217;s not possible since the object will be removed long
before that.</p>
<p>The lesson to learn from this is simple: There is no point in setting
<tt class="docutils literal"><span class="pre">req.grace</span></tt> to a value higher than <tt class="docutils literal"><span class="pre">beresp.grace</span></tt>, but there could
be a point in setting <tt class="docutils literal"><span class="pre">beresp.grace</span></tt> higher than <tt class="docutils literal"><span class="pre">req.grace</span></tt>.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">You can use <tt class="docutils literal"><span class="pre">set</span> <span class="pre">req.grace</span> <span class="pre">=</span> <span class="pre">0s;</span></tt> to ensure that editorial staff
doesn&#8217;t get older objects (assuming they also don&#8217;t hit the cache).
The obvious downside of this is that you disable all grace
functionality for these users, regardless of the reason.</p>
</div>
</div>
</div>
<div class="section" id="when-can-grace-happen">
<h2><a class="toc-backref" href="#id105">8.3&nbsp;&nbsp;&nbsp;When can grace happen</a><a class="headerlink" href="#when-can-grace-happen" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>A request is already pending for some specific content (deliver old
content as long as fetching new content is in progress).</li>
<li>No healthy backend is available</li>
<li>You need health probes or saint mode for Varnish to consider the backend
as unhealthy.</li>
</ul>
<div class="handout container">
<p>The original purpose of grace mode was to avoid piling up clients
whenever a popular object expired from cache. So as long as a client is
waiting for the new content, Varnish will prefer delivering graced
objects over queuing up more clients to wait for this new content.</p>
<p>This is why setting <tt class="docutils literal"><span class="pre">req.grace</span></tt> to a low value is a good performance
gain. It ensures that no client will get <em>too</em> old content, but as long
as Varnish has a copy of the content and is in the progress of updating
it, the old content will be sent. You can disable this entirely by
setting <tt class="docutils literal"><span class="pre">req.grace=0s</span></tt>, and still use graced objects for unhealthy
backends.</p>
</div>
</div>
<div class="section" id="exercise-grace">
<h2><a class="toc-backref" href="#id106">8.4&nbsp;&nbsp;&nbsp;Exercise: Grace</a><a class="headerlink" href="#exercise-grace" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Reuse the CGI script in /usr/lib/cgi-bin/test.cgi, but increase the
sleep time and allow it to cache:</p>
<div class="highlight-python"><pre>#! /bin/sh
sleep 15
echo "Content-type: text/plain"
echo "Cache-control: max-age=20"
echo
echo "Hello world"
date</pre>
</div>
</li>
<li><p class="first">Make it executable</p>
</li>
<li><p class="first">Test that it works outside of Varnish</p>
</li>
<li><p class="first">Set up <tt class="docutils literal"><span class="pre">beresp.grace</span></tt> and <tt class="docutils literal"><span class="pre">req.grace</span></tt> to 10s in VCL</p>
</li>
<li><p class="first">Fire up a single request to warm the cache, it will take 15 seconds.</p>
</li>
<li><p class="first">Fire up two requests roughly in parallel</p>
</li>
<li><p class="first">Repeat until you can see how grace affects multiple clients</p>
</li>
</ol>
<div class="handout container">
<p>With this exercise, you should see that as long as the content is within
the regular TTL, there is no difference. Once the TTL expires, the first
client that asks for the content should be stuck for 15 seconds, while
the second client should get the graced copy.</p>
<p>Also try setting <tt class="docutils literal"><span class="pre">req.grace</span></tt> to 0s and 10s while leaving
<tt class="docutils literal"><span class="pre">beresp.grace</span></tt> intact, then do the opposite.</p>
<p>Bonus: What happens to the <cite>Age</cite>-header when it takes 15 seconds to
generate a page?</p>
</div>
</div>
<div class="section" id="health-checks">
<h2><a class="toc-backref" href="#id107">8.5&nbsp;&nbsp;&nbsp;Health checks</a><a class="headerlink" href="#health-checks" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Poke your web server every N seconds</li>
<li>Affects backend selection</li>
<li><tt class="docutils literal"><span class="pre">req.backend.healthy</span></tt></li>
<li>Varnish needs at least <cite>threshold</cite> amount of good probes within a set of
the last <cite>window</cite> probes. Where <cite>threshold</cite> and <cite>window</cite> are parameters.</li>
<li>Set using <cite>.probe</cite></li>
<li>varnishlog: Backend_health</li>
<li>varnishadm: debug.health</li>
</ul>
<pre class="literal-block">
backend one {
        .host = &quot;example.com&quot;;
        .probe = {
                .url = &quot;/healthtest&quot;;
                .interval = 3s;
                .window = 5;
                .threshold = 2;
        }
}

</pre>
<div class="handout container">
<p>You can define a health check for each backend, which will cause Varnish
to probe a URL every few seconds. Normally, it will take more than one
failed request before Varnish stops using a specific backend server.</p>
<p>The above example will cause Varnish to send a request to
<a class="reference external" href="http://example.com/healthtest">http://example.com/healthtest</a> every 3 seconds. When deciding whether to
use a server or not, it will look at the last 5 probes it has sent and
require that at least 3 of them were good.</p>
<p>You also have an important variable called <cite>.initial</cite>, which defaults to
the same value as <cite>.threshold</cite>. It defines how many probes Varnish
should pretend are good when it first starts up. Before <cite>.initial</cite> was
added, Varnish needed enough time to probe the Web server and gather
good probes before it was able to start functioning after boot.</p>
<div class="highlight-python"><pre>debug.health
200 545
Backend foo is Healthy
Current states  good:  8 threshold:  5 window:  8
Average responsetime of good probes: 0.355237
Oldest                                                    Newest
================================================================
------------------------------------------------------4444444444 Good IPv4
------------------------------------------------------XXXXXXXXXX Good Xmit
------------------------------------------------------RRRRRRRRRR Good Recv
-------------------------------------------------HHHHHHHHHHHHHHH Happy</pre>
</div>
<p>The above shows the output of debug.health - the same data is also
available in the more concise <cite>Debug_health</cite> tag of varnishlog.</p>
<p><cite>Good IPv4</cite> indicates that the IP was available for routing and that
Varnish was able to connect over IPv4. <cite>Good Xmit</cite> indicates that
Varnish was able to transmit data.  <cite>Good Recv</cite> indicates that Varnish
got a valid reply. <cite>Happy</cite> indicates that the reply was a 200 OK.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Varnish does NOT send a Host header with health checks. If you
need that, you can define the entire request using <cite>.request</cite> instead
of <cite>.url</cite>.</p>
<pre class="last literal-block">
backend one {
        .host = &quot;example.com&quot;;
        .probe = {
                .request =
                        &quot;GET / HTTP/1.1&quot;
                        &quot;Host: www.foo.bar&quot;
                        &quot;Connection: close&quot;;
        }
}

</pre>
</div>
</div>
</div>
<div class="section" id="health-checks-and-grace">
<h2><a class="toc-backref" href="#id108">8.6&nbsp;&nbsp;&nbsp;Health checks and grace</a><a class="headerlink" href="#health-checks-and-grace" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>If a backend is marked as sick, grace mode is attempted</li>
<li>You can use <tt class="docutils literal"><span class="pre">req.backend.healthy</span></tt> to alter <tt class="docutils literal"><span class="pre">req.grace</span></tt> when a backend
is sick to allow Varnish to use even older content, if available.</li>
</ul>
<div class="handout container">
<p>When Varnish has no healthy backend available, it will attempt to use a
graced copy of the object it is looking for. But all the rules you
specify in VCL still apply.</p>
<p>Since you have <tt class="docutils literal"><span class="pre">req.backend.healthy</span></tt> available to you, you can use
this to optionally increase <tt class="docutils literal"><span class="pre">req.grace</span></tt> just for requests to unhealthy
backends.</p>
</div>
</div>
<div class="section" id="directors">
<h2><a class="toc-backref" href="#id109">8.7&nbsp;&nbsp;&nbsp;Directors</a><a class="headerlink" href="#directors" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Contains 1 or more backends</li>
<li>All backends must be known</li>
<li>Multiple selection methods</li>
<li>random, round-robin, hash, client and dns</li>
</ul>
<pre class="literal-block">

backend one {
   .host = &quot;localhost&quot;;
   .port = &quot;80&quot;;
}

backend two {
   .host = &quot;127.0.0.1&quot;;
   .port = &quot;81&quot;;
}

director localhosts round-robin {
        { .backend = one; }
        { .backend = two; }
        { .backend = { .host = &quot;localhost&quot;; .port = &quot;82&quot;; } }
}

sub vcl_recv {
        set req.backend = localhosts;
}

</pre>
<div class="handout container">
<p>Backend directors, usually just called directors, provide logical
groupings of similar web servers. There are several different
directors available, but they all share the same basic properties.</p>
<p>First of all, anywhere in VCL where you can refer to a backend, you
can also refer to a director.</p>
<p>All directors also allow you to re-use previously defined backends,
or define &#8220;anonymous&#8221; backends within the director definition. If a
backend is defined explicitly and referred to both directly and
from a director, Varnish will correctly record data such as number
of connections (i.e.: max connections limiting) and saintmode
thresholds. Defining an anonymous backend within a director will
still give you all the normal properties of a backend.</p>
<p>And a director must have a name.</p>
<p>The simplest directors available are the round-robin director and
the random director. The round-robin director takes no
additional arguments - only the backends. It will pick the first
backend for the first request, then the second backend for the
second request, and so on, and start again from the top. If a
health probe has marked a backend as sick, the round-robin director
will skip it.</p>
<p>The random director picks a backend randomly. It has one
per-backend parameter called <cite>weight</cite>, which provides a mechanism
for balancing the traffic to the backends. It also provides a
director-wide parameter called <cite>retries</cite> - it will try this
many times to find a healthy backend.</p>
<p>The above example will result in twice as much traffic to
localhost.</p>
</div>
<dl class="class">
<dt>
<em class="property">class </em><tt class="descname">handout</tt></dt>
<dd></dd></dl>

<div class="section" id="client-and-hash-directors">
<h3><a class="toc-backref" href="#id110">8.7.1&nbsp;&nbsp;&nbsp;Client and hash directors</a><a class="headerlink" href="#client-and-hash-directors" title="Permalink to this headline">¶</a></h3>
<p>The client and hash directors are both special variants of the random
director. Instead of a random number, the client director uses the
<tt class="docutils literal"><span class="pre">client.identity</span></tt>. The <tt class="docutils literal"><span class="pre">client.identity</span></tt> variable defaults to the
client IP, but can be changed in VCL. The same client will be directed
to the same backend, assuming that the <tt class="docutils literal"><span class="pre">client.identity</span></tt> is the same
for all requests.</p>
<p>Similarly, the hash director uses the hash data, which means that the same
URL will go to the same web server every time. This is most relevant for
multi-tiered caches.</p>
<p>For both the client and the hash director, the director will pick the next
backend available if the preferred one is unhealthy.</p>
<dl class="class">
<dt>
<em class="property">class </em><tt class="descname">handout</tt></dt>
<dd></dd></dl>

</div>
<div class="section" id="the-dns-director">
<h3><a class="toc-backref" href="#id111">8.7.2&nbsp;&nbsp;&nbsp;The DNS director</a><a class="headerlink" href="#the-dns-director" title="Permalink to this headline">¶</a></h3>
<p>The DNS director uses the Host header sent by a client to find a backend
among a list of possibles.  This allows dynamic scaling and changing of web
server pools without modifying Varnish&#8217; configuration, but instead just
waiting for Varnish to pick up on the DNS changes.</p>
<p>As the DNS director is perhaps the most complex, some extra
explanation might be useful. Consider the following example VCL.</p>
<pre class="literal-block">
director mydirector dns {
        .list = {
                .port = &quot;81&quot;;
                &quot;192.168.0.0&quot;/24;
        }
        .ttl = 5m;
        .suffix = &quot;internal.example.net&quot;;
}

sub vcl_recv {
        set req.backend = mydirector;
}

</pre>
<p>It defines 255 backends, all in the 192.168.0.0/24 range. The DNS director
can also use the traditional (non-list) format of defining backends, and
most options are supported in .list, as long as they are specified before
the relevant backends.</p>
<p>The TTL specified is for the DNS cache. In our example, the <cite>mydirector</cite>
director will cache the DNS lookups for 5 minutes. When a client asks for
<tt class="docutils literal"><span class="pre">www.example.org</span></tt>, Varnish will look up
<tt class="docutils literal"><span class="pre">www.example.org.internal.example.net</span></tt>, and if it resolves to something,
the DNS director will check if on of the backends in the 192.168.0.0./24
range matches, then use that.</p>
</div>
</div>
<div class="section" id="demo-health-probes-and-grace">
<h2><a class="toc-backref" href="#id112">8.8&nbsp;&nbsp;&nbsp;Demo: Health probes and grace</a><a class="headerlink" href="#demo-health-probes-and-grace" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="saint-mode">
<h2><a class="toc-backref" href="#id113">8.9&nbsp;&nbsp;&nbsp;Saint mode</a><a class="headerlink" href="#saint-mode" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Saint mode marks an object as sick for a specific backend for a period of
time</li>
<li>The rest of Varnish just sees a sick backend, be it for grace or backend
selection</li>
<li>Other content from the same backend can still be accessed</li>
<li>... unless more than a set amount of objects are added to the saintmode
black list for a specific backend, then the entire backend is considered
sick.</li>
<li>Normal to restart after setting <tt class="docutils literal"><span class="pre">beresp.saintmode</span> <span class="pre">=</span> <span class="pre">20s;</span></tt> in
<tt class="docutils literal"><span class="pre">vcl_fetch</span></tt></li>
</ul>
<div class="handout container">
<p>Saint mode is meant to complement your regular health checks. Some times
you just can&#8217;t spot a problem in a simple health probe, but it might be
obvious in <tt class="docutils literal"><span class="pre">vcl_fetch</span></tt>.</p>
<p>An example could be a thumbnail generator. When it fails it might return
&#8220;200 OK&#8221;, but no data. You can spot that the <cite>Length</cite>-header is 0 in
<tt class="docutils literal"><span class="pre">vcl_fetch</span></tt>, but the health probes might not be able to pick up on
this.</p>
<p>In this situation you can set <tt class="docutils literal"><span class="pre">beresp.saintmode</span> <span class="pre">=</span> <span class="pre">20s;</span></tt>, and Varnish
will not attempt to access that object (aka: URL) from that specific
backend for the next 20 seconds. If you restart and attempt the same
request again, Varnish will either pick a different backend if one is
available, or try to use a graced object, or finally deliver an error
message.</p>
<p>If you have more than 10 [objects] (default) objects
black listed for a specific backend, the entire backend is considered
sick. The rationale is that if 10 URLs already failed, there&#8217;s probably
no reason to try an 11th.</p>
<p>There is no need to worry about recovering. The object will only be on
the saint list for as long as you specify, regardless of whether the
threshold is reached or not.</p>
<p>Use saint mode to complement your health checks. They are meant to
either help Varnish &#8220;fail fast&#8221; for a backend that has failed, until the
health probes can take over, or catch errors that are not possible to
spot with the health checks.</p>
<p>As such, it&#8217;s advised to keep the saint period short. Typical suggestions
are 20 seconds, 30 seconds, etc.</p>
</div>
</div>
<div class="section" id="restart-in-vcl">
<h2><a class="toc-backref" href="#id114">8.10&nbsp;&nbsp;&nbsp;Restart in VCL</a><a class="headerlink" href="#restart-in-vcl" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Start the VCL processing again from the top of <tt class="docutils literal"><span class="pre">vcl_recv</span></tt>.</li>
<li>Any changes made are kept.</li>
<li>Parameter <tt class="docutils literal"><span class="pre">max_restarts</span></tt> safe guards against infinite loops</li>
<li><tt class="docutils literal"><span class="pre">req.restarts</span></tt> counts the number of restarts</li>
</ul>
<pre class="literal-block">
sub vcl_fetch {
        if (req.restarts == 0 &amp;&amp;
                 req.request == &quot;GET&quot; &amp;&amp;
                 beresp.status == 301) {
                set beresp.http.location = regsub(beresp.http.location,&quot;^http://&quot;,&quot;&quot;);
                set req.http.host = regsub(beresp.http.location,&quot;/.*$&quot;,&quot;&quot;);
                set req.url = regsub(beresp.http.location,&quot;[^/]*&quot;,&quot;&quot;);
                return (restart);
        }
}

</pre>
<div class="handout container">
<p>Restarts in VCL can be used everywhere.</p>
<p>They allow you to re-run the VCL state engine with different variables.
The above example simply executes a redirect without going through the
client. An other example is using it in combination with PURGE and
rewriting so the script that issues PURGE will also refresh the content.</p>
<p>Yet another example is to combine it with saint mode.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Varnish version 2.1.5 is the first version where <tt class="docutils literal"><span class="pre">return(restart);</span></tt>
is valid in <tt class="docutils literal"><span class="pre">vcl_deliver</span></tt>, making it available everywhere.</p>
</div>
</div>
</div>
<div class="section" id="backend-properties">
<h2><a class="toc-backref" href="#id115">8.11&nbsp;&nbsp;&nbsp;Backend properties</a><a class="headerlink" href="#backend-properties" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Most properties are optional</li>
</ul>
<div class="highlight-python"><pre>backend default {
   .host = "localhost";
   .port = "80";
   .connect_timeout = 0.5s;
   .between_bytes_timeout = 5s;
   .saintmode_threshold = 20;
   .first_byte_timeout = 20s;
   .max_connections = 50;
}
</pre>
</div>
<div class="handout container">
<p>All the backend-specific timers that are available as parameters can
also be overridden in the VCL on a backend-specific level.</p>
<p>While the timeouts have already been discussed, there are some other
notable parameters.</p>
<p>The saintmode threshold defines how many items can be blacklisted by
saint mode before the entire backend is considered sick. Saint mode will
be discussed in more detail.</p>
<p>If your backend is struggling, it might be advantageous to set
<tt class="docutils literal"><span class="pre">max_connections</span></tt> so only a set number of simultaneous connections
will be issued to a specific backend.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Varnish only accepts hostnames for backend servers that resolve to a
maximum of one IPv4 address <cite>and</cite> one IPv6 address. The parameter
<tt class="docutils literal"><span class="pre">prefer_ipv6</span></tt> defines which one Varnish will prefer.</p>
</div>
</div>
</div>
<div class="section" id="example-evil-backend-hack">
<h2><a class="toc-backref" href="#id116">8.12&nbsp;&nbsp;&nbsp;Example: Evil backend hack</a><a class="headerlink" href="#example-evil-backend-hack" title="Permalink to this headline">¶</a></h2>
<p>You can not use saintmode in <tt class="docutils literal"><span class="pre">vcl_error</span></tt> and health probes can be
slow to pick up on trouble. So, in order to act on a failing backend
right away you can use the supplied hack to force delivery of graced
object right away.</p>
<p>You can use a fake backend that&#8217;s always sick to force a grace copy. This
is considered a rather dirty hack that works.</p>
<pre class="literal-block">
backend normal {
        .host = &quot;localhost&quot;;
        .probe = { .url = &quot;/&quot;; }
}

backend fail {
        .host = &quot;localhost&quot;;
        .port = &quot;21121&quot;;
        .probe = { .url = &quot;/asfasfasf&quot;; .initial = 0; .interval = 1d; }
}

sub vcl_recv {
        if (req.restarts == 0) {
                set req.backend = normal;
        } else {
                set req.backend = fail;
        }

        if (req.backend.healthy) {
                set req.grace = 30s;
        } else {
                set req.grace = 24h;
        }
}

sub vcl_fetch {
        set beresp.grace = 24h;
}

sub vcl_error {
        if (req.restarts == 0) {
                return (restart);
        }
}

</pre>
</div>
<div class="section" id="access-control-lists">
<h2><a class="toc-backref" href="#id117">8.13&nbsp;&nbsp;&nbsp;Access Control Lists</a><a class="headerlink" href="#access-control-lists" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>An ACL is a list of IPs or IP ranges.</li>
<li>Compare with <tt class="docutils literal"><span class="pre">client.ip</span></tt> or <tt class="docutils literal"><span class="pre">server.ip</span></tt></li>
</ul>
<pre class="literal-block">
acl management {
        &quot;172.16.0.0&quot;/16;
}

acl sysadmins {
        &quot;192.168.0.0&quot;/16;
        ! &quot;192.168.0.1&quot;;
}

sub vcl_recv {
        if (client.ip ~ management) {
                set req.url = regsub(req.url, &quot;^&quot;,&quot;/proper-stuff&quot;);
        } elsif (client.ip ~ sysadmins) {
                set req.url = regsub(req.url, &quot;^&quot;,&quot;/cool-stuff&quot;);
        }
}

</pre>
<div class="handout container">
<p>ACLs are fairly simple. A single IP is listed as <tt class="docutils literal"><span class="pre">&quot;192.168.1.2&quot;</span></tt>, and
to turn it into an IP-range, add the /24 <em>outside</em> of the quotation
marks (<tt class="docutils literal"><span class="pre">&quot;192.168.1.0&quot;/24</span></tt>). To exclude an IP or range from an ACL,
precede it with an exclamation mark - that way you can include all the
IPs in a range except the gateway, for example.</p>
<p>ACLs can be used for anything. Some people have even used ACLs to
differantiate how their Varnish servers behaves (e.g.: A single VCL for
different Varnish servers - but it evaluates server.ip to see where it
really is).</p>
<p>Typical use cases are for PURGE requests, bans or avoiding the cache
entirely.</p>
</div>
</div>
<div class="section" id="exercise-combine-purge-and-restart">
<h2><a class="toc-backref" href="#id118">8.14&nbsp;&nbsp;&nbsp;Exercise: Combine PURGE and restart</a><a class="headerlink" href="#exercise-combine-purge-and-restart" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Re-write the PURGE example to also issue a restart</li>
<li>The result should be that a PURGE both removes the content and fetches a
new copy from the backend.</li>
</ul>
</div>
<div class="section" id="solution-combine-purge-and-restart">
<h2><a class="toc-backref" href="#id119">8.15&nbsp;&nbsp;&nbsp;Solution: Combine PURGE and restart</a><a class="headerlink" href="#solution-combine-purge-and-restart" title="Permalink to this headline">¶</a></h2>
<pre class="literal-block">
acl purgers {
        &quot;127.0.0.1&quot;;
        &quot;192.168.0.0&quot;/24;
}

sub vcl_recv {
        if (req.restarts == 0) {
                unset req.http.X-purger;
        }
        if (req.request == &quot;PURGE&quot;) {
                if (!client.ip ~ purgers) {
                        error 405 &quot;Method not allowed&quot;;
                }
                return (lookup);
        }
}

sub vcl_hit {
        if (req.request == &quot;PURGE&quot;) {
                purge;
                set req.request = &quot;GET&quot;;
                set req.http.X-purger = &quot;Purged&quot;;
                error 800 &quot;restart&quot;;
        }
}

sub vcl_miss {
        if (req.request == &quot;PURGE&quot;) {
                purge;
                set req.request = &quot;GET&quot;;
                set req.http.X-purger = &quot;Purged-possibly&quot;;
                error 800 &quot;restart&quot;;    # cant restart in miss, yet. go via error
        }
}

sub vcl_error {
        if (obj.status == 800 ) {
                return(restart);
        }
}

sub vcl_pass {
        if (req.request == &quot;PURGE&quot;) {
                error 502 &quot;PURGE on a passed object&quot;;
        }
}

sub vcl_deliver {
        if (req.http.X-purger) {
                set resp.http.X-purger = req.http.X-purger;
        }
}

</pre>
<div class="handout container">
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Whenever you are using <tt class="docutils literal"><span class="pre">req.http</span></tt> to store an internal variable,
you should get used to unsetting it in <tt class="docutils literal"><span class="pre">vcl_recv</span></tt> on the first run.
Otherwise a client could supply it directly. In this situation, the
outcome wouldn&#8217;t be harmful, but it&#8217;s a good habit to establish.</p>
</div>
</div>
</div>
</div>
<div class="section" id="content-composition">
<h1><a class="toc-backref" href="#id120">9&nbsp;&nbsp;&nbsp;Content Composition</a><a class="headerlink" href="#content-composition" title="Permalink to this headline">¶</a></h1>
<p><em>This chapter is for the webdeveloper course only</em></p>
<p>You now know almost all you need to know to adapt your site to work well
with Varnish. In this chapter, we will look closer at how to glue your
content together. We will look at:</p>
<ul class="simple">
<li>AJAX and masquerading AJAX requests through Varnish.</li>
<li>Cookies and how you can work with them.</li>
<li>Edge Side Includes (ESI) and how you can compose a single client-visible
page out of multiple objects.</li>
<li>Combining ESI and Cookies.</li>
</ul>
<div class="handout container">
While you may or may not be comfortable in PHP, it should be easy to
re-use the same ideas in other languages after you&#8217;ve finished this
chapter.</div>
<div class="section" id="a-typical-site">
<h2><a class="toc-backref" href="#id121">9.1&nbsp;&nbsp;&nbsp;A typical site</a><a class="headerlink" href="#a-typical-site" title="Permalink to this headline">¶</a></h2>
<p>Most websites follow a pattern, with easily distinguishable parts:</p>
<ul class="simple">
<li>A front page.</li>
<li>Articles or sub-pages.</li>
<li>A login-box or &#8220;home bar&#8221;.</li>
<li>Static elements, like CSS, JavaScript and graphics.</li>
</ul>
<p>To truly utilize Varnish to its full potential, you have to start by
mentally organizing your own site. Ask yourself this:</p>
<ul class="simple">
<li>What makes this page unique, and how can I let caches know.</li>
</ul>
<div class="handout container">
<p>Beginning with the static elements should be easy. You already know what
you need to know to handle those.</p>
<p>An other easy option is to only cache content for users that are not
logged in. For news-papers, that&#8217;s probably enough. For a web-shop,
that&#8217;s not going to cut it.</p>
<p>But even for a web-shop, you can frequently re-use objects. If you can
isolate the user-specific bits, like the shopping cart, you can cache
the rest. You could even cache the shopping cart, if you told Varnish
when it changed.</p>
<p>The most important lessons, though, is to start with what you know.</p>
</div>
</div>
<div class="section" id="cookies">
<h2><a class="toc-backref" href="#id122">9.2&nbsp;&nbsp;&nbsp;Cookies</a><a class="headerlink" href="#cookies" title="Permalink to this headline">¶</a></h2>
<p>Cookies are frequently used to identify unique users, or user-choices. They
can be used for anything from identifying a user-session in a web-shop to
opting out of a sites mobile-version. There are three ways cookies can be
handled:</p>
<ul class="simple">
<li>The client can (and will) send a Cookie request-header containing all
cookies that matches that site and path.</li>
<li>The server can set a cookie by returning a Set-Cookie response-header.</li>
<li>You can modify cookies through JavaScript.</li>
</ul>
<div class="handout container">
<p>We will not look too closely at the JavaScript-method, but it is often
necessary to go down that road for user-specific content. We&#8217;ll see why
soon enough.</p>
<p>For Varnish, there are several ways to handle Cookies.</p>
</div>
</div>
<div class="section" id="vary-and-cookies">
<h2><a class="toc-backref" href="#id123">9.3&nbsp;&nbsp;&nbsp;Vary and Cookies</a><a class="headerlink" href="#vary-and-cookies" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>The Vary-header can be used to let caches cache content that is based on
the value of cookies.</li>
<li>Cookies are widely used</li>
<li>... but almost no-one sends <tt class="docutils literal"><span class="pre">Vary:</span> <span class="pre">Cookie</span></tt> for content that does,
indeed, vary based on the Cookie.</li>
<li>Thus: Varnish does not cache when cookies are involved, by default.</li>
</ul>
<div class="handout container">
<p>There is a good chance that you never knew what the Vary-header did
before you begun this course. You are not alone. However, many people
know how to store and retrieve cookies.</p>
<p>If Varnish&#8217; default VCL only obeyed the HTTP standard, you would be able
to cache content freely, regardless of the cookies a client sent. If the
server generated different pages based on the cookie-header, it would
signal that by sending a Vary response-header with Cookie in it. Sadly,
that&#8217;s not the case.</p>
<p>To avoid cache collisions and littering the cache with large amount of
copies of the same content, Varnish does not cache a page if the Cookie
request-header or Set-Cookie response header is present.</p>
<p>You can force it, by issuing <tt class="docutils literal"><span class="pre">return</span> <span class="pre">(lookup);</span></tt> in <cite>vcl_recv</cite>, and
similar actions for Set-Cookie, and you&#8217;ll most likely have to. But be
careful, or you end up giving a page generated based on a cookie to the
wrong person.</p>
</div>
</div>
<div class="section" id="best-practices-for-cookies">
<h2><a class="toc-backref" href="#id124">9.4&nbsp;&nbsp;&nbsp;Best practices for cookies</a><a class="headerlink" href="#best-practices-for-cookies" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p class="first">Remove all cookies you know you do not need, then cache if none are left.</p>
</li>
<li><p class="first">Use URL schemes that let you easily determine if a page needs a cookie or
not. E.g:</p>
<blockquote>
<div><ul class="simple">
<li>/common/ - strip all cookies.</li>
<li>/user/ - Leave user-cookies.</li>
<li>/voucher/ - Only leave the voucher-cookie.</li>
<li>etc.</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">Once you have a URL scheme that works, add the req.http.cookie to the
cache hash in <cite>vcl_hash</cite>: <tt class="docutils literal"><span class="pre">hash_data(req.http.cookie);</span></tt>.</p>
</li>
<li><p class="first">Never cache a <cite>Set-Cookie</cite> header. Either remove the header before
caching or don&#8217;t cache the object at all.</p>
</li>
<li><p class="first">Avoid using <tt class="docutils literal"><span class="pre">return</span> <span class="pre">(deliver);</span></tt> more than once in <cite>vcl_fetch</cite>. Instead,
finish up with something similar to:</p>
<div class="highlight-python"><pre>if (beresp.ttl &gt; 0s) {
        unset beresp.http.set-cookie;
}</pre>
</div>
<p>This will ensure that all cached pages are stripped of set-cookie.</p>
</li>
</ul>
<div class="handout container">
<p>A golden rule through all of this is: It&#8217;s far better to either NOT
cache or cache multiple copies of the same content for each user than it
is to deliver the wrong content to the wrong person.</p>
<p>Your worst-case scenario should be a broken cache and overloaded web
servers, not a compromised user-account and a lawsuit.</p>
</div>
</div>
<div class="section" id="exercise-compare-vary-and-hash-data">
<h2><a class="toc-backref" href="#id125">9.5&nbsp;&nbsp;&nbsp;Exercise: Compare Vary and <tt class="docutils literal"><span class="pre">hash_data</span></tt></a><a class="headerlink" href="#exercise-compare-vary-and-hash-data" title="Permalink to this headline">¶</a></h2>
<p>Both a <tt class="docutils literal"><span class="pre">Vary:</span> <span class="pre">Cookie</span></tt> response-header and <tt class="docutils literal"><span class="pre">hash_data(req.http.cookie);</span></tt>
will create separate objects in the cache. This exercise is all about Vary-
and hash-dynamics.</p>
<ol class="arabic simple">
<li>Use the <tt class="docutils literal"><span class="pre">purge;</span></tt> code from previous chapters.</li>
<li>Test with <tt class="docutils literal"><span class="pre">curl</span> <span class="pre">--cookie</span> <span class="pre">&quot;user=John&quot;</span> <span class="pre">http://localhost/cookies.php</span></tt></li>
<li>Force Varnish to cache, despite the client sending a Cookie header</li>
<li>Change the cookie, and see if you get a new value.</li>
<li>Make <tt class="docutils literal"><span class="pre">cookies.php</span></tt> send a <tt class="docutils literal"><span class="pre">Vary:</span> <span class="pre">Cookie</span></tt> header, then try changing
the cookie again.</li>
<li>Try to PURGE. Check if it affects all, none or just one of the objects
in cache (e.g: change the cookie-value and see if PURGE has purged all
of them).</li>
<li>Remove <tt class="docutils literal"><span class="pre">beresp.http.Vary</span></tt> in <cite>vcl_fetch</cite> and see if Varnish will still
honor the Vary-header.</li>
<li>Add <tt class="docutils literal"><span class="pre">hash_data(req.http.cookie);</span></tt> in <cite>vcl_hash</cite>. Check how multiple
cookie-values will give individually-cached pages.</li>
<li>Try PURGE now that you use <tt class="docutils literal"><span class="pre">hash_data()</span></tt> instead of Vary.</li>
</ol>
<div class="handout container">
Once you&#8217;ve done this exercise, you should have a very good idea on how
both Vary and <tt class="docutils literal"><span class="pre">hash_data();</span></tt> works. We only looked at it for the
Cookie header, but the same rules would apply to any other header too.</div>
</div>
<div class="section" id="edge-side-includes">
<h2><a class="toc-backref" href="#id126">9.6&nbsp;&nbsp;&nbsp;Edge Side Includes</a><a class="headerlink" href="#edge-side-includes" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>What is ESI</li>
<li>How to use ESI</li>
<li>Testing ESI without Varnish</li>
</ul>
<img alt="_images/esi.png" class="align-center" src="_images/esi.png" style="width: 60%;" />
<div class="handout container">
<p>Edge Side Includes or ESI is a small markup language for dynamic
web content assembly at the reverse proxy level.
The reverse proxy analyses the HTML code, parses ESI specific markup and
assembles the final result before flushing it to the client.</p>
<p>With ESI, Varnish can be used not only to deliver objects, but to glue
them together. The most typical use case for ESI is a news article with
a &#8220;most recent news&#8221; box at the side. The article itself is most likely
written once and possibly never changed, and can be cached for a long
time. The box at the side with &#8220;most recent news&#8221;, however, will change
frequently. With ESI, the article can include a &#8220;most recent news&#8221; box
with a different TTL.</p>
<p>Varnish would then first fetch the news article from a web server, then
parse it for ESI content, see the <tt class="docutils literal"><span class="pre">&lt;esi:include</span> <span class="pre">src=&quot;/top.html&quot;&gt;</span></tt>
item, then fetch <cite>/top.html</cite> as if it was a normal object, either
finding it already cached or getting it from a web server and inserting
it into cache. The TTL of <cite>/top.html</cite> can be 5 minutes while the article
is cached for two days. Varnish will know that it has to glue the page
together from two different objects when it sends it, and thus it will
update the parts independently and always use the most updated version.</p>
</div>
</div>
<div class="section" id="basic-esi-usage">
<h2><a class="toc-backref" href="#id127">9.7&nbsp;&nbsp;&nbsp;Basic ESI usage</a><a class="headerlink" href="#basic-esi-usage" title="Permalink to this headline">¶</a></h2>
<p>Enabling ESI in Varnish is simple enough:</p>
<pre class="literal-block">
sub vcl_fetch {
        set beresp.do_esi = true;
}

</pre>
<p>To include a page in another, the <tt class="docutils literal"><span class="pre">&lt;esi:include&gt;</span></tt> tag is used:</p>
<div class="highlight-python"><pre>&lt;esi:include src="/url" /&gt;</pre>
</div>
<p>You can also strip cookies for the top-element of an ESI page, but leave
them for the sub-page. This is done in <cite>vcl_recv</cite>.</p>
<div class="handout container">
<p>Varnish only supports the three following tags:</p>
<ul>
<li><p class="first"><tt class="docutils literal"><span class="pre">&lt;esi:include&gt;</span></tt> : calls the page defined in the &#8220;src&#8221; attribute and inserts it
in the page where the tag has been placed.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">&lt;esi:remove&gt;</span></tt> : removes any code inside this opening and closing tag.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">&lt;!--esi</span> <span class="pre">``(content)</span></tt> &#8211;&gt;``: Leaves <tt class="docutils literal"><span class="pre">(content)</span></tt> unparsed. E.g,
the following will not perform substitution for the
<tt class="docutils literal"><span class="pre">&lt;esi:include...</span></tt> tag:</p>
<div class="highlight-python"><pre>&lt;!--esi
    An esi tag looks like: &lt;esi:include src="example"&gt;
--&gt;</pre>
</div>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">By default, Varnish refuses to parse content for ESI if it does not
<cite>look</cite> like XML. That means that it has to start with a <cite>&lt;</cite>-sign.
You should be able to see ESI parse errors both in varnishstat and
varnishlog, though you may have to look closely.</p>
</div>
</div>
</div>
<div class="section" id="exercise-enable-esi-and-cookies">
<h2><a class="toc-backref" href="#id128">9.8&nbsp;&nbsp;&nbsp;Exercise: Enable ESI and Cookies</a><a class="headerlink" href="#exercise-enable-esi-and-cookies" title="Permalink to this headline">¶</a></h2>
<p>Use the <cite>esi-top.php</cite> and <cite>esi-user.php</cite>-files to test ESI.</p>
<ol class="arabic simple">
<li>Visit the <cite>esi-top.php</cite>-page and observe that the ESI-markup is clearly
visible.</li>
<li>Enable ESI in Varnish and re-test.</li>
<li>Strip all cookies from <cite>esi-top.php</cite> and make it cache.</li>
<li>Let the user-page cache too. It emits <tt class="docutils literal"><span class="pre">Vary:</span> <span class="pre">Cookie</span></tt>, but might need
some help.</li>
</ol>
<div class="handout container">
<p>Try using <tt class="docutils literal"><span class="pre">return(lookup)</span></tt> in <cite>vcl_recv</cite> as little as you can, and
<tt class="docutils literal"><span class="pre">return(deliver);</span></tt> in <cite>vcl_fetch</cite> as little as you can. This is a
general rule, that will train you to make safer Varnish setups.</p>
<p>During the exercise, make sure you understand all the cache mechanisms
at play. You can also try removing the <tt class="docutils literal"><span class="pre">Vary:</span> <span class="pre">Cookie</span></tt>-header from
<cite>esi-user.php</cite> and test.</p>
<p>You may also want to try <tt class="docutils literal"><span class="pre">PURGE</span></tt>. You will have to purge each of the
objects: Purging just <cite>/esi-top.php</cite> will not automatically purge
<cite>/esi-user.php</cite>.</p>
</div>
</div>
<div class="section" id="testing-esi-without-varnish">
<h2><a class="toc-backref" href="#id129">9.9&nbsp;&nbsp;&nbsp;Testing ESI without Varnish</a><a class="headerlink" href="#testing-esi-without-varnish" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>You can test ESI Using JavaScript to fill in the blanks</li>
</ul>
<div class="handout container">
<p>During the development period you might not need Varnish all the time as it
might make you less comfortable when adding a particular feature. There
is a solution based on JavaScript that you could use to interpret ESI syntax
without having to use Varnish at all. You can download the library at the
following URL:</p>
<ul class="simple">
<li><a class="reference external" href="http://www.catalystframework.org/calendar/static/2008/esi/ESI_Parser.tar.gz">http://www.catalystframework.org/calendar/static/2008/esi/ESI_Parser.tar.gz</a></li>
</ul>
<p>Once downloaded, extract it in your code base, include <cite>esiparser.js</cite> and
include the following JavaScript code to trigger the ESI parser:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="nx">do_esi_parsing</span><span class="p">(</span><span class="nb">document</span><span class="p">);</span> <span class="p">});</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="masquerading-ajax-requests">
<h2><a class="toc-backref" href="#id130">9.10&nbsp;&nbsp;&nbsp;Masquerading AJAX requests</a><a class="headerlink" href="#masquerading-ajax-requests" title="Permalink to this headline">¶</a></h2>
<table border="1" class="docutils">
<colgroup>
<col width="49%" />
<col width="51%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><img alt="_images/ajaxok.png" class="first last align-center" src="_images/ajaxok.png" style="width: 900px;" />
</td>
<td><img alt="_images/ajaxko.png" class="first last align-center" src="_images/ajaxko.png" style="width: 900px;" />
</td>
</tr>
<tr class="row-even"><td>What works</td>
<td>What does not work</td>
</tr>
</tbody>
</table>
<div class="handout container">
With AJAX it is not possible to send requests to a request across another domain.
This is a security restriction imposed by browsers. This issue can be easily
solved by using Varnish and VCL.</div>
</div>
<div class="section" id="exercise-write-a-vcl-that-masquerades-xhr-calls">
<h2><a class="toc-backref" href="#id131">9.11&nbsp;&nbsp;&nbsp;Exercise : write a VCL that masquerades XHR calls</a><a class="headerlink" href="#exercise-write-a-vcl-that-masquerades-xhr-calls" title="Permalink to this headline">¶</a></h2>
<p>By using the <cite>ajax.html</cite> page provided write a VCL that masquerades Ajax
requests.</p>
</div>
<div class="section" id="solution-write-a-vcl-that-masquerades-xhr-calls">
<h2><a class="toc-backref" href="#id132">9.12&nbsp;&nbsp;&nbsp;Solution : write a VCL that masquerades XHR calls</a><a class="headerlink" href="#solution-write-a-vcl-that-masquerades-xhr-calls" title="Permalink to this headline">¶</a></h2>
<p><strong>ajax.html</strong></p>
<pre class="literal-block">
&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot;
&quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;
&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;
    &lt;head&gt;
        &lt;script type=&quot;text/javascript&quot; src=&quot;http://ajax.googleapis.com/ajax/libs/jquery/1.4/jquery.min.js&quot;&gt;
        &lt;/script&gt;
        &lt;script type=&quot;text/javascript&quot;&gt;
            function getNonMasqueraded()
            {
                $(&quot;#result&quot;).load( &quot;http://www.google.com/robots.txt&quot; );
            }

            function getMasqueraded()
            {
                $(&quot;#result&quot;).load( &quot;/masq/robots.txt&quot; );
            }
        &lt;/script&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;h1&gt;Cross-domain Ajax&lt;/h1&gt;
        &lt;ul&gt;
            &lt;li&gt;&lt;a href=&quot;javascript:getNonMasqueraded()&quot;&gt;Test a non masqueraded cross-domain request&lt;/a&gt;&lt;/li&gt;
            &lt;li&gt;&lt;a href=&quot;javascript:getMasqueraded()&quot;&gt;Test a masqueraded cross-domain request&lt;/a&gt;&lt;/li&gt;
        &lt;/ul&gt;

        &lt;h1&gt;Result&lt;/h1&gt;
        &lt;div id=&quot;result&quot;&gt;&lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;

</pre>
<p><strong>default.vcl</strong></p>
<div class="highlight-python"><pre>backend google {
    .host = "209.85.147.106";
    .port = "80";
}

sub vcl_fetch {
    if (req.url ~ "^/masq") {
        set req.backend = google;
        set req.http.host = "www.google.com";
        set req.url = regsub(req.url, "^/masq", "");
        remove req.http.Cookie;
        return(deliver);
    }
    /* [...] */
}
</pre>
</div>
</div>
</div>
<div class="section" id="finishing-words">
<h1><a class="toc-backref" href="#id133">10&nbsp;&nbsp;&nbsp;Finishing words</a><a class="headerlink" href="#finishing-words" title="Permalink to this headline">¶</a></h1>
<div class="section" id="varnish-2-1-to-3-0">
<h2><a class="toc-backref" href="#id134">10.1&nbsp;&nbsp;&nbsp;Varnish 2.1 to 3.0</a><a class="headerlink" href="#varnish-2-1-to-3-0" title="Permalink to this headline">¶</a></h2>
<p>Varnish 3.0, in addition to new features, also changed several aspects of
VCL and parameters.</p>
<table border="1" class="docutils">
<colgroup>
<col width="47%" />
<col width="53%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Varnish 2.1</th>
<th class="head">Varnish 3.0</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>vcl_fetch: <tt class="docutils literal"><span class="pre">return</span> <span class="pre">(pass);</span></tt></td>
<td>vcl_fetch: <tt class="docutils literal"><span class="pre">return</span> <span class="pre">(hit_for_pass);</span></tt></td>
</tr>
<tr class="row-odd"><td>vcl_recv: <tt class="docutils literal"><span class="pre">return</span> <span class="pre">(pass);</span></tt></td>
<td>vcl_recv: <tt class="docutils literal"><span class="pre">return</span> <span class="pre">(pass);</span></tt></td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">purge(....);</span></tt></td>
<td><tt class="docutils literal"><span class="pre">ban(.....);</span></tt></td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">C{</span> <span class="pre">VRT_Nuke(...);</span> <span class="pre">}C</span></tt></td>
<td><tt class="docutils literal"><span class="pre">purge;</span></tt></td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">set</span> <span class="pre">req.url</span> <span class="pre">=</span> <span class="pre">&quot;/test&quot;</span> <span class="pre">req.url;</span></tt></td>
<td><tt class="docutils literal"><span class="pre">set</span> <span class="pre">req.url</span> <span class="pre">=</span> <span class="pre">&quot;/test&quot;</span> <span class="pre">+</span> <span class="pre">req.url;</span></tt></td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">log</span> <span class="pre">&quot;something&quot;;</span></tt></td>
<td><tt class="docutils literal"><span class="pre">import</span> <span class="pre">std;</span></tt>
<tt class="docutils literal"><span class="pre">std.log(&quot;something&quot;);</span></tt></td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">&quot;%2520&quot;</span></tt> is literal <cite>%20</cite></td>
<td><tt class="docutils literal"><span class="pre">&quot;%20&quot;</span></tt> - no more %-escapes</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">set</span> <span class="pre">req.hash</span> <span class="pre">+=</span> <span class="pre">req.url</span></tt></td>
<td><tt class="docutils literal"><span class="pre">hash_data(req.url);</span></tt></td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">esi;</span></tt></td>
<td><tt class="docutils literal"><span class="pre">set</span> <span class="pre">beresp.do_esi</span> <span class="pre">=</span> <span class="pre">true;</span></tt></td>
</tr>
<tr class="row-odd"><td><cite>thread_pool_max</cite> does not depend
on <cite>thread_pools</cite>, but
<cite>thread_pool_min</cite> does.</td>
<td>Both <cite>thread_pool_max</cite> and
<cite>thread_pool_min</cite> are per thread
pool</td>
</tr>
<tr class="row-even"><td>thread_pool_max=200 and
thread_pools=8 means max 200
total threads.</td>
<td>thread_pool_max=200 and
thread_pools=8 means max 1600
total threads</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="resources">
<h2><a class="toc-backref" href="#id135">10.2&nbsp;&nbsp;&nbsp;Resources</a><a class="headerlink" href="#resources" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>RFC 2616</li>
</ul>
<p>Community driven:</p>
<ul class="simple">
<li><a class="reference external" href="http://varnish-cache.org">http://varnish-cache.org</a></li>
<li><a class="reference external" href="http://varnish-cache.org/docs/">http://varnish-cache.org/docs/</a></li>
<li><a class="reference external" href="http://repo.varnish-cache.org/">http://repo.varnish-cache.org/</a></li>
<li><a class="reference external" href="http://varnish-cache.org/wiki/VCLExamples">http://varnish-cache.org/wiki/VCLExamples</a></li>
<li>Public mailing lists: <a class="reference external" href="http://varnish-cache.org/wiki/MailingLists">http://varnish-cache.org/wiki/MailingLists</a></li>
<li>Public IRC channel: #varnish at irc.linpro.no</li>
</ul>
<p>Commercial:</p>
<ul class="simple">
<li><a class="reference external" href="http://planet.varnish-cache.org/">http://planet.varnish-cache.org/</a></li>
<li><a class="reference external" href="http://www.varnish-software.com">http://www.varnish-software.com</a></li>
<li><a class="reference external" href="http://repo.varnish-software.com">http://repo.varnish-software.com</a> (for service agreement customers)</li>
<li><a class="reference external" href="mailto:support&#37;&#52;&#48;varnish-software&#46;com">support<span>&#64;</span>varnish-software<span>&#46;</span>com</a> (for existing customers, with SLA)</li>
<li><a class="reference external" href="mailto:sales&#37;&#52;&#48;varnish-software&#46;com">sales<span>&#64;</span>varnish-software<span>&#46;</span>com</a></li>
</ul>
</div>
</div>
<div class="section" id="appendix-a-varnish-programs">
<h1><a class="toc-backref" href="#id136">11&nbsp;&nbsp;&nbsp;Appendix A: Varnish Programs</a><a class="headerlink" href="#appendix-a-varnish-programs" title="Permalink to this headline">¶</a></h1>
<p>SHMLOG tools</p>
<ul class="simple">
<li>varnishlog</li>
<li>varnishncsa</li>
<li>varnishstat</li>
<li>varnishhist</li>
<li>varnishtop</li>
<li>varnishsizes</li>
</ul>
<p>Administration</p>
<ul class="simple">
<li>varnishadm</li>
</ul>
<p>Misc</p>
<ul class="simple">
<li>varnishtest</li>
<li>varnishreplay</li>
</ul>
<div class="handout container">
<p>Varnish provides several tools to help monitor and control Varnish.
varnishadm, used to access the management interface, is the only one
that can affect a running instance of Varnish.</p>
<p>All the other tools operate exclusively on the shared memory log, often
called shmlog in the context of Varnish. They take similar (but not
identical) command line arguments, and use the same underlying API.</p>
<p>Among the log-parsing tools, varnishstat is so far unique in that it
only looks at counters. The counters are easily found in the shmlog, and
are typically polled at reasonable interval to give the impression of
real-time updates. Counters, unlike the rest of the log, are not
directly mapped to a single request, but represent how many times some
specific action has occurred since Varnish started.</p>
<p>The rest of the tools work on the round robin part of the shmlog, which
deals with specific requests. Since the shmlog provides large amounts of
information, it is usually necessary to filter it. But that does not
just mean &#8220;show me everything that matches X&#8221;. The most basic log tool,
varnishlog, will do precisely that. The rest of the tools, however, can
process the information further and display running statistical
information.</p>
<p>If varnishlog is used to dump data to disk, varnishreplay can simulate a
similar load. varnishtest is used for regression tests, mainly during
development. Both are outside the scope of this course.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There is a delay in the log process, though usually it is not
noticeable. The shmlog is 80MB large by default, which gives some
potential history, but that is not guaranteed and it depends heavily
on when the last roll-around of the shmlog occurred.</p>
</div>
</div>
<div class="section" id="varnishtop">
<h2><a class="toc-backref" href="#id137">11.1&nbsp;&nbsp;&nbsp;varnishtop</a><a class="headerlink" href="#varnishtop" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>varnishtop -i TxStatus

  list length 6                                                          hostname

  3864.45 TxStatus       200
  1001.33 TxStatus       304
    33.93 TxStatus       301
     3.99 TxStatus       302
     3.00 TxStatus       404
     1.00 TxStatus       403</pre>
</div>
<ul class="simple">
<li>Group tags and tag-content by frequency</li>
</ul>
<div class="handout container">
<p>varnishtop groups tags and the content of the tag together to
generate a sorted list of the most frequently appearing
tag/tag-content pair.</p>
<p>Because the usefulness is only visible once you start filtering, it
is often overlooked. The above example lists status codes that
Varnish returns.</p>
<p>Two of the perhaps most useful variants of varnishtop is:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">varnishtop</span> <span class="pre">-i</span> <span class="pre">TxUrl</span></tt> creates a list of URLs requested from a web
server. Use this this find out what is causing back-end traffic
and start hitting items on the top of the list.</li>
<li><tt class="docutils literal"><span class="pre">varnishtop</span> <span class="pre">-i</span> <span class="pre">TxStatus</span></tt> lists what status codes Varnish returns
to clients. (As shown above)</li>
</ul>
<p>Some other possibly useful examples are:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">varnishtop</span> <span class="pre">-i</span> <span class="pre">RxUrl</span></tt> displays what URLs are most frequently
requested from a client.</li>
<li><tt class="docutils literal"><span class="pre">varnishtop</span> <span class="pre">-i</span> <span class="pre">RxHeader</span> <span class="pre">-I</span> <span class="pre">'User-Agent:.*Linux.*'</span></tt> lists
User-Agent headers with &#8220;Linux&#8221; in it (e.g: most used Linux web
browsers, that report them self as Linux).</li>
<li><tt class="docutils literal"><span class="pre">varnishtop</span> <span class="pre">-i</span> <span class="pre">RxStatus</span></tt> will list status codes received from a
web server.</li>
<li><tt class="docutils literal"><span class="pre">varnishtop</span> <span class="pre">-i</span> <span class="pre">VCL_call</span></tt> shows what VCL functions are used.</li>
<li><tt class="docutils literal"><span class="pre">varnishtop</span> <span class="pre">-i</span> <span class="pre">RxHeader</span> <span class="pre">-I</span> <span class="pre">Referrer</span></tt> shows the most common
referrer addresses.</li>
</ul>
</div>
</div>
<div class="section" id="varnishncsa">
<h2><a class="toc-backref" href="#id138">11.2&nbsp;&nbsp;&nbsp;varnishncsa</a><a class="headerlink" href="#varnishncsa" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>10.10.0.1 - - [24/Aug/2008:03:46:48 +0100] "GET \
http://www.example.com/images/foo.png HTTP/1.1" 200 5330 \
"http://www.example.com/" "Mozilla/5.0"</pre>
</div>
<div class="handout container">
<p>If you already have tools in place to analyze Apache-like logs (NCSA
logs), varnishncsa can be used to print the shmlog as ncsa-styled log.</p>
<p>Filtering works similar to varnishlog.</p>
</div>
</div>
<div class="section" id="varnishhist">
<h2><a class="toc-backref" href="#id139">11.3&nbsp;&nbsp;&nbsp;varnishhist</a><a class="headerlink" href="#varnishhist" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>                      #
                      #
                      #
                      #
                      ##
                     ###
                     ###
                     ###
                     ###
                     ###
                  |  ###
                  |  ###
                | |  ###
                |||| ###                    #
                |||| ####                   #
                |##|#####   #           #   #  # #
+-------+-------+-------+-------+-------+-------+-------+-------+-------
|1e-6   |1e-5   |1e-4   |1e-3   |1e-2   |1e-1   |1e0    |1e1    |1e2</pre>
</div>
</div>
<div class="section" id="exercise-try-the-tools">
<h2><a class="toc-backref" href="#id140">11.4&nbsp;&nbsp;&nbsp;Exercise: Try the tools</a><a class="headerlink" href="#exercise-try-the-tools" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Send a few requests to Varnish using <tt class="docutils literal"><span class="pre">GET</span> <span class="pre">-e</span> <span class="pre">http://localhost:8000</span></tt></li>
<li>verify you have some cached objects using <tt class="docutils literal"><span class="pre">varnishstat</span></tt></li>
<li>look at the communication with the clients, using <tt class="docutils literal"><span class="pre">varnishlog</span></tt>.
Try sending various headers and see them appear in varnishlog.</li>
<li>Install <tt class="docutils literal"><span class="pre">siege</span></tt></li>
<li>Run siege against localhost while looking at varnishhist</li>
</ul>
</div>
</div>
<div class="section" id="appendix-b-extra-material">
<h1><a class="toc-backref" href="#id141">12&nbsp;&nbsp;&nbsp;Appendix B: Extra Material</a><a class="headerlink" href="#appendix-b-extra-material" title="Permalink to this headline">¶</a></h1>
<p>The following is content needed for some of the exercises.</p>
<div class="section" id="ajax-html">
<h2><a class="toc-backref" href="#id142">12.1&nbsp;&nbsp;&nbsp;ajax.html</a><a class="headerlink" href="#ajax-html" title="Permalink to this headline">¶</a></h2>
<pre class="literal-block">
&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot;
&quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;
&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;
    &lt;head&gt;
        &lt;script type=&quot;text/javascript&quot; src=&quot;http://ajax.googleapis.com/ajax/libs/jquery/1.4/jquery.min.js&quot;&gt;
        &lt;/script&gt;
        &lt;script type=&quot;text/javascript&quot;&gt;
            function getNonMasqueraded()
            {
                $(&quot;#result&quot;).load( &quot;http://www.google.com/robots.txt&quot; );
            }

            function getMasqueraded()
            {
                $(&quot;#result&quot;).load( &quot;/masq/robots.txt&quot; );
            }
        &lt;/script&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;h1&gt;Cross-domain Ajax&lt;/h1&gt;
        &lt;ul&gt;
            &lt;li&gt;&lt;a href=&quot;javascript:getNonMasqueraded()&quot;&gt;Test a non masqueraded cross-domain request&lt;/a&gt;&lt;/li&gt;
            &lt;li&gt;&lt;a href=&quot;javascript:getMasqueraded()&quot;&gt;Test a masqueraded cross-domain request&lt;/a&gt;&lt;/li&gt;
        &lt;/ul&gt;

        &lt;h1&gt;Result&lt;/h1&gt;
        &lt;div id=&quot;result&quot;&gt;&lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;

</pre>
</div>
<div class="section" id="article-php">
<h2><a class="toc-backref" href="#id143">12.2&nbsp;&nbsp;&nbsp;article.php</a><a class="headerlink" href="#article-php" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>&lt;?php
header( "Cache-Control: public, must-revalidate, max-age=3600, s-maxage=3600"  );

$date = new DateTime();
$now = $date-&gt;format( DateTime::RFC2822 );
?&gt;
&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;
&lt;html xmlns="http://www.w3.org/1999/xhtml"&gt;
    &lt;head&gt;&lt;/head&gt;
    &lt;body&gt;
        &lt;h1&gt;This is an article, cached for 1 hour&lt;/h1&gt;

        &lt;h2&gt;Now is &lt;?php echo $now; ?&gt;&lt;/h2&gt;
        &lt;a href="&lt;?=$_SERVER['PHP_SELF']?&gt;"&gt;Refresh this page&lt;/a&gt;
    &lt;/body&gt;
&lt;/html&gt;
</pre>
</div>
</div>
<div class="section" id="cookies-php">
<h2><a class="toc-backref" href="#id144">12.3&nbsp;&nbsp;&nbsp;cookies.php</a><a class="headerlink" href="#cookies-php" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>&lt;?php
header( 'Content-Type: text/plain' );

print( "The following cookies have been received by the server\n" );

foreach( $_COOKIE as $name =&gt; $value )
    print( "- ${name} : ${value}\n" );
?&gt;</pre>
</div>
</div>
<div class="section" id="esi-top-php">
<h2><a class="toc-backref" href="#id145">12.4&nbsp;&nbsp;&nbsp;esi-top.php</a><a class="headerlink" href="#esi-top-php" title="Permalink to this headline">¶</a></h2>
<pre class="literal-block">
&lt;?php
header('Content-Type: text/html');
header('Cache-Control: max-age=30, s-maxage=3600');
$date = new DateTime();
$now = $date-&gt;format( DateTime::RFC2822 );
$setc = &quot;&quot;;
if( isset($_POST['k']) and $_POST['k'] !== '' and
    isset($_POST['v']) and $_POST['v'] !== '') {
        $k=$_POST['k'];
        $v=$_POST['v'];
        $setc = &quot;Set-Cookie: $k=$v&quot;;

         header(&quot;$setc&quot;);
         ?&gt;&lt;meta http-equiv=&quot;refresh&quot; content=&quot;1&quot; /&gt;
         &lt;h1&gt;Refreshing to set cookie &lt;?php print $setc; ?&gt;&lt;/h1&gt;&lt;?php
}
?&gt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;ESI top page&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;ESI Test page&lt;/h1&gt;
&lt;p&gt;This is content on the top-page of the ESI page. The top page is cached for 1 hour in Varnish, but only 30 seconds on the client.&lt;/p&gt; &lt;p&gt;The time when the top-element was created:&lt;/p&gt;&lt;h3&gt;

&lt;?php echo &quot;$now&quot;; ?&gt;


&lt;h1&gt;Set a cookie:&lt;/h1&gt;&lt;form action=&quot;/esi-top.php&quot; method=&quot;POST&quot;&gt;
Key: &lt;input type=&quot;text&quot; name=&quot;k&quot;&gt;
Value: &lt;input type=&quot;text&quot; name=&quot;v&quot;&gt;
&lt;input type=&quot;submit&quot;&gt; &lt;/form&gt;

&lt;/h3&gt;&lt;p&gt;The top page received the following Cookies:&lt;/p&gt;&lt;ul&gt;

&lt;?php

foreach( $_COOKIE as $name =&gt; $value )
    print( &quot;&lt;li&gt;${name} : ${value}&lt;/li&gt;\n&quot; );
?&gt;


&lt;table border=&quot;1&quot;&gt;&lt;tr&gt;&lt;td&gt;&lt;esi:include src=&quot;/esi-user.php&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/body&gt;&lt;/html&gt;

</pre>
</div>
<div class="section" id="esi-user-php">
<h2><a class="toc-backref" href="#id146">12.5&nbsp;&nbsp;&nbsp;esi-user.php</a><a class="headerlink" href="#esi-user-php" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>&lt;?php
header('Content-Type: text/html');
header('Cache-Control: max-age=30, s-maxage=20');
header('Vary: Cookie');
$date = new DateTime();
$now = $date-&gt;format( DateTime::RFC2822 );
?&gt;
&lt;p&gt;This is content on the user-specific ESI-include. This part of the page is can be cached in Varnish separately since it emits a "Vary: Cookie"-header. We can not affect the client-cache of this sub-page, since that is determined by the cache-control headers on the top-element.&lt;/p&gt;
&lt;p&gt;The time when the user-specific-element was created:&lt;/p&gt;&lt;h3&gt;

&lt;?php echo "$now"; ?&gt;


&lt;/h3&gt;&lt;p&gt;The user-specific page received the following Cookies:&lt;/p&gt;&lt;ul&gt;

&lt;?php

foreach( $_COOKIE as $name =&gt; $value )
    print( "&lt;li&gt;${name} : ${value}&lt;/li&gt;\n" );
?&gt;

&lt;/ul&gt;
</pre>
</div>
</div>
<div class="section" id="httpheadersexample-php">
<h2><a class="toc-backref" href="#id147">12.6&nbsp;&nbsp;&nbsp;httpheadersexample.php</a><a class="headerlink" href="#httpheadersexample-php" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>&lt;?php
define( 'LAST_MODIFIED_STRING', 'Sat, 09 Sep 2000 22:00:00 GMT' );

// expires_date : 10s after page generation
$expires_date = new DateTime();
$expires_date-&gt;add(new DateInterval('PT10S'));

$headers = array(
    'Date' =&gt; date( 'D, d M Y H:i:s', time() ),
);

if( isset( $_GET['h'] ) and $_GET['h'] !== '' )
{
    switch( $_GET['h'] )
    {
        case "expires" :
            $headers['Expires'] = toUTCDate($expires_date);
        break;

        case "cache-control":
            $headers['Cache-Control'] = "public, must-revalidate, max-age=3600, s-maxage=3600";
        break;

        case "cache-control-override":
            $headers['Expires'] = toUTCDate($expires_date);
            $headers['Cache-Control'] = "public, must-revalidate, max-age=2, s-maxage=2";
        break;

        case "last-modified":
            $headers['Last-Modified'] = LAST_MODIFIED_STRING;
            $headers['Etag'] = md5( 12345 );

            if( isset( $_SERVER['HTTP_IF_MODIFIED_SINCE'] ) and
                $_SERVER['HTTP_IF_MODIFIED_SINCE'] == LAST_MODIFIED_STRING ) {
                header( "HTTP/1.1 304 Not Modified" );
                exit(  );
            }
        break;

        case "vary":
            $headers['Expires'] = toUTCDate($expires_date);
            $headers['Vary'] = 'User-Agent';
        break;
    }

    sendHeaders( $headers );
}

function sendHeaders( array $headerList )
{
    foreach( $headerList as $name =&gt; $value )
    {
        header( "${name}: ${value}" );
    }
}

function toUTCDate( DateTime $date )
{
    $date-&gt;setTimezone( new DateTimeZone( 'UTC' ) );
    return $date-&gt;format( 'D, d M Y H:i:s \G\M\T' );
}
?&gt;
&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;
&lt;html xmlns="http://www.w3.org/1999/xhtml"&gt;
    &lt;head&gt;&lt;/head&gt;
    &lt;body&gt;
        &lt;h1&gt;Headers sent&lt;/h1&gt;
        &lt;?php
            foreach( $headers as $name =&gt; $value ) {
                print "&lt;strong&gt;${name}&lt;/strong&gt;: ${value}&lt;br/&gt;";
            }

            if( isset( $_SERVER['HTTP_IF_MODIFIED_SINCE'] ) ) {
                print "&lt;strong&gt;If-Modified-Since&lt;/strong&gt; has been sent in the";
                print "request, value : " . $_SERVER['HTTP_IF_MODIFIED_SINCE'];
            }
        ?&gt;
        &lt;hr/&gt;
        &lt;h1&gt;Links for testing&lt;/h1&gt;
        &lt;ul&gt;
            &lt;li&gt;&lt;a href="&lt;?=$_SERVER['PHP_SELF']?&gt;?h=expires"&gt;Test Expires response header&lt;/a&gt;&lt;/li&gt;
            &lt;li&gt;&lt;a href="&lt;?=$_SERVER['PHP_SELF']?&gt;?h=cache-control"&gt;Test Cache-Control response header&lt;/a&gt;&lt;/li&gt;
            &lt;li&gt;&lt;a href="&lt;?=$_SERVER['PHP_SELF']?&gt;?h=cache-control-override"&gt;Test Cache-Control response header overrides Expires&lt;/a&gt;&lt;/li&gt;
            &lt;li&gt;&lt;a href="&lt;?=$_SERVER['PHP_SELF']?&gt;?h=last-modified"&gt;Test Last-Modified/If-modified-since response header&lt;/a&gt;&lt;/li&gt;
            &lt;li&gt;&lt;a href="&lt;?=$_SERVER['PHP_SELF']?&gt;?h=vary"&gt;Test Vary response header&lt;/a&gt;&lt;/li&gt;
        &lt;ul&gt;
    &lt;/body&gt;
&lt;/html&gt;
</pre>
</div>
</div>
<div class="section" id="purgearticle-php">
<h2><a class="toc-backref" href="#id148">12.7&nbsp;&nbsp;&nbsp;purgearticle.php</a><a class="headerlink" href="#purgearticle-php" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>&lt;?php
header( 'Content-Type: text/plain' );
header( 'Cache-Control: max-age=0' );
$hostname = 'localhost';
$port     = 80;
$URL      = '/article.php';
$debug    = true;

print "Updating the article in the database ...\n";
purgeURL( $hostname, $port, $URL, $debug );

function purgeURL( $hostname, $port, $purgeURL, $debug )
{
    $finalURL = sprintf(
        "http://%s:%d%s", $hostname, $port, $purgeURL
    );

    print( "Purging ${finalURL}\n" );

    $curlOptionList = array(
        CURLOPT_RETURNTRANSFER    =&gt; true,
        CURLOPT_CUSTOMREQUEST     =&gt; 'PURGE',
        CURLOPT_HEADER            =&gt; true ,
        CURLOPT_NOBODY            =&gt; true,
        CURLOPT_URL               =&gt; $finalURL,
        CURLOPT_CONNECTTIMEOUT_MS =&gt; 2000
    );

    $fd = false;
    if( $debug == true ) {
        print "\n---- Curl debug -----\n";
        $fd = fopen("php://output", 'w+');
        $curlOptionList[CURLOPT_VERBOSE] = true;
        $curlOptionList[CURLOPT_STDERR]  = $fd;
    }

    $curlHandler = curl_init();
    curl_setopt_array( $curlHandler, $curlOptionList );
    curl_exec( $curlHandler );
    curl_close( $curlHandler );
    if( $fd !== false ) {
        fclose( $fd );
    }
}
?&gt;
</pre>
</div>
</div>
<div class="section" id="test-php">
<h2><a class="toc-backref" href="#id149">12.8&nbsp;&nbsp;&nbsp;test.php</a><a class="headerlink" href="#test-php" title="Permalink to this headline">¶</a></h2>
<pre class="literal-block">
&lt;?php
$cc = &quot;&quot;;
if( isset($_GET['k']) and $_GET['k'] !== '' and
    isset($_GET['v']) and $_GET['v'] !== '') {
        $k=$_GET['k'];
        $v=$_GET['v'];
        $cc = &quot;Cache-Control: $k=$v&quot;;

        header(&quot;$cc&quot;);

}
?&gt;
&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot;
&quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;
&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;
    &lt;head&gt;&lt;/head&gt;
    &lt;body&gt;
        &lt;h1&gt;Cache-Control Header:&lt;/h1&gt;
        &lt;?php
                print &quot;&lt;pre&gt;$cc&lt;/pre&gt;\n&quot;;
        ?&gt;
        &lt;hr/&gt;
        &lt;h1&gt;Links for testing&lt;/h1&gt;
        &lt;form action=&quot;/test.php&quot; method=&quot;GET&quot;&gt;
        Key: &lt;input type=&quot;text&quot; name=&quot;k&quot;&gt;
        Value: &lt;input type=&quot;text&quot; name=&quot;v&quot;&gt;
        &lt;input type=&quot;submit&quot;&gt;
        &lt;/form&gt;
    &lt;/body&gt;
&lt;/html&gt;

</pre>
</div>
<div class="section" id="set-cookie-php">
<h2><a class="toc-backref" href="#id150">12.9&nbsp;&nbsp;&nbsp;set-cookie.php</a><a class="headerlink" href="#set-cookie-php" title="Permalink to this headline">¶</a></h2>
<pre class="literal-block">
&lt;?php
header(&quot;Cache-Control: max-age=0&quot;);
$cc = &quot;&quot;;
if( isset($_POST['k']) and $_POST['k'] !== '' and
    isset($_POST['v']) and $_POST['v'] !== '') {
        $k=$_POST['k'];
        $v=$_POST['v'];
        $setc = &quot;Set-Cookie: $k=$v&quot;;

        header(&quot;$setc&quot;);

}
?&gt;
&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot;
&quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;
&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;
    &lt;head&gt;&lt;/head&gt;
    &lt;body&gt;
        &lt;h1&gt;Set-Cookie Header:&lt;/h1&gt;
        &lt;?php
                print &quot;&lt;pre&gt;$setc&lt;/pre&gt;\n&quot;;
        ?&gt;
        &lt;hr/&gt;
        &lt;h1&gt;Links for testing&lt;/h1&gt;
        &lt;form action=&quot;/set-cookie.php&quot; method=&quot;POST&quot;&gt;
        Key: &lt;input type=&quot;text&quot; name=&quot;k&quot;&gt;
        Value: &lt;input type=&quot;text&quot; name=&quot;v&quot;&gt;
        &lt;input type=&quot;submit&quot;&gt;
        &lt;/form&gt;
    &lt;/body&gt;
&lt;/html&gt;

</pre>
<p>PageBreak</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="#">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">1&nbsp;&nbsp;&nbsp;Introduction</a><ul>
<li><a class="reference internal" href="#about-the-course">1.1&nbsp;&nbsp;&nbsp;About the course</a></li>
<li><a class="reference internal" href="#goals-and-prerequisites">1.2&nbsp;&nbsp;&nbsp;Goals and Prerequisites</a></li>
<li><a class="reference internal" href="#introduction-to-varnish">1.3&nbsp;&nbsp;&nbsp;Introduction to Varnish</a></li>
<li><a class="reference internal" href="#design-principles">1.4&nbsp;&nbsp;&nbsp;Design principles</a></li>
<li><a class="reference internal" href="#how-objects-are-stored">1.5&nbsp;&nbsp;&nbsp;How objects are stored</a></li>
</ul>
</li>
<li><a class="reference internal" href="#getting-started">2&nbsp;&nbsp;&nbsp;Getting started</a><ul>
<li><a class="reference internal" href="#configuration">2.1&nbsp;&nbsp;&nbsp;Configuration</a></li>
<li><a class="reference internal" href="#command-line-configuration">2.2&nbsp;&nbsp;&nbsp;Command line configuration</a></li>
<li><a class="reference internal" href="#configuration-files">2.3&nbsp;&nbsp;&nbsp;Configuration files</a></li>
<li><a class="reference internal" href="#defining-a-backend-in-vcl">2.4&nbsp;&nbsp;&nbsp;Defining a backend in VCL</a></li>
<li><a class="reference internal" href="#exercise-installation">2.5&nbsp;&nbsp;&nbsp;Exercise: Installation</a></li>
<li><a class="reference internal" href="#exercise-fetch-data-through-varnish">2.6&nbsp;&nbsp;&nbsp;Exercise: Fetch data through Varnish</a></li>
<li><a class="reference internal" href="#log-data">2.7&nbsp;&nbsp;&nbsp;Log data</a></li>
<li><a class="reference internal" href="#varnishlog">2.8&nbsp;&nbsp;&nbsp;varnishlog</a></li>
<li><a class="reference internal" href="#varnishlog-tag-examples">2.9&nbsp;&nbsp;&nbsp;Varnishlog tag examples</a></li>
<li><a class="reference internal" href="#varnishlog-options">2.10&nbsp;&nbsp;&nbsp;varnishlog options</a></li>
<li><a class="reference internal" href="#varnishstat">2.11&nbsp;&nbsp;&nbsp;varnishstat</a></li>
<li><a class="reference internal" href="#the-management-interface">2.12&nbsp;&nbsp;&nbsp;The management interface</a></li>
<li><a class="reference internal" href="#exercise-try-out-the-tools">2.13&nbsp;&nbsp;&nbsp;Exercise: Try out the tools</a></li>
</ul>
</li>
<li><a class="reference internal" href="#tuning">3&nbsp;&nbsp;&nbsp;Tuning</a><ul>
<li><a class="reference internal" href="#process-architecture">3.1&nbsp;&nbsp;&nbsp;Process Architecture</a><ul>
<li><a class="reference internal" href="#the-management-process">3.1.1&nbsp;&nbsp;&nbsp;The management process</a></li>
<li><a class="reference internal" href="#the-child-process">3.1.2&nbsp;&nbsp;&nbsp;The child process</a></li>
<li><a class="reference internal" href="#vcl-compilation">3.1.3&nbsp;&nbsp;&nbsp;VCL compilation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#storage-backends">3.2&nbsp;&nbsp;&nbsp;Storage backends</a></li>
<li><a class="reference internal" href="#the-shared-memory-log">3.3&nbsp;&nbsp;&nbsp;The shared memory log</a></li>
<li><a class="reference internal" href="#tunable-parameters">3.4&nbsp;&nbsp;&nbsp;Tunable parameters</a></li>
<li><a class="reference internal" href="#threading-model">3.5&nbsp;&nbsp;&nbsp;Threading model</a></li>
<li><a class="reference internal" href="#threading-parameters">3.6&nbsp;&nbsp;&nbsp;Threading parameters</a><ul>
<li><a class="reference internal" href="#details-of-threading-parameters">3.6.1&nbsp;&nbsp;&nbsp;Details of threading parameters</a></li>
<li><a class="reference internal" href="#number-of-threads">3.6.2&nbsp;&nbsp;&nbsp;Number of threads</a></li>
<li><a class="reference internal" href="#timing-thread-growth">3.6.3&nbsp;&nbsp;&nbsp;Timing thread growth</a></li>
</ul>
</li>
<li><a class="reference internal" href="#system-parameters">3.7&nbsp;&nbsp;&nbsp;System parameters</a></li>
<li><a class="reference internal" href="#timers">3.8&nbsp;&nbsp;&nbsp;Timers</a></li>
<li><a class="reference internal" href="#exercise-tune-first-byte-timeout">3.9&nbsp;&nbsp;&nbsp;Exercise: Tune first_byte_timeout</a></li>
<li><a class="reference internal" href="#exercise-configure-threading">3.10&nbsp;&nbsp;&nbsp;Exercise: Configure threading</a></li>
</ul>
</li>
<li><a class="reference internal" href="#http">4&nbsp;&nbsp;&nbsp;HTTP</a><ul>
<li><a class="reference internal" href="#protocol-basics">4.1&nbsp;&nbsp;&nbsp;Protocol basics</a></li>
<li><a class="reference internal" href="#requests">4.2&nbsp;&nbsp;&nbsp;Requests</a></li>
<li><a class="reference internal" href="#request-example">4.3&nbsp;&nbsp;&nbsp;Request example</a></li>
<li><a class="reference internal" href="#response">4.4&nbsp;&nbsp;&nbsp;Response</a></li>
<li><a class="reference internal" href="#response-example">4.5&nbsp;&nbsp;&nbsp;Response example</a></li>
<li><a class="reference internal" href="#http-request-response-control-flow">4.6&nbsp;&nbsp;&nbsp;HTTP request/response control flow</a></li>
<li><a class="reference internal" href="#statelesness-and-idempotence">4.7&nbsp;&nbsp;&nbsp;Statelesness and idempotence</a></li>
<li><a class="reference internal" href="#cache-related-headers">4.8&nbsp;&nbsp;&nbsp;Cache related headers</a></li>
<li><a class="reference internal" href="#exercise-test-various-cache-headers">4.9&nbsp;&nbsp;&nbsp;Exercise : Test various Cache headers</a></li>
<li><a class="reference internal" href="#expires">4.10&nbsp;&nbsp;&nbsp;Expires</a></li>
<li><a class="reference internal" href="#cache-control">4.11&nbsp;&nbsp;&nbsp;Cache-Control</a></li>
<li><a class="reference internal" href="#last-modified">4.12&nbsp;&nbsp;&nbsp;Last-Modified</a></li>
<li><a class="reference internal" href="#if-modified-since">4.13&nbsp;&nbsp;&nbsp;If-Modified-Since</a></li>
<li><a class="reference internal" href="#if-none-match">4.14&nbsp;&nbsp;&nbsp;If-None-Match</a></li>
<li><a class="reference internal" href="#etag">4.15&nbsp;&nbsp;&nbsp;Etag</a></li>
<li><a class="reference internal" href="#pragma">4.16&nbsp;&nbsp;&nbsp;Pragma</a></li>
<li><a class="reference internal" href="#vary">4.17&nbsp;&nbsp;&nbsp;Vary</a></li>
<li><a class="reference internal" href="#age">4.18&nbsp;&nbsp;&nbsp;Age</a></li>
<li><a class="reference internal" href="#header-availability-summary">4.19&nbsp;&nbsp;&nbsp;Header availability summary</a></li>
<li><a class="reference internal" href="#cache-hit-and-misses">4.20&nbsp;&nbsp;&nbsp;Cache-hit and misses</a></li>
<li><a class="reference internal" href="#exercise-use-article-php-to-test-age">4.21&nbsp;&nbsp;&nbsp;Exercise: Use <cite>article.php</cite> to test <cite>Age</cite></a></li>
</ul>
</li>
<li><a class="reference internal" href="#vcl-basics">5&nbsp;&nbsp;&nbsp;VCL Basics</a><ul>
<li><a class="reference internal" href="#the-vcl-state-engine">5.1&nbsp;&nbsp;&nbsp;The VCL State Engine</a></li>
<li><a class="reference internal" href="#syntax">5.2&nbsp;&nbsp;&nbsp;Syntax</a></li>
<li><a class="reference internal" href="#vcl-request-flow">5.3&nbsp;&nbsp;&nbsp;VCL - request flow</a><ul>
<li><a class="reference internal" href="#detailed-request-flow">5.3.1&nbsp;&nbsp;&nbsp;Detailed request flow</a></li>
</ul>
</li>
<li><a class="reference internal" href="#vcl-functions">5.4&nbsp;&nbsp;&nbsp;VCL - functions</a></li>
<li><a class="reference internal" href="#vcl-vcl-recv">5.5&nbsp;&nbsp;&nbsp;VCL - <tt class="docutils literal"><span class="pre">vcl_recv</span></tt></a></li>
<li><a class="reference internal" href="#default-vcl-recv">5.6&nbsp;&nbsp;&nbsp;Default: <tt class="docutils literal"><span class="pre">vcl_recv</span></tt></a></li>
<li><a class="reference internal" href="#example-basic-device-detection">5.7&nbsp;&nbsp;&nbsp;Example: Basic Device Detection</a></li>
<li><a class="reference internal" href="#vcl-vcl-fetch">5.8&nbsp;&nbsp;&nbsp;VCL - <tt class="docutils literal"><span class="pre">vcl_fetch</span></tt></a></li>
<li><a class="reference internal" href="#default-vcl-fetch">5.9&nbsp;&nbsp;&nbsp;Default: <tt class="docutils literal"><span class="pre">vcl_fetch</span></tt></a></li>
<li><a class="reference internal" href="#the-initial-value-of-beresp-ttl">5.10&nbsp;&nbsp;&nbsp;The initial value of <tt class="docutils literal"><span class="pre">beresp.ttl</span></tt></a></li>
<li><a class="reference internal" href="#example-enforce-caching-of-jpg-urls-for-60-seconds">5.11&nbsp;&nbsp;&nbsp;Example: Enforce caching of .jpg urls for 60 seconds</a></li>
<li><a class="reference internal" href="#example-cache-jpg-for-60-only-if-s-maxage-isn-t-present">5.12&nbsp;&nbsp;&nbsp;Example: Cache .jpg for 60 only if s-maxage isn&#8217;t present</a></li>
<li><a class="reference internal" href="#exercise-either-use-s-maxage-or-set-ttl-by-file-type">5.13&nbsp;&nbsp;&nbsp;Exercise: Either use s-maxage or set ttl by file type</a></li>
<li><a class="reference internal" href="#solution-either-use-s-maxage-or-set-ttl-by-file-type">5.14&nbsp;&nbsp;&nbsp;Solution: Either use s-maxage or set ttl by file type</a></li>
<li><a class="reference internal" href="#summary-of-vcl-part-1">5.15&nbsp;&nbsp;&nbsp;Summary of VCL - Part 1</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id1">6&nbsp;&nbsp;&nbsp;VCL functions</a><ul>
<li><a class="reference internal" href="#variable-availability-in-vcl">6.1&nbsp;&nbsp;&nbsp;Variable availability in VCL</a></li>
<li><a class="reference internal" href="#vcl-vcl-hash">6.2&nbsp;&nbsp;&nbsp;VCL - <tt class="docutils literal"><span class="pre">vcl_hash</span></tt></a></li>
<li><a class="reference internal" href="#vcl-vcl-hit">6.3&nbsp;&nbsp;&nbsp;VCL - <tt class="docutils literal"><span class="pre">vcl_hit</span></tt></a></li>
<li><a class="reference internal" href="#vcl-vcl-miss">6.4&nbsp;&nbsp;&nbsp;VCL - <tt class="docutils literal"><span class="pre">vcl_miss</span></tt></a></li>
<li><a class="reference internal" href="#vcl-vcl-pass">6.5&nbsp;&nbsp;&nbsp;VCl - <tt class="docutils literal"><span class="pre">vcl_pass</span></tt></a></li>
<li><a class="reference internal" href="#vcl-vcl-deliver">6.6&nbsp;&nbsp;&nbsp;VCL - <tt class="docutils literal"><span class="pre">vcl_deliver</span></tt></a></li>
<li><a class="reference internal" href="#vcl-vcl-error">6.7&nbsp;&nbsp;&nbsp;VCL - <tt class="docutils literal"><span class="pre">vcl_error</span></tt></a></li>
<li><a class="reference internal" href="#example-redirecting-users-with-vcl-error">6.8&nbsp;&nbsp;&nbsp;Example: Redirecting users with <tt class="docutils literal"><span class="pre">vcl_error</span></tt></a></li>
<li><a class="reference internal" href="#exercise-modify-the-error-message-and-headers">6.9&nbsp;&nbsp;&nbsp;Exercise: Modify the error message and headers</a></li>
<li><a class="reference internal" href="#solution-modify-the-error-message-and-headers">6.10&nbsp;&nbsp;&nbsp;Solution: Modify the error message and headers</a></li>
</ul>
</li>
<li><a class="reference internal" href="#cache-invalidation">7&nbsp;&nbsp;&nbsp;Cache invalidation</a><ul>
<li><a class="reference internal" href="#naming-confusion">7.1&nbsp;&nbsp;&nbsp;Naming confusion</a></li>
<li><a class="reference internal" href="#removing-a-single-object">7.2&nbsp;&nbsp;&nbsp;Removing a single object</a></li>
<li><a class="reference internal" href="#example-purge">7.3&nbsp;&nbsp;&nbsp;Example: <tt class="docutils literal"><span class="pre">purge;</span></tt></a></li>
<li><a class="reference internal" href="#the-lookup-that-always-misses">7.4&nbsp;&nbsp;&nbsp;The lookup that always misses</a></li>
<li><a class="reference internal" href="#banning">7.5&nbsp;&nbsp;&nbsp;Banning</a></li>
<li><a class="reference internal" href="#vcl-contexts-when-adding-bans">7.6&nbsp;&nbsp;&nbsp;VCL contexts when adding bans</a></li>
<li><a class="reference internal" href="#smart-bans">7.7&nbsp;&nbsp;&nbsp;Smart bans</a></li>
<li><a class="reference internal" href="#ban-or-purge">7.8&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">ban()</span></tt> or <tt class="docutils literal"><span class="pre">purge;</span></tt>?</a></li>
<li><a class="reference internal" href="#exercise-write-a-vcl-for-bans-and-purges">7.9&nbsp;&nbsp;&nbsp;Exercise: Write a VCL for bans and purges</a></li>
<li><a class="reference internal" href="#solution-write-a-vcl-for-bans-and-purges">7.10&nbsp;&nbsp;&nbsp;Solution: Write a VCL for bans and purges</a></li>
<li><a class="reference internal" href="#exercise-purge-an-article-from-the-backend">7.11&nbsp;&nbsp;&nbsp;Exercise : PURGE an article from the backend</a></li>
<li><a class="reference internal" href="#solution-purge-an-article-from-the-backend">7.12&nbsp;&nbsp;&nbsp;Solution : PURGE an article from the backend</a></li>
</ul>
</li>
<li><a class="reference internal" href="#saving-a-request">8&nbsp;&nbsp;&nbsp;Saving a request</a><ul>
<li><a class="reference internal" href="#core-grace-mechanisms">8.1&nbsp;&nbsp;&nbsp;Core grace mechanisms</a></li>
<li><a class="reference internal" href="#req-grace-and-beresp-grace">8.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">req.grace</span></tt> and <tt class="docutils literal"><span class="pre">beresp.grace</span></tt></a></li>
<li><a class="reference internal" href="#when-can-grace-happen">8.3&nbsp;&nbsp;&nbsp;When can grace happen</a></li>
<li><a class="reference internal" href="#exercise-grace">8.4&nbsp;&nbsp;&nbsp;Exercise: Grace</a></li>
<li><a class="reference internal" href="#health-checks">8.5&nbsp;&nbsp;&nbsp;Health checks</a></li>
<li><a class="reference internal" href="#health-checks-and-grace">8.6&nbsp;&nbsp;&nbsp;Health checks and grace</a></li>
<li><a class="reference internal" href="#directors">8.7&nbsp;&nbsp;&nbsp;Directors</a><ul>
<li><a class="reference internal" href="#client-and-hash-directors">8.7.1&nbsp;&nbsp;&nbsp;Client and hash directors</a></li>
<li><a class="reference internal" href="#the-dns-director">8.7.2&nbsp;&nbsp;&nbsp;The DNS director</a></li>
</ul>
</li>
<li><a class="reference internal" href="#demo-health-probes-and-grace">8.8&nbsp;&nbsp;&nbsp;Demo: Health probes and grace</a></li>
<li><a class="reference internal" href="#saint-mode">8.9&nbsp;&nbsp;&nbsp;Saint mode</a></li>
<li><a class="reference internal" href="#restart-in-vcl">8.10&nbsp;&nbsp;&nbsp;Restart in VCL</a></li>
<li><a class="reference internal" href="#backend-properties">8.11&nbsp;&nbsp;&nbsp;Backend properties</a></li>
<li><a class="reference internal" href="#example-evil-backend-hack">8.12&nbsp;&nbsp;&nbsp;Example: Evil backend hack</a></li>
<li><a class="reference internal" href="#access-control-lists">8.13&nbsp;&nbsp;&nbsp;Access Control Lists</a></li>
<li><a class="reference internal" href="#exercise-combine-purge-and-restart">8.14&nbsp;&nbsp;&nbsp;Exercise: Combine PURGE and restart</a></li>
<li><a class="reference internal" href="#solution-combine-purge-and-restart">8.15&nbsp;&nbsp;&nbsp;Solution: Combine PURGE and restart</a></li>
</ul>
</li>
<li><a class="reference internal" href="#content-composition">9&nbsp;&nbsp;&nbsp;Content Composition</a><ul>
<li><a class="reference internal" href="#a-typical-site">9.1&nbsp;&nbsp;&nbsp;A typical site</a></li>
<li><a class="reference internal" href="#cookies">9.2&nbsp;&nbsp;&nbsp;Cookies</a></li>
<li><a class="reference internal" href="#vary-and-cookies">9.3&nbsp;&nbsp;&nbsp;Vary and Cookies</a></li>
<li><a class="reference internal" href="#best-practices-for-cookies">9.4&nbsp;&nbsp;&nbsp;Best practices for cookies</a></li>
<li><a class="reference internal" href="#exercise-compare-vary-and-hash-data">9.5&nbsp;&nbsp;&nbsp;Exercise: Compare Vary and <tt class="docutils literal"><span class="pre">hash_data</span></tt></a></li>
<li><a class="reference internal" href="#edge-side-includes">9.6&nbsp;&nbsp;&nbsp;Edge Side Includes</a></li>
<li><a class="reference internal" href="#basic-esi-usage">9.7&nbsp;&nbsp;&nbsp;Basic ESI usage</a></li>
<li><a class="reference internal" href="#exercise-enable-esi-and-cookies">9.8&nbsp;&nbsp;&nbsp;Exercise: Enable ESI and Cookies</a></li>
<li><a class="reference internal" href="#testing-esi-without-varnish">9.9&nbsp;&nbsp;&nbsp;Testing ESI without Varnish</a></li>
<li><a class="reference internal" href="#masquerading-ajax-requests">9.10&nbsp;&nbsp;&nbsp;Masquerading AJAX requests</a></li>
<li><a class="reference internal" href="#exercise-write-a-vcl-that-masquerades-xhr-calls">9.11&nbsp;&nbsp;&nbsp;Exercise : write a VCL that masquerades XHR calls</a></li>
<li><a class="reference internal" href="#solution-write-a-vcl-that-masquerades-xhr-calls">9.12&nbsp;&nbsp;&nbsp;Solution : write a VCL that masquerades XHR calls</a></li>
</ul>
</li>
<li><a class="reference internal" href="#finishing-words">10&nbsp;&nbsp;&nbsp;Finishing words</a><ul>
<li><a class="reference internal" href="#varnish-2-1-to-3-0">10.1&nbsp;&nbsp;&nbsp;Varnish 2.1 to 3.0</a></li>
<li><a class="reference internal" href="#resources">10.2&nbsp;&nbsp;&nbsp;Resources</a></li>
</ul>
</li>
<li><a class="reference internal" href="#appendix-a-varnish-programs">11&nbsp;&nbsp;&nbsp;Appendix A: Varnish Programs</a><ul>
<li><a class="reference internal" href="#varnishtop">11.1&nbsp;&nbsp;&nbsp;varnishtop</a></li>
<li><a class="reference internal" href="#varnishncsa">11.2&nbsp;&nbsp;&nbsp;varnishncsa</a></li>
<li><a class="reference internal" href="#varnishhist">11.3&nbsp;&nbsp;&nbsp;varnishhist</a></li>
<li><a class="reference internal" href="#exercise-try-the-tools">11.4&nbsp;&nbsp;&nbsp;Exercise: Try the tools</a></li>
</ul>
</li>
<li><a class="reference internal" href="#appendix-b-extra-material">12&nbsp;&nbsp;&nbsp;Appendix B: Extra Material</a><ul>
<li><a class="reference internal" href="#ajax-html">12.1&nbsp;&nbsp;&nbsp;ajax.html</a></li>
<li><a class="reference internal" href="#article-php">12.2&nbsp;&nbsp;&nbsp;article.php</a></li>
<li><a class="reference internal" href="#cookies-php">12.3&nbsp;&nbsp;&nbsp;cookies.php</a></li>
<li><a class="reference internal" href="#esi-top-php">12.4&nbsp;&nbsp;&nbsp;esi-top.php</a></li>
<li><a class="reference internal" href="#esi-user-php">12.5&nbsp;&nbsp;&nbsp;esi-user.php</a></li>
<li><a class="reference internal" href="#httpheadersexample-php">12.6&nbsp;&nbsp;&nbsp;httpheadersexample.php</a></li>
<li><a class="reference internal" href="#purgearticle-php">12.7&nbsp;&nbsp;&nbsp;purgearticle.php</a></li>
<li><a class="reference internal" href="#test-php">12.8&nbsp;&nbsp;&nbsp;test.php</a></li>
<li><a class="reference internal" href="#set-cookie-php">12.9&nbsp;&nbsp;&nbsp;set-cookie.php</a></li>
</ul>
</li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/index.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li><a href="#">Varnish Book 3.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, VarnishTollef Fog Heen (Varnish Software), Kristian Lyngstøl (Varnish Software), Jérôme Renard (39Web).
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>