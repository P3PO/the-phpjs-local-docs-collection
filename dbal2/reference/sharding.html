
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>13. Sharding &mdash; Doctrine DBAL 2.1.0 documentation</title>
    <link rel="stylesheet" href="../_static/bootstrap/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/layout.css" type="text/css" />
    <link rel="stylesheet" href="../_static/configurationblock.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.1.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>

    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/configurationblock.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/configurationblock.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/configurationblock.js"></script>
    <script src="../_static/bootstrap/js/bootstrap.min.js"></script>

    <script type="text/javascript">
    <!--
        $(document).ready(function() {
            $("#versions").change(function() {
                var docsUrl = $(this).val();
                window.location.href = docsUrl;
            });
        });
    -->
    </script>
    <link rel="shortcut icon" href="../_static/doctrine.ico"/>
    <link rel="top" title="Doctrine DBAL 2.1.0 documentation" href="../index.html" />
    <link rel="next" title="14. SQLAzure Sharding Tutorial" href="sharding_azure_tutorial.html" />
    <link rel="prev" title="12. Security" href="security.html" />
 
<!-- RTD Extra Head -->
<script type="text/javascript">
  // This is included here for Javascript that doesn't have access to the templates.
  var doc_version = "latest";
  var doc_slug = "doctrine-dbal";
  var page_name = "reference/sharding";
</script>

<script type="text/javascript" src="//media.readthedocs.org/javascript/rtd.js"></script>
<link rel="stylesheet" href="//media.readthedocs.org/css/rtd-shim.css" type="text/css" />
<!-- end RTD <extrahead> -->

  </head>
  <body>
    <div id="wrapper">
      <div id="header">
        <h1 id="h1title"></h1>
        <div id="logo">
          <a href="http://www.doctrine-project.org/">Doctrine - PHP Database Libraries</a>
        </div>
      </div>
      <div id="nav" class="cls">
        <div class="tl cls">
          <ul>
            <li><a target="_top" href="/">home</a></li>
            <li><a class="" target="_top" href="http://www.doctrine-project.org/about">about</a></li>
            <li><a class="" target="_top" href="http://www.doctrine-project.org/projects.html">projects</a></li>
            <li><a class="" target="_top" href="http://www.doctrine-project.org/projects/orm">orm</a></li>
            <li><a class="" target="_top" href="http://www.doctrine-project.org/projects/dbal">dbal</a></li>
            <li><a class="" target="_top" href="http://www.doctrine-project.org/blog">blog</a></li>
            <li><a class="" target="_top" href="http://www.doctrine-project.org/jira">development</a></li>
            <li><a class="" target="_top" href="http://www.doctrine-project.org/contribute">contribute</a></li>
            <li><a class="" target="_top" href="http://www.doctrine-project.org/community">community</a></li>
          </ul>
        </div>
      </div>
      <div id="content" class="cls">
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="sharding_azure_tutorial.html" title="14. SQLAzure Sharding Tutorial"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="security.html" title="12. Security"
             accesskey="P">previous</a> |</li>
        <li><a href="/">Doctrine Homepage</a> &raquo;</li>
        <li><a href="../index.html">Doctrine DBAL 2.1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

        <div class="document">
            <div class="documentwrapper">
                <div class="bodywrapper">

              <div class="body" >
                
  <div class="section" id="sharding">
<h1>13. Sharding<a class="headerlink" href="#sharding" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The sharding extension is currently in transition from a seperate Project
into DBAL. Class names may differ.</p>
</div>
<p>Starting with 2.3 Doctrine DBAL contains some functionality to simplify the
development of horizontally sharded applications. In this first release it
contains a <tt class="docutils literal"><span class="pre">ShardManager</span></tt> interface. This interface allows to programatically
select a shard to send queries to. At the moment there are no functionalities
yet to dynamically pick a shard based on ID, query or database row yet. That
means the sharding extension is primarily suited for:</p>
<ul class="simple">
<li>multi-tenant applications or</li>
<li>applications with completely separated datasets (example: weather data).</li>
</ul>
<p>Both kind of application will work with both DBAL and ORM.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Horizontal sharding is an evasive architecture that will affect your application code and using this
extension to Doctrine will not make it work &#8220;magically&#8221;.</p>
</div>
<p>You have to understand and integrate the following drawbacks:</p>
<ul class="simple">
<li>Pre-generation of IDs that are unique across all shards required.</li>
<li>No transaction support across shards.</li>
<li>No foreign key support across shards (meaning no &#8220;real&#8221; relations).</li>
<li>Very complex (or impossible) to query aggregates across shards.</li>
<li>Denormalization: Composite keys required where normalized non-sharded db schemas don&#8217;t need them.</li>
<li>Schema Operations have to be done on all shards.</li>
</ul>
<p>The primary questions in a sharding architecture are:</p>
<ul class="simple">
<li>Where is my data located?</li>
<li>Where should I save this new data to find it later?</li>
</ul>
<p>To answer these questions you generally have to craft a function that will tell
you for a given ID, on which shard the data for this ID is located. To simplify
this approach you will generally just pick a table which is the root of a set of
related data and decide for the IDs of this table. All the related data that
belong to this table are saved on the same shard.</p>
<p>Take for example a multi-user blog application with the following tables:</p>
<ul class="simple">
<li>Blog [id, name]</li>
<li>Post [id, blog_id, subject, body, author_id]</li>
<li>Comment [id, post_id, comment, author_id]</li>
<li>User [id, username]</li>
</ul>
<p>A sensible sharding architecture will split the application by blog. That means
all the data for a particular blog will be on a single shard and scaling is
done by putting the amount of blogs on many different database servers.</p>
<p>Now users can post and comment on different blogs that reside on different
shards. This makes the database schema above slightly tricky, because both
<cite>author_id</cite> columns cannot have foreign keys to <cite>User (id)</cite>. Instead the User
table is located in an entirely different &#8220;dimension&#8221; of the application in
terms of the sharding architecture.</p>
<p>To simplify working with this kind of multi-dimensional database schema, you
can replace the author_ids with something more &#8220;meaningful&#8221;, for example the
e-mail address of the users if that is always known. The &#8220;user&#8221; table can then
be separated from the database schema above and put on a second horizontally
scaled sharding architecture.</p>
<p>As you can see, even with just the four tables above, sharding actually becomes
quite complex to think about.</p>
<p>The rest of this section discusses Doctrine sharding functionality in technical
detail.</p>
<div class="section" id="id-generation">
<h2>13.1. ID Generation<a class="headerlink" href="#id-generation" title="Permalink to this headline">¶</a></h2>
<p>To solve the issue of unique ID-generation across all shards are several
approaches you should evaluate:</p>
<div class="section" id="use-guid-uuids">
<h3>13.1.1. Use GUID/UUIDs<a class="headerlink" href="#use-guid-uuids" title="Permalink to this headline">¶</a></h3>
<p>The most simple ID-generation mechanism for sharding are
universally unique identifiers. These are 16-byte
(128-bit) numbers that are guaranteed to be unique across different servers.
You can <a class="reference external" href="http://en.wikipedia.org/wiki/Universally_unique_identifier">read up on UUIDs on Wikipedia</a>.</p>
<p>The drawback of UUIDs is the segmentation they cause on indexes. Because UUIDs
are not sequentially generated, they can have negative impact on index access
performance. Additionally they are much bigger
than numerical primary keys (which are normally 4-bytes in length).</p>
<p>At the moment Doctrine DBAL drivers MySQL and SQL Server support the generation
of UUID/GUIDs. You can use the following bit of code to generate them across
platforms:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">use</span> <span class="nx">Doctrine\DBAL\DriverManager</span><span class="p">;</span>

<span class="nv">$conn</span> <span class="o">=</span> <span class="nx">DriverManager</span><span class="o">::</span><span class="na">getConnection</span><span class="p">(</span><span class="sd">/**..**/</span><span class="p">);</span>
<span class="nv">$guid</span> <span class="o">=</span> <span class="nv">$conn</span><span class="o">-&gt;</span><span class="na">fetchColumn</span><span class="p">(</span><span class="s1">&#39;SELECT &#39;</span> <span class="o">.</span> <span class="nv">$conn</span><span class="o">-&gt;</span><span class="na">getDatabasePlatform</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getGuidExpression</span><span class="p">());</span>

<span class="nv">$conn</span><span class="o">-&gt;</span><span class="na">insert</span><span class="p">(</span><span class="s2">&quot;my_table&quot;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s2">&quot;id&quot;</span> <span class="o">=&gt;</span> <span class="nv">$guid</span><span class="p">,</span> <span class="s2">&quot;foo&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;bar&quot;</span><span class="p">));</span>
</pre></div>
</div>
<p>In your application you should hide this details in Id-Generation services:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">MyApplication</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">IdGenerationService</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$conn</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">generateCustomerId</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">conn</span><span class="o">-&gt;</span><span class="na">fetchColumn</span><span class="p">(</span><span class="s1">&#39;SELECT &#39;</span> <span class="o">.</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">conn</span><span class="o">-&gt;</span><span class="na">getDatabasePlatform</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getGuidExpression</span><span class="p">()</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>A good starting point to read up on GUIDs (vs numerical ids) is this blog post
<a class="reference external" href="http://www.codinghorror.com/blog/2007/03/primary-keys-ids-versus-guids.html">Coding Horror: Primary Keys: IDs vs GUIDs</a>.</p>
</div>
<div class="section" id="table-generator">
<h3>13.1.2. Table Generator<a class="headerlink" href="#table-generator" title="Permalink to this headline">¶</a></h3>
<p>In some scenarios there is no way around a numerical, automatically
incrementing id. The way Auto incrementing IDs are implemented in MySQL and SQL
Server however is completely unsuitable for sharding. Remember in a sharding
architecture you have to know where the row for a specific ID is located and
IDs have to be globally unique across all servers. Auto-Increment Primary Keys
are missing both properties.</p>
<p>To get around this issue you can use the so-called &#8220;table-generator&#8221; strategy.
In this case you define a single database that is responsible for the
generation of auto-incremented ids. You create a table on this database and
through the use of locking create new sequential ids.</p>
<p>There are three important drawbacks to this strategy:</p>
<ul class="simple">
<li>Single point of failure</li>
<li>Bottleneck when application is write-heavy</li>
<li>A second independent database connection is needed to guarantee transaction
safety.</li>
</ul>
<p>If you can live with this drawbacks then you can use table-generation with the
following code in Doctrine:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">use</span> <span class="nx">Doctrine\DBAL\DriverManager</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Doctrine\DBAL\Id\TableGenerator</span><span class="p">;</span>

<span class="nv">$conn</span> <span class="o">=</span> <span class="nx">DriverManager</span><span class="o">::</span><span class="na">getConnection</span><span class="p">(</span><span class="o">/**..**</span><span class="p">);</span> <span class="c1">// connection 1</span>

<span class="c1">// creating the TableGenerator automatically opens a second connection.</span>
<span class="nv">$tableGenerator</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TableGenerator</span><span class="p">(</span><span class="nv">$conn</span><span class="p">,</span> <span class="s2">&quot;sequences_tbl_name&quot;</span><span class="p">);</span>

<span class="nv">$id1</span> <span class="o">=</span> <span class="nv">$tableGenerator</span><span class="o">-&gt;</span><span class="na">nextValue</span><span class="p">(</span><span class="s2">&quot;sequence_name1&quot;</span><span class="p">);</span>
<span class="nv">$id2</span> <span class="o">=</span> <span class="nv">$tableGenerator</span><span class="o">-&gt;</span><span class="na">nextValue</span><span class="p">(</span><span class="s2">&quot;sequence_name2&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>The table generator obviously needs a table to work. The schema of this table
is described in the <tt class="docutils literal"><span class="pre">TableGenerator</span></tt> class-docblock. Alternatively you
can use the <tt class="docutils literal"><span class="pre">Doctrine\DBAL\Id\TableGeneratorSchemaVisitor</span></tt> and apply it to your
<tt class="docutils literal"><span class="pre">Doctrine\DBAL\Schema\Schema</span></tt> instance. It will automatically add the required
sequence table.</p>
</div>
<div class="section" id="natural-identifiers">
<h3>13.1.3. Natural Identifiers<a class="headerlink" href="#natural-identifiers" title="Permalink to this headline">¶</a></h3>
<p>Sometimes you are lucky and your application data-model comes with a natural
id. This is mostly the case for applications who get their IDs generated
somewhere else (exogeneous ID-generation) or that work with temporal data. In
that case you can just define the natural primary key and shard your
application based on this data.</p>
</div>
</div>
<div class="section" id="transactions">
<h2>13.2. Transactions<a class="headerlink" href="#transactions" title="Permalink to this headline">¶</a></h2>
<p>Transactions in sharding can only work for data that is located on a single
shard. If you need transactions in your sharding architecture then you have to
make sure that the data updated during a transaction is located on a single
shard.</p>
</div>
<div class="section" id="foreign-keys">
<h2>13.3. Foreign Keys<a class="headerlink" href="#foreign-keys" title="Permalink to this headline">¶</a></h2>
<p>Since you cannot create foreign keys between remote database servers, in a
sharding architecture you should put the data on a shard that belongs to each
other. But even if you can isolate most of the rows on a single shard there may
exist relations between tables that exist on different shards. In this case
your application should be aware of the potential inconsistencies and handle
them graciously.</p>
</div>
<div class="section" id="complex-queries">
<h2>13.4. Complex Queries<a class="headerlink" href="#complex-queries" title="Permalink to this headline">¶</a></h2>
<p>GROUP BY, DISTINCT and ORDER BY are clauses that cannot be easily used in a
sharding architecture. If you have to execute these queries against multiple
shards then you cannot just append the different results to each other.</p>
<p>You have to be aware of this problem and design your queries accordingly or
shard the data in a way that you never have to query multiple shards to
calculate a result.</p>
</div>
<div class="section" id="shardmanager-interface">
<h2>13.5. ShardManager Interface<a class="headerlink" href="#shardmanager-interface" title="Permalink to this headline">¶</a></h2>
<p>The central API of the sharding extension is the <tt class="docutils literal"><span class="pre">ShardManager</span></tt> interface.
It contains two different groups of functions with regard to sharding.</p>
<p>First, it contains the Shard Selection API. You can pick a shard based on a
so-called &#8220;distribution-value&#8221; or reset the connection to the &#8220;global&#8221; shard,
a necessary database that often contains heavily cached, sharding independent
data such as meta tables or the &#8220;user/tenant&#8221; table.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">use</span> <span class="nx">Doctrine\DBAL\DriverManager</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Doctrine\Shards\DBAL\SQLAzure\SQLAzureShardManager</span><span class="p">;</span>

<span class="nv">$conn</span> <span class="o">=</span> <span class="nx">DriverManager</span><span class="o">::</span><span class="na">getConnection</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;sharding&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;federationName&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;my_database&#39;</span><span class="p">,</span>
        <span class="s1">&#39;distributionKey&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;customer_id&#39;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">));</span>
<span class="nv">$shardManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SQLAzureShardManager</span><span class="p">(</span><span class="nv">$conn</span><span class="p">);</span>

<span class="nv">$currentCustomerId</span> <span class="o">=</span> <span class="mi">1234</span><span class="p">;</span>
<span class="nv">$shardManager</span><span class="o">-&gt;</span><span class="na">selectShard</span><span class="p">(</span><span class="nv">$currentCustomerId</span><span class="p">);</span>
<span class="c1">// all queries after this call hit the shard</span>
<span class="c1">// where customer with id 1234 is on.</span>

<span class="nv">$shardManager</span><span class="o">-&gt;</span><span class="na">selectGlobal</span><span class="p">();</span>
<span class="c1">// the global database is selected.</span>
</pre></div>
</div>
<p>To access the currently selected distribution value use the following API
method:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="nv">$value</span> <span class="o">=</span> <span class="nv">$shardManager</span><span class="o">-&gt;</span><span class="na">getCurrentDistributionValue</span><span class="p">();</span>
</pre></div>
</div>
<p>The shard manager will prevent you switching shards when a transaction is open.
This is especially important when using sharding with the ORM. Because the ORM
uses a single transaction during the flush-operation this means that you can
only ever use one <tt class="docutils literal"><span class="pre">EntityManager</span></tt> with data from a single shard.</p>
<p>The second API is the &#8220;fan-out&#8221; query API. This allows you to execute queries against
ALL shards. The order of the results of this operation is undefined, that means
your query has to return the data in a way that works for the application, or
you have to sort the data in the application.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="nv">$sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM customers&quot;</span><span class="p">;</span>
<span class="nv">$rows</span> <span class="o">=</span> <span class="nv">$shardManager</span><span class="o">-&gt;</span><span class="na">queryAll</span><span class="p">(</span><span class="nv">$sql</span><span class="p">,</span> <span class="nv">$params</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="schema-operations-schemasynchronizer-interface">
<h2>13.6. Schema Operations: SchemaSynchronizer Interface<a class="headerlink" href="#schema-operations-schemasynchronizer-interface" title="Permalink to this headline">¶</a></h2>
<p>Schema Operations in a sharding architecture are tricky. You have to perform
them on all databases instances (shards) at the same time. Also Doctrine
has problems with this in particular as you cannot generate an SQL file with
changes on any development machine anymore and apply this on production. The
required changes depend on the amount of shards.</p>
<p>To allow the Doctrine Schema API operations on a sharding architecture we
performed a refactored from code inside ORM <tt class="docutils literal"><span class="pre">Doctrine\ORM\Tools\SchemaTool</span></tt>
class and extracted the code for operations on Schema instances into a new
<tt class="docutils literal"><span class="pre">Doctrine\Shards\DBAL\SchemaSynchronizer</span></tt> interface.</p>
<p>Every sharding implementation can implement this interface and allow schema
operations to take part on multiple shards.</p>
</div>
<div class="section" id="sql-azure-federations">
<h2>13.7. SQL Azure Federations<a class="headerlink" href="#sql-azure-federations" title="Permalink to this headline">¶</a></h2>
<p>Doctrine Shards ships with a custom implementation for Microsoft SQL
Azure. The Azure platform provides a native sharding functionality. In SQL
Azure the sharding functionality is called Federations. This
functionality applies the following restrictions (in line with the ones listed
above):</p>
<ul class="simple">
<li>IDENTITY columns are not allowed on sharded tables (federated tables)</li>
<li>Each table may only have exactly one clustered index and this index has to
have the distribution key/sharding-id as one column.</li>
<li>Every unique index (or primary key) has to contain the
distribution-key/sharding-id.</li>
</ul>
<p>Especially the requirements 2 and 3 prevent normalized database schemas. You
have to put the distribution key on every sharded table, which can affect your
application code quite a bit. This may lead to the creation of composite keys
where you normally wouldn&#8217;t need them.</p>
<p>The benefit of SQL Azure Federations is that they implement all the
shard-picking logic on the server. You only have to make use of the <tt class="docutils literal"><span class="pre">USE</span>
<span class="pre">FEDERATION</span></tt> statement. You don&#8217;t have to maintain a list of all the shards
inside your application and more importantly, resizing shards is done
transparently on the server.</p>
<p>Features of SQL Azure are:</p>
<ul class="simple">
<li>Central server to log into federations architecture. No need to know all
connection details of all shards.</li>
<li>Database level operation to split shards, taking away the tediousness of this
operation for application developers.</li>
<li>A global tablespace that can contain global data to all shards.</li>
<li>One or many different federations (this library only supports working with
one)</li>
<li>Sharded or non-sharded tables inside federations</li>
<li>Allows filtering SELECT queries on the database based on the selected
sharding key value. This allows to implement sharded Multi-Tenant Apps very easily.</li>
</ul>
<p>To setup an SQL Azure ShardManager use the following code:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">use</span> <span class="nx">Doctrine\DBAL\DriverManager</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Doctrine\Shards\DBAL\SQLAzure\SQLAzureShardManager</span><span class="p">;</span>

<span class="nv">$conn</span> <span class="o">=</span> <span class="nx">DriverManager</span><span class="o">::</span><span class="na">getConnection</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;dbname&#39;</span>   <span class="o">=&gt;</span> <span class="s1">&#39;my_database&#39;</span><span class="p">,</span>
    <span class="s1">&#39;host&#39;</span>     <span class="o">=&gt;</span> <span class="s1">&#39;tcp:dbname.windows.net&#39;</span><span class="p">,</span>
    <span class="s1">&#39;user&#39;</span>     <span class="o">=&gt;</span> <span class="s1">&#39;user@dbname&#39;</span><span class="p">,</span>
    <span class="s1">&#39;password&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;XXX&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sharding&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;federationName&#39;</span>   <span class="o">=&gt;</span> <span class="s1">&#39;my_federation&#39;</span><span class="p">,</span>
        <span class="s1">&#39;distributionKey&#39;</span>  <span class="o">=&gt;</span> <span class="s1">&#39;customer_id&#39;</span><span class="p">,</span>
        <span class="s1">&#39;distributionType&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">));</span>
<span class="nv">$shardManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SQLAzureShardManager</span><span class="p">(</span><span class="nv">$conn</span><span class="p">);</span>
</pre></div>
</div>
<p>Currently you are limited to one federation in your application.</p>
<p>You can inspect all the currently known shards on SQL Azure using the
<tt class="docutils literal"><span class="pre">ShardManager#getShards()</span></tt> function:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$shardManager</span><span class="o">-&gt;</span><span class="na">getShards</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$shard</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$shard</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="s2">&quot; &quot;</span> <span class="o">.</span> <span class="nv">$shard</span><span class="p">[</span><span class="s1">&#39;rangeLow&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="s2">&quot; - &quot;</span> <span class="o">.</span> <span class="nv">$shard</span><span class="p">[</span><span class="s1">&#39;rangeHigh&#39;</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="schema-operations">
<h3>13.7.1. Schema Operations<a class="headerlink" href="#schema-operations" title="Permalink to this headline">¶</a></h3>
<p>Schema Operations on SQL Azure Federations are possible with the
<tt class="docutils literal"><span class="pre">SQLAzureSchemaSynchronizer</span></tt>. You can instantiate this from your code:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">use</span> <span class="nx">Doctrine\Shards\DBAL\SQLAzure\SQLAzureSchemaSynchronizer</span><span class="p">;</span>

<span class="nv">$synchronizer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SQLAzureSchemaSynchronizer</span><span class="p">(</span><span class="nv">$conn</span><span class="p">,</span> <span class="nv">$shardManager</span><span class="p">);</span>
</pre></div>
</div>
<p>You can use the API such as <tt class="docutils literal"><span class="pre">createSchema($schema)</span></tt> then and it will be
distributed across all shards. The assumptions are:</p>
<ul class="simple">
<li>Using <tt class="docutils literal"><span class="pre">SchemaSynchronizer#createSchema()</span></tt> assumes the database is empty.
The federation is created during this operation.</li>
<li>Using <tt class="docutils literal"><span class="pre">SchemaSynchronizer#updateSchema()</span></tt> assumes the database and the
federation exists. All shards of the federation are iterated and update is
applied to all shards consecutively.</li>
</ul>
<p>For a schema with tables in the global or federated sub-schema you have to use
the Schema API to mark tables:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">use</span> <span class="nx">Doctrine\DBAL\Schema\Schema</span><span class="p">;</span>

<span class="nv">$schema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Schema</span><span class="p">();</span>

<span class="c1">// no options set, this table will be on the federation root</span>
<span class="nv">$users</span> <span class="o">=</span> <span class="nv">$schema</span><span class="o">-&gt;</span><span class="na">createTable</span><span class="p">(</span><span class="s1">&#39;Users&#39;</span><span class="p">);</span>
<span class="c1">//...</span>

<span class="c1">// marked as sharded, but no distribution column given:</span>
<span class="c1">// non-federated table inside the federation</span>
<span class="nv">$products</span> <span class="o">=</span> <span class="nv">$schema</span><span class="o">-&gt;</span><span class="na">createTable</span><span class="p">(</span><span class="s1">&#39;Products&#39;</span><span class="p">);</span>
<span class="nv">$products</span><span class="o">-&gt;</span><span class="na">addOption</span><span class="p">(</span><span class="s1">&#39;azure.federated&#39;</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
<span class="c1">//...</span>

<span class="c1">// shared + distribution column:</span>
<span class="c1">// federated table</span>
<span class="nv">$customers</span> <span class="o">=</span> <span class="nv">$schema</span><span class="o">-&gt;</span><span class="na">createTable</span><span class="p">(</span><span class="s1">&#39;Customers&#39;</span><span class="p">);</span>
<span class="nv">$customers</span><span class="o">-&gt;</span><span class="na">addColumn</span><span class="p">(</span><span class="s1">&#39;CustomerID&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">);</span>
<span class="c1">//...</span>
<span class="nv">$customers</span><span class="o">-&gt;</span><span class="na">addOption</span><span class="p">(</span><span class="s1">&#39;azure.federated&#39;</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
<span class="nv">$customers</span><span class="o">-&gt;</span><span class="na">addOption</span><span class="p">(</span><span class="s1">&#39;azure.federatedOnColumnName&#39;</span><span class="p">,</span> <span class="s1">&#39;CustomerID&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="sqlazure-filtering">
<h3>13.7.2. SQLAzure Filtering<a class="headerlink" href="#sqlazure-filtering" title="Permalink to this headline">¶</a></h3>
<p>SQL Azure comes with a powerful filtering feature, that allows you to
automatically implement a multi-tenant application for a formerly single-tenant
application. The restriction to make this work is that your application does not work with
IDENTITY columns.</p>
<p>Normally when you select a shard using <tt class="docutils literal"><span class="pre">ShardManager#selectShard()</span></tt> any query
executed against this shard will return data from ALL the tenants located on
this shard. With the &#8220;FILTERING=ON&#8221; flag on the <tt class="docutils literal"><span class="pre">USE</span> <span class="pre">FEDERATION</span></tt> query
however SQL Azure can automatically filter all SELECT queries with the chosen
distribution value. Additionally you can automatically set the currently
selected distribution value in every INSERT statement using a function for this
value as the <tt class="docutils literal"><span class="pre">DEFAULT</span></tt> part of the column. If you are using GUIDs for every
row then UPDATE and DELETE statements using only GUIDs will work out perfectly
as well, as they are by definition for unique rows. This feature allows you to
build multi-tenant applications, even though they were not originally designed
that way.</p>
<p>To enable filtering you can use the
<tt class="docutils literal"><span class="pre">SQLAzureShardManager#setFilteringEnabled()</span></tt> method. This method is not part
of the interface. You can also set a default value for filtering by passing it
as the &#8220;sharding.filteringEnabled&#8221; parameter to
<tt class="docutils literal"><span class="pre">DriverManager#getConnection()</span></tt>.</p>
</div>
</div>
<div class="section" id="generic-sql-sharding-support">
<h2>13.8. Generic SQL Sharding Support<a class="headerlink" href="#generic-sql-sharding-support" title="Permalink to this headline">¶</a></h2>
<p>Besides the custom SQL Azure support there is a generic implementation that
works with all database drivers. It requires to specify all database
connections and will switch between the different connections under the hood
when using the <tt class="docutils literal"><span class="pre">ShardManager</span></tt> API. This is also the biggest drawback of this
approach, since fan-out queries need to connect to all databases in a single
request.</p>
<p>See the configuration for a sample sharding connection:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">use</span> <span class="nx">Doctrine\DBAL\DriverManager</span><span class="p">;</span>

<span class="nv">$conn</span> <span class="o">=</span> <span class="nx">DriverManager</span><span class="o">::</span><span class="na">getConnection</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;wrapperClass&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Doctrine\Shards\DBAL\PoolingShardConnection&#39;</span><span class="p">,</span>
    <span class="s1">&#39;driver&#39;</span>       <span class="o">=&gt;</span> <span class="s1">&#39;pdo_sqlite&#39;</span><span class="p">,</span>
    <span class="s1">&#39;global&#39;</span>       <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;memory&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">),</span>
    <span class="s1">&#39;shards&#39;</span>       <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;memory&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;memory&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="s1">&#39;shardChoser&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Doctrine\Shards\DBAL\ShardChoser\MultiTenantShardChoser&#39;</span><span class="p">,</span>
<span class="p">));</span>
</pre></div>
</div>
<p>You have to configure the following options:</p>
<ul class="simple">
<li>&#8216;wrapperClass&#8217; - Selecting the PoolingShardConnection as above.</li>
<li>&#8216;global&#8217; - An array of database parameters that is used for connecting to the
global database.</li>
<li>&#8216;shards&#8217; - An array of shard database parameters. You have to specify an
&#8216;id&#8217; parameter for each of the shard configurations.</li>
<li>&#8216;shardChoser&#8217; - Implementation of the
<tt class="docutils literal"><span class="pre">Doctrine\Shards\DBAL\ShardChoser\ShardChoser</span></tt> interface.</li>
</ul>
<p>The Shard Choser interface maps the distribution value to a shard-id. This
gives you the freedom to implement your own strategy for sharding the data
horizontally.</p>
</div>
</div>


              </div>
                </div>

            </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">



            
                <h3>Project Versions</h3>

                <select name="versions" id="versions">
            
            <option value="http://readthedocs.org/en/latest/">latest</option>
            
                </select>
            
            <div id="searchbox" style="">
              <h3>Search</h3>
                <form class="search" action="http://readthedocs.org/search/project/" method="get">
                  <input type="text" name="q" size="18">
                  <input type="submit" value="Go">
                  <input type="hidden" name="selected_facets" value="project:Doctrine DBAL">
                </form>
            </div>
            <h3><a href="../index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">13. Sharding</a><ul>
<li><a class="reference internal" href="#id-generation">13.1. ID Generation</a><ul>
<li><a class="reference internal" href="#use-guid-uuids">13.1.1. Use GUID/UUIDs</a></li>
<li><a class="reference internal" href="#table-generator">13.1.2. Table Generator</a></li>
<li><a class="reference internal" href="#natural-identifiers">13.1.3. Natural Identifiers</a></li>
</ul>
</li>
<li><a class="reference internal" href="#transactions">13.2. Transactions</a></li>
<li><a class="reference internal" href="#foreign-keys">13.3. Foreign Keys</a></li>
<li><a class="reference internal" href="#complex-queries">13.4. Complex Queries</a></li>
<li><a class="reference internal" href="#shardmanager-interface">13.5. ShardManager Interface</a></li>
<li><a class="reference internal" href="#schema-operations-schemasynchronizer-interface">13.6. Schema Operations: SchemaSynchronizer Interface</a></li>
<li><a class="reference internal" href="#sql-azure-federations">13.7. SQL Azure Federations</a><ul>
<li><a class="reference internal" href="#schema-operations">13.7.1. Schema Operations</a></li>
<li><a class="reference internal" href="#sqlazure-filtering">13.7.2. SQLAzure Filtering</a></li>
</ul>
</li>
<li><a class="reference internal" href="#generic-sql-sharding-support">13.8. Generic SQL Sharding Support</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="security.html"
                                  title="previous chapter">12. Security</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="sharding_azure_tutorial.html"
                                  title="next chapter">14. SQLAzure Sharding Tutorial</a></p>
  
    <h3>This Page</h3>
    <ul class="this-page-menu">
      
        <li><a href="../_sources/reference/sharding.txt"
               rel="nofollow">Show Source</a></li>
      
      
        <li><a href="https://github.com/doctrine/dbal/blob/master/docs/en/reference/sharding.rst">
          Show on GitHub</a></li>
        <li><a href="https://github.com/doctrine/dbal/edit/master/docs/en/reference/sharding.rst">
          Edit on GitHub</a></li>
      
    </ul>
  

        </div>
      </div>
          <div class="clearer"></div>
        </div>

          <div class="footer">
              &copy; Copyright 2010, Roman Borschel, Guilherme Blanco, Benjamin Eberlei, Jonathan Wage.
              Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
            <br/>
            <a target="_BLANK" href="http://www.servergrove.com"><img src="http://www.doctrine-project.org/images/servergrove.jpg" /></a>      <br/><br/>
            <form action="https://www.paypal.com/cgi-bin/webscr" method="post">
              <input type="hidden" name="cmd" value="_s-xclick" />
              <input type="hidden" name="hosted_button_id" value="BAE2E3XANQ77Y" />
              <input type="image" src="https://www.paypal.com/en_US/i/btn/btn_donateCC_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!" />
              <img alt="" border="0" src="https://www.paypal.com/en_US/i/scr/pixel.gif" width="1" height="1" />
            </form>
          </div>
 <!-- End original user content -->


<br/>
<br/>
<br/>


<style type="text/css">
  #version_menu, .rtd-badge.rtd {
    -webkit-transition: all 0.25s 0.75s;
    transition: all 0.25s 0.75s;
  }
  .footer_popout:hover #version_menu, .footer_popout:hover .rtd-badge.rtd {
    -webkit-transition: all 0.25s 0s;
    transition: all 0.25s 0s;
  }
  .rtd-badge {
    position: fixed;
    display: block;
    bottom: 5px;
    height: 40px;
    text-indent: -9999em;
    border-radius: 3px;
    -moz-border-radius: 3px;
    -webkit-border-radius: 3px;
    box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 1px 0 rgba(255, 255, 255, 0.2) inset;
    -moz-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 1px 0 rgba(255, 255, 255, 0.2) inset;
    -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 1px 0 rgba(255, 255, 255, 0.2) inset;
  }
  #version_menu {
    position: fixed;
    visibility: hidden;
    opacity: 0;
    bottom: 11px;
    right: 47px;
    list-style-type: none;
    margin: 0;
  }
  .footer_popout:hover #version_menu {
    visibility: visible;
    opacity: 1;
    right: 166px;
  }
  #version_menu li {
    display: block;
    float: right;
  }
  #version_menu li a {
    display: block;
    padding: 6px 10px 4px 10px;
    margin: 7px 7px 0 0;
    font-weight: bold;
    font-size: 14px;
    height: 20px;
    line-height: 17px;
    text-decoration: none;
    color: #fff;
    background: #8ca1af url(//media.readthedocs.org//images/gradient-light.png) bottom left repeat-x;
    border-radius: 3px;
    -moz-border-radius: 3px;
    -webkit-border-radius: 3px;
    box-shadow: 0 1px 1px #465158;
    -moz-box-shadow: 0 1px 1px #465158;
    -webkit-box-shadow: 0 1px 1px #465158;
    text-shadow: 0 1px 1px rgba(0, 0, 0, 0.5);
  }
  #version_menu li a:hover {
    text-decoration: none;
    background-color: #697983;
    box-shadow: 0 1px 0px #465158;
    -moz-box-shadow: 0 1px 0px #465158;
    -webkit-box-shadow: 0 1px 0px #465158;
  }
  .rtd-badge.rtd {
    background: #3b4449 url(//media.readthedocs.org//images/badge-rtd.png) scroll top left no-repeat;
    border: 1px solid #282E32;
    width: 41px;
    right: 5px;
  }
  .footer_popout:hover .rtd-badge.rtd {
    width: 160px;
  }
  .rtd-badge.revsys { background: #465158 url(//media.readthedocs.org//images/badge-revsys.png) top left no-repeat;
    border: 1px solid #1C5871;
    width: 290px;
    right: 173px;
  }
  .rtd-badge.revsys-inline-sponsored {
    position: inherit;
    margin-left: auto;
    margin-right: 175px;
    margin-bottom: 5px;
    background: #465158 url(//media.readthedocs.org//images/badge-revsys.png) top left no-repeat;
    border: 1px solid #1C5871;
    width: 290px;
    right: 173px;
  }
  .rtd-badge.revsys-inline {
    position: inherit;
    margin-left: auto;
    margin-right: 175px;
    margin-bottom: 5px;
    background: #465158 url(//media.readthedocs.org//images/badge-revsys-sm.png) top left no-repeat;
    border: 1px solid #1C5871;
    width: 205px;
    right: 173px;
  }

</style>
<div class="rtd_doc_footer">
  <div class="footer_popout">
    <a href="//readthedocs.org/projects/doctrine-dbal/?fromdocs=doctrine-dbal" class="rtd-badge rtd"> Brought to you by Read the Docs</a>
    <ul id="version_menu">
      
        <li><a href="/en/latest/">latest</a></li>
      
    </ul>
  </div>
</div>
<!-- RTD Analytics Code -->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-17997319-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>




      </div>

      <div id="bot-rcnr">
        <div class="tl"><!-- corner --></div>
      </div>
    </div>

  <script src="http://www.google-analytics.com/urchin.js" type="text/javascript">
  </script>
  <script type="text/javascript">
  _uacct = "UA-288343-7";
  urchinTracker();
  </script>
  <a class="githublink" href="http://github.com/doctrine"><img src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png" alt="Fork me on GitHub"></a>
  </body>
</html>