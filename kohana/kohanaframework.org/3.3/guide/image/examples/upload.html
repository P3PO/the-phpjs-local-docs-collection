<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

<title>Upload Image | Kohana User Guide</title>

<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok8v=02fcfa4f56/"},atok:"eee59e90a8282bcfc7cd8af99a42a3da",petok:"e4673149d8528458f2cc6fbc7ac93aab1726dabf-1394799565-1800",zone:"kohanaframework.org",rocket:"0",apps:{"ga_key":{"ua":"UA-27864271-1","ga_bs":"2"}}}];var a=document.createElement("script"),b=document.getElementsByTagName("script")[0];a.async=!0;a.src="//ajax.cloudflare.com/cdn-cgi/nexp/dok8v=b064e16429/cloudflare.min.js";b.parentNode.insertBefore(a,b);}}catch(e){};
//]]>
</script>
<link type="text/css" href="../../../guide-media/css/print.css" rel="stylesheet" media="print" />
<link type="text/css" href="../../../guide-media/css/screen.css" rel="stylesheet" media="screen" />
<link type="text/css" href="../../../guide-media/css/kodoc.css" rel="stylesheet" media="screen" />
<link type="text/css" href="../../../guide-media/css/shCore.css" rel="stylesheet" media="screen" />
<link type="text/css" href="../../../guide-media/css/shThemeKodoc.css" rel="stylesheet" media="screen" />

<script type="text/javascript" src="../../../guide-media/js/jquery.min.js"></script>
<script type="text/javascript" src="../../../guide-media/js/jquery.cookie.js"></script>
<script type="text/javascript" src="../../../guide-media/js/kodoc.js"></script>
<script type="text/javascript" src="../../../guide-media/js/shCore.js"></script>
<script type="text/javascript" src="../../../guide-media/js/shBrushPhp.js"></script>

<!--[if lt IE 9]>
<script src="http://ie7-js.googlecode.com/svn/version/2.1(beta4)/IE9.js"></script>
<![endif]-->
<script type="text/javascript">
/* <![CDATA[ */
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-27864271-1']);
_gaq.push(['_trackPageview']);

(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();

(function(b){(function(a){"__CF"in b&&"DJS"in b.__CF?b.__CF.DJS.push(a):"addEventListener"in b?b.addEventListener("load",a,!1):b.attachEvent("onload",a)})(function(){"FB"in b&&"Event"in FB&&"subscribe"in FB.Event&&(FB.Event.subscribe("edge.create",function(a){_gaq.push(["_trackSocial","facebook","like",a])}),FB.Event.subscribe("edge.remove",function(a){_gaq.push(["_trackSocial","facebook","unlike",a])}),FB.Event.subscribe("message.send",function(a){_gaq.push(["_trackSocial","facebook","send",a])}));"twttr"in b&&"events"in twttr&&"bind"in twttr.events&&twttr.events.bind("tweet",function(a){if(a){var b;if(a.target&&a.target.nodeName=="IFRAME")a:{if(a=a.target.src){a=a.split("#")[0].match(/[^?=&]+=([^&]*)?/g);b=0;for(var c;c=a[b];++b)if(c.indexOf("url")===0){b=unescape(c.split("=")[1]);break a}}b=void 0}_gaq.push(["_trackSocial","twitter","tweet",b])}})})})(window);
/* ]]> */
</script>
</head>
<body>

	<div id="kodoc-header">
		<div class="container">
			<a href="http://kohanaframework.org/" id="kodoc-logo">
				<img src="../../../guide-media/img/kohana.png" />
			</a>
			<div id="kodoc-menu">
				<ul>
					<li class="guide first">
						<a href="../../../guide.1.html">User Guide</a>
					</li>
										<li class="api">
						<a href="../../../guide-api.html">API Browser</a>
					</li>
									</ul>
			</div>
		</div>
	</div>

	<div id="kodoc-content">
		<div class="wrapper">
			<div class="container">
				<div class="span-22 prefix-1 suffix-1">
					<ul id="kodoc-breadcrumb">
																				<li><a href="../../../guide.1.html">User Guide</a></li>
																											<li><a href="../../image.1.html">Image</a></li>
																											<li class="last">Upload Image</li>
																		</ul>
				</div>
				<div class="span-6 prefix-1">
					<div id="kodoc-topics">
						<h2 id="image"><a href="../index.html">Image</a></h2>

<ul>
<li><a href="../using.html">Using</a></li>
<li><a href="../examples.1.html">Examples</a>

<ul>
<li><a href="upload.html">Upload Image</a></li>
<li><a href="crop.html">Crop Profile Image</a></li>
<li><a href="dynamic.html">Dynamic Image Controller</a></li>
</ul></li>
</ul>
					</div>
				</div>
				<div id="kodoc-body" class="span-16 suffix-1 last">
					<h1 id="upload-image">Upload Image</h1>

<div class="page-toc">
					<a href="upload.html#upload-image">Upload Image</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;				<a href="upload.html#controller">Controller</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;				<a href="upload.html#views">Views</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;				<a href="upload.html#screenshots">Screenshots</a><br />
	</div>
<p>The following example shows how to handle uploading of an image, resize it and save it to a file. Be sure you have enabled the <a href="../../../guide-api/Image.html">Image</a> module as discussed in getting started guide.</p>

<p>Assuming you are creating a web application that allows your members to upload their profile picture (avatar), the steps below explains it how.</p>

<h2 id="controller">Controller</h2>

<p>First we need to create a controller that handles the requests for uploading an image. We will name it <code>Controller_Avatar</code> and accessible through <code>/avatar</code> URL. Assuming that your project is located at <a href="http://localhost/kohana">http://localhost/kohana</a>, then our avatar controller is at <a href="http://localhost/kohana/avatar">http://localhost/kohana/avatar</a>.</p>

<p>For simplicity, the upload form will be on <code>index</code> action and <code>upload</code> action will process the uploaded file. This is what our controller now looks like. Please note that we are not using <a href="../../../guide-api/Controller_Template.html">Controller_Template</a>, just <a href="../../../guide-api/Controller.html">Controller</a>.</p>

<pre><code>&lt;?php defined('SYSPATH') or die('No direct script access.');

class Controller_Avatar extends Controller {

    public function action_index()
    {
        $view = View::factory('avatar/index');
        $this-&gt;response-&gt;body($view);
    }

    public function action_upload()
    {
        $view = View::factory('avatar/upload');
        $error_message = NULL;
        $filename = NULL;

        if ($this-&gt;request-&gt;method() == Request::POST)
        {
            if (isset($_FILES['avatar']))
            {
                $filename = $this-&gt;_save_image($_FILES['avatar']);
            }
        }

        if ( ! $filename)
        {
            $error_message = 'There was a problem while uploading the image.
                Make sure it is uploaded and must be JPG/PNG/GIF file.';
        }

        $view-&gt;uploaded_file = $filename;
        $view-&gt;error_message = $error_message;
        $this-&gt;response-&gt;body($view);
    }

    protected function _save_image($image)
    {
        if (
            ! Upload::valid($image) OR
            ! Upload::not_empty($image) OR
            ! Upload::type($image, array('jpg', 'jpeg', 'png', 'gif')))
        {
            return FALSE;
        }

        $directory = DOCROOT.'uploads/';

        if ($file = Upload::save($image, NULL, $directory))
        {
            $filename = strtolower(Text::random('alnum', 20)).'.jpg';

            Image::factory($file)
                -&gt;resize(200, 200, Image::AUTO)
                -&gt;save($directory.$filename);

            // Delete the temporary file
            unlink($file);

            return $filename;
        }

        return FALSE;
    }

}
</code></pre>

<p>We have <code>index</code> and <code>upload</code> actions. <code>index</code> action will display the upload form and <code>upload</code> action will process the uploaded image and provides feedback to the user.</p>

<p>In <code>upload</code> action, it checks if the request method was <code>POST</code>, then delegates the process to <code>_save_image()</code> method which in turn performs various checks and finally resize and save the image to the <code>uploads</code> directory.</p>

<h2 id="views">Views</h2>

<p>For the upload form (the <code>index</code> action), the view is located at <code>views/avatar/index.php</code>.</p>

<pre><code>&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;Upload Avatar&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;h1&gt;Upload your avatar&lt;/h1&gt;
        &lt;form id="upload-form" action="&lt;?php echo URL::site('avatar/upload') ?&gt;" method="post" enctype="multipart/form-data"&gt;
            &lt;p&gt;Choose file:&lt;/p&gt;
            &lt;p&gt;&lt;input type="file" name="avatar" id="avatar" /&gt;&lt;/p&gt;
            &lt;p&gt;&lt;input type="submit" name="submit" id="submit" value="Upload" /&gt;&lt;/p&gt;
        &lt;/form&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>Take note of the action attribute. It points to our <code>avatar/upload</code> action whose view code goes to <code>views/avatar/upload.php</code>.</p>

<pre><code>&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;Upload Avatar Result&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;?php if ($uploaded_file): ?&gt;
        &lt;h1&gt;Upload success&lt;/h1&gt;
        &lt;p&gt;
            Here is your uploaded avatar:
            &lt;img src="&lt;?php echo URL::site("/uploads/$uploaded_file") ?&gt;" alt="Uploaded avatar" /&gt;
        &lt;/p&gt;
        &lt;?php else: ?&gt;
        &lt;h1&gt;Something went wrong with the upload&lt;/h1&gt;
        &lt;p&gt;&lt;?php echo $error_message ?&gt;&lt;/p&gt;
        &lt;?php endif ?&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>When the upload is successfull, a success message is displayed with the uploaded image displayed. Otherwise, when it fails, it displays an error message.</p>

<h2 id="screenshots">Screenshots</h2>

<p>Below are screenshots for this example.</p>

<p><img src="../../../guide-media/image/upload_form.jpg" alt="Upload image form" /></p>

<p><em>Upload image form</em></p>

<p><img src="../../../guide-media/image/upload_result.jpg" alt="Upload result page" /></p>

<p><em>Upload result form</em></p>

									</div>
			</div>
		</div>
	</div>

	<div id="kodoc-footer">
		<div class="container">
			<div class="span-12">
							<p>&copy; 2008–2012 Kohana Team</p>
						</div>
			<div class="span-12 last right">
			<p>Powered by <a href="http://kohanaframework.org/">Kohana</a> v3.3.1</p>
			</div>
		</div>
	</div>

</body>
</html>
