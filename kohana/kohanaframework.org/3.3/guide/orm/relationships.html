<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

<title>Relationships | Kohana User Guide</title>

<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok8v=02fcfa4f56/"},atok:"eee59e90a8282bcfc7cd8af99a42a3da",petok:"0c49ca18b53fd0da0e85a8950a749261fadaae6a-1394799567-1800",zone:"kohanaframework.org",rocket:"0",apps:{"ga_key":{"ua":"UA-27864271-1","ga_bs":"2"}}}];var a=document.createElement("script"),b=document.getElementsByTagName("script")[0];a.async=!0;a.src="//ajax.cloudflare.com/cdn-cgi/nexp/dok8v=b064e16429/cloudflare.min.js";b.parentNode.insertBefore(a,b);}}catch(e){};
//]]>
</script>
<link type="text/css" href="../../guide-media/css/print.css" rel="stylesheet" media="print" />
<link type="text/css" href="../../guide-media/css/screen.css" rel="stylesheet" media="screen" />
<link type="text/css" href="../../guide-media/css/kodoc.css" rel="stylesheet" media="screen" />
<link type="text/css" href="../../guide-media/css/shCore.css" rel="stylesheet" media="screen" />
<link type="text/css" href="../../guide-media/css/shThemeKodoc.css" rel="stylesheet" media="screen" />

<script type="text/javascript" src="../../guide-media/js/jquery.min.js"></script>
<script type="text/javascript" src="../../guide-media/js/jquery.cookie.js"></script>
<script type="text/javascript" src="../../guide-media/js/kodoc.js"></script>
<script type="text/javascript" src="../../guide-media/js/shCore.js"></script>
<script type="text/javascript" src="../../guide-media/js/shBrushPhp.js"></script>

<!--[if lt IE 9]>
<script src="http://ie7-js.googlecode.com/svn/version/2.1(beta4)/IE9.js"></script>
<![endif]-->
<script type="text/javascript">
/* <![CDATA[ */
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-27864271-1']);
_gaq.push(['_trackPageview']);

(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();

(function(b){(function(a){"__CF"in b&&"DJS"in b.__CF?b.__CF.DJS.push(a):"addEventListener"in b?b.addEventListener("load",a,!1):b.attachEvent("onload",a)})(function(){"FB"in b&&"Event"in FB&&"subscribe"in FB.Event&&(FB.Event.subscribe("edge.create",function(a){_gaq.push(["_trackSocial","facebook","like",a])}),FB.Event.subscribe("edge.remove",function(a){_gaq.push(["_trackSocial","facebook","unlike",a])}),FB.Event.subscribe("message.send",function(a){_gaq.push(["_trackSocial","facebook","send",a])}));"twttr"in b&&"events"in twttr&&"bind"in twttr.events&&twttr.events.bind("tweet",function(a){if(a){var b;if(a.target&&a.target.nodeName=="IFRAME")a:{if(a=a.target.src){a=a.split("#")[0].match(/[^?=&]+=([^&]*)?/g);b=0;for(var c;c=a[b];++b)if(c.indexOf("url")===0){b=unescape(c.split("=")[1]);break a}}b=void 0}_gaq.push(["_trackSocial","twitter","tweet",b])}})})})(window);
/* ]]> */
</script>
</head>
<body>

	<div id="kodoc-header">
		<div class="container">
			<a href="http://kohanaframework.org/" id="kodoc-logo">
				<img src="../../guide-media/img/kohana.png" />
			</a>
			<div id="kodoc-menu">
				<ul>
					<li class="guide first">
						<a href="../../guide.1.html">User Guide</a>
					</li>
										<li class="api">
						<a href="../../guide-api.html">API Browser</a>
					</li>
									</ul>
			</div>
		</div>
	</div>

	<div id="kodoc-content">
		<div class="wrapper">
			<div class="container">
				<div class="span-22 prefix-1 suffix-1">
					<ul id="kodoc-breadcrumb">
																				<li><a href="../../guide.1.html">User Guide</a></li>
																											<li><a href="../orm.1.html">ORM</a></li>
																											<li class="last">Relationships</li>
																		</ul>
				</div>
				<div class="span-6 prefix-1">
					<div id="kodoc-topics">
						<h2 id="orm"><a href="index.html">ORM</a></h2>

<ul>
<li><a href="models.html">Creating ORM Models</a></li>
<li><a href="using.html">Basic usage</a></li>
<li><a href="relationships.html">Relationships</a></li>
<li><a href="validation.html">Validation</a></li>
<li><a href="filters.html">Filters</a></li>
<li><a href="examples.1.html">Examples</a>

<ul>
<li><a href="examples/simple.html">Simple</a></li>
<li><a href="examples/validation.html">Validation</a></li>
</ul></li>
<li><a href="upgrading.html">Upgrading</a></li>
</ul>
					</div>
				</div>
				<div id="kodoc-body" class="span-16 suffix-1 last">
					<h1 id="relationships">Relationships</h1>

<div class="page-toc">
					<a href="relationships.html#relationships">Relationships</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;				<a href="relationships.html#belongsto">belongs_to</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;				<a href="relationships.html#hasmany">has_many</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;				<a href="relationships.html#hasone">has_one</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;				<a href="relationships.html#hasmany-through">has_many "through"</a><br />
	</div>
<p>Kohana ORM supports four types of object relationships: <code>belongs_to</code>, <code>has_many</code>, <code>has_many "through"</code> and <code>has_one</code>. The <code>has_many "through"</code> relationship can be used to function like Active Record's <code>has_many_and_belongs_to</code> relationship type.</p>

<h2 id="belongsto">belongs_to</h2>

<p>A <code>belongs_to</code> relation should be used when you have one model that belongs to another. For example, a <code>Child</code> model belongs_to a <code>Parent</code> or a <code>Flag</code> model <code>belongs_to</code> a <code>Country</code>.</p>

<p>This is the base <code>belongs_to</code> relationship:</p>

<pre><code>protected $_belongs_to = array(
    '[alias name]' =&gt; array(
        'model'       =&gt; '[model name]',
        'foreign_key' =&gt; '[column]',
    ),
);
</code></pre>

<p>You can omit any or all of the keys/values in the array on the right, in which case defaults are used:</p>

<pre><code>protected $_belongs_to = array('[alias name]' =&gt; array());
</code></pre>

<p>The <strong>alias name</strong> is what is used to access the related model in your code. If you had a <code>Post</code> model that belonged to a <code>User</code> model and wished to use the default values of the <code>belongs_to</code> configuration then your code would look like this:</p>

<pre><code>protected $_belongs_to = array('user' =&gt; array());
</code></pre>

<p>To access the user model, you would use <code>$post-&gt;user</code>.  Since we're using the defaults above, the alias name will be used for the model name, and the foreign key in the posts table will be the alias name followed by <code>_id</code>, in this case it would be <code>user_id</code>. (You can change the <code>_id</code> suffix by modifying the <code>$foreign_key_suffix</code> variable in the model.)</p>

<p>Let's say your <code>Post</code> database table schema doesn't have a <code>user_id</code> column but instead has an <code>author_id</code> column which is a foreign key for a record in the <code>User</code> table. You could use code like this:</p>

<pre><code>protected $_belongs_to = array(
    'user' =&gt; array(
        'foreign_key' =&gt; 'author_id',
    ),
);
</code></pre>

<p>If you wanted access a post's author by using code like <code>$post-&gt;author</code> then you would simply need to change the alias and add the <code>model</code> index:</p>

<pre><code>protected $_belongs_to = array(
    'author' =&gt; array(
        'model'       =&gt; 'User',
    ),
);
</code></pre>

<h2 id="hasmany">has_many</h2>

<p>The standard <code>has_many</code> relationship will likely fall on the other side of a <code>belongs_to</code> relationship.  In the above examples, a post belongs to a user.  From the user's perspective, a user has many posts. A has_many relationship is defined below:</p>

<pre><code>protected $_has_many = array(
    '[alias name]' =&gt; array(
        'model'       =&gt; '[model name]',
        'foreign_key' =&gt; '[column]',
    ),
);
</code></pre>

<p>Again, you can omit all keys in the right array to use the defaults:</p>

<pre><code>protected $_has_many = array('[alias name]' =&gt; array());
</code></pre>

<p>For our user and post example, this would look like the following in the user model:</p>

<pre><code>protected $_has_many = array('posts' =&gt; array());
</code></pre>

<p>Using the above, the posts could be access using <code>$user-&gt;posts-&gt;find_all()</code>.  Notice the <code>find_all()</code> used in this example. With <code>belongs_to</code> and <code>has_one</code> relationship types, the model is already loaded with necessary data.  For <code>has_many</code> relationships, however, you may want to limit the number of results or add additional conditions to the SQL query; you can do so prior to the <code>find_all()</code>.</p>

<p>The model name used by default will be the singular name of the alias using the <code>inflector</code> class.  In this case, <code>posts</code> uses <code>post</code> as the model name.  The foreign key used by default is the owner model's name followed by <code>_id</code>.  In this case, the foreign key will be <code>user_id</code> and it must exist in the posts table as before.</p>

<p>Let's assume now you want to access the posts using the name <code>stories</code> instead, and are still using the <code>author_id</code> key as in the <code>belongs_to</code> example.  You would define your has_many relationship as:</p>

<pre><code>protected $_has_many = array(
    'stories' =&gt; array(
        'model'       =&gt; 'Post',
        'foreign_key' =&gt; 'author_id',
    ),
);
</code></pre>

<h2 id="hasone">has_one</h2>

<p>A <code>has_one</code> relationship is almost identical to a <code>has_many</code> relationship.  In a <code>has_one</code> relationship, there can be 1 and only 1 relationship (rather than 1 or more in a has_many). If a user can only have one post or story, rather than many then the code would look like this:</p>

<pre><code>protected $_has_one = array(
    'story' =&gt; array(
        'model'       =&gt; 'Post',
        'foreign_key' =&gt; 'author_id',
    ),
);
</code></pre>

<h2 id="hasmany-through">has_many "through"</h2>

<p>A <code>has_many "through"</code> relationship is used for many-to-many relationships.  For instance, let's assume now we have an additional model, called <code>Category</code>.  Posts may belong to more than one category, and each category may have more than one post.  To link them together, an additional table is needed with columns for a <code>post_id</code> and a <code>category_id</code> (sometimes called a pivot table).  We'll name the model for this <code>Post_Category</code> and the corresponding table <code>categories_posts</code>.</p>

<p>To define the <code>has_many</code> "through" relationship, the same syntax for standard has_many relationships is used with the addition of a 'through' parameter.  Let's assume we're working with the Post model:</p>

<pre><code>protected $_has_many = array(
    'categories' =&gt; array(
        'model'   =&gt; 'Category',
        'through' =&gt; 'categories_posts',
    ),
);
</code></pre>

<p>In the Category model:</p>

<pre><code>protected $_has_many = array(
    'posts' =&gt; array(
        'model'   =&gt; 'Post',
        'through' =&gt; 'categories_posts',
    ),
);
</code></pre>

<p>To access the categories and posts, you simply use <code>$post-&gt;categories-&gt;find_all()</code> and <code>$category-&gt;posts-&gt;find_all()</code></p>

<p>Methods are available to check for, add, and remove relationships for many-to-many relationships.  Let's assume you have a $post model loaded, and a $category model loaded as well.  You can check to see if the $post is related to this $category with the following call:</p>

<pre><code>$post-&gt;has('categories', $category);
</code></pre>

<p>The first parameter is the alias name to use (in case your post model has more than one relationship to the category model) and the second is the model to check for a relationship with.</p>

<p>Assuming you want to add the relationship (by creating a new record in the categories_posts table), you would simply do:</p>

<pre><code>$post-&gt;add('categories', $category);
</code></pre>

<p>To remove:</p>

<pre><code>$post-&gt;remove('categories', $category);
</code></pre>

									</div>
			</div>
		</div>
	</div>

	<div id="kodoc-footer">
		<div class="container">
			<div class="span-12">
							<p>&copy; 2008–2012 Kohana Team</p>
						</div>
			<div class="span-12 last right">
			<p>Powered by <a href="http://kohanaframework.org/">Kohana</a> v3.3.1</p>
			</div>
		</div>
	</div>

</body>
</html>
