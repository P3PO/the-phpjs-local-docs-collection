<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

<title>Codebench | Kohana User Guide</title>

<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok8v=02fcfa4f56/"},atok:"eee59e90a8282bcfc7cd8af99a42a3da",petok:"6b736853d69f1da621f1b24955404fbb62c5b0c7-1394799180-1800",zone:"kohanaframework.org",rocket:"0",apps:{"ga_key":{"ua":"UA-27864271-1","ga_bs":"2"}}}];var a=document.createElement("script"),b=document.getElementsByTagName("script")[0];a.async=!0;a.src="//ajax.cloudflare.com/cdn-cgi/nexp/dok8v=b064e16429/cloudflare.min.js";b.parentNode.insertBefore(a,b);}}catch(e){};
//]]>
</script>
<link type="text/css" href="../guide-media/css/print.css" rel="stylesheet" media="print" />
<link type="text/css" href="../guide-media/css/screen.css" rel="stylesheet" media="screen" />
<link type="text/css" href="../guide-media/css/kodoc.css" rel="stylesheet" media="screen" />
<link type="text/css" href="../guide-media/css/shCore.css" rel="stylesheet" media="screen" />
<link type="text/css" href="../guide-media/css/shThemeKodoc.css" rel="stylesheet" media="screen" />

<script type="text/javascript" src="../guide-media/js/jquery.min.js"></script>
<script type="text/javascript" src="../guide-media/js/jquery.cookie.js"></script>
<script type="text/javascript" src="../guide-media/js/kodoc.js"></script>
<script type="text/javascript" src="../guide-media/js/shCore.js"></script>
<script type="text/javascript" src="../guide-media/js/shBrushPhp.js"></script>

<!--[if lt IE 9]>
<script src="http://ie7-js.googlecode.com/svn/version/2.1(beta4)/IE9.js"></script>
<![endif]-->
<script type="text/javascript">
/* <![CDATA[ */
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-27864271-1']);
_gaq.push(['_trackPageview']);

(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();

(function(b){(function(a){"__CF"in b&&"DJS"in b.__CF?b.__CF.DJS.push(a):"addEventListener"in b?b.addEventListener("load",a,!1):b.attachEvent("onload",a)})(function(){"FB"in b&&"Event"in FB&&"subscribe"in FB.Event&&(FB.Event.subscribe("edge.create",function(a){_gaq.push(["_trackSocial","facebook","like",a])}),FB.Event.subscribe("edge.remove",function(a){_gaq.push(["_trackSocial","facebook","unlike",a])}),FB.Event.subscribe("message.send",function(a){_gaq.push(["_trackSocial","facebook","send",a])}));"twttr"in b&&"events"in twttr&&"bind"in twttr.events&&twttr.events.bind("tweet",function(a){if(a){var b;if(a.target&&a.target.nodeName=="IFRAME")a:{if(a=a.target.src){a=a.split("#")[0].match(/[^?=&]+=([^&]*)?/g);b=0;for(var c;c=a[b];++b)if(c.indexOf("url")===0){b=unescape(c.split("=")[1]);break a}}b=void 0}_gaq.push(["_trackSocial","twitter","tweet",b])}})})})(window);
/* ]]> */
</script>
</head>
<body>

	<div id="kodoc-header">
		<div class="container">
			<a href="http://kohanaframework.org/" id="kodoc-logo">
				<img src="../guide-media/img/kohana.png" />
			</a>
			<div id="kodoc-menu">
				<ul>
					<li class="guide first">
						<a href="http://kohanaframework.org/3.3/guide">User Guide</a>
					</li>
										<li class="api">
						<a href="http://kohanaframework.org/3.3/guide-api">API Browser</a>
					</li>
									</ul>
			</div>
		</div>
	</div>

	<div id="kodoc-content">
		<div class="wrapper">
			<div class="container">
				<div class="span-22 prefix-1 suffix-1">
					<ul id="kodoc-breadcrumb">
																				<li><a href="http://kohanaframework.org/3.3/guide">User Guide</a></li>
																											<li><a href="codebench.html">Codebench</a></li>
																		</ul>
				</div>
				<div class="span-6 prefix-1">
					<div id="kodoc-topics">
						<h2 id="codebench"><a href="codebench/index.html">Codebench</a></h2>
					</div>
				</div>
				<div id="kodoc-body" class="span-16 suffix-1 last">
					<h1 id="using-codebench">Using Codebench</h1>

<p class="note">The contents of this page are taken (with some minor changes) from <a href="http://www.geertdedeckere.be/article/introducing-codebench">http://www.geertdedeckere.be/article/introducing-codebench</a> and are copyright Geert De Deckere.</p>

<div class="page-toc">
					<a href="codebench.html#using-codebench">Using Codebench</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;				<a href="codebench.html#codebench-goals">Codebench Goals</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;				<a href="codebench.html#benchmark-multiple-regular-expressions-at-once">Benchmark multiple regular expressions at once</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;				<a href="codebench.html#benchmark-multiple-subjects-at-once">Benchmark multiple subjects at once</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;				<a href="codebench.html#make-it-flexible-enough-to-work-for-all-pcre-functions">Make it flexible enough to work for all PCRE functions</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;				<a href="codebench.html#create-clean-and-portable-benchmark-cases">Create clean and portable benchmark cases</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;				<a href="codebench.html#visualize-the-benchmarks">Visualize the benchmarks</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;				<a href="codebench.html#working-with-codebench">Working with Codebench</a><br />
	</div>
<p>For a long time I have been using a quick-and-dirty <code>benchmark.php</code> file to optimize bits of PHP code, many times regex-related stuff. The file contained not much more than a <a href="http://php.net/gettimeofday">gettimeofday</a> function wrapped around a <code>for</code> loop. It worked, albeit not very efficiently. Something more solid was needed. I set out to create a far more usable piece of software to aid in the everlasting quest to squeeze every millisecond out of those regular expressions.</p>

<h2 id="codebench-goals">Codebench Goals</h2>

<h3 id="benchmark-multiple-regular-expressions-at-once">Benchmark multiple regular expressions at once</h3>

<p>Being able to compare the speed of an arbitrary amount of regular expressions would be tremendously useful. In case you are wondering—yes, I had been writing down benchmark times for each regex, uncommenting them one by one. You get the idea. Those days should be gone forever now.</p>

<h3 id="benchmark-multiple-subjects-at-once">Benchmark multiple subjects at once</h3>

<p>What gets overlooked too often when testing and optimizing regular expressions is the fact that speed can vastly differ depending on the subjects, also known as input or target strings. Just because your regular expression matches, say, a valid email address quickly, does not necessarily mean it will quickly realize when an invalid email is provided. I plan to write a follow-up article with hands-on regex examples to demonstrate this point. Anyway, Codebench allows you to create an array of subjects which will be passed to each benchmark.</p>

<h3 id="make-it-flexible-enough-to-work-for-all-pcre-functions">Make it flexible enough to work for all PCRE functions</h3>

<p>Initially I named the module “Regexbench”. I quickly realized, though, it would be flexible enough to benchmark all kinds of PHP code, hence the change to “Codebench”. While tools specifically built to help profiling PCRE functions, like <a href="http://php.net/preg_match">preg_match</a> or <a href="http://php.net/preg_replace">preg_replace</a>, definitely have their use, more flexibility was needed here. You should be able to compare all kinds of constructions like combinations of PCRE functions and native PHP string functions.</p>

<h3 id="create-clean-and-portable-benchmark-cases">Create clean and portable benchmark cases</h3>

<p>Throwing valuable benchmark data away every time I needed to optimize another regular expression had to stop. A clean file containing the complete set of all regex variations to compare, together with the set of subjects to test them against, would be more than welcome. Moreover, it would be easy to exchange benchmark cases with others.</p>

<h3 id="visualize-the-benchmarks">Visualize the benchmarks</h3>

<p>Obviously providing a visual representation of the benchmark results, via simple graphs, would make interpreting them easier. Having not to think about Internet Explorer for once, made writing CSS a whole lot more easy and fun. It resulted in some fine graphs which are fully resizable.</p>

<p>Below are two screenshots of Codebench in action. <code>Valid_Color</code> is a class made for benchmarking different ways to validate hexadecimal HTML color values, e.g. <code>#FFF</code>. If you are interested in the story behind the actual regular expressions, take a look at <a href="http://forum.kohanaphp.com/comments.php?DiscussionID=2192">this topic in the Kohana forums</a>.</p>

<p><img src="../guide-media/codebench/codebench_screenshot1.png" alt="Benchmarking several ways to validate HTML color values" />
<strong>Benchmarking seven ways to validate HTML color values</strong></p>

<p><img src="../guide-media/codebench/codebench_screenshot2.png" alt="Collapsable results per subject for each method" />
<strong>Collapsable results per subject for each method</strong></p>

<h2 id="working-with-codebench">Working with Codebench</h2>

<p>Codebench is included in Kohana 3, but if you need you <a href="http://github.com/kohana/codebench/">can download it</a> from GitHub. Be sure Codebench is activated in your <code>application/bootstrap.php</code>.</p>

<p>Creating your own benchmarks is just a matter of creating a class that extends the Codebench class.  The class should go in <code>classes/bench</code> and the class name should have the <code>Bench_</code> prefix.  Put the code parts you want to compare into separate methods. Be sure to prefix those methods with <code>bench_</code>, other methods will not be benchmarked. Glance at the files in <code>modules/codebench/classes/bench/</code> for more examples.</p>

<p>Here is another short example with some extra explanations.</p>

<pre><code>// classes/bench/ltrimdigits.php
class Bench_LtrimDigits extends Codebench {

    // Some optional explanatory comments about the benchmark file.
    // HTML allowed. URLs will be converted to links automatically.
    public $description = 'Chopping off leading digits: regex vs ltrim.';

    // How many times to execute each method per subject.
    // Total loops = loops * number of methods * number of subjects
    public $loops = 100000;

    // The subjects to supply iteratively to your benchmark methods.
    public $subjects = array
    (
        '123digits',
        'no-digits',
    );

    public function bench_regex($subject)
    {
        return preg_replace('/^\d+/', '', $subject);
    }

    public function bench_ltrim($subject)
    {
        return ltrim($subject, '0..9');
    }
}
</code></pre>

<p>And the winner is… <a href="http://php.net/ltrim">ltrim</a>. Happy benchmarking!</p>

									</div>
			</div>
		</div>
	</div>

	<div id="kodoc-footer">
		<div class="container">
			<div class="span-12">
							<p>&copy; 2008–2012 Kohana Team</p>
						</div>
			<div class="span-12 last right">
			<p>Powered by <a href="http://kohanaframework.org/">Kohana</a> v3.3.1</p>
			</div>
		</div>
	</div>

</body>
</html>
