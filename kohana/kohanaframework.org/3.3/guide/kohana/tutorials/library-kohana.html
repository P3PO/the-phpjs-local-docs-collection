<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

<title>Kohana as a Library | Kohana User Guide</title>

<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok8v=02fcfa4f56/"},atok:"eee59e90a8282bcfc7cd8af99a42a3da",petok:"2b26cee811a1820a24ee09439ad1f0174cb9385a-1394799558-1800",zone:"kohanaframework.org",rocket:"0",apps:{"ga_key":{"ua":"UA-27864271-1","ga_bs":"2"}}}];var a=document.createElement("script"),b=document.getElementsByTagName("script")[0];a.async=!0;a.src="//ajax.cloudflare.com/cdn-cgi/nexp/dok8v=b064e16429/cloudflare.min.js";b.parentNode.insertBefore(a,b);}}catch(e){};
//]]>
</script>
<link type="text/css" href="../../../guide-media/css/print.css" rel="stylesheet" media="print" />
<link type="text/css" href="../../../guide-media/css/screen.css" rel="stylesheet" media="screen" />
<link type="text/css" href="../../../guide-media/css/kodoc.css" rel="stylesheet" media="screen" />
<link type="text/css" href="../../../guide-media/css/shCore.css" rel="stylesheet" media="screen" />
<link type="text/css" href="../../../guide-media/css/shThemeKodoc.css" rel="stylesheet" media="screen" />

<script type="text/javascript" src="../../../guide-media/js/jquery.min.js"></script>
<script type="text/javascript" src="../../../guide-media/js/jquery.cookie.js"></script>
<script type="text/javascript" src="../../../guide-media/js/kodoc.js"></script>
<script type="text/javascript" src="../../../guide-media/js/shCore.js"></script>
<script type="text/javascript" src="../../../guide-media/js/shBrushPhp.js"></script>

<!--[if lt IE 9]>
<script src="http://ie7-js.googlecode.com/svn/version/2.1(beta4)/IE9.js"></script>
<![endif]-->
<script type="text/javascript">
/* <![CDATA[ */
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-27864271-1']);
_gaq.push(['_trackPageview']);

(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();

(function(b){(function(a){"__CF"in b&&"DJS"in b.__CF?b.__CF.DJS.push(a):"addEventListener"in b?b.addEventListener("load",a,!1):b.attachEvent("onload",a)})(function(){"FB"in b&&"Event"in FB&&"subscribe"in FB.Event&&(FB.Event.subscribe("edge.create",function(a){_gaq.push(["_trackSocial","facebook","like",a])}),FB.Event.subscribe("edge.remove",function(a){_gaq.push(["_trackSocial","facebook","unlike",a])}),FB.Event.subscribe("message.send",function(a){_gaq.push(["_trackSocial","facebook","send",a])}));"twttr"in b&&"events"in twttr&&"bind"in twttr.events&&twttr.events.bind("tweet",function(a){if(a){var b;if(a.target&&a.target.nodeName=="IFRAME")a:{if(a=a.target.src){a=a.split("#")[0].match(/[^?=&]+=([^&]*)?/g);b=0;for(var c;c=a[b];++b)if(c.indexOf("url")===0){b=unescape(c.split("=")[1]);break a}}b=void 0}_gaq.push(["_trackSocial","twitter","tweet",b])}})})})(window);
/* ]]> */
</script>
</head>
<body>

	<div id="kodoc-header">
		<div class="container">
			<a href="http://kohanaframework.org/" id="kodoc-logo">
				<img src="../../../guide-media/img/kohana.png" />
			</a>
			<div id="kodoc-menu">
				<ul>
					<li class="guide first">
						<a href="../../../guide.1.html">User Guide</a>
					</li>
										<li class="api">
						<a href="../../../guide-api.html">API Browser</a>
					</li>
									</ul>
			</div>
		</div>
	</div>

	<div id="kodoc-content">
		<div class="wrapper">
			<div class="container">
				<div class="span-22 prefix-1 suffix-1">
					<ul id="kodoc-breadcrumb">
																				<li><a href="../../../guide.1.html">User Guide</a></li>
																											<li><a href="../../kohana.1.html">Kohana</a></li>
																											<li class="last">Kohana as a Library</li>
																		</ul>
				</div>
				<div class="span-6 prefix-1">
					<div id="kodoc-topics">
						<h2 id="kohana"><a href="../index.html">Kohana</a></h2>

<ul>
<li><a href="../install.html">Installation</a></li>
<li><span>Getting Started</span>

<ul>
<li><a href="../conventions.html">Conventions and Style</a></li>
<li><a href="../mvc.1.html">Model View Controller</a>

<ul>
<li><a href="../mvc/controllers.html">Controllers</a></li>
<li><a href="../mvc/models.html">Models</a></li>
<li><a href="../mvc/views.html">Views</a></li>
</ul></li>
<li><a href="../files.1.html">Cascading Filesystem</a>

<ul>
<li><a href="../files/classes.html">Class Files</a></li>
<li><a href="../files/config.html">Config Files</a></li>
<li><a href="../files/i18n.html">Translation Files</a></li>
<li><a href="../files/messages.html">Message Files</a></li>
</ul></li>
<li><a href="../config.html">Configuration</a></li>
<li><a href="../flow.html">Request Flow</a></li>
<li><a href="../bootstrap.html">Bootstrap</a></li>
<li><a href="../modules.html">Modules</a></li>
<li><a href="../routing.html">Routing</a></li>
<li><a href="../errors.html">Error Handling</a></li>
<li><a href="../tips.html">Tips &amp; Common Mistakes</a></li>
<li><a href="../upgrading.html">Upgrading from v3.2</a></li>
</ul></li>
<li><span>Basic Usage</span>

<ul>
<li><a href="../debugging.html">Debugging</a></li>
<li><a href="../autoloading.html">Loading Classes</a></li>
<li><a href="../extension.html">Transparent Extension</a></li>
<li><a href="../helpers.html">Helpers</a></li>
<li><a href="../requests.html">Requests</a></li>
<li><a href="../sessions.html">Sessions</a></li>
<li><a href="../cookies.html">Cookies</a></li>
<li><a href="../fragments.html">Fragments</a></li>
<li><a href="../profiling.html">Profiling</a></li>
</ul></li>
<li><a href="../security.1.html">Security</a>

<ul>
<li><a href="../security/xss.html">XSS</a></li>
<li><a href="../security/validation.html">Validation</a></li>
<li><a href="../security/cookies.html">Cookies</a></li>
<li><a href="../security/database.html">Database</a></li>
<li><a href="../security/encryption.html">Encryption</a></li>
<li><a href="../security/deploying.html">Deploying</a></li>
</ul></li>
<li><span>Tutorials</span>

<ul>
<li><a href="hello-world.html">Hello World</a></li>
<li><a href="simple-mvc.html">Simple MVC</a></li>
<li><a href="error-pages.html">Custom Error Pages</a></li>
<li><a href="clean-urls.html">Clean URLs</a></li>
<li><a href="sharing-kohana.html">Sharing Kohana</a></li>
<li><a href="library-kohana.html">Kohana as a Library</a></li>
<li><a href="git.html">Working with Git</a></li>
</ul></li>
</ul>
					</div>
				</div>
				<div id="kodoc-body" class="span-16 suffix-1 last">
					<h1 id="importing-kohana-as-a-library">Importing Kohana as a Library</h1>

<div class="page-toc">
					<a href="library-kohana.html#importing-kohana-as-a-library">Importing Kohana as a Library</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;				<a href="library-kohana.html#demo-application">Demo application</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;				<a href="library-kohana.html#file-demophp">File: `demo.php`</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;				<a href="library-kohana.html#install-kohana">Install Kohana</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;				<a href="library-kohana.html#create-a-common-setup-file">Create a common setup file</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;				<a href="library-kohana.html#file-kohanacommonphp">File: `kohana/common.php`</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;				<a href="library-kohana.html#alter-kohanas-indexphp">Alter Kohana's `index.php`</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;				<a href="library-kohana.html#file-kohanaindexphp">File: `kohana/index.php`</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;				<a href="library-kohana.html#create-the-include-file">Create the include file</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;				<a href="library-kohana.html#file-kohanaincludephp">File: `kohana/include.php`</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;				<a href="library-kohana.html#integration">Integration</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;				<a href="library-kohana.html#file-demophp">File: `demo.php`</a><br />
	</div>
<p>If you're working with an existing codebase it's often difficult to modernise the code as it would mean a complete rewrite and there's rarely the time. An alternative is to improve the codebase incrementally as best you can, gradually outsourcing code to external libraries to reduce the amount of old code there is to maintain.</p>

<p>This tutorial describes how to include the Kohana PHP framework into existing PHP applications, without having to use the routing and HMVC request handling features.</p>

<p class="note">The code modified in this tutorial was copied from Kohana version 3.1.x. You may need to update it to work with future releases.</p>

<p>In normal usage of the Kohana framework, the <code>index.php</code> file acts as the request handler; it sets up the environment, loads the system configuration, and then handles the request (see <a href="../flow.html">Request Flow</a>).
We'll walk you through the steps required to create a file we'll call <code>include.php</code> which will allow you to include Kohana from exiting PHP applications.</p>

<h2 id="demo-application">Demo application</h2>

<p>The following file will serve as our (insultingly simple) demo application for this tutorial.</p>

<h3 id="file-demophp">File: <code>demo.php</code></h3>

<pre><code>    &lt;?php
        $content = 'Hello World';
    ?&gt;
    &lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;Demo page&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;?php echo $content; ?&gt;
    &lt;/body&gt;
    &lt;/html&gt;
</code></pre>

<h2 id="install-kohana">Install Kohana</h2>

<p><a href="../install.html">Download and install the Kohana framework</a>; from this point on, we'll be referring to the location of the Kohana libraries as the <code>kohana</code> directory.</p>

<h2 id="create-a-common-setup-file">Create a common setup file</h2>

<p>Since <code>index.php</code> and <code>include.php</code> will duplicate a lot of code, we're going to move that code to a third file, <code>common.php</code>. The bulk of the code is unchanged; we've changed the install check to exit rather than return after rendering, and removed the request execution.</p>

<p>The new file creates the initial request object, rather than fully executing the request, so that, if you do define routes, the <code>Request::$initial</code> variable will be set up correctly.</p>

<h3 id="file-kohanacommonphp">File: <code>kohana/common.php</code></h3>

<pre><code>    &lt;?php

    /**
     * The directory in which your application specific resources are located.
     * The application directory must contain the bootstrap.php file.
     *
     * @link http://kohanaframework.org/guide/about.install#application
     */
    $application = 'application';

    /**
     * The directory in which your modules are located.
     *
     * @link http://kohanaframework.org/guide/about.install#modules
     */
    $modules = 'modules';

    /**
     * The directory in which the Kohana resources are located. The system
     * directory must contain the classes/kohana.php file.
     *
     * @link http://kohanaframework.org/guide/about.install#system
     */
    $system = 'system';

    /**
     * The default extension of resource files. If you change this, all resources
     * must be renamed to use the new extension.
     *
     * @link http://kohanaframework.org/guide/about.install#ext
     */
    define('EXT', '.php');

    /**
     * Set the PHP error reporting level. If you set this in php.ini, you remove this.
     * @link http://www.php.net/manual/errorfunc.configuration#ini.error-reporting
     *
     * When developing your application, it is highly recommended to enable notices
     * and strict warnings. Enable them by using: E_ALL | E_STRICT
     *
     * In a production environment, it is safe to ignore notices and strict warnings.
     * Disable them by using: E_ALL ^ E_NOTICE
     *
     * When using a legacy application with PHP &gt;= 5.3, it is recommended to disable
     * deprecated notices. Disable with: E_ALL &amp; ~E_DEPRECATED
     */
    error_reporting(E_ALL | E_STRICT);

    /**
     * End of standard configuration! Changing any of the code below should only be
     * attempted by those with a working knowledge of Kohana internals.
     *
     * @link http://kohanaframework.org/guide/using.configuration
     */

    // Set the full path to the docroot
    define('DOCROOT', realpath(dirname(__FILE__)).DIRECTORY_SEPARATOR);

    // Make the application relative to the docroot, for symlink'd index.php
    if ( ! is_dir($application) AND is_dir(DOCROOT.$application))
        $application = DOCROOT.$application;

    // Make the modules relative to the docroot, for symlink'd index.php
    if ( ! is_dir($modules) AND is_dir(DOCROOT.$modules))
        $modules = DOCROOT.$modules;

    // Make the system relative to the docroot, for symlink'd index.php
    if ( ! is_dir($system) AND is_dir(DOCROOT.$system))
        $system = DOCROOT.$system;

    // Define the absolute paths for configured directories
    define('APPPATH', realpath($application).DIRECTORY_SEPARATOR);
    define('MODPATH', realpath($modules).DIRECTORY_SEPARATOR);
    define('SYSPATH', realpath($system).DIRECTORY_SEPARATOR);

    // Clean up the configuration vars
    unset($application, $modules, $system);

    if (file_exists('install'.EXT))
    {
        // Load the installation check
        include 'install'.EXT;
        exit; // Changes were made here
    }

    /**
     * Define the start time of the application, used for profiling.
     */
    if ( ! defined('KOHANA_START_TIME'))
    {
        define('KOHANA_START_TIME', microtime(TRUE));
    }

    /**
     * Define the memory usage at the start of the application, used for profiling.
     */
    if ( ! defined('KOHANA_START_MEMORY'))
    {
        define('KOHANA_START_MEMORY', memory_get_usage());
    }

    // Bootstrap the application
    require APPPATH.'bootstrap'.EXT;

    /**
     * Instantiate the request object. A source of the URI can be passed, eg: $_SERVER['PATH_INFO'].
     * If no source is specified, the URI will be automatically detected.
     */
    Request::factory(); // Changes were made here
</code></pre>

<h2 id="alter-kohanas-indexphp">Alter Kohana's <code>index.php</code></h2>

<p>Having moved most of the code from Kohana's <code>index.php</code> to <code>common.php</code> the new <code>kohana/index.php</code> contains only this:</p>

<h3 id="file-kohanaindexphp">File: <code>kohana/index.php</code></h3>

<pre><code>    &lt;?php

    require_once 'common.php';

    // Execute the request
    Request::$initial-&gt;execute()
        -&gt;execute()
        -&gt;send_headers(TRUE)
        -&gt;body();
</code></pre>

<h2 id="create-the-include-file">Create the include file</h2>

<p>Our <code>include.php</code> file is also pretty simple. The try-catch clause is needed because if the request matches no routes Kohana will throw an <code>HTTP_Exception_404</code> exception.</p>

<h3 id="file-kohanaincludephp">File: <code>kohana/include.php</code></h3>

<pre><code>    &lt;?php

    try {
        require_once 'common.php';
    }
    catch (HTTP_Exception_404 $e)
    {
        // The request did not match any routes; ignore the 404 exception.
    }
</code></pre>

<p><strong>NB:</strong> Due to the way Kohana's routing  works, if the request matches no routes it will fail to instantiate an object, and <code>Request::$current</code> and <code>Request::$initial</code> will not be available.</p>

<h2 id="integration">Integration</h2>

<p>Now that we're set up, we can add Kohana into our application using a single include, and then we're good to go.</p>

<h3 id="file-demophp">File: <code>demo.php</code></h3>

<pre><code>    &lt;?php
        require_once 'kohana/include.php';

        $content = 'Hello World';
        $content = HTML::anchor('http://kohanaframework.org/', $content);
    ?&gt;
    &lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;Demo page&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;?php echo $content; ?&gt;
        &lt;hr /&gt;
        &lt;?php echo URL::base(); ?&gt;
        &lt;hr /&gt;
        &lt;?php echo Debug::dump(array(1,2,3,4,5)); ?&gt;
    &lt;/body&gt;
    &lt;/html&gt;
</code></pre>

									</div>
			</div>
		</div>
	</div>

	<div id="kodoc-footer">
		<div class="container">
			<div class="span-12">
							<p>&copy; 2008–2012 Kohana Team</p>
						</div>
			<div class="span-12 last right">
			<p>Powered by <a href="http://kohanaframework.org/">Kohana</a> v3.3.1</p>
			</div>
		</div>
	</div>

</body>
</html>
