<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

<title>Controllers | Kohana User Guide</title>

<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok8v=02fcfa4f56/"},atok:"eee59e90a8282bcfc7cd8af99a42a3da",petok:"70229a476dc3739e72e06094446df2649c2adcfb-1394799546-1800",zone:"kohanaframework.org",rocket:"0",apps:{"ga_key":{"ua":"UA-27864271-1","ga_bs":"2"}}}];var a=document.createElement("script"),b=document.getElementsByTagName("script")[0];a.async=!0;a.src="//ajax.cloudflare.com/cdn-cgi/nexp/dok8v=b064e16429/cloudflare.min.js";b.parentNode.insertBefore(a,b);}}catch(e){};
//]]>
</script>
<link type="text/css" href="../../../guide-media/css/print.css" rel="stylesheet" media="print" />
<link type="text/css" href="../../../guide-media/css/screen.css" rel="stylesheet" media="screen" />
<link type="text/css" href="../../../guide-media/css/kodoc.css" rel="stylesheet" media="screen" />
<link type="text/css" href="../../../guide-media/css/shCore.css" rel="stylesheet" media="screen" />
<link type="text/css" href="../../../guide-media/css/shThemeKodoc.css" rel="stylesheet" media="screen" />

<script type="text/javascript" src="../../../guide-media/js/jquery.min.js"></script>
<script type="text/javascript" src="../../../guide-media/js/jquery.cookie.js"></script>
<script type="text/javascript" src="../../../guide-media/js/kodoc.js"></script>
<script type="text/javascript" src="../../../guide-media/js/shCore.js"></script>
<script type="text/javascript" src="../../../guide-media/js/shBrushPhp.js"></script>

<!--[if lt IE 9]>
<script src="http://ie7-js.googlecode.com/svn/version/2.1(beta4)/IE9.js"></script>
<![endif]-->
<script type="text/javascript">
/* <![CDATA[ */
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-27864271-1']);
_gaq.push(['_trackPageview']);

(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();

(function(b){(function(a){"__CF"in b&&"DJS"in b.__CF?b.__CF.DJS.push(a):"addEventListener"in b?b.addEventListener("load",a,!1):b.attachEvent("onload",a)})(function(){"FB"in b&&"Event"in FB&&"subscribe"in FB.Event&&(FB.Event.subscribe("edge.create",function(a){_gaq.push(["_trackSocial","facebook","like",a])}),FB.Event.subscribe("edge.remove",function(a){_gaq.push(["_trackSocial","facebook","unlike",a])}),FB.Event.subscribe("message.send",function(a){_gaq.push(["_trackSocial","facebook","send",a])}));"twttr"in b&&"events"in twttr&&"bind"in twttr.events&&twttr.events.bind("tweet",function(a){if(a){var b;if(a.target&&a.target.nodeName=="IFRAME")a:{if(a=a.target.src){a=a.split("#")[0].match(/[^?=&]+=([^&]*)?/g);b=0;for(var c;c=a[b];++b)if(c.indexOf("url")===0){b=unescape(c.split("=")[1]);break a}}b=void 0}_gaq.push(["_trackSocial","twitter","tweet",b])}})})})(window);
/* ]]> */
</script>
</head>
<body>

	<div id="kodoc-header">
		<div class="container">
			<a href="http://kohanaframework.org/" id="kodoc-logo">
				<img src="../../../guide-media/img/kohana.png" />
			</a>
			<div id="kodoc-menu">
				<ul>
					<li class="guide first">
						<a href="../../../guide.1.html">User Guide</a>
					</li>
										<li class="api">
						<a href="../../../guide-api.html">API Browser</a>
					</li>
									</ul>
			</div>
		</div>
	</div>

	<div id="kodoc-content">
		<div class="wrapper">
			<div class="container">
				<div class="span-22 prefix-1 suffix-1">
					<ul id="kodoc-breadcrumb">
																				<li><a href="../../../guide.1.html">User Guide</a></li>
																											<li><a href="../../kohana.1.html">Kohana</a></li>
																											<li class="last">Controllers</li>
																		</ul>
				</div>
				<div class="span-6 prefix-1">
					<div id="kodoc-topics">
						<h2 id="kohana"><a href="../index.html">Kohana</a></h2>

<ul>
<li><a href="../install.html">Installation</a></li>
<li><span>Getting Started</span>

<ul>
<li><a href="../conventions.html">Conventions and Style</a></li>
<li><a href="../mvc.1.html">Model View Controller</a>

<ul>
<li><a href="controllers.html">Controllers</a></li>
<li><a href="models.html">Models</a></li>
<li><a href="views.html">Views</a></li>
</ul></li>
<li><a href="../files.1.html">Cascading Filesystem</a>

<ul>
<li><a href="../files/classes.html">Class Files</a></li>
<li><a href="../files/config.html">Config Files</a></li>
<li><a href="../files/i18n.html">Translation Files</a></li>
<li><a href="../files/messages.html">Message Files</a></li>
</ul></li>
<li><a href="../config.html">Configuration</a></li>
<li><a href="../flow.html">Request Flow</a></li>
<li><a href="../bootstrap.html">Bootstrap</a></li>
<li><a href="../modules.html">Modules</a></li>
<li><a href="../routing.html">Routing</a></li>
<li><a href="../errors.html">Error Handling</a></li>
<li><a href="../tips.html">Tips &amp; Common Mistakes</a></li>
<li><a href="../upgrading.html">Upgrading from v3.2</a></li>
</ul></li>
<li><span>Basic Usage</span>

<ul>
<li><a href="../debugging.html">Debugging</a></li>
<li><a href="../autoloading.html">Loading Classes</a></li>
<li><a href="../extension.html">Transparent Extension</a></li>
<li><a href="../helpers.html">Helpers</a></li>
<li><a href="../requests.html">Requests</a></li>
<li><a href="../sessions.html">Sessions</a></li>
<li><a href="../cookies.html">Cookies</a></li>
<li><a href="../fragments.html">Fragments</a></li>
<li><a href="../profiling.html">Profiling</a></li>
</ul></li>
<li><a href="../security.1.html">Security</a>

<ul>
<li><a href="../security/xss.html">XSS</a></li>
<li><a href="../security/validation.html">Validation</a></li>
<li><a href="../security/cookies.html">Cookies</a></li>
<li><a href="../security/database.html">Database</a></li>
<li><a href="../security/encryption.html">Encryption</a></li>
<li><a href="../security/deploying.html">Deploying</a></li>
</ul></li>
<li><span>Tutorials</span>

<ul>
<li><a href="../tutorials/hello-world.html">Hello World</a></li>
<li><a href="../tutorials/simple-mvc.html">Simple MVC</a></li>
<li><a href="../tutorials/error-pages.html">Custom Error Pages</a></li>
<li><a href="../tutorials/clean-urls.html">Clean URLs</a></li>
<li><a href="../tutorials/sharing-kohana.html">Sharing Kohana</a></li>
<li><a href="../tutorials/library-kohana.html">Kohana as a Library</a></li>
<li><a href="../tutorials/git.html">Working with Git</a></li>
</ul></li>
</ul>
					</div>
				</div>
				<div id="kodoc-body" class="span-16 suffix-1 last">
					<h1 id="controllers">Controllers</h1>

<div class="page-toc">
					<a href="controllers.html#controllers">Controllers</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;				<a href="controllers.html#creating-controllers">Creating Controllers</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;				<a href="controllers.html#this-request">$this->request</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;				<a href="controllers.html#this-response">$this->response</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;				<a href="controllers.html#actions">Actions</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;				<a href="controllers.html#parameters">Parameters</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;				<a href="controllers.html#examples">Examples</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;				<a href="controllers.html#before-and-after">Before and after</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;				<a href="controllers.html#custom-construct-function">Custom __construct() function</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;				<a href="controllers.html#extending-other-controllers">Extending other controllers</a><br />
	</div>
<p>A Controller is a class file that stands in between the models and the views in an application. It passes information on to the model when data needs to be changed and it requests information from the model when data needs to be loaded. Controllers then pass on the information of the model to the views where the final output can be rendered for the users.  Controllers essentially control the flow of the application.</p>

<p>Controllers are called by the <a href="../../../guide-api/Request.html#execute">Request::execute()</a> function based on the <a href="../../../guide-api/Route.html">Route</a> that the url matched.  Be sure to read the <a href="../routing.html">routing</a> page to understand how to use routes to map urls to your controllers.</p>

<h2 id="creating-controllers">Creating Controllers</h2>

<p>In order to function, a controller must do the following:</p>

<ul>
<li>Reside in <code>classes/Controller</code> (or a sub-directory)</li>
<li>Filename must match the class name exactly, e.g. <code>Articles.php</code></li>
<li>The class name must map to the filename (with <code>/</code> replaced with <code>_</code>) and each word is capitalized</li>
<li>Must have the Controller class as a (grand)parent</li>
</ul>

<p>Some examples of controller names and file locations:</p>

<pre><code>// classes/Controller/Foobar.php
class Controller_Foobar extends Controller {

// classes/Controller/Admin.php
class Controller_Admin extends Controller {
</code></pre>

<p>Controllers can be in sub-folders:</p>

<pre><code>// classes/Controller/Baz/Bar.php
class Controller_Baz_Bar extends Controller {

// classes/Controller/Product/Category.php
class Controller_Product_Category extends Controller {
</code></pre>

<p class="note">Note that controllers in sub-folders can not be called by the default route, you will need to define a route that has a <a href="../routing.html#directory">directory</a> param or sets a default value for directory.</p>

<p>Controllers can extend other controllers.</p>

<pre><code>// classes/Controller/Users.php
class Controller_Users extends Controller_Template

// classes/Controller/Api.php
class Controller_Api extends Controller_REST
</code></pre>

<p class="note"><a href="../../../guide-api/Controller_Template.html">Controller_Template</a> is an example controller provided in Kohana.</p>

<p>You can also have a controller extend another controller to share common things, such as requiring you to be logged in to use all of those controllers.</p>

<pre><code>// classes/Controller/Admin.php
class Controller_Admin extends Controller {
    // This controller would have a before() that checks if the user is logged in

// classes/Controller/Admin/Plugins.php
class Controller_Admin_Plugins extends Controller_Admin {
    // Because this controller extends Controller_Admin, it would have the same logged in check
</code></pre>

<h2 id="this-request">$this->request</h2>

<p>Every controller has the <code>$this-&gt;request</code> property which is the <a href="../../../guide-api/Request.html">Request</a> object that called the controller.  You can use this to get information about the current request, as well as set the response body via <code>$this-&gt;response-&gt;body($ouput)</code>.</p>

<p>Here is a partial list of the properties and methods available to <code>$this-&gt;request</code>.  These can also be accessed via <code>Request::instance()</code>, but <code>$this-&gt;request</code> is provided as a shortcut.  See the <a href="../../../guide-api/Request.html">Request</a> class for more information on any of these.</p>

<table>
<thead>
<tr>
  <th>Property/method</th>
  <th>What it does</th>
</tr>
</thead>
<tbody>
<tr>
  <td><a href="http://kohanaframework.org/3.3/guide/api/Request#property:route">$this->request->route()</a></td>
  <td>The <a href="../../../guide-api/Route.html">Route</a> that matched the current request url</td>
</tr>
<tr>
  <td><a href="http://kohanaframework.org/3.3/guide/api/Request#property:directory">$this->request->directory()</a>, <br /> <a href="http://kohanaframework.org/3.3/guide/api/Request#property:controller">$this->request->controller</a>, <br /> <a href="http://kohanaframework.org/3.3/guide/api/Request#property:action">$this->request->action</a></td>
  <td>The directory, controller and action that matched for the current route</td>
</tr>
<tr>
  <td><a href="http://kohanaframework.org/3.3/guide/api/Request#param">$this->request->param()</a></td>
  <td>Any other params defined in your route</td>
</tr>
</tbody>
</table>

<h2 id="this-response">$this->response</h2>

<p><a href="http://kohanaframework.org/3.3/guide/api/Response#property:body">$this->response->body()</a> | The content to return for this request
<a href="http://kohanaframework.org/3.3/guide/api/Response#property:status">$this->response->status()</a> | The HTTP status for the request (200, 404, 500, etc.)
<a href="http://kohanaframework.org/3.3/guide/api/Response#property:headers">$this->response->headers()</a> | The HTTP headers to return with the response</p>

<h2 id="actions">Actions</h2>

<p>You create actions for your controller by defining a public function with an <code>action_</code> prefix.  Any method that is not declared as <code>public</code> and prefixed with <code>action_</code> can NOT be called via routing.</p>

<p>An action method will decide what should be done based on the current request, it <em>controls</em> the application.  Did the user want to save a blog post?  Did they provide the necessary fields?   Do they have permission to do that?  The controller will call other classes, including models, to accomplish this.  Every action should set <code>$this-&gt;response-&gt;body($view)</code> to the <a href="views.html">view file</a> to be sent to the browser, unless it redirected or otherwise ended the script earlier.</p>

<p>A very basic action method that simply loads a <a href="views.html">view</a> file.</p>

<pre><code>public function action_hello()
{
    $this-&gt;response-&gt;body(View::factory('hello/world')); // This will load views/hello/world.php
}
</code></pre>

<h3 id="parameters">Parameters</h3>

<p>Parameters are accessed by calling <code>$this-&gt;request-&gt;param('name')</code> where <code>name</code> is the name defined in the route.</p>

<pre><code>// Assuming Route::set('example','&lt;controller&gt;(/&lt;action&gt;(/&lt;id&gt;(/&lt;new&gt;)))');

public function action_foobar()
{
    $id = $this-&gt;request-&gt;param('id');
    $new = $this-&gt;request-&gt;param('new');
</code></pre>

<p>If that parameter is not set it will be returned as NULL.  You can provide a second parameter to set a default value if that param is not set.</p>

<pre><code>public function action_foobar()
{
    // $id will be false if it was not supplied in the url
    $id = $this-&gt;request-&gt;param('user',FALSE);
</code></pre>

<h3 id="examples">Examples</h3>

<p>A view action for a product page.</p>

<pre><code>public function action_view()
{
    $product = new Model_Product($this-&gt;request-&gt;param('id'));

    if ( ! $product-&gt;loaded())
    {
        throw HTTP_Exception::factory(404, 'Product not found!');
    }

    $this-&gt;response-&gt;body(View::factory('product/view')
        -&gt;set('product', $product));
}
</code></pre>

<p>A user login action.</p>

<pre><code>public function action_login()
{
    $view = View::factory('user/login');

    if ($this-&gt;request-&gt;post())
    {
        // Try to login
        if (Auth::instance()-&gt;login($this-&gt;request-&gt;post('username'), $this-&gt;request-&gt;post('password')))
        {
            $this-&gt;redirect('home', 303);
        }

        $view-&gt;errors = 'Invalid email or password';
    }

    $this-&gt;response-&gt;body($view);
}
</code></pre>

<h2 id="before-and-after">Before and after</h2>

<p>You can use the <code>before()</code> and <code>after()</code> functions to have code executed before or after the action is executed. For example, you could check if the user is logged in, set a template view, loading a required file, etc.</p>

<p>For example, if you look in <code>Controller_Template</code> you can see that in the be</p>

<p>You can check what action has been requested (via <code>$this-&gt;request-&gt;action</code>) and do something based on that, such as requiring the user to be logged in to use a controller, unless they are using the login action.</p>

<pre><code>// Checking auth/login in before, and redirecting if necessary:

Controller_Admin extends Controller {

    public function before()
    {
        // If this user doesn't have the admin role, and is not trying to login, redirect to login
        if ( ! Auth::instance()-&gt;logged_in('admin') AND $this-&gt;request-&gt;action !== 'login')
        {
            $this-&gt;redirect('admin/login', 302);
        }
    }

    public function action_login() {
        ...
</code></pre>

<h3 id="custom-construct-function">Custom __construct() function</h3>

<p>In general, you should not have to change the <code>__construct()</code> function, as anything you need for all actions can be done in <code>before()</code>.  If you need to change the controller constructor, you must preserve the parameters or PHP will complain.  This is so the Request object that called the controller is available.  <em>Again, in most cases you should probably be using <code>before()</code>, and not changing the constructor</em>, but if you really, <em>really</em> need to it should look like this:</p>

<pre><code>// You should almost never need to do this, use before() instead!

// Be sure Kohana_Request is in the params
public function __construct(Request $request, Response $response)
{
    // You must call parent::__construct at some point in your function
    parent::__construct($request, $response);

    // Do whatever else you want
}
</code></pre>

<h2 id="extending-other-controllers">Extending other controllers</h2>

<p>TODO: More description and examples of extending other controllers, multiple extension, etc.</p>

									</div>
			</div>
		</div>
	</div>

	<div id="kodoc-footer">
		<div class="container">
			<div class="span-12">
							<p>&copy; 2008–2012 Kohana Team</p>
						</div>
			<div class="span-12 last right">
			<p>Powered by <a href="http://kohanaframework.org/">Kohana</a> v3.3.1</p>
			</div>
		</div>
	</div>

</body>
</html>
