<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

<title>Encryption | Kohana User Guide</title>

<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok8v=02fcfa4f56/"},atok:"eee59e90a8282bcfc7cd8af99a42a3da",petok:"f2d88b8e46a2acc9b006b51e048dee3bbbcde820-1394799556-1800",zone:"kohanaframework.org",rocket:"0",apps:{"ga_key":{"ua":"UA-27864271-1","ga_bs":"2"}}}];var a=document.createElement("script"),b=document.getElementsByTagName("script")[0];a.async=!0;a.src="//ajax.cloudflare.com/cdn-cgi/nexp/dok8v=b064e16429/cloudflare.min.js";b.parentNode.insertBefore(a,b);}}catch(e){};
//]]>
</script>
<link type="text/css" href="../../../guide-media/css/print.css" rel="stylesheet" media="print" />
<link type="text/css" href="../../../guide-media/css/screen.css" rel="stylesheet" media="screen" />
<link type="text/css" href="../../../guide-media/css/kodoc.css" rel="stylesheet" media="screen" />
<link type="text/css" href="../../../guide-media/css/shCore.css" rel="stylesheet" media="screen" />
<link type="text/css" href="../../../guide-media/css/shThemeKodoc.css" rel="stylesheet" media="screen" />

<script type="text/javascript" src="../../../guide-media/js/jquery.min.js"></script>
<script type="text/javascript" src="../../../guide-media/js/jquery.cookie.js"></script>
<script type="text/javascript" src="../../../guide-media/js/kodoc.js"></script>
<script type="text/javascript" src="../../../guide-media/js/shCore.js"></script>
<script type="text/javascript" src="../../../guide-media/js/shBrushPhp.js"></script>

<!--[if lt IE 9]>
<script src="http://ie7-js.googlecode.com/svn/version/2.1(beta4)/IE9.js"></script>
<![endif]-->
<script type="text/javascript">
/* <![CDATA[ */
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-27864271-1']);
_gaq.push(['_trackPageview']);

(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();

(function(b){(function(a){"__CF"in b&&"DJS"in b.__CF?b.__CF.DJS.push(a):"addEventListener"in b?b.addEventListener("load",a,!1):b.attachEvent("onload",a)})(function(){"FB"in b&&"Event"in FB&&"subscribe"in FB.Event&&(FB.Event.subscribe("edge.create",function(a){_gaq.push(["_trackSocial","facebook","like",a])}),FB.Event.subscribe("edge.remove",function(a){_gaq.push(["_trackSocial","facebook","unlike",a])}),FB.Event.subscribe("message.send",function(a){_gaq.push(["_trackSocial","facebook","send",a])}));"twttr"in b&&"events"in twttr&&"bind"in twttr.events&&twttr.events.bind("tweet",function(a){if(a){var b;if(a.target&&a.target.nodeName=="IFRAME")a:{if(a=a.target.src){a=a.split("#")[0].match(/[^?=&]+=([^&]*)?/g);b=0;for(var c;c=a[b];++b)if(c.indexOf("url")===0){b=unescape(c.split("=")[1]);break a}}b=void 0}_gaq.push(["_trackSocial","twitter","tweet",b])}})})})(window);
/* ]]> */
</script>
</head>
<body>

	<div id="kodoc-header">
		<div class="container">
			<a href="http://kohanaframework.org/" id="kodoc-logo">
				<img src="../../../guide-media/img/kohana.png" />
			</a>
			<div id="kodoc-menu">
				<ul>
					<li class="guide first">
						<a href="../../../guide.1.html">User Guide</a>
					</li>
										<li class="api">
						<a href="../../../guide-api.html">API Browser</a>
					</li>
									</ul>
			</div>
		</div>
	</div>

	<div id="kodoc-content">
		<div class="wrapper">
			<div class="container">
				<div class="span-22 prefix-1 suffix-1">
					<ul id="kodoc-breadcrumb">
																				<li><a href="../../../guide.1.html">User Guide</a></li>
																											<li><a href="../../kohana.1.html">Kohana</a></li>
																											<li class="last">Encryption</li>
																		</ul>
				</div>
				<div class="span-6 prefix-1">
					<div id="kodoc-topics">
						<h2 id="kohana"><a href="../index.html">Kohana</a></h2>

<ul>
<li><a href="../install.html">Installation</a></li>
<li><span>Getting Started</span>

<ul>
<li><a href="../conventions.html">Conventions and Style</a></li>
<li><a href="../mvc.1.html">Model View Controller</a>

<ul>
<li><a href="../mvc/controllers.html">Controllers</a></li>
<li><a href="../mvc/models.html">Models</a></li>
<li><a href="../mvc/views.html">Views</a></li>
</ul></li>
<li><a href="../files.1.html">Cascading Filesystem</a>

<ul>
<li><a href="../files/classes.html">Class Files</a></li>
<li><a href="../files/config.html">Config Files</a></li>
<li><a href="../files/i18n.html">Translation Files</a></li>
<li><a href="../files/messages.html">Message Files</a></li>
</ul></li>
<li><a href="../config.html">Configuration</a></li>
<li><a href="../flow.html">Request Flow</a></li>
<li><a href="../bootstrap.html">Bootstrap</a></li>
<li><a href="../modules.html">Modules</a></li>
<li><a href="../routing.html">Routing</a></li>
<li><a href="../errors.html">Error Handling</a></li>
<li><a href="../tips.html">Tips &amp; Common Mistakes</a></li>
<li><a href="../upgrading.html">Upgrading from v3.2</a></li>
</ul></li>
<li><span>Basic Usage</span>

<ul>
<li><a href="../debugging.html">Debugging</a></li>
<li><a href="../autoloading.html">Loading Classes</a></li>
<li><a href="../extension.html">Transparent Extension</a></li>
<li><a href="../helpers.html">Helpers</a></li>
<li><a href="../requests.html">Requests</a></li>
<li><a href="../sessions.html">Sessions</a></li>
<li><a href="../cookies.html">Cookies</a></li>
<li><a href="../fragments.html">Fragments</a></li>
<li><a href="../profiling.html">Profiling</a></li>
</ul></li>
<li><a href="../security.1.html">Security</a>

<ul>
<li><a href="xss.html">XSS</a></li>
<li><a href="validation.html">Validation</a></li>
<li><a href="cookies.html">Cookies</a></li>
<li><a href="database.html">Database</a></li>
<li><a href="encryption.html">Encryption</a></li>
<li><a href="deploying.html">Deploying</a></li>
</ul></li>
<li><span>Tutorials</span>

<ul>
<li><a href="../tutorials/hello-world.html">Hello World</a></li>
<li><a href="../tutorials/simple-mvc.html">Simple MVC</a></li>
<li><a href="../tutorials/error-pages.html">Custom Error Pages</a></li>
<li><a href="../tutorials/clean-urls.html">Clean URLs</a></li>
<li><a href="../tutorials/sharing-kohana.html">Sharing Kohana</a></li>
<li><a href="../tutorials/library-kohana.html">Kohana as a Library</a></li>
<li><a href="../tutorials/git.html">Working with Git</a></li>
</ul></li>
</ul>
					</div>
				</div>
				<div id="kodoc-body" class="span-16 suffix-1 last">
					<h1 id="encryption">Encryption</h1>

<div class="page-toc">
					<a href="encryption.html#encryption">Encryption</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;				<a href="encryption.html#complete-config-example">Complete Config Example</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;				<a href="encryption.html#basic-usage">Basic Usage</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;				<a href="encryption.html#create-an-instance">Create an instance</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;				<a href="encryption.html#encoding-data">Encoding Data</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;				<a href="encryption.html#decoding-data">Decoding Data</a><br />
	</div>
<p>Kohana supports built-in encryption and decryption via the <a href="../../../guide-api/Encrypt.html">Encrypt</a> class, which is a convenient wrapper for the <a href="http://www.php.net/mcrypt">Mcrypt library</a>.</p>

<p>To use the class, first start by ensuring you have the Mcrypt extension loaded to your PHP config. See the <a href="http://www.php.net/manual/en/mcrypt.installation.php">Mcrypt Installation page</a> on php.net. The Mcrypt extension requires <a href="http://sourceforge.net/projects/mcrypt/files/">libmcrypt</a>.</p>

<p>Next, copy the default config/encryption.php from system/config folder to your application/config folder.</p>

<p>The default Encryption config file that ships with Kohana 3.2.x looks like this:</p>

<pre><code>&lt;?php defined('SYSPATH') OR die('No direct script access.');

return array(

    'default' =&gt; array(
        /**
        * The following options must be set:
        *
        * string   key     secret passphrase
        * integer  mode    encryption mode, one of MCRYPT_MODE_*
        * integer  cipher  encryption cipher, one of the Mcrpyt cipher constants
        */
        'cipher' =&gt; MCRYPT_RIJNDAEL_128,
        'mode'   =&gt; MCRYPT_MODE_NOFB,
    ),

);
</code></pre>

<p>A couple of notes about the config.
First, you may have multiple first-level keys other than 'default' if you need to.
In this respect, the config file is similar to having multiple databases defined in your config/database.php file.
Second, notice there is no key provided. You need to add that.
It is strongly recommended that you choose a high-strength random key using the <a href="http://linux.die.net/man/1/pwgen">pwgen linux program</a>...</p>

<pre><code>shell&gt; pwgen 63 1
trwQwVXX96TIJoKxyBHB9AJkwAOHixuV1ENZmIWyanI0j1zNgSVvqywy044Agaj
</code></pre>

<p>...or by going to <a href="https://www.grc.com/passwords.htm">GRC.com/passwords.htm</a>.</p>

<h2 id="complete-config-example">Complete Config Example</h2>

<p>Here's a sample encryption configuration with three types of encryption defined. <strong>If you copy this example, please change your keys!</strong></p>

<pre><code>&lt;?php defined('SYSPATH') OR die('No direct script access.');
// application/config/encrypt.php

return array(

    'default' =&gt; array(
        'key'    =&gt; 'trwQwVXX96TIJoKxyBHB9AJkwAOHixuV1ENZmIWyanI0j1zNgSVvqywy044Agaj',
        'cipher' =&gt; MCRYPT_RIJNDAEL_128,
        'mode'   =&gt; MCRYPT_MODE_NOFB,
    ),
    'blowfish' =&gt; array(
        'key'    =&gt; '7bZJJkmNrelj5NaKoY6h6rMSRSmeUlJuTeOd5HHka5XknyMX4uGSfeVolTz4IYy',
        'cipher' =&gt; MCRYPT_BLOWFISH,
        'mode'   =&gt; MCRYPT_MODE_ECB,
    ),
    'tripledes' =&gt; array(
        'key'    =&gt; 'a9hcSLRvA3LkFc7EJgxXIKQuz1ec91J7P6WNq1IaxMZp4CTj5m31gZLARLxI1jD',
        'cipher' =&gt; MCRYPT_3DES,
        'mode'   =&gt; MCRYPT_MODE_CBC,
    ),
);
</code></pre>

<p>You can view the available encryption ciphers and modes on your system by running...</p>

<pre><code>shell&gt; php -r "print_r(get_defined_constants());" | grep MCRYPT
</code></pre>

<p>For more information on Mcrypt ciphers, visit <a href="http://us3.php.net/manual/en/mcrypt.ciphers.php">php.net/mcrypt.ciphers</a>.</p>

<h2 id="basic-usage">Basic Usage</h2>

<h3 id="create-an-instance">Create an instance</h3>

<p>To use the Encryption class, obtain an instance of the Encrypt class by calling it's <em>instance</em> method,
optionally passing the desired configuration group. If you do not pass a config group to the instance method,
the default group will be used.</p>

<pre><code>$encrypt = Encrypt::instance('tripledes');
</code></pre>

<h3 id="encoding-data">Encoding Data</h3>

<p>Next, encode some data using the <em>encode</em> method:</p>

<pre><code>$encrypt = Encrypt::instance('tripledes');
$encrypted_data = $encrypt-&gt;encode('Data to Encode');
// $encrypted_data now contains pCD5Z6oVdb9hbLxxV+FgGrhwVzZuhQoH
</code></pre>

<p class="note">Raw encrypted strings usually won't print in a browser, and may not store properly in a VARCHAR or TEXT field. For this reason, Kohana's Encrypt class automatically calls base64_encode on encode, and base64_decode on decode, to prevent this problem.</p>

<p class="note">One word of caution. The length of the encoded data expands quite a bit, so be sure your database column is long enough to store the encrypted data. If even one character is truncated, the data will not be recoverable.</p>

<h3 id="decoding-data">Decoding Data</h3>

<p>To decode some data, load it from the place you stored it (most likely your database) then pass it to the <em>decode</em> method:</p>

<pre><code>$encrypt = Encrypt::instance('tripledes');
$decoded_string = $encrypt-&gt;decode($encrypted_data);
echo $decoded_string;
// prints 'Data to Encode'
</code></pre>

<p>You can't know in advance what the encoded string will be, and it's not reproducible, either.
That is, you can encode the same value over and over, but you'll always obtain a different encoded version,
even without changing your key, cipher and mode.  This is because Kohana adds some random entropy before encoding it with your value.
This ensures an attacker cannot easily discover your key and cipher, even given a collection of encoded values.</p>

									</div>
			</div>
		</div>
	</div>

	<div id="kodoc-footer">
		<div class="container">
			<div class="span-12">
							<p>&copy; 2008–2012 Kohana Team</p>
						</div>
			<div class="span-12 last right">
			<p>Powered by <a href="http://kohanaframework.org/">Kohana</a> v3.3.1</p>
			</div>
		</div>
	</div>

</body>
</html>
