<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

<title>Requests | Kohana User Guide</title>

<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok8v=02fcfa4f56/"},atok:"eee59e90a8282bcfc7cd8af99a42a3da",petok:"1a0781ba0605c57e84b0cf44ac2101fd1ec24be8-1394799553-1800",zone:"kohanaframework.org",rocket:"0",apps:{"ga_key":{"ua":"UA-27864271-1","ga_bs":"2"}}}];var a=document.createElement("script"),b=document.getElementsByTagName("script")[0];a.async=!0;a.src="//ajax.cloudflare.com/cdn-cgi/nexp/dok8v=b064e16429/cloudflare.min.js";b.parentNode.insertBefore(a,b);}}catch(e){};
//]]>
</script>
<link type="text/css" href="../../guide-media/css/print.css" rel="stylesheet" media="print" />
<link type="text/css" href="../../guide-media/css/screen.css" rel="stylesheet" media="screen" />
<link type="text/css" href="../../guide-media/css/kodoc.css" rel="stylesheet" media="screen" />
<link type="text/css" href="../../guide-media/css/shCore.css" rel="stylesheet" media="screen" />
<link type="text/css" href="../../guide-media/css/shThemeKodoc.css" rel="stylesheet" media="screen" />

<script type="text/javascript" src="../../guide-media/js/jquery.min.js"></script>
<script type="text/javascript" src="../../guide-media/js/jquery.cookie.js"></script>
<script type="text/javascript" src="../../guide-media/js/kodoc.js"></script>
<script type="text/javascript" src="../../guide-media/js/shCore.js"></script>
<script type="text/javascript" src="../../guide-media/js/shBrushPhp.js"></script>

<!--[if lt IE 9]>
<script src="http://ie7-js.googlecode.com/svn/version/2.1(beta4)/IE9.js"></script>
<![endif]-->
<script type="text/javascript">
/* <![CDATA[ */
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-27864271-1']);
_gaq.push(['_trackPageview']);

(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();

(function(b){(function(a){"__CF"in b&&"DJS"in b.__CF?b.__CF.DJS.push(a):"addEventListener"in b?b.addEventListener("load",a,!1):b.attachEvent("onload",a)})(function(){"FB"in b&&"Event"in FB&&"subscribe"in FB.Event&&(FB.Event.subscribe("edge.create",function(a){_gaq.push(["_trackSocial","facebook","like",a])}),FB.Event.subscribe("edge.remove",function(a){_gaq.push(["_trackSocial","facebook","unlike",a])}),FB.Event.subscribe("message.send",function(a){_gaq.push(["_trackSocial","facebook","send",a])}));"twttr"in b&&"events"in twttr&&"bind"in twttr.events&&twttr.events.bind("tweet",function(a){if(a){var b;if(a.target&&a.target.nodeName=="IFRAME")a:{if(a=a.target.src){a=a.split("#")[0].match(/[^?=&]+=([^&]*)?/g);b=0;for(var c;c=a[b];++b)if(c.indexOf("url")===0){b=unescape(c.split("=")[1]);break a}}b=void 0}_gaq.push(["_trackSocial","twitter","tweet",b])}})})})(window);
/* ]]> */
</script>
</head>
<body>

	<div id="kodoc-header">
		<div class="container">
			<a href="http://kohanaframework.org/" id="kodoc-logo">
				<img src="../../guide-media/img/kohana.png" />
			</a>
			<div id="kodoc-menu">
				<ul>
					<li class="guide first">
						<a href="../../guide.1.html">User Guide</a>
					</li>
										<li class="api">
						<a href="../../guide-api.html">API Browser</a>
					</li>
									</ul>
			</div>
		</div>
	</div>

	<div id="kodoc-content">
		<div class="wrapper">
			<div class="container">
				<div class="span-22 prefix-1 suffix-1">
					<ul id="kodoc-breadcrumb">
																				<li><a href="../../guide.1.html">User Guide</a></li>
																											<li><a href="../kohana.1.html">Kohana</a></li>
																											<li class="last">Requests</li>
																		</ul>
				</div>
				<div class="span-6 prefix-1">
					<div id="kodoc-topics">
						<h2 id="kohana"><a href="index.html">Kohana</a></h2>

<ul>
<li><a href="install.html">Installation</a></li>
<li><span>Getting Started</span>

<ul>
<li><a href="conventions.html">Conventions and Style</a></li>
<li><a href="mvc.1.html">Model View Controller</a>

<ul>
<li><a href="mvc/controllers.html">Controllers</a></li>
<li><a href="mvc/models.html">Models</a></li>
<li><a href="mvc/views.html">Views</a></li>
</ul></li>
<li><a href="files.1.html">Cascading Filesystem</a>

<ul>
<li><a href="files/classes.html">Class Files</a></li>
<li><a href="files/config.html">Config Files</a></li>
<li><a href="files/i18n.html">Translation Files</a></li>
<li><a href="files/messages.html">Message Files</a></li>
</ul></li>
<li><a href="config.html">Configuration</a></li>
<li><a href="flow.html">Request Flow</a></li>
<li><a href="bootstrap.html">Bootstrap</a></li>
<li><a href="modules.html">Modules</a></li>
<li><a href="routing.html">Routing</a></li>
<li><a href="errors.html">Error Handling</a></li>
<li><a href="tips.html">Tips &amp; Common Mistakes</a></li>
<li><a href="upgrading.html">Upgrading from v3.2</a></li>
</ul></li>
<li><span>Basic Usage</span>

<ul>
<li><a href="debugging.html">Debugging</a></li>
<li><a href="autoloading.html">Loading Classes</a></li>
<li><a href="extension.html">Transparent Extension</a></li>
<li><a href="helpers.html">Helpers</a></li>
<li><a href="requests.html">Requests</a></li>
<li><a href="sessions.html">Sessions</a></li>
<li><a href="cookies.html">Cookies</a></li>
<li><a href="fragments.html">Fragments</a></li>
<li><a href="profiling.html">Profiling</a></li>
</ul></li>
<li><a href="security.1.html">Security</a>

<ul>
<li><a href="security/xss.html">XSS</a></li>
<li><a href="security/validation.html">Validation</a></li>
<li><a href="security/cookies.html">Cookies</a></li>
<li><a href="security/database.html">Database</a></li>
<li><a href="security/encryption.html">Encryption</a></li>
<li><a href="security/deploying.html">Deploying</a></li>
</ul></li>
<li><span>Tutorials</span>

<ul>
<li><a href="tutorials/hello-world.html">Hello World</a></li>
<li><a href="tutorials/simple-mvc.html">Simple MVC</a></li>
<li><a href="tutorials/error-pages.html">Custom Error Pages</a></li>
<li><a href="tutorials/clean-urls.html">Clean URLs</a></li>
<li><a href="tutorials/sharing-kohana.html">Sharing Kohana</a></li>
<li><a href="tutorials/library-kohana.html">Kohana as a Library</a></li>
<li><a href="tutorials/git.html">Working with Git</a></li>
</ul></li>
</ul>
					</div>
				</div>
				<div id="kodoc-body" class="span-16 suffix-1 last">
					<h1 id="requests">Requests</h1>

<div class="page-toc">
					<a href="requests.html#requests">Requests</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;				<a href="requests.html#creating-requests">Creating Requests</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;				<a href="requests.html#internal-requests">Internal Requests</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;				<a href="requests.html#the-initial-request">The initial request</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;				<a href="requests.html#sub-requests">Sub-requests</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;				<a href="requests.html#external-requests">External Requests</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;				<a href="requests.html#executing-requests">Executing Requests</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;				<a href="requests.html#header-callbacks">Header callbacks</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;				<a href="requests.html#nested-requests">Nested requests</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;				<a href="requests.html#callback-parameters">Callback parameters</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;				<a href="requests.html#following-redirects">Following redirects</a><br />
					&nbsp;&nbsp;&nbsp;&nbsp;				<a href="requests.html#request-cache-control">Request Cache Control</a><br />
	</div>
<p>Kohana includes a flexible HMVC request system. It supports out of the box support for internal requests and external requests.</p>

<p>HMVC stands for <code>Hierarchical Model View Controller</code> and basically means requests can each have MVC triads called from inside each other.</p>

<p>The Request object in Kohana is HTTP/1.1 compliant.</p>

<h2 id="creating-requests">Creating Requests</h2>

<p>Creating a request is very easy:</p>

<h3 id="internal-requests">Internal Requests</h3>

<p>An internal request is a request calling to the internal application. It utilizes <a href="routing.html">routes</a> to direct the application based on the URI that is passed to it. A basic internal request might look something like:</p>

<pre><code>$request = Request::factory('welcome');
</code></pre>

<p>In this example, the URI is 'welcome'.</p>

<h4 id="the-initial-request">The initial request</h4>

<p>Since Kohana uses HMVC, you can call many requests inside each other. The first request (usually called from <code>index.php</code>) is called the "initial request". You can access this request via:</p>

<pre><code>Request::initial();
</code></pre>

<p>You should only use this method if you are absolutely sure you want the initial request. Otherwise you should use the <code>Request::current()</code> method.</p>

<h4 id="sub-requests">Sub-requests</h4>

<p>You can call a request at any time in your application by using the <code>Request::factory()</code> syntax. All of these requests will be considered sub-requests.</p>

<p>Other than this difference, they are exactly the same. You can detect if the request is a sub-request in your controller with the is_initial() method:</p>

<pre><code>$sub_request = ! $this-&gt;request-&gt;is_initial()
</code></pre>

<h3 id="external-requests">External Requests</h3>

<p>An external request calls out to a third party website.</p>

<p>You can use this to scrape HTML from a remote site, or make a REST call to a third party API:</p>

<pre><code>// This uses GET
$request = Request::factory('http://www.google.com/');

// This uses PUT
$request = Request::factory('http://example.com/put_api')-&gt;method(Request::PUT)-&gt;body(json_encode('the body'))-&gt;headers('Content-Type', 'application/json');

// This uses POST
$request = Request::factory('http://example.com/post_api')-&gt;method(Request::POST)-&gt;post(array('foo' =&gt; 'bar', 'bar' =&gt; 'baz'));
</code></pre>

<h2 id="executing-requests">Executing Requests</h2>

<p>To execute a request, use the <code>execute()</code> method on it. This will give you a <a href="http://kohanaframework.org/3.3/guide/kohana/responses">response</a> object.</p>

<pre><code>$request = Request::factory('welcome');
$response = $request-&gt;execute();
</code></pre>

<h3 id="header-callbacks">Header callbacks</h3>

<p>The request client supports header callbacks - an array of callbacks that will be triggered when a specified header is included in the response from a server. Header callbacks provide a powerful way to deal with scenarios including authentication, rate limiting, redirects and other application-specific use cases:</p>

<pre><code>$request = Request::factory('http://example.com/user', array(
    'header_callbacks' =&gt; array(
        'Content-Encoding' =&gt;
            function (Request $request, Response $response, Request_Client $client)
            {
                // Uncompress the response
                $response-&gt;body(GZIP::expand($response-&gt;body()));
            },
        'X-Rate-Limited' =&gt;
            function (Request $request, Response $response, Request_Client $client)
            {
                // Log the rate limit event
                // And perhaps set a deadlock in cache to prevent further requests
            },
        'WWW-Authenticate' =&gt;
            function (Request $request, Response $response, Request_Client $client)
            {
                // Execute a request to refresh your OAuth token somehow
                // Have the original request resent
                return Request::factory($request-&gt;uri())
                        -&gt;query($request-&gt;query())
                        -&gt;headers('Authorization', 'token'.$token);
            }));
</code></pre>

<p>Where multiple headers are present in the response, callbacks will be executed in sequence. Callbacks can be any valid PHP callback type and have three possible return types:</p>

<table>
<thead>
<tr>
  <th>Type</th>
  <th>Function</th>
</tr>
</thead>
<tbody>
<tr>
  <td><a href="../../guide-api/Request.html">Request</a> object</td>
  <td>If a new request is returned, the request client will automatically assign properties, callbacks etc to match the original request and then execute the request. No further callbacks will be triggered for the original request, but the new request may trigger callbacks when executed.</td>
</tr>
<tr>
  <td><a href="../../guide-api/Response.html">Response</a> object</td>
  <td>If the callback returns a new response instance it will be returned to the application. No further callbacks will be triggered for the original request. The callback is responsible for setting any relevant callbacks and properties for the request it executes</td>
</tr>
<tr>
  <td>NULL</td>
  <td>The callback can, if required, modify the provided Response object and return NULL. The modified response object will be passed into subsequent callbacks.</td>
</tr>
</tbody>
</table>

<h4 id="nested-requests">Nested requests</h4>

<p>If your callback returns a new Request object, the request client will apply the same callback and property definitions to it before execution. This allows for nested requests - for example, you might need to re-authenticate before submitting a POST request and then being redirected to a new location. To avoid infinite recursion and fatal errors, the request client keeps track of the number of subrequests and will throw a <a href="../../guide-api/Request_Client_Recursion_Exception.html">Request_Client_Recursion_Exception</a> if the recursion gets too deep. This behaviour is controlled by two properties: <a href="../../guide-api/Request_Client.html#callback_depth">Request_Client::callback_depth()</a> and <a href="../../guide-api/Request_Client.html#max_callback_depth">Request_Client::max_callback_depth()</a>. The default limit is 5 subrequests.</p>

<p>If your callback executes a new request itself and returns the response, it is responsible for dealing with any callbacks and request nesting itself. You may find the <a href="../../guide-api/Request_Client.html#assign_client_properties">Request_Client::assign_client_properties()</a> method useful in this case.</p>

<h4 id="callback-parameters">Callback parameters</h4>

<p>Arbitrary parameters can be passed to the callbacks through the <a href="../../guide-api/Request_Client.html#callback_params">Request_Client::callback_params()</a> property:</p>

<pre><code>$request = Request::factory('http://example.com/foo', array(
    'header_callbacks' =&gt; array(
        'X-Custom-1' =&gt;
            function (Request $request, Response $response, Request_Client $client)
            {
                // Do something that needs an external parameter
                if ($client-&gt;callback_params('foo') == 'bar')
                {
                    // etc
                }
            },
        )
    'callback_params' =&gt; array(
        'foo' =&gt; 'bar'
        )
    ));

// later on
$request-&gt;client()-&gt;callback_params('foo',FALSE);
</code></pre>

<p>As with nested requests, callback_params will automatically be passed to subrequests if the callback returns a new Request object. If the callback returns a Response object, it is responsible for passing on any relevant parameters.</p>

<h4 id="following-redirects">Following redirects</h4>

<p>The request client ships with a standard callback to automatically follow redirects - <a href="../../guide-api/Request_Client.html#on_header_location">Request_Client::on_header_location()</a>. This will recursively follow redirects that are specified with a Location header and a status code in 201, 301, 302, 303, 307. This behaviour is disabled by default, but can be enabled by passing a set of options to the Request's constructor:</p>

<pre><code>$request = Request::factory('http://example.com/redirectme', array(
    'follow' =&gt; TRUE));
</code></pre>

<p class="note">If you define additional header callbacks of your own, you will need to include the 'Location' callback in your callbacks array.</p>

<p>A number of options are available to control the behaviour of the <a href="../../guide-api/Request_Client.html">Request_Client</a> when following redirects.</p>

<table>
<thead>
<tr>
  <th>Option</th>
  <th>Default</th>
  <th>Function</th>
</tr>
</thead>
<tbody>
<tr>
  <td>follow</td>
  <td>FALSE</td>
  <td>Whether to follow redirects</td>
</tr>
<tr>
  <td>follow_headers</td>
  <td>array('Authorization')</td>
  <td>The keys of headers that will be re-sent with the redirected request</td>
</tr>
<tr>
  <td>strict_redirect</td>
  <td>TRUE</td>
  <td>Whether to use the original request method following to a 302 redirect (see below)</td>
</tr>
</tbody>
</table>

<p class="note">HTTP/1.1 specifies that a 302 redirect should be followed using the original request method. However, the vast majority of clients and servers get this wrong, with 302 widely used for 'POST - 302 redirect - GET' patterns. By default, Kohana's client is fully compliant with the HTTP spec. If you need to interact with non-compliant third party sites you may need to set strict_redirect FALSE to force the client to switch to GET following a 302 response.</p>

<p>You can easily alter this behaviour by configuring your own 'Location' header callback.</p>

<h2 id="request-cache-control">Request Cache Control</h2>

<p>You can cache requests for fast execution by passing a cache instance in as the second parameter of factory:</p>

<pre><code>$request = Request::factory('welcome', array('cache'=&gt;Cache::instance()));
</code></pre>

<p>TODO</p>

									</div>
			</div>
		</div>
	</div>

	<div id="kodoc-footer">
		<div class="container">
			<div class="span-12">
							<p>&copy; 2008–2012 Kohana Team</p>
						</div>
			<div class="span-12 last right">
			<p>Powered by <a href="http://kohanaframework.org/">Kohana</a> v3.3.1</p>
			</div>
		</div>
	</div>

</body>
</html>
